# Toobit Multi-Trade Telegram Bot

## Overview
This project is a sophisticated Telegram-based trading bot designed for Toobit USDT-M futures trading, featuring multi-trade capabilities. It enables users to manage multiple simultaneous trading configurations through a conversational interface. Key capabilities include advanced risk management, portfolio tracking, and real-time trade execution monitoring. The business vision is to provide a powerful, user-friendly tool for active traders, leveraging Telegram for accessibility and real-time interaction, with ambitions to expand to other exchanges and offer a comprehensive suite of trading tools.

## User Preferences
Preferred communication style: Simple, everyday language.

## System Architecture
The application utilizes Flask as its web framework, serving as the primary interface for the Telegram Mini-App and handling webhook integration for real-time message processing. The core innovation is the `MultiTradeManager` class, enabling concurrent management of multiple trading configurations while ensuring user isolation and orchestrating multiple `TradingBot` instances.

**Codebase Consolidation (Aug 2025)**: Successfully consolidated redundant files and documentation. Removed 20+ duplicate markdown files, backup Python files, and redundant configuration files. Streamlined project structure with `api/` directory containing main Flask application, unified deployment guide, and clean separation between Replit development and Vercel production environments. Final cleanup in August 2025 removed additional non-essential documentation files while preserving critical project information.

**Vercel Deployment Fix (Aug 2025)**: Resolved 404 error in Vercel deployment by updating vercel.json to point to api/app.py instead of api/app_streamlined.py. Updated api/index.py import path and verified Flask app export. The deployment should now work correctly at https://v0-03-one.vercel.app/ after redeployment.

**Security Enhancement (Aug 2025)**: Implemented comprehensive webhook security system with secret token authentication, request structure validation, and manual webhook setup. The automatic webhook configuration has been disabled to allow manual configuration through Vercel dashboard and Telegram API.

**Replit Migration & Market Data Removal (Aug 2025)**: Successfully migrated project from Replit Agent to standard Replit environment. Removed market data tab, live charting functionality, Chart.js dependencies, and all associated API endpoints (/api/market-data, /api/kline-data) to streamline the application and focus on core trading bot capabilities. All packages properly installed and working. The Positions tab is now the default landing page.

**Limit Order Functionality Fix (Aug 2025)**: Fixed critical issue where limit price positions couldn't be created and executed. Added missing validation logic for 'entry' and 'side' steps in the trade configuration wizard. The frontend now properly captures and validates limit prices, enabling users to create both market and limit orders successfully.

**Live Market Data Integration (Aug 2025)**: Completed comprehensive migration to real-time market data across all platform deployments. All trading operations, price checks, callback handlers, and position updates now use live market prices from Binance, CoinGecko, and CryptoCompare APIs with fallback mechanisms. Updated Vercel requirements.txt and deployment configuration to support live data APIs. Fixed limit order execution to properly display live market prices while maintaining user-specified entry prices for P&L calculations. Implemented automatic position updates with live P&L calculations triggered during portfolio views and margin data requests. Both Replit and Vercel environments consistently use authentic market data for demo and production trading modes.

**Real Limit Order Implementation (Aug 2025)**: Implemented proper limit order functionality where orders wait for market price to reach the specified limit before execution. Added "pending" status for limit orders that don't immediately meet price conditions. Created automated monitoring system that checks pending orders and executes them when market price reaches limit conditions. Long limit orders execute when market drops to/below limit price; short limit orders execute when market rises to/above limit price. Enhanced UI with blue pending status indicator and comprehensive limit order tracking. Fixed frontend and backend to properly display pending orders in position lists and Telegram bot menus. Added validation to prevent nonsensical limit prices (long above market, short below market). Updated both Replit and Vercel deployments with identical pending status functionality.

**Replit Environment Migration Complete (Aug 2025)**: Successfully completed migration from Replit Agent to standard Replit environment. Fixed critical limit order validation issue that was preventing long limit orders above market price (buy stop orders for breakout strategies). Resolved position bug where edited pending positions would behave incorrectly when viewing portfolio tab due to inconsistent limit order execution logic between trade execution and portfolio update functions. Fixed deployment inconsistencies by implementing dual import strategy in api/app.py to support both Vercel serverless deployment and direct execution workflows. Created compatibility entry point (app.py) for Telegram Trading Bot workflow. The system now supports all four types of limit orders consistently across all functions: long limit (buy below market), long stop (buy above market), short limit (sell above market), and short stop (sell below market). All packages are installed and working properly with Flask application running on port 5000. Both Replit and Vercel deployments now have identical functionality with zero deployment inconsistencies.

**Critical Trading Logic Correction (Aug 2025)**: Fixed fundamental flaws in margin, position size, and leverage calculations throughout the system. Corrected `calculate_position_margin()` function to properly handle margin as user input amount (not position_value/leverage). Fixed `calculate_unrealized_pnl()` to use correct leveraged P&L formula: `price_change_percentage * leverage * margin`. Updated position execution logic to properly calculate position_value (margin * leverage) and position_size (position_value / entry_price). **Critical Fix**: Corrected take profit and stop loss profit/loss calculations where TP/SL percentages apply to margin (what user risks), not position value. With $100 margin, 10x leverage, 10% TP: price needs only 1% movement, profit = $10 (10% of $100 margin). The trading system now uses mathematically correct futures trading formulas where leverage amplifies price sensitivity but profit/loss amounts are calculated from user's margin input.

**Enhanced TP/SL Display (Aug 2025)**: Implemented comprehensive take profit and stop loss enhancement showing actual prices alongside profit/loss amounts instead of just percentages. Added `calculate_tp_sl_prices_and_amounts()` function that computes exact TP/SL trigger prices and expected profit/loss amounts based on margin trading principles. **Critical Fix**: Corrected profit/loss calculation logic to use proper percentage-based calculations (price_change_percentage * margin) where 10% SL on $10 margin = $1 loss, not $10. Updated both web interface and Telegram bot to display: TP levels with exact prices and profit amounts (e.g., "TP1: $63,000 (+$0.50)"), SL with exact price and loss amount (e.g., "SL: $54,000 (-$1.00)"). Enhanced user experience by showing accurate financial impact of risk management levels, helping users make more informed trading decisions with mathematically correct margin calculations.

**Template Structure Consolidation (Aug 2025)**: Eliminated dual template structure by removing redundant root-level templates directory and consolidating all templates into the api/templates/ directory. This ensures consistent template resolution for both Replit and Vercel deployments while maintaining proper Flask application structure. The Flask app automatically resolves templates from its local templates directory, eliminating any deployment inconsistencies.

The trading system features a modular design with `TradeConfig` objects encapsulating trade parameters and `TradingBot` instances handling execution, state tracking, and trailing stop functionality. Position management supports partial closing at configurable take profit levels, and risk management includes breakeven stop loss movement and trailing stop activation.

The `PortfolioTracker` offers comprehensive analytics, including multi-user support, detailed trade history, performance metrics (win/loss ratios, P&L), and daily summaries.

The Telegram Bot integrates via webhooks, processing messages and callback queries. The UI/UX utilizes HTML formatting for rich text and interactive menus, with a sophisticated dark blue theme, elegant gradient backgrounds, high-contrast white text, and vibrant blue accents, optimized for mobile with a responsive design. It provides real-time trade execution notifications and status updates with robust error handling.

Data management uses in-memory, dictionary-based structures for user data isolation, trade configuration persistence, and session management. API credentials are securely encrypted using Fernet encryption and stored in `UserCredentials` and `UserTradingSession` models.

The system features:
- **Comprehensive Trade Information Display**: Shows full trade details (entry, take profits, stop loss, amounts) before execution and for active positions, with real-time ROE calculation and color-coded P&L indicators.
- **Complete Trade Management UI**: Full Edit/Execute/Delete functionality in the web app trading tab, with smart UI controls tailored for each tab.
- **Streamlined Core Trading Focus**: Removed market data tab and live charting functionality to focus on core trading bot capabilities. Trade execution continues to use live market prices through the existing `get_live_market_price` function.
- **Collapsible UI Enhancement**: Implemented collapsible/expandable functionality for both positions and trading tabs, improving user experience with dynamic display of trade details.
- **Multi-Symbol Trading Support**: Enhanced `get_live_market_price` function with a multi-source API fallback system, supporting 12+ cryptocurrency pairs and ensuring reliable live price data for trade execution.

## External Dependencies
- **Toobit Exchange API**: Custom `ExchangeClient` for Toobit futures API communication.
- **Telegram Bot API**: For webhook-based communication, rich messaging, and inline keyboard support.
- **Python Libraries**: Flask, Requests/aiohttp, Threading/Asyncio, Logging, Cryptography.
- **Chart.js**: For interactive data visualization and charting.
- **Binance API**: Used for real-time market data (prices, kline data).
- **CoinGecko API**: Utilized as a fallback for live market data.
- **CryptoCompare API**: Utilized as a fallback for live market data.