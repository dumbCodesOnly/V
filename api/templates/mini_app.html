<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Toobit Trading Mini-App</title>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Feather Icons -->
    <link href="https://cdn.jsdelivr.net/npm/feather-icons@4.29.0/dist/feather.css" rel="stylesheet">
    

    
    <style>
        :root {
            --tg-theme-bg-color: #000000;
            --tg-theme-text-color: #ffffff;
            --tg-theme-hint-color: #cccccc;
            --tg-theme-link-color: #87ceeb;
            --tg-theme-button-color: #4a90e2;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #1a1a1a;
            --tg-theme-accent-color: #5dade2;
            --tg-theme-card-bg: #2a2a2a;
            --tg-theme-border-color: #4a4a4a;
            --tg-theme-success: #5cb85c;
            --tg-theme-warning: #f0ad4e;
            --tg-theme-danger: #d9534f;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--tg-theme-bg-color) !important;
            color: var(--tg-theme-text-color) !important;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            -webkit-user-select: none;
            user-select: none;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Ensure all text elements use proper colors for dark mode */
        * {
            color: inherit;
        }

        .text-muted {
            color: var(--tg-theme-hint-color) !important;
        }

        .text-primary {
            color: var(--tg-theme-button-color) !important;
        }

        small {
            color: var(--tg-theme-hint-color) !important;
        }

        /* Dark mode card styling */
        .card {
            background: var(--tg-theme-secondary-bg-color) !important;
            border: 2px solid var(--tg-theme-border-color) !important;
            color: var(--tg-theme-text-color) !important;
        }

        .card-header {
            background: var(--tg-theme-secondary-bg-color) !important;
            border-bottom: 2px solid var(--tg-theme-border-color) !important;
            color: var(--tg-theme-text-color) !important;
        }

        .card-body {
            background: var(--tg-theme-secondary-bg-color) !important;
            color: var(--tg-theme-text-color) !important;
        }

        /* Alert styling for dark mode */
        .alert {
            background: var(--tg-theme-secondary-bg-color) !important;
            border: 2px solid var(--tg-theme-border-color) !important;
            color: var(--tg-theme-text-color) !important;
        }

        .alert-info {
            background: rgba(74, 144, 226, 0.1) !important;
            border-color: var(--tg-theme-button-color) !important;
            color: var(--tg-theme-text-color) !important;
        }

        /* Ensure list items are properly styled */
        ul, li {
            color: var(--tg-theme-text-color) !important;
        }

        .mini-app-container {
            max-width: 100vw;
            padding: 0;
            margin: 0;
        }

        .header {
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            padding: 1.25rem;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 2px solid var(--tg-theme-border-color);
        }

        .header h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .nav-tabs {
            background: var(--tg-theme-secondary-bg-color);
            border-bottom: 2px solid var(--tg-theme-border-color);
            padding: 0 1rem;
        }

        .nav-tabs .nav-link {
            color: var(--tg-theme-hint-color);
            border: none;
            padding: 1rem 1rem;
            font-size: 0.95rem;
            border-radius: 0;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-tabs .nav-link.active {
            color: var(--tg-theme-text-color);
            background: var(--tg-theme-card-bg);
            border-bottom: 3px solid var(--tg-theme-button-color);
            font-weight: 700;
        }

        .nav-tabs .nav-link:hover:not(.active) {
            color: var(--tg-theme-text-color);
            background: var(--tg-theme-card-bg);
        }

        .tab-content {
            padding: 1rem;
        }

        .trade-card {
            background: var(--tg-theme-card-bg);
            border: 2px solid var(--tg-theme-border-color);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .trade-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.5);
        }

        .collapsible-header {
            cursor: pointer;
            background: var(--tg-theme-card-bg);
            border: 2px solid var(--tg-theme-border-color);
            border-radius: 16px;
            padding: 1rem 1.5rem;
            margin-bottom: 0;
            transition: all 0.3s ease;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible-header:hover {
            border-color: var(--tg-theme-button-color);
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.2);
        }

        .collapsible-content {
            background: var(--tg-theme-card-bg);
            border: 2px solid var(--tg-theme-border-color);
            border-top: none;
            border-radius: 0 0 16px 16px;
            padding: 0 1.5rem;
            margin-bottom: 1.5rem;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .collapsible-content.expanded {
            max-height: 600px;
            padding: 1.5rem;
            border-top: 1px solid var(--tg-theme-border-color);
        }

        .collapsible-header.expanded {
            border-radius: 16px 16px 0 0;
            border-bottom: none;
        }

        .expand-icon {
            transition: transform 0.3s ease;
            font-size: 1.2rem;
            color: var(--tg-theme-button-color);
            font-weight: bold;
        }

        .expand-icon.expanded {
            transform: rotate(180deg);
        }

        .btn-primary {
            background: var(--tg-theme-button-color);
            border: 2px solid var(--tg-theme-button-color);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            font-weight: 700;
            width: 100%;
            margin-bottom: 0.75rem;
            color: var(--tg-theme-button-text-color);
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .btn-primary:hover {
            background: var(--tg-theme-accent-color);
            border-color: var(--tg-theme-accent-color);
            color: var(--tg-theme-button-text-color);
        }

        .btn-primary:active {
            transform: translateY(0px);
            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.4);
        }

        .btn-outline-primary {
            color: var(--tg-theme-text-color);
            border: 2px solid var(--tg-theme-button-color);
            background: var(--tg-theme-card-bg);
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .btn-outline-primary:hover {
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border-color: var(--tg-theme-button-color);
        }

        .btn-outline-danger {
            color: var(--tg-theme-danger);
            border: 2px solid var(--tg-theme-danger);
            background: rgba(244, 67, 54, 0.1);
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .btn-outline-danger:hover {
            background: var(--tg-theme-danger);
            color: white;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }

        .btn-outline-success {
            color: var(--tg-theme-success);
            border: 2px solid var(--tg-theme-success);
            background: rgba(76, 175, 80, 0.1);
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .btn-outline-success:hover {
            background: var(--tg-theme-success);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .btn-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.85rem;
            width: auto;
            margin: 0.25rem;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .form-control {
            background: var(--tg-theme-card-bg);
            border: 2px solid var(--tg-theme-border-color);
            color: var(--tg-theme-text-color);
            border-radius: 12px;
            padding: 1rem;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            background: var(--tg-theme-card-bg);
            border-color: var(--tg-theme-button-color);
            color: var(--tg-theme-text-color);
            box-shadow: 0 0 10px rgba(74, 144, 226, 0.6);
            outline: none;
        }

        .form-control::placeholder {
            color: var(--tg-theme-hint-color);
            opacity: 1;
        }

        .input-group-text {
            background: var(--tg-theme-card-bg);
            border: 2px solid var(--tg-theme-border-color);
            color: var(--tg-theme-text-color);
            font-weight: 700;
            border-radius: 12px 0 0 12px;
        }

        .form-select {
            background: var(--tg-theme-card-bg);
            border: 2px solid var(--tg-theme-border-color);
            color: var(--tg-theme-text-color);
            border-radius: 12px;
            padding: 1rem;
            font-weight: 600;
        }

        .form-select:focus {
            border-color: var(--tg-theme-button-color);
            box-shadow: 0 0 10px rgba(74, 144, 226, 0.6);
        }

        .form-select option {
            background: var(--tg-theme-card-bg);
            color: var(--tg-theme-text-color);
        }

        .form-label {
            color: var(--tg-theme-text-color);
            font-weight: 700;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .text-muted {
            color: var(--tg-theme-hint-color) !important;
            font-weight: 500;
        }

        .progress-indicator {
            font-family: monospace;
            font-size: 0.9rem;
            margin: 0.5rem 0;
            padding: 0.75rem;
            background: var(--tg-theme-card-bg);
            border: 2px solid var(--tg-theme-button-color);
            border-radius: 8px;
            color: var(--tg-theme-text-color);
            font-weight: 600;
        }

        .status-badge {
            padding: 0.35rem 0.7rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-active { 
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white; 
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }
        .status-configured { 
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white; 
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);
        }
        .status-pending { 
            background: linear-gradient(135deg, #2196f3, #1976d2);
            color: white; 
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
        }
        .status-stopped { 
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white; 
            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
        }

        .position-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .stat-box {
            text-align: center;
            padding: 1.75rem;
            background: linear-gradient(135deg, var(--tg-theme-card-bg), var(--tg-theme-secondary-bg-color));
            border: 2px solid var(--tg-theme-border-color);
            border-radius: 16px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            transition: transform 0.2s ease;
        }

        .stat-box:hover {
            transform: translateY(-3px);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--tg-theme-text-color);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--tg-theme-text-color);
            margin-top: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .trade-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.25rem;
            margin-top: 1rem;
        }

        .trade-controls .btn-sm {
            font-size: 0.75rem;
            padding: 0.375rem 0.5rem;
        }

        .hidden { display: none; }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--tg-theme-hint-color);
        }

        .modal {
            z-index: 2000;
        }

        .modal-content {
            background: var(--tg-theme-card-bg);
            color: var(--tg-theme-text-color);
            border: 2px solid var(--tg-theme-border-color);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
        }

        .modal-header {
            border-bottom: 2px solid var(--tg-theme-border-color);
            background: linear-gradient(135deg, var(--tg-theme-secondary-bg-color), var(--tg-theme-card-bg));
            border-radius: 20px 20px 0 0;
        }

        .modal-header .modal-title {
            color: var(--tg-theme-text-color);
            font-weight: 700;
            font-size: 1.25rem;
        }

        .modal-footer {
            border-top: 2px solid var(--tg-theme-border-color);
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 0 0 20px 20px;
        }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.8);
        }

        .btn-close {
            filter: invert(1) brightness(1.5);
            opacity: 0.8;
        }

        .btn-close:hover {
            opacity: 1;
        }

        .form-label {
            color: var(--tg-theme-text-color);
            font-weight: 600;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
        }

        .text-muted {
            color: var(--tg-theme-hint-color) !important;
        }

        .loading {
            color: var(--tg-theme-hint-color);
        }

        /* Enhanced Mobile Responsive Design */
        @media (max-width: 576px) {
            /* Optimized container padding for mobile */
            .mini-app-container {
                padding: 0;
                margin: 0;
                max-width: 100vw;
                overflow-x: hidden;
            }

            /* Reduce header padding on mobile */
            .header {
                padding: 1rem;
            }

            .header h1 {
                font-size: 1.3rem;
            }

            /* Mobile-optimized tab navigation */
            .nav-tabs {
                padding: 0 0.5rem;
                border-bottom: 1px solid var(--tg-theme-border-color);
            }

            .nav-tabs .nav-link {
                padding: 0.75rem 0.5rem;
                font-size: 0.85rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* Compact tab content padding */
            .tab-content {
                padding: 0.75rem;
            }

            /* Optimized card layout for mobile */
            .trade-card {
                padding: 1rem;
                margin-bottom: 1rem;
                border-radius: 12px;
            }

            .collapsible-header {
                padding: 0.75rem 1rem;
                border-radius: 12px;
            }

            .collapsible-content {
                border-radius: 0 0 12px 12px;
            }

            .collapsible-header.expanded {
                border-radius: 12px 12px 0 0;
            }

            .collapsible-content.expanded {
                padding: 1rem;
                max-height: 500px;
            }

            /* Mobile-friendly position summary grid */
            .position-summary {
                grid-template-columns: 1fr;
                gap: 0.75rem;
                margin-bottom: 1rem;
            }

            .stat-box {
                padding: 1.25rem;
                border-radius: 12px;
            }

            .stat-value {
                font-size: 1.3rem;
            }

            .stat-label {
                font-size: 0.8rem;
                margin-top: 0.5rem;
            }

            /* Enhanced button sizing for touch */
            .btn-primary {
                padding: 0.875rem 1.25rem;
                font-size: 0.95rem;
                border-radius: 10px;
                margin-bottom: 0.5rem;
                min-height: 48px; /* iOS minimum touch target */
            }

            .btn-sm {
                padding: 0.6rem 0.75rem;
                font-size: 0.8rem;
                min-height: 40px;
                margin: 0.125rem;
            }

            /* Mobile-optimized trade controls */
            .trade-controls {
                grid-template-columns: 1fr;
                gap: 0.5rem;
                margin-top: 0.75rem;
            }

            .trade-controls .btn-sm {
                width: 100%;
                font-size: 0.85rem;
                padding: 0.625rem 1rem;
                margin: 0.125rem 0;
            }

            /* Form controls optimized for mobile */
            .form-control {
                padding: 0.875rem;
                font-size: 16px; /* Prevents iOS zoom */
                border-radius: 10px;
            }

            .form-select {
                padding: 0.875rem;
                font-size: 16px;
                border-radius: 10px;
            }

            .input-group-text {
                padding: 0.875rem;
                font-size: 0.9rem;
                border-radius: 10px 0 0 10px;
            }

            /* Modal optimization for mobile */
            .modal-dialog {
                margin: 0.5rem;
                max-width: calc(100vw - 1rem);
            }

            .modal-content {
                border-radius: 16px;
            }

            .modal-header {
                padding: 1rem;
                border-radius: 16px 16px 0 0;
            }

            .modal-body {
                padding: 1rem;
            }

            .modal-footer {
                padding: 1rem;
                border-radius: 0 0 16px 16px;
            }

            /* Status badges mobile optimization */
            .status-badge {
                padding: 0.4rem 0.8rem;
                font-size: 0.7rem;
            }

            /* Progress indicator mobile sizing */
            .progress-indicator {
                padding: 0.625rem;
                font-size: 0.85rem;
                border-radius: 6px;
            }
        }

        /* Tablet and medium screens */
        @media (min-width: 577px) and (max-width: 768px) {
            .position-summary {
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
            }

            .trade-controls {
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem;
            }

            .nav-tabs .nav-link {
                padding: 0.875rem 1rem;
                font-size: 0.9rem;
            }

            .header h1 {
                font-size: 1.4rem;
            }
        }

        /* Large screens optimization */
        @media (min-width: 992px) {
            .position-summary {
                grid-template-columns: 1fr 1fr 1fr;
            }

            .trade-controls {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }

        /* Touch-friendly enhancements */
        @media (hover: none) and (pointer: coarse) {
            /* Enhanced touch targets */
            .btn, .nav-link, .collapsible-header {
                min-height: 44px;
                padding: 0.75rem 1rem;
            }

            /* Remove hover effects on touch devices */
            .btn:hover,
            .nav-link:hover,
            .collapsible-header:hover,
            .trade-card:hover,
            .stat-box:hover {
                transform: none;
                box-shadow: initial;
            }

            /* Enhanced tap feedback */
            .btn:active,
            .nav-link:active,
            .collapsible-header:active {
                transform: scale(0.98);
                opacity: 0.8;
                transition: all 0.1s ease;
            }
        }

        /* High DPI display optimization */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .text-primary,
            .stat-value,
            .form-label {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
        }

        /* Landscape orientation adjustments */
        @media (orientation: landscape) and (max-height: 500px) {
            .header {
                padding: 0.75rem;
            }

            .header h1 {
                font-size: 1.2rem;
            }

            .nav-tabs .nav-link {
                padding: 0.5rem 0.75rem;
            }

            .tab-content {
                padding: 0.5rem;
            }

            .trade-card {
                padding: 0.75rem;
                margin-bottom: 0.75rem;
            }
        }

        .text-center {
            color: var(--tg-theme-text-color);
        }

        small {
            color: var(--tg-theme-hint-color);
            font-weight: 500;
        }

        h1, h2, h3, h4, h5, h6 {
            color: var(--tg-theme-text-color);
            font-weight: 700;
        }

        /* Form input styling for dark mode */
        .form-control, .form-select {
            background: var(--tg-theme-card-bg) !important;
            border: 2px solid var(--tg-theme-border-color) !important;
            color: var(--tg-theme-text-color) !important;
        }

        .form-control:focus, .form-select:focus {
            background: var(--tg-theme-card-bg) !important;
            border-color: var(--tg-theme-button-color) !important;
            color: var(--tg-theme-text-color) !important;
            box-shadow: 0 0 10px rgba(74, 144, 226, 0.3) !important;
        }

        .form-control::placeholder {
            color: var(--tg-theme-hint-color) !important;
        }

        .form-label {
            color: var(--tg-theme-text-color) !important;
        }

        .list-group-item {
            background: var(--tg-theme-secondary-bg-color, #1a2332);
            border: 1px solid var(--tg-theme-border-color, #3a4a5c);
            color: var(--tg-theme-text-color, #e8eaed);
        }

        .badge {
            font-weight: 600;
            padding: 0.5rem 0.75rem;
        }

        .bg-success {
            background: linear-gradient(135deg, #28a745, #20c997) !important;
            color: white !important;
        }

        .bg-warning {
            background: linear-gradient(135deg, #ffc107, #fd7e14) !important;
            color: #212529 !important;
        }

        .bg-danger {
            background: linear-gradient(135deg, #dc3545, #e83e8c) !important;
            color: white !important;
        }

        .border-success {
            border-color: #28a745 !important;
        }

        .border-warning {
            border-color: #ffc107 !important;
        }

        .border-danger {
            border-color: #dc3545 !important;
        }



        .two-column-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="mini-app-container">
        <!-- Header -->
        <div class="header">
            <h5 class="mb-0">🚀 Toobit Trading Bot</h5>
            <small id="user-info">Loading...</small>
        </div>

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs justify-content-center" id="main-tabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="positions-tab" data-bs-toggle="tab" data-bs-target="#positions" type="button">
                    📊 Positions
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="trading-tab" data-bs-toggle="tab" data-bs-target="#trading" type="button">
                    🎯 Trading
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="portfolio-tab" data-bs-toggle="tab" data-bs-target="#portfolio" type="button">
                    💼 Portfolio
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="credentials-tab" data-bs-toggle="tab" data-bs-target="#credentials" type="button">
                    🔑 API Keys
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="main-tab-content">
            <!-- Positions Tab -->
            <div class="tab-pane fade show active" id="positions" role="tabpanel">
                <div class="position-summary">
                    <div class="stat-box">
                        <div class="stat-value" id="total-positions">0</div>
                        <div class="stat-label">Active Positions</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="total-pnl">$0.00</div>
                        <div class="stat-label">Total P&L</div>
                    </div>
                </div>
                
                <div id="positions-list">
                    <div class="loading">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        Loading positions...
                    </div>
                </div>
            </div>

            <!-- Trading Tab -->
            <div class="tab-pane fade" id="trading" role="tabpanel">
                <div class="mb-3">
                    <button class="btn btn-primary" onclick="createNewTrade()">
                        ➕ New Trade
                    </button>
                </div>
                
                <div id="trade-configs-list">
                    <div class="loading">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        Loading trade configurations...
                    </div>
                </div>
            </div>

            <!-- Portfolio Tab -->
            <div class="tab-pane fade" id="portfolio" role="tabpanel">
                <div class="position-summary">
                    <div class="stat-box">
                        <div class="stat-value" id="account-balance">$0.00</div>
                        <div class="stat-label">Account Balance</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="margin-used">$0.00</div>
                        <div class="stat-label">Margin Used</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="free-margin">$0.00</div>
                        <div class="stat-label">Free Margin</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="margin-ratio">0%</div>
                        <div class="stat-label">Margin Ratio</div>
                    </div>
                </div>
                
                <!-- P&L Summary Row -->
                <div class="position-summary">
                    <div class="stat-box">
                        <div class="stat-value" id="realized-pnl">$0.00</div>
                        <div class="stat-label">Realized P&L</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="total-pnl-portfolio">$0.00</div>
                        <div class="stat-label">Total P&L</div>
                    </div>
                </div>
                
                <div id="portfolio-details">
                    <div class="loading">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        Loading portfolio data...
                    </div>
                </div>
            </div>

            <!-- Credentials Tab -->
            <div class="tab-pane fade" id="credentials" role="tabpanel">
                <div class="mb-3">
                    <h6 class="text-primary">🔑 API Credentials Management</h6>
                    <p class="text-muted">Manage your exchange API credentials for live trading</p>
                </div>
                
                <div id="credentials-status" class="mb-4">
                    <div class="loading">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        Loading credentials status...
                    </div>
                </div>

                <div id="credentials-setup" class="hidden">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Add API Credentials</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Exchange</label>
                                <select class="form-control" id="exchange-select">
                                    <option value="toobit">Toobit</option>
                                    <option value="binance">Binance</option>
                                    <option value="okx">OKX</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">API Key</label>
                                <input type="text" class="form-control" id="api-key-input" placeholder="Enter your API key">
                                <small class="text-muted">Your API key will be encrypted and stored securely</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">API Secret</label>
                                <input type="password" class="form-control" id="api-secret-input" placeholder="Enter your API secret">
                                <small class="text-muted">Your secret will be encrypted and stored securely</small>
                            </div>
                            <div class="mb-3" id="passphrase-group" style="display: none;">
                                <label class="form-label">Passphrase (if required)</label>
                                <input type="password" class="form-control" id="passphrase-input" placeholder="Enter passphrase if required">
                            </div>
                            <div class="two-column-grid">
                                <button class="btn btn-outline-secondary" onclick="cancelCredentialsSetup()">Cancel</button>
                                <button class="btn btn-primary" onclick="saveCredentials()">Save Credentials</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <div class="alert alert-info">
                        <strong>🔐 Security Information:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Your API credentials are encrypted using military-grade encryption</li>
                            <li>Only trading permissions are required - never share withdrawal access</li>
                            <li>All credentials are stored securely and never shared</li>
                            <li>You can delete your credentials at any time</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trade Configuration Modal -->
    <div class="modal fade" id="tradeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title" id="tradeModalTitle">Configure Trade</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="trade-progress" class="progress-indicator mb-3"></div>
                    
                    <!-- Symbol Selection -->
                    <div id="symbol-step" class="config-step">
                        <label class="form-label">Trading Pair</label>
                        <select class="form-control" id="trade-symbol-select">
                            <option value="">Select Symbol</option>
                            <option value="BTCUSDT">BTC/USDT</option>
                            <option value="ETHUSDT">ETH/USDT</option>
                            <option value="BNBUSDT">BNB/USDT</option>
                            <option value="ADAUSDT">ADA/USDT</option>
                            <option value="SOLUSDT">SOL/USDT</option>
                            <option value="XRPUSDT">XRP/USDT</option>
                            <option value="DOTUSDT">DOT/USDT</option>
                            <option value="DOGEUSDT">DOGE/USDT</option>
                            <option value="LINKUSDT">LINK/USDT</option>
                            <option value="LTCUSDT">LTC/USDT</option>
                            <option value="MATICUSDT">MATIC/USDT</option>
                            <option value="AVAXUSDT">AVAX/USDT</option>
                            <option value="UNIUSDT">UNI/USDT</option>
                        </select>
                    </div>

                    <!-- Side Selection -->
                    <div id="side-step" class="config-step hidden">
                        <label class="form-label">Position Side</label>
                        <div class="two-column-grid">
                            <button class="btn btn-outline-primary" onclick="setTradeSide('long')">
                                📈 Long
                            </button>
                            <button class="btn btn-outline-primary" onclick="setTradeSide('short')">
                                📉 Short
                            </button>
                        </div>
                    </div>

                    <!-- Amount & Leverage -->
                    <div id="amount-step" class="config-step hidden">
                        <label class="form-label">Margin</label>
                        <div class="input-group mb-2">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="amount-input" placeholder="Enter amount" step="0.01">
                        </div>
                        <label class="form-label">Leverage</label>
                        <select class="form-control" id="leverage-select">
                            <option value="1">1x</option>
                            <option value="2">2x</option>
                            <option value="5">5x</option>
                            <option value="10" selected>10x</option>
                            <option value="20">20x</option>
                            <option value="50">50x</option>
                            <option value="100">100x</option>
                        </select>
                    </div>

                    <!-- Entry Configuration -->
                    <div id="entry-step" class="config-step hidden">
                        <label class="form-label">Entry Type</label>
                        <div class="two-column-grid mb-2">
                            <button class="btn btn-outline-primary" onclick="setEntryType('market')">
                                🎯 Market
                            </button>
                            <button class="btn btn-outline-primary" onclick="setEntryType('limit')">
                                📍 Limit
                            </button>
                        </div>
                        <div id="limit-price-input" class="hidden">
                            <label class="form-label">Limit Price</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="entry-price" placeholder="Entry price" step="0.0001">
                            </div>
                        </div>
                    </div>

                    <!-- Take Profits -->
                    <div id="tp-step" class="config-step hidden">
                        <label class="form-label">Take Profit Levels</label>
                        <div id="tp-levels">
                            <div class="input-group mb-2">
                                <span class="input-group-text">TP1 %</span>
                                <input type="number" class="form-control tp-percent" data-level="1" placeholder="5" step="0.1">
                                <span class="input-group-text">Size %</span>
                                <input type="number" class="form-control tp-allocation" data-level="1" placeholder="30" step="1">
                            </div>
                        </div>
                        <button class="btn btn-outline-primary btn-sm" onclick="addTpLevel()">+ Add TP Level</button>
                    </div>

                    <!-- Stop Loss -->
                    <div id="sl-step" class="config-step hidden">
                        <label class="form-label">Stop Loss</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="stop-loss" placeholder="2" step="0.1">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>

                    <!-- Breakeven Settings -->
                    <div id="breakeven-step" class="config-step hidden">
                        <label class="form-label">Break-even Settings</label>
                        <select class="form-control" id="breakeven-select">
                            <option value="disabled">Disabled</option>
                            <option value="tp1">After TP1</option>
                            <option value="tp2">After TP2</option>
                            <option value="tp3">After TP3</option>
                        </select>
                        <small class="text-muted">Move stop loss to break-even after take profit levels</small>
                    </div>

                    <!-- Trailing Stop Settings -->
                    <div id="trailing-step" class="config-step hidden">
                        <label class="form-label">Trailing Stop</label>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="trailing-enabled" onchange="toggleTrailingStop()">
                            <label class="form-check-label" for="trailing-enabled">
                                Enable Trailing Stop
                            </label>
                        </div>
                        <div id="trailing-options" class="hidden">
                            <div class="mb-3">
                                <label class="form-label">Trail Percentage</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="trail-percentage" placeholder="2" step="0.1" min="0.1">
                                    <span class="input-group-text">%</span>
                                </div>
                                <small class="text-muted">Percentage to trail behind best price</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Activation Price (Optional)</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="trail-activation" placeholder="45500" step="0.01">
                                </div>
                                <small class="text-muted">Price at which trailing stop activates</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" onclick="previousStep()">← Back</button>
                    <button type="button" class="btn btn-primary" onclick="nextStep()">Next →</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Telegram Web App integration
        let tg = window.Telegram.WebApp;
        let currentUser = null;
        let currentTrade = null;
        let configStep = 0;
        const configSteps = ['symbol', 'side', 'amount', 'entry', 'tp', 'sl', 'breakeven', 'trailing'];
        
        // Initialize Telegram Web App with enhanced compatibility
        if (typeof tg !== 'undefined' && tg.ready) {
            tg.ready();
            tg.expand();
            
            // Check if showPopup is available (Telegram WebApp v6.1+)
            if (!tg.showPopup) {
                tg.showPopup = function(params) {
                    // Fallback to showAlert for older versions
                    if (tg.showAlert) {
                        tg.showAlert(params.message || 'Notification');
                    } else {
                        alert(params.message || 'Notification');
                    }
                };
            }
        } else {
            // Fallback for testing outside Telegram with dark theme
            tg = {
                backgroundColor: '#1a2332',
                textColor: '#e8eaed',
                buttonColor: '#2196f3',
                showAlert: function(message) { 
                    console.log('TG Alert:', message);
                    alert(message); 
                },
                showPopup: function(params) {
                    console.log('TG Popup:', params);
                    alert(params.message || 'Notification');
                },
                MainButton: {
                    setText: function() {},
                    show: function() {},
                    hide: function() {}
                }
            };
        }
        
        // Set up theme - Force high contrast colors for dark mode
        document.body.style.backgroundColor = '#000000';
        document.documentElement.style.setProperty('--tg-theme-bg-color', '#000000');
        document.documentElement.style.setProperty('--tg-theme-text-color', '#ffffff');
        document.documentElement.style.setProperty('--tg-theme-button-color', '#4a90e2');
        
        // Get user info
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            currentUser = tg.initDataUnsafe.user;
            document.getElementById('user-info').textContent = `Hi, ${currentUser.first_name}!`;
        } else {
            // Fallback for testing outside Telegram
            currentUser = { id: 123456789, first_name: 'Demo User' };
            document.getElementById('user-info').textContent = `Hi, ${currentUser.first_name}! (Demo Mode)`;
        }

        // Main button integration
        tg.MainButton.setText("Execute Trade");
        tg.MainButton.hide();

        // API Functions
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(endpoint, {
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Telegram-User-ID': currentUser?.id || 'anonymous'
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                // Use fallback alert instead of tg.showAlert for compatibility
                if (typeof tg !== 'undefined' && tg.showAlert) {
                    tg.showAlert(`Error: ${error.message}`);
                } else {
                    console.error(`Error: ${error.message}`);
                }
                return null;
            }
        }

        // Toggle position collapse/expand
        function togglePosition(index) {
            const content = document.getElementById(`content-${index}`);
            const icon = document.getElementById(`icon-${index}`);
            const header = content.previousElementSibling;
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                header.classList.remove('expanded');
                icon.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                header.classList.add('expanded');
                icon.classList.add('expanded');
            }
        }

        // Toggle trade configuration collapse/expand
        function toggleTrade(index) {
            const content = document.getElementById(`trade-content-${index}`);
            const icon = document.getElementById(`trade-icon-${index}`);
            const header = content.previousElementSibling;
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                header.classList.remove('expanded');
                icon.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
                header.classList.add('expanded');
                icon.classList.add('expanded');
            }
        }
        
        // Toggle history section collapse/expand
        function toggleHistorySection() {
            const content = document.getElementById('history-content');
            const icon = document.getElementById('history-icon');
            
            if (content.style.display === 'none' || content.style.display === '') {
                content.style.display = 'block';
                icon.textContent = '▲';
            } else {
                content.style.display = 'none';
                icon.textContent = '▼';
            }
        }

        // Load data functions
        async function loadPositions() {
            const data = await apiCall(`/api/user-trades?user_id=${currentUser?.id}`);
            if (!data) return;
            
            const container = document.getElementById('positions-list');
            const activePositions = data.trades?.filter(t => t.status === 'active' || t.status === 'pending') || [];
            const closedPositions = data.trades?.filter(t => t.status === 'stopped') || [];
            
            document.getElementById('total-positions').textContent = activePositions.length;
            
            let totalPnl = 0;
            activePositions.forEach(pos => totalPnl += pos.unrealized_pnl || 0);
            document.getElementById('total-pnl').textContent = `$${totalPnl.toFixed(2)}`;
            document.getElementById('total-pnl').style.color = totalPnl >= 0 ? '#28a745' : '#dc3545';
            
            let content = '';
            
            // Active Positions Section
            if (activePositions.length === 0) {
                content += '<div class="text-center py-4"><small class="text-muted">No active or pending positions</small></div>';
            } else {
            
            content += activePositions.map((pos, index) => `
                <div class="position-item">
                    <div class="collapsible-header" onclick="togglePosition(${index})">
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <div>
                                <strong>${pos.symbol}</strong>
                                <span class="status-badge status-${pos.status} ms-2">${pos.side.toUpperCase()}</span>
                                ${pos.status === 'pending' ? '<small class="text-info ms-1">(PENDING)</small>' : ''}
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="text-end me-3">
                                    <div class="stat-value" style="color: ${pos.unrealized_pnl >= 0 ? '#28a745' : '#dc3545'}">
                                        $${(pos.unrealized_pnl || 0).toFixed(2)}
                                    </div>
                                    <small class="text-muted">P&L</small>
                                </div>
                                <span class="expand-icon" id="icon-${index}">▼</span>
                            </div>
                        </div>
                    </div>
                    <div class="collapsible-content" id="content-${index}">
                    
                    <!-- Position Details -->
                    <div class="row mt-2">
                        <div class="col-4">
                            <small class="text-muted">Position Size:</small><br>
                            <strong>$${pos.position_size || (pos.amount * pos.leverage) || '0'}</strong>
                            <br><small class="text-muted">Margin: $${pos.amount || '0'}</small>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Leverage:</small><br>
                            <strong>${pos.leverage}x</strong>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Entry:</small><br>
                            <strong>$${pos.entry_price || 'Market'}</strong>
                        </div>
                    </div>
                    
                    <!-- Current Price & ROE -->
                    ${pos.current_price ? `
                    <div class="row mt-2">
                        <div class="col-6">
                            <small class="text-muted">Current Price:</small><br>
                            <strong>$${pos.current_price}</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">ROE:</small><br>
                            <strong style="color: ${calculateROE(pos) >= 0 ? '#28a745' : '#dc3545'}">
                                ${calculateROE(pos).toFixed(2)}%
                            </strong>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Take Profit & Stop Loss with Prices and P&L -->
                    <div class="mt-2">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Take Profits:</small><br>
                                <div style="font-size: 0.85rem;">
                                    ${pos.tp_sl_calculations && pos.tp_sl_calculations.take_profits && pos.tp_sl_calculations.take_profits.length > 0 ? 
                                        pos.tp_sl_calculations.take_profits.map(tp => 
                                            `<div><strong>TP${tp.level}:</strong> $${tp.price.toFixed(4)} <span style="color: #28a745;">(+$${tp.profit_amount.toFixed(2)})</span></div>`
                                        ).join('') : 
                                        '<strong>Not set</strong>'}
                                </div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Stop Loss:</small><br>
                                <div style="font-size: 0.85rem;">
                                    ${pos.tp_sl_calculations && pos.tp_sl_calculations.stop_loss && pos.tp_sl_calculations.stop_loss.price ? 
                                        `<div><strong>SL:</strong> $${pos.tp_sl_calculations.stop_loss.price.toFixed(4)} <span style="color: #dc3545;">(-$${pos.tp_sl_calculations.stop_loss.loss_amount.toFixed(2)})</span></div>` : 
                                        '<strong>Not set</strong>'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Margin Info -->
                    <div class="row mt-2">
                        <div class="col-6">
                            <small class="text-muted">Margin Used:</small><br>
                            <strong>$${(pos.position_margin || 0).toFixed(2)}</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Status:</small><br>
                            <strong class="text-${pos.status === 'active' ? 'success' : pos.status === 'pending' ? 'warning' : 'danger'}">
                                ${pos.status.toUpperCase()}
                            </strong>
                        </div>
                    </div>
                    
                    <div class="trade-controls mt-2" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <button class="btn btn-outline-primary btn-sm" onclick="editTrade('${pos.trade_id}')">
                            ✏️ Edit
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="closeTrade('${pos.trade_id}')">
                            ❌ Close
                        </button>
                    </div>
                    </div>
                </div>
            `).join('');
            }
            

            
            container.innerHTML = content;
        }

        async function loadTradeConfigs() {
            const data = await apiCall(`/api/user-trades?user_id=${currentUser?.id}`);
            if (!data) return;
            
            const container = document.getElementById('trade-configs-list');
            const trades = data.trades || [];
            
            if (trades.length === 0) {
                container.innerHTML = '<div class="text-center py-4"><small class="text-muted">No trade configurations</small></div>';
                return;
            }
            
            container.innerHTML = trades.map((trade, index) => `
                <div class="position-item">
                    <div class="collapsible-header" onclick="toggleTrade(${index})">
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <div>
                                <strong>${trade.name}</strong>
                                <span class="status-badge status-${trade.status} ms-2">${trade.status}</span>
                            </div>
                            <div class="d-flex align-items-center">
                                ${trade.status === 'active' && trade.unrealized_pnl !== undefined ? 
                                    `<div class="text-end me-3">
                                        <div class="stat-value" style="color: ${trade.unrealized_pnl >= 0 ? '#28a745' : '#dc3545'}">
                                            $${trade.unrealized_pnl.toFixed(2)}
                                        </div>
                                        <small class="text-muted">P&L</small>
                                    </div>` : 
                                    `<div class="text-end me-3">
                                        <div class="stat-value" style="color: var(--tg-theme-text-color)">
                                            ${trade.symbol || 'No Symbol'}
                                        </div>
                                        <small class="text-muted">Symbol</small>
                                    </div>`
                                }
                                <span class="expand-icon" id="trade-icon-${index}">▼</span>
                            </div>
                        </div>
                    </div>
                    <div class="collapsible-content" id="trade-content-${index}">
                    <div class="progress-indicator">
                        ${getTradeProgress(trade)}
                    </div>
                    
                    <!-- Basic Trade Info -->
                    <div class="row mt-2">
                        <div class="col-6">
                            <small class="text-muted">Symbol:</small><br>
                            <strong>${trade.symbol || 'Not set'}</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Side:</small><br>
                            <strong>${trade.side ? trade.side.toUpperCase() : 'Not set'}</strong>
                        </div>
                    </div>
                    
                    ${trade.status === 'active' ? `
                    <!-- Active Trade Details -->
                    <div class="row mt-2">
                        <div class="col-4">
                            <small class="text-muted">Position Size:</small><br>
                            <strong>$${trade.position_size || (trade.amount * trade.leverage) || '0'}</strong>
                            <br><small class="text-muted">Margin: $${trade.amount || '0'}</small>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Leverage:</small><br>
                            <strong>${trade.leverage || '1'}x</strong>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Entry:</small><br>
                            <strong>$${trade.entry_price || 'Market'}</strong>
                        </div>
                    </div>
                    
                    <!-- Take Profit & Stop Loss with Prices and P&L -->
                    <div class="mt-2">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Take Profits:</small><br>
                                <div style="font-size: 0.85rem;">
                                    ${trade.tp_sl_calculations && trade.tp_sl_calculations.take_profits && trade.tp_sl_calculations.take_profits.length > 0 ? 
                                        trade.tp_sl_calculations.take_profits.map(tp => 
                                            `<div><strong>TP${tp.level}:</strong> $${tp.price.toFixed(4)} <span style="color: #28a745;">(+$${tp.profit_amount.toFixed(2)})</span></div>`
                                        ).join('') : 
                                        '<strong>Not set</strong>'}
                                </div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Stop Loss:</small><br>
                                <div style="font-size: 0.85rem;">
                                    ${trade.tp_sl_calculations && trade.tp_sl_calculations.stop_loss && trade.tp_sl_calculations.stop_loss.price ? 
                                        `<div><strong>SL:</strong> $${trade.tp_sl_calculations.stop_loss.price.toFixed(4)} <span style="color: #dc3545;">(-$${trade.tp_sl_calculations.stop_loss.loss_amount.toFixed(2)})</span></div>` : 
                                        '<strong>Not set</strong>'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${trade.current_price ? `
                    <div class="row mt-2">
                        <div class="col-6">
                            <small class="text-muted">Current Price:</small><br>
                            <strong>$${trade.current_price}</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">ROE:</small><br>
                            <strong style="color: ${calculateROE(trade) >= 0 ? '#28a745' : '#dc3545'}">
                                ${calculateROE(trade).toFixed(2)}%
                            </strong>
                        </div>
                    </div>
                    ` : ''}
                    ` : `
                    <!-- Configuration Details for Non-Active Trades -->
                    <div class="row mt-2">
                        <div class="col-4">
                            <small class="text-muted">Position Size:</small><br>
                            <strong>${trade.position_size ? '$' + trade.position_size : trade.amount && trade.leverage ? '$' + (trade.amount * trade.leverage) : 'Not set'}</strong>
                            ${trade.amount ? '<br><small class="text-muted">Margin: $' + trade.amount + '</small>' : ''}
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Leverage:</small><br>
                            <strong>${trade.leverage ? trade.leverage + 'x' : 'Not set'}</strong>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Entry:</small><br>
                            <strong>${trade.entry_price ? '$' + trade.entry_price : trade.entry_type === 'market' ? 'Market' : 'Not set'}</strong>
                        </div>
                    </div>
                    
                    <!-- Take Profit & Stop Loss for Configured Trades with Prices and P&L -->
                    <div class="mt-2">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Take Profits:</small><br>
                                <div style="font-size: 0.85rem;">
                                    ${trade.tp_sl_calculations && trade.tp_sl_calculations.take_profits && trade.tp_sl_calculations.take_profits.length > 0 ? 
                                        trade.tp_sl_calculations.take_profits.map(tp => 
                                            `<div><strong>TP${tp.level}:</strong> $${tp.price.toFixed(4)} <span style="color: #28a745;">(+$${tp.profit_amount.toFixed(2)})</span></div>`
                                        ).join('') : 
                                        trade.take_profits && trade.take_profits.length > 0 ? 
                                            trade.take_profits.map((tp, idx) => `<div><strong>TP${idx+1}:</strong> ${tp.percentage || tp}%</div>`).join('') :
                                        '<strong>Not set</strong>'}
                                </div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Stop Loss:</small><br>
                                <div style="font-size: 0.85rem;">
                                    ${trade.tp_sl_calculations && trade.tp_sl_calculations.stop_loss && trade.tp_sl_calculations.stop_loss.price ? 
                                        `<div><strong>SL:</strong> $${trade.tp_sl_calculations.stop_loss.price.toFixed(4)} <span style="color: #dc3545;">(-$${trade.tp_sl_calculations.stop_loss.loss_amount.toFixed(2)})</span></div>` : 
                                        trade.stop_loss_percent ? 
                                            `<div><strong>SL:</strong> ${trade.stop_loss_percent}%</div>` :
                                        '<strong>Not set</strong>'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configuration Status -->
                    <div class="row mt-2">
                        <div class="col-6">
                            <small class="text-muted">Entry Type:</small><br>
                            <strong>${trade.entry_type ? trade.entry_type.toUpperCase() : 'Not set'}</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Status:</small><br>
                            <strong class="text-${trade.status === 'configured' ? 'warning' : trade.status === 'active' ? 'success' : 'secondary'}">
                                ${trade.status ? trade.status.toUpperCase() : 'DRAFT'}
                            </strong>
                        </div>
                    </div>
                    `}
                    
                    <div class="trade-controls mt-2" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.25rem;">
                        <button class="btn btn-outline-primary btn-sm" onclick="editTradeConfig('${trade.trade_id}')">
                            ✏️ Edit
                        </button>
                        ${trade.symbol && trade.side && trade.amount && 
                          ((trade.entry_type === 'market') || (trade.entry_type === 'limit' && trade.entry_price)) &&
                          trade.take_profits && trade.take_profits.length > 0 && trade.stop_loss_percent ?
                          `<button class="btn btn-success btn-sm" onclick="executeTrade('${trade.trade_id}')">
                            🚀 Execute
                          </button>` :
                          `<button class="btn btn-outline-secondary btn-sm" disabled title="Complete configuration first">
                            🚀 Execute
                          </button>`
                        }
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteTrade('${trade.trade_id}')">
                            🗑️ Delete
                        </button>
                    </div>
                    </div>
                </div>
            `).join('');
        }

        async function loadPortfolio() {
            const data = await apiCall(`/api/margin-data?user_id=${currentUser?.id || '123456789'}`);
            const tradesData = await apiCall(`/api/user-trades?user_id=${currentUser?.id}`);
            if (!data) return;
            
            const summary = data.summary || {};
            
            document.getElementById('account-balance').textContent = `$${summary.account_balance?.toFixed(2) || '0.00'}`;
            document.getElementById('margin-used').textContent = `$${summary.total_margin_used?.toFixed(2) || '0.00'}`;
            document.getElementById('free-margin').textContent = `$${summary.free_margin?.toFixed(2) || '0.00'}`;
            document.getElementById('margin-ratio').textContent = `${summary.margin_utilization?.toFixed(1) || '0'}%`;
            
            // Update total P&L if elements exist
            const realizedPnlElement = document.getElementById('realized-pnl');
            const totalPnlElement = document.getElementById('total-pnl');
            if (realizedPnlElement) {
                realizedPnlElement.textContent = `$${(summary.realized_pnl || 0).toFixed(2)}`;
                realizedPnlElement.style.color = (summary.realized_pnl || 0) >= 0 ? '#28a745' : '#dc3545';
            }
            if (totalPnlElement) {
                totalPnlElement.textContent = `$${(summary.total_pnl || 0).toFixed(2)}`;
                totalPnlElement.style.color = (summary.total_pnl || 0) >= 0 ? '#28a745' : '#dc3545';
            }
            
            // Also update portfolio-specific total P&L element
            const portfolioTotalPnlElement = document.getElementById('total-pnl-portfolio');
            if (portfolioTotalPnlElement) {
                portfolioTotalPnlElement.textContent = `$${(summary.total_pnl || 0).toFixed(2)}`;
                portfolioTotalPnlElement.style.color = (summary.total_pnl || 0) >= 0 ? '#28a745' : '#dc3545';
            }
            
            const container = document.getElementById('portfolio-details');
            const positions = data.positions || [];
            const allTrades = tradesData?.trades || [];
            const activePositions = allTrades.filter(t => t.status === 'active' || t.status === 'pending');
            const closedPositions = allTrades.filter(t => t.status === 'stopped');
            
            let content = '';
            
            // Active Positions Section
            if (activePositions.length > 0) {
                content += `<h6 class="mb-3">Active Positions</h6>`;
                content += activePositions.map(pos => `
                    <div class="trade-card">
                        <div class="d-flex justify-content-between mb-2">
                            <strong>${pos.symbol}</strong>
                            <span class="status-badge status-${pos.status}">${pos.side.toUpperCase()}</span>
                            ${pos.status === 'pending' ? '<small class="text-info ms-1">(PENDING)</small>' : ''}
                        </div>
                        <div class="row">
                            <div class="col-4">
                                <small class="text-muted">Size</small><br>
                                <strong>$${pos.position_size || (pos.amount * pos.leverage) || '0'}</strong>
                                <br><small class="text-muted">Margin: $${pos.amount || '0'}</small>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Entry</small><br>
                                <strong>$${pos.entry_price || 'Market'}</strong>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">P&L</small><br>
                                <strong style="color: ${(pos.unrealized_pnl || 0) >= 0 ? '#28a745' : '#dc3545'}">
                                    $${(pos.unrealized_pnl || 0).toFixed(2)}
                                </strong>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                content += '<div class="text-center py-4"><small class="text-muted">No active positions</small></div>';
            }
            
            // Closed Positions History Section - Collapsible
            content += `<div class="mt-4">
                <div class="collapsible-header" onclick="toggleHistorySection()" style="cursor: pointer; padding: 0.75rem; background: rgba(108, 117, 125, 0.1); border-radius: 8px; margin-bottom: 1rem;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0 text-muted">📚 Closed Positions History</h6>
                            <small class="text-muted">${closedPositions.length} closed position${closedPositions.length !== 1 ? 's' : ''}</small>
                        </div>
                        <span class="expand-icon" id="history-icon">▼</span>
                    </div>
                </div>
                <div class="collapsible-content" id="history-content" style="display: none;">
            `;
            
            if (closedPositions.length > 0) {
                content += closedPositions.slice(-10).reverse().map(pos => `
                    <div class="trade-card" style="opacity: 0.8; border-left: 3px solid #6c757d;">
                        <div class="d-flex justify-content-between mb-2">
                            <div>
                                <strong>${pos.symbol}</strong>
                                <span class="status-badge status-stopped ms-2">${pos.side.toUpperCase()}</span>
                                <small class="text-muted ms-2">CLOSED</small>
                            </div>
                            <div class="text-end">
                                <strong style="color: ${(pos.final_pnl || 0) >= 0 ? '#28a745' : '#dc3545'}">
                                    $${(pos.final_pnl || 0).toFixed(2)}
                                </strong>
                                <br><small class="text-muted">Final P&L</small>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-4">
                                <small class="text-muted">Size</small><br>
                                <strong>$${pos.position_size || (pos.amount * pos.leverage) || '0'}</strong>
                                <br><small class="text-muted">Margin: $${pos.amount || '0'}</small>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Entry</small><br>
                                <strong>$${pos.entry_price || 'Market'}</strong>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Leverage</small><br>
                                <strong>${pos.leverage || '1'}x</strong>
                            </div>
                        </div>
                        ${pos.closed_at ? `
                        <div class="mt-2">
                            <small class="text-muted">Closed: ${new Date(pos.closed_at).toLocaleString()}</small>
                        </div>
                        ` : ''}
                    </div>
                `).join('');
                
                if (closedPositions.length > 10) {
                    content += `<div class="text-center py-2">
                        <small class="text-muted">... and ${closedPositions.length - 10} more closed positions</small>
                    </div>`;
                }
            } else {
                content += `<div class="text-center py-4"><small class="text-muted">No closed positions yet</small></div>`;
            }
            
            content += `</div></div>`; // Close collapsible content and container
            
            container.innerHTML = content;
        }

        // Trade configuration functions
        function createNewTrade() {
            currentTrade = {
                trade_id: 'new_' + Date.now(),
                name: 'New Trade',
                symbol: '',
                side: '',
                amount: '',
                leverage: 10,
                entry_type: '',
                entry_price: '',
                take_profits: [],
                stop_loss_percent: '',
                breakeven_after: 'disabled',
                trailing_stop_enabled: false,
                trail_percentage: '',
                trail_activation_price: ''
            };
            configStep = 0;
            showTradeModal();
        }

        async function editTrade(tradeId) {
            const data = await apiCall(`/api/trade-config?trade_id=${tradeId}`);
            if (data) {
                currentTrade = data;
                configStep = 0;
                showTradeModal();
            }
        }

        async function closeTrade(tradeId) {
            if (!confirm('Are you sure you want to close this position?')) return;
            
            const result = await apiCall('/api/close-trade', {
                method: 'POST',
                body: JSON.stringify({
                    user_id: currentUser?.id,
                    trade_id: tradeId
                })
            });
            
            if (result && result.success) {
                tg.showAlert(`Position closed successfully! P&L: $${result.final_pnl?.toFixed(2) || '0.00'}`);
                loadPositions();
                loadPortfolio();
            }
        }

        async function deleteTrade(tradeId) {
            if (!confirm('Are you sure you want to permanently delete this trade configuration?')) return;
            
            const result = await apiCall('/api/delete-trade', {
                method: 'POST',
                body: JSON.stringify({
                    user_id: currentUser?.id,
                    trade_id: tradeId
                })
            });
            
            if (result && result.success) {
                tg.showAlert('Trade configuration deleted successfully!');
                loadTradeConfigs();
                loadPositions();
                loadPortfolio();
            }
        }

        async function selectTrade(tradeId) {
            const data = await apiCall(`/api/trade-config?trade_id=${tradeId}`);
            if (!data) return;
            
            // Check if trade is complete
            const isComplete = data.symbol && data.side && data.amount && 
                              (data.entry_type === 'market' || (data.entry_type === 'limit' && data.entry_price)) &&
                              data.take_profits?.length > 0 && data.stop_loss_percent;
            
            if (isComplete && data.status === 'configured') {
                // Ask user if they want to execute the trade
                if (confirm(`Execute trade for ${data.symbol} ${data.side.toUpperCase()}?`)) {
                    await executeTrade(tradeId);
                }
            } else {
                // Open for editing
                currentTrade = data;
                configStep = 0;
                showTradeModal();
            }
        }

        async function editTradeConfig(tradeId) {
            const data = await apiCall(`/api/trade-config?trade_id=${tradeId}`);
            if (data) {
                currentTrade = data;
                configStep = 0;
                showTradeModal();
            }
        }

        async function executeTrade(tradeId) {
            const result = await apiCall('/api/execute-trade', {
                method: 'POST',
                body: JSON.stringify({
                    user_id: currentUser?.id,
                    trade_id: tradeId
                })
            });
            
            if (result && result.success) {
                tg.showAlert('Trade executed successfully!');
                tg.MainButton.hide();
                loadPositions();
                loadTradeConfigs();
                loadPortfolio();
            }
        }

        function showTradeModal() {
            updateTradeModal();
            new bootstrap.Modal(document.getElementById('tradeModal')).show();
        }

        function updateTradeModal() {
            if (!currentTrade) return;
            
            // Update progress indicator
            const progress = getTradeProgress(currentTrade);
            document.getElementById('trade-progress').innerHTML = progress;
            
            // Hide all steps
            document.querySelectorAll('.config-step').forEach(step => step.classList.add('hidden'));
            
            // Show current step
            const currentStepElement = document.getElementById(configSteps[configStep] + '-step');
            if (currentStepElement) {
                currentStepElement.classList.remove('hidden');
            }
            
            // Update modal title
            document.getElementById('tradeModalTitle').textContent = 
                `${currentTrade.name} - Step ${configStep + 1}/${configSteps.length}`;
            
            // Update form values
            if (currentTrade.symbol) document.getElementById('trade-symbol-select').value = currentTrade.symbol;
            if (currentTrade.amount) document.getElementById('amount-input').value = currentTrade.amount;
            if (currentTrade.leverage) document.getElementById('leverage-select').value = currentTrade.leverage;
            if (currentTrade.entry_price) document.getElementById('entry-price').value = currentTrade.entry_price;
            if (currentTrade.stop_loss_percent) document.getElementById('stop-loss').value = currentTrade.stop_loss_percent;
            if (currentTrade.breakeven_after) document.getElementById('breakeven-select').value = currentTrade.breakeven_after;
            if (currentTrade.trailing_stop_enabled) {
                document.getElementById('trailing-enabled').checked = currentTrade.trailing_stop_enabled;
                toggleTrailingStop();
            }
            if (currentTrade.trail_percentage) document.getElementById('trail-percentage').value = currentTrade.trail_percentage;
            if (currentTrade.trail_activation_price) document.getElementById('trail-activation').value = currentTrade.trail_activation_price;
        }

        function nextStep() {
            if (!validateCurrentStep()) return;
            
            if (configStep < configSteps.length - 1) {
                configStep++;
                updateTradeModal();
            } else {
                saveTrade();
            }
        }

        function previousStep() {
            if (configStep > 0) {
                configStep--;
                updateTradeModal();
            }
        }

        function validateCurrentStep() {
            const step = configSteps[configStep];
            
            switch (step) {
                case 'symbol':
                    const symbol = document.getElementById('trade-symbol-select').value;
                    if (!symbol) {
                        tg.showAlert('Please select a trading pair');
                        return false;
                    }
                    currentTrade.symbol = symbol;
                    break;
                    
                case 'side':
                    if (!currentTrade.side) {
                        tg.showAlert('Please select a position side (Long or Short)');
                        return false;
                    }
                    break;
                    
                case 'amount':
                    const amount = parseFloat(document.getElementById('amount-input').value);
                    const leverage = parseInt(document.getElementById('leverage-select').value);
                    if (!amount || amount <= 0) {
                        tg.showAlert('Please enter a valid amount');
                        return false;
                    }
                    currentTrade.amount = amount;
                    currentTrade.leverage = leverage;
                    break;
                    
                case 'entry':
                    if (!currentTrade.entry_type) {
                        tg.showAlert('Please select an entry type (Market or Limit)');
                        return false;
                    }
                    if (currentTrade.entry_type === 'limit') {
                        const entryPrice = parseFloat(document.getElementById('entry-price').value);
                        if (!entryPrice || entryPrice <= 0) {
                            tg.showAlert('Please enter a valid limit price');
                            return false;
                        }
                        currentTrade.entry_price = entryPrice;
                    } else {
                        currentTrade.entry_price = ''; // Clear for market orders
                    }
                    break;
                    
                case 'tp':
                    // Collect take profit data
                    currentTrade.take_profits = [];
                    document.querySelectorAll('#tp-levels .input-group').forEach((group, index) => {
                        const percent = parseFloat(group.querySelector('.tp-percent').value);
                        const allocation = parseFloat(group.querySelector('.tp-allocation').value);
                        if (percent && allocation) {
                            currentTrade.take_profits.push({ percentage: percent, allocation: allocation });
                        }
                    });
                    if (currentTrade.take_profits.length === 0) {
                        tg.showAlert('Please add at least one take profit level');
                        return false;
                    }
                    break;
                    
                case 'sl':
                    const stopLoss = parseFloat(document.getElementById('stop-loss').value);
                    if (!stopLoss || stopLoss <= 0) {
                        tg.showAlert('Please set a stop loss percentage');
                        return false;
                    }
                    currentTrade.stop_loss_percent = stopLoss;
                    break;
                    
                case 'breakeven':
                    const breakeven = document.getElementById('breakeven-select').value;
                    currentTrade.breakeven_after = breakeven;
                    break;
                    
                case 'trailing':
                    const trailingEnabled = document.getElementById('trailing-enabled').checked;
                    currentTrade.trailing_stop_enabled = trailingEnabled;
                    
                    if (trailingEnabled) {
                        const trailPercent = parseFloat(document.getElementById('trail-percentage').value);
                        if (!trailPercent || trailPercent <= 0) {
                            tg.showAlert('Please set a trail percentage');
                            return false;
                        }
                        currentTrade.trail_percentage = trailPercent;
                        
                        const activationPrice = parseFloat(document.getElementById('trail-activation').value);
                        if (activationPrice) {
                            currentTrade.trail_activation_price = activationPrice;
                        }
                    } else {
                        currentTrade.trail_percentage = '';
                        currentTrade.trail_activation_price = '';
                    }
                    break;
            }
            
            return true;
        }

        function setTradeSide(side) {
            currentTrade.side = side;
            document.querySelectorAll('#side-step .btn').forEach(btn => btn.classList.remove('btn-primary'));
            event.target.classList.add('btn-primary');
        }

        function setEntryType(type) {
            currentTrade.entry_type = type;
            document.querySelectorAll('#entry-step .btn').forEach(btn => btn.classList.remove('btn-primary'));
            event.target.classList.add('btn-primary');
            
            const limitInput = document.getElementById('limit-price-input');
            if (type === 'limit') {
                limitInput.classList.remove('hidden');
            } else {
                limitInput.classList.add('hidden');
                currentTrade.entry_price = '';
            }
        }

        function addTpLevel() {
            const container = document.getElementById('tp-levels');
            const level = container.children.length + 1;
            
            const tpDiv = document.createElement('div');
            tpDiv.className = 'input-group mb-2';
            tpDiv.innerHTML = `
                <span class="input-group-text">TP${level} %</span>
                <input type="number" class="form-control tp-percent" data-level="${level}" placeholder="5" step="0.1">
                <span class="input-group-text">Size %</span>
                <input type="number" class="form-control tp-allocation" data-level="${level}" placeholder="30" step="1">
                <button class="btn btn-outline-danger" onclick="this.parentElement.remove()">×</button>
            `;
            container.appendChild(tpDiv);
        }

        async function saveTrade() {
            // Collect take profit data
            currentTrade.take_profits = [];
            document.querySelectorAll('#tp-levels .input-group').forEach((group, index) => {
                const percent = parseFloat(group.querySelector('.tp-percent').value);
                const allocation = parseFloat(group.querySelector('.tp-allocation').value);
                if (percent && allocation) {
                    currentTrade.take_profits.push({ percentage: percent, allocation: allocation });
                }
            });
            
            // Save trade configuration
            const result = await apiCall('/api/save-trade', {
                method: 'POST',
                body: JSON.stringify({
                    user_id: currentUser?.id,
                    trade: currentTrade
                })
            });
            
            if (result && result.success) {
                tg.showAlert('Trade configuration saved successfully!');
                bootstrap.Modal.getInstance(document.getElementById('tradeModal')).hide();
                loadTradeConfigs();
                loadPositions();
            }
        }

        function calculateROE(trade) {
            if (!trade.unrealized_pnl || !trade.amount || !trade.leverage) return 0;
            const positionSize = trade.amount;
            const margin = positionSize / (trade.leverage || 1);
            return margin > 0 ? (trade.unrealized_pnl / margin) * 100 : 0;
        }

        function getTradeProgress(trade) {
            const steps = {
                "Symbol": trade.symbol ? "✅" : "⏳",
                "Side": trade.side ? "✅" : "⏳", 
                "Amount": trade.amount ? "✅" : "⏳",
                "Entry": (trade.entry_type === "market" || (trade.entry_type === "limit" && trade.entry_price)) ? "✅" : "⏳",
                "TPs": trade.take_profits?.length > 0 ? "✅" : "⏳",
                "SL": trade.stop_loss_percent ? "✅" : "⏳"
            };
            
            const completed = Object.values(steps).filter(s => s === "✅").length;
            const total = Object.keys(steps).length;
            const progress = "█".repeat(completed) + "░".repeat(total - completed);
            
            // Add advanced settings indicators
            const advancedSettings = [];
            if (trade.breakeven_after && trade.breakeven_after !== 'disabled') {
                advancedSettings.push('BE');
            }
            if (trade.trailing_stop_enabled) {
                advancedSettings.push('TS');
            }
            const advancedText = advancedSettings.length > 0 ? ` +${advancedSettings.join(',')}` : '';
            
            return `${completed}/${total} [${progress}] ${Object.entries(steps).map(([k,v]) => `${k}${v}`).join(' ')}${advancedText}`;
        }

        function toggleTrailingStop() {
            const enabled = document.getElementById('trailing-enabled').checked;
            const options = document.getElementById('trailing-options');
            if (enabled) {
                options.classList.remove('hidden');
            } else {
                options.classList.add('hidden');
            }
        }

        // API Credentials Management Functions
        async function loadCredentialsStatus() {
            const data = await apiCall(`/api/user-credentials?user_id=${currentUser?.id || '123456789'}`);
            const statusContainer = document.getElementById('credentials-status');
            const setupContainer = document.getElementById('credentials-setup');
            
            if (!data) return;
            
            if (data.has_credentials) {
                statusContainer.innerHTML = `
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">✅ API Credentials Active</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">Exchange:</small><br>
                                    <strong>${(data.exchange || 'Unknown').toUpperCase()}</strong>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Mode:</small><br>
                                    <strong>${data.testnet_mode ? '🧪 Testnet' : '🚀 Live Trading'}</strong>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="two-column-grid">
                                    <button class="btn btn-outline-warning" onclick="showCredentialsSetup()">🔄 Update</button>
                                    <button class="btn btn-outline-danger" onclick="deleteCredentials()">🗑️ Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                setupContainer.classList.add('hidden');
            } else {
                statusContainer.innerHTML = `
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0">⚠️ No API Credentials</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-2">Add your exchange API credentials to enable live trading.</p>
                            <button class="btn btn-primary" onclick="showCredentialsSetup()">🔑 Add Credentials</button>
                        </div>
                    </div>
                `;
                setupContainer.classList.add('hidden');
            }
        }

        function showCredentialsSetup() {
            document.getElementById('credentials-setup').classList.remove('hidden');
        }

        function cancelCredentialsSetup() {
            document.getElementById('credentials-setup').classList.add('hidden');
            clearCredentialsForm();
        }

        function clearCredentialsForm() {
            document.getElementById('api-key-input').value = '';
            document.getElementById('api-secret-input').value = '';
            document.getElementById('passphrase-input').value = '';
            document.getElementById('exchange-select').value = 'toobit';
        }

        async function saveCredentials() {
            const exchange = document.getElementById('exchange-select').value;
            const apiKey = document.getElementById('api-key-input').value.trim();
            const apiSecret = document.getElementById('api-secret-input').value.trim();
            const passphrase = document.getElementById('passphrase-input').value.trim();

            if (!apiKey || !apiSecret) {
                alert('Please enter both API key and secret');
                return;
            }

            try {
                const response = await fetch('/api/save-credentials', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUser?.id || '123456789',
                        exchange: exchange,
                        api_key: apiKey,
                        api_secret: apiSecret,
                        passphrase: passphrase || null
                    })
                });

                if (response.ok) {
                    alert('✅ Credentials saved successfully!');
                    clearCredentialsForm();
                    cancelCredentialsSetup();
                    loadCredentialsStatus();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error || 'Failed to save credentials'}`);
                }
            } catch (error) {
                console.error('Error saving credentials:', error);
                alert('Error saving credentials. Please try again.');
            }
        }

        async function deleteCredentials() {
            if (!confirm('Are you sure you want to delete your API credentials?')) {
                return;
            }

            try {
                const response = await fetch('/api/delete-credentials', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentUser?.id || '123456789' })
                });

                if (response.ok) {
                    alert('✅ Credentials deleted successfully');
                    loadCredentialsStatus();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error || 'Failed to delete credentials'}`);
                }
            } catch (error) {
                console.error('Error deleting credentials:', error);
                alert('Error deleting credentials. Please try again.');
            }
        }





        // Tab switching handlers
        document.addEventListener('shown.bs.tab', function (event) {
            const tabId = event.target.getAttribute('data-bs-target');
            
            switch (tabId) {
                case '#positions':
                    loadPositions();
                    break;
                case '#trading':
                    loadTradeConfigs();
                    break;
                case '#portfolio':
                    loadPortfolio();
                    break;
                case '#credentials':
                    loadCredentialsStatus();
                    break;
            }
        });

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadPositions(); // Start with positions tab
        });

        // Auto-refresh every 30 seconds
        setInterval(() => {
            const activeTab = document.querySelector('.nav-link.active').getAttribute('data-bs-target');
            if (activeTab === '#positions') loadPositions();
            else if (activeTab === '#portfolio') loadPortfolio();
        }, 30000);

        // Mobile-specific enhancements
        function initializeMobileEnhancements() {
            // Prevent double-tap zoom on buttons
            document.querySelectorAll('.btn, .nav-link, .collapsible-header').forEach(element => {
                element.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    this.click();
                });
            });

            // Add swipe gesture support for tab navigation
            let startX = 0;
            let startY = 0;
            let isScrolling = false;

            document.addEventListener('touchstart', function(e) {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                isScrolling = false;
            });

            document.addEventListener('touchmove', function(e) {
                const deltaX = Math.abs(e.touches[0].clientX - startX);
                const deltaY = Math.abs(e.touches[0].clientY - startY);
                
                if (deltaY > deltaX) {
                    isScrolling = true;
                }
            });

            document.addEventListener('touchend', function(e) {
                if (isScrolling) return;
                
                const endX = e.changedTouches[0].clientX;
                const deltaX = endX - startX;
                
                if (Math.abs(deltaX) > 50) { // Minimum swipe distance
                    const tabs = document.querySelectorAll('.nav-link');
                    const activeTab = document.querySelector('.nav-link.active');
                    const currentIndex = Array.from(tabs).indexOf(activeTab);
                    
                    if (deltaX > 0 && currentIndex > 0) {
                        // Swipe right - previous tab
                        tabs[currentIndex - 1].click();
                    } else if (deltaX < 0 && currentIndex < tabs.length - 1) {
                        // Swipe left - next tab
                        tabs[currentIndex + 1].click();
                    }
                }
            });

            // Optimize scroll performance
            let ticking = false;
            function updateScrollElements() {
                // Add scroll-based effects here if needed
                ticking = false;
            }

            function requestTick() {
                if (!ticking) {
                    requestAnimationFrame(updateScrollElements);
                    ticking = true;
                }
            }

            document.addEventListener('scroll', requestTick);

            // Handle safe area insets for newer devices
            if (CSS.supports('padding: env(safe-area-inset-top)')) {
                document.documentElement.style.setProperty('--safe-area-top', 'env(safe-area-inset-top)');
                document.documentElement.style.setProperty('--safe-area-bottom', 'env(safe-area-inset-bottom)');
                
                // Adjust header and bottom spacing
                const header = document.querySelector('.header');
                if (header) {
                    header.style.paddingTop = 'calc(1.25rem + var(--safe-area-top, 0px))';
                }
            }

            // Improve form interactions on mobile
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('focus', function() {
                    // Scroll input into view with some padding
                    setTimeout(() => {
                        this.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center' 
                        });
                    }, 300);
                });

                // Format numbers for better readability
                input.addEventListener('blur', function() {
                    if (this.value && !isNaN(this.value)) {
                        const value = parseFloat(this.value);
                        if (this.step && this.step.includes('.')) {
                            const decimals = this.step.split('.')[1].length;
                            this.value = value.toFixed(decimals);
                        }
                    }
                });
            });

            // Add haptic feedback for touch interactions (if supported)
            if ('vibrate' in navigator) {
                document.querySelectorAll('.btn-primary, .btn-success, .btn-danger').forEach(button => {
                    button.addEventListener('click', function() {
                        navigator.vibrate(50); // Light haptic feedback
                    });
                });
            }

            // Optimize modal interactions for mobile
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('shown.bs.modal', function() {
                    // Prevent background scrolling
                    document.body.style.overflow = 'hidden';
                    
                    // Focus first input
                    const firstInput = this.querySelector('input, select, textarea');
                    if (firstInput) {
                        setTimeout(() => firstInput.focus(), 100);
                    }
                });

                modal.addEventListener('hidden.bs.modal', function() {
                    // Restore background scrolling
                    document.body.style.overflow = '';
                });
            });

            // Add pull-to-refresh functionality
            let pullStartY = 0;
            let pulling = false;
            const pullThreshold = 80;

            document.addEventListener('touchstart', function(e) {
                if (window.scrollY === 0) {
                    pullStartY = e.touches[0].clientY;
                    pulling = true;
                }
            });

            document.addEventListener('touchmove', function(e) {
                if (!pulling) return;
                
                const currentY = e.touches[0].clientY;
                const pullDistance = currentY - pullStartY;
                
                if (pullDistance > pullThreshold && window.scrollY === 0) {
                    // Visual feedback for pull-to-refresh
                    const header = document.querySelector('.header h1');
                    if (header && !header.textContent.includes('↓')) {
                        header.textContent = '↓ ' + header.textContent.replace('↓ ', '');
                    }
                }
            });

            document.addEventListener('touchend', function(e) {
                if (!pulling) return;
                pulling = false;
                
                const header = document.querySelector('.header h1');
                if (header && header.textContent.includes('↓')) {
                    header.textContent = header.textContent.replace('↓ ', '');
                    
                    // Trigger refresh
                    const activeTab = document.querySelector('.nav-link.active').getAttribute('data-bs-target');
                    if (activeTab === '#positions') loadPositions();
                    else if (activeTab === '#trading') loadTradeConfigs();
                    else if (activeTab === '#portfolio') loadPortfolio();
                    else if (activeTab === '#credentials') loadCredentialsStatus();
                }
            });

            // Optimize touch targets for better accessibility
            document.querySelectorAll('.btn-sm').forEach(button => {
                if (button.offsetHeight < 44) {
                    button.style.minHeight = '44px';
                    button.style.display = 'flex';
                    button.style.alignItems = 'center';
                    button.style.justifyContent = 'center';
                }
            });
        }

        // Initialize mobile enhancements after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeMobileEnhancements();
        });
    </script>
</body>
</html>