<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Toobit Trading Mini-App</title>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Feather Icons -->
    <link href="https://cdn.jsdelivr.net/npm/feather-icons@4.29.0/dist/feather.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Chart.js for candlestick visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>

    
    <style>
        :root {
            --tg-theme-bg-color: #0f1419;
            --tg-theme-text-color: #e8eef7;
            --tg-theme-hint-color: #8b9dc3;
            --tg-theme-link-color: #6bb6ff;
            --tg-theme-button-color: #4a5d7a;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #1a202c;
            --tg-theme-accent-color: #5b7394;
            --tg-theme-card-bg: #212836;
            --tg-theme-border-color: #3a4658;
            --tg-theme-success: #52c41a;
            --tg-theme-warning: #faad14;
            --tg-theme-danger: #ff4d4f;
            --tg-theme-silver-blue: #6b8bb3;
            --tg-theme-silver-light: #a8b5c8;
            --tg-theme-silver-dark: #2d3748;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            font-weight: 400;
            font-display: swap;
            background: var(--tg-theme-bg-color) !important;
            color: var(--tg-theme-text-color) !important;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            -webkit-user-select: none;
            user-select: none;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            letter-spacing: -0.005em;
            line-height: 1.5;
        }

        /* Ensure all text elements use proper colors for dark mode */
        * {
            color: inherit;
        }

        .text-muted {
            color: var(--tg-theme-hint-color) !important;
        }

        .text-primary {
            color: var(--tg-theme-button-color) !important;
        }

        small {
            color: var(--tg-theme-hint-color) !important;
        }

        /* Enhanced Typography */
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 600;
            letter-spacing: -0.02em;
            margin-bottom: 0.5rem;
        }

        /* Live price indicator animation */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .live-indicator {
            animation: pulse 2s infinite;
        }

        /* Dedicated live indicator dot styling with connectivity states */
        .live-indicator-dot {
            width: 8px;
            height: 8px;
            background: #52c41a; /* Default green */
            border-radius: 50%;
            opacity: 0.7;
            animation: pulse 2s infinite;
            position: relative;
            z-index: 10;
            transition: background-color 0.3s ease;
        }

        /* Connectivity status colors */
        .live-indicator-dot.connected {
            background: #52c41a; /* Green - good connectivity */
        }

        .live-indicator-dot.slow {
            background: #faad14; /* Orange - slow connectivity */
        }

        .live-indicator-dot.error {
            background: #ff4d4f; /* Red - error or no connectivity */
            animation: pulse 1s infinite; /* Faster pulse for errors */
        }

        /* Single Page Form Styling */
        .single-page-form {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .config-section {
            background: var(--tg-theme-card-bg);
            border: 1px solid var(--tg-theme-border-color);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .section-title {
            color: var(--tg-theme-button-color);
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--tg-theme-border-color);
        }
        
        .form-label.required::after {
            content: " *";
            color: var(--tg-theme-danger);
        }
        
        .validation-error {
            color: var(--tg-theme-danger);
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: none;
        }
        
        .validation-error.show {
            display: block;
        }
        
        .side-btn.active,
        .entry-btn.active {
            background-color: var(--tg-theme-button-color) !important;
            border-color: var(--tg-theme-button-color) !important;
            color: white !important;
        }
        
        .modal-lg {
            max-width: 800px;
        }

        .modal-xl {
            max-width: 1140px;
        }
        
        @media (max-width: 1200px) {
            .modal-xl {
                max-width: 95%;
                margin: 1rem auto;
            }
        }
        
        @media (max-width: 768px) {
            .modal-lg, .modal-xl {
                max-width: 98%;
                margin: 0.5rem auto;
            }
            
            .single-page-form {
                max-height: 80vh;
            }

            .smc-chart-wrapper {
                height: 450px !important;
            }
        }

        /* SMC Analysis Compact Info Boxes */
        .smc-detail-item {
            background: var(--tg-theme-card-bg);
            border: 1px solid var(--tg-theme-border-color);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .smc-detail-item.compact {
            padding: 8px 10px;
            border-radius: 6px;
        }

        .smc-detail-item:hover {
            border-color: var(--tg-theme-button-color);
            background: rgba(74, 144, 226, 0.05);
        }

        .smc-detail-label {
            font-size: 0.75rem;
            color: var(--tg-theme-hint-color);
            font-weight: 500;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .smc-detail-item.compact .smc-detail-label {
            font-size: 0.7rem;
            margin-bottom: 2px;
        }

        .smc-detail-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--tg-theme-text-color);
            font-family: 'JetBrains Mono', monospace;
        }

        .smc-detail-item.compact .smc-detail-value {
            font-size: 0.85rem;
        }

        .smc-reasoning-list {
            margin: 0;
            padding-left: 1rem;
        }

        .smc-reasoning-list li {
            font-size: 0.85rem;
            margin-bottom: 0.25rem;
            color: var(--tg-theme-text-color);
        }

        /* Enhanced Loading Indicators */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(15, 20, 25, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }

        .loading-spinner {
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--tg-theme-text-color);
            font-size: 0.9rem;
        }

        .spinner-ring {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(107, 139, 179, 0.3);
            border-top: 3px solid var(--tg-theme-button-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-dots {
            display: inline-flex;
            gap: 4px;
        }

        .loading-dot {
            width: 4px;
            height: 4px;
            background: var(--tg-theme-button-color);
            border-radius: 50%;
            animation: loadingDots 1.4s infinite ease-in-out both;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes loadingDots {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Button loading states */
        .btn-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 16px;
            height: 16px;
            margin: -8px 0 0 -8px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Inline loading for small components */
        .inline-loading {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--tg-theme-hint-color);
            font-size: 0.85rem;
        }

        .inline-spinner {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(139, 157, 195, 0.3);
            border-top: 2px solid var(--tg-theme-hint-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Card loading state */
        .card-loading {
            position: relative;
            overflow: hidden;
        }

        .card-loading::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.1),
                transparent
            );
            animation: shimmer 1.5s infinite;
            z-index: 1;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Price update loading */
        .price-loading {
            position: relative;
        }

        .price-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            right: -20px;
            width: 12px;
            height: 12px;
            border: 2px solid rgba(82, 196, 26, 0.3);
            border-top: 2px solid #52c41a;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* Tab loading indicator */
        .tab-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            flex-direction: column;
            gap: 1rem;
        }

        /* Skeleton loading for lists */
        .skeleton {
            background: linear-gradient(
                90deg,
                var(--tg-theme-border-color),
                rgba(58, 70, 88, 0.6),
                var(--tg-theme-border-color)
            );
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-line {
            height: 16px;
            margin-bottom: 8px;
        }

        .skeleton-line.short { width: 60%; }
        .skeleton-line.medium { width: 80%; }
        .skeleton-line.long { width: 100%; }

        .header h5 {
            font-weight: 700;
            font-size: 1.25rem;
            letter-spacing: -0.015em;
        }

        .nav-tabs .nav-link {
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            font-size: 0.9rem;
            letter-spacing: -0.005em;
        }

        /* Monospace font for numbers, prices, and data */
        .stat-value, .price-display, .amount-display {
            font-family: 'JetBrains Mono', 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-weight: 500;
            letter-spacing: -0.02em;
        }

        /* Button typography */
        .btn {
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            font-size: 0.875rem;
            letter-spacing: -0.005em;
        }

        /* Card titles and labels */
        .card-title, .form-label {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        /* Status and badge typography */
        .status-badge, .badge {
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            font-size: 0.75rem;
            letter-spacing: 0.025em;
            text-transform: uppercase;
        }

        /* Dark mode card styling */
        .card {
            background: var(--tg-theme-secondary-bg-color) !important;
            border: 2px solid var(--tg-theme-border-color) !important;
            color: var(--tg-theme-text-color) !important;
        }

        .card-header {
            background: var(--tg-theme-secondary-bg-color) !important;
            border-bottom: 2px solid var(--tg-theme-border-color) !important;
            color: var(--tg-theme-text-color) !important;
        }

        .card-body {
            background: var(--tg-theme-secondary-bg-color) !important;
            color: var(--tg-theme-text-color) !important;
        }

        /* Alert styling for dark mode */
        .alert {
            background: var(--tg-theme-secondary-bg-color) !important;
            border: 2px solid var(--tg-theme-border-color) !important;
            color: var(--tg-theme-text-color) !important;
        }

        .alert-info {
            background: rgba(74, 144, 226, 0.1) !important;
            border-color: var(--tg-theme-button-color) !important;
            color: var(--tg-theme-text-color) !important;
        }

        /* Ensure list items are properly styled */
        ul, li {
            color: var(--tg-theme-text-color) !important;
        }

        .mini-app-container {
            max-width: 100vw;
            padding: 0;
            margin: 0;
        }

        .header {
            background: linear-gradient(135deg, #0f1419 0%, #1a2332 25%, #2d3e5a 75%, #4a6186 100%);
            color: #ffffff;
            padding: 0.75rem 0 0.5rem 0;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid rgba(107, 139, 179, 0.4);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6), 
                        0 4px 16px rgba(75, 93, 122, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            margin: 0;
            position: relative;
            padding: 0 1rem;
        }

        .header .logo-section {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            justify-content: center;
        }

        .header .logo-icon {
            width: 28px;
            height: 28px;
            background: transparent;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            position: relative;
        }

        .header h1 {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            letter-spacing: -0.025em;
            color: #ffffff !important;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8), 
                         0 1px 2px rgba(0, 0, 0, 0.6);
            position: relative;
            line-height: 1.2;
            /* Remove gradient to fix fogginess */
            background: none !important;
            -webkit-background-clip: unset !important;
            background-clip: unset !important;
            -webkit-text-fill-color: #ffffff !important;
        }

        .header .subtitle {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.95) !important;
            font-weight: 500;
            margin-top: 0.25rem;
            letter-spacing: 0.8px;
            text-transform: uppercase;
            text-shadow: 0 1px 4px rgba(0, 0, 0, 0.8);
        }

        /* Hamburger Menu Styling */
        .hamburger-menu {
            position: relative;
            z-index: 1001;
            flex-shrink: 0;
        }

        .hamburger-button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .hamburger-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .hamburger-icon {
            width: 18px;
            height: 12px;
            position: relative;
        }

        .hamburger-icon span {
            display: block;
            width: 100%;
            height: 2px;
            background: #ffffff;
            border-radius: 1px;
            position: absolute;
            transition: all 0.3s ease;
        }

        .hamburger-icon span:nth-child(1) {
            top: 0;
        }

        .hamburger-icon span:nth-child(2) {
            top: 5px;
        }

        .hamburger-icon span:nth-child(3) {
            top: 10px;
        }

        .hamburger-button.active .hamburger-icon span:nth-child(1) {
            transform: rotate(45deg);
            top: 5px;
        }

        .hamburger-button.active .hamburger-icon span:nth-child(2) {
            opacity: 0;
        }

        .hamburger-button.active .hamburger-icon span:nth-child(3) {
            transform: rotate(-45deg);
            top: 5px;
        }

        .hamburger-dropdown {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background: linear-gradient(135deg, #1a2332 0%, #2d3748 100%);
            border: 1px solid rgba(107, 139, 179, 0.3);
            border-radius: 12px;
            min-width: 200px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5),
                        0 4px 16px rgba(75, 93, 122, 0.3);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1002;
        }

        .hamburger-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .hamburger-dropdown .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            color: var(--tg-theme-text-color);
            text-decoration: none;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 500;
            font-size: 0.9rem;
            border-bottom: 1px solid rgba(107, 139, 179, 0.1);
            transition: all 0.3s ease;
        }

        .hamburger-dropdown .dropdown-item:last-child {
            border-bottom: none;
        }

        .hamburger-dropdown .dropdown-item:hover {
            background: rgba(74, 144, 226, 0.1);
            color: #4a90e2;
        }

        .hamburger-dropdown .dropdown-item:first-child {
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }

        .hamburger-dropdown .dropdown-item:last-child {
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        .hamburger-dropdown .dropdown-item i {
            font-size: 16px;
            width: 20px;
            text-align: center;
        }

        .nav-tabs {
            background: var(--tg-theme-secondary-bg-color);
            border-bottom: 2px solid var(--tg-theme-border-color);
            padding: 0 1rem;
        }

        .nav-tabs .nav-link {
            color: var(--tg-theme-hint-color);
            border: none;
            padding: 1rem 1.5rem;
            font-size: 0.95rem;
            border-radius: 0;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
            text-align: center;
        }

        .nav-tabs .nav-link::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 3px;
            background: linear-gradient(90deg, #4a90e2, #357abd);
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }

        .nav-tabs .nav-link.active {
            color: var(--tg-theme-text-color);
            background: rgba(74, 144, 226, 0.1);
        }

        .nav-tabs .nav-link.active::after {
            width: 80%;
            font-weight: 700;
            box-shadow: 0 -2px 10px rgba(107, 139, 179, 0.2);
        }

        .nav-tabs .nav-link:hover:not(.active) {
            color: var(--tg-theme-text-color);
            background: var(--tg-theme-card-bg);
        }

        .tab-content {
            padding: 1rem;
        }

        .trade-card {
            background: linear-gradient(135deg, var(--tg-theme-card-bg) 0%, var(--tg-theme-silver-dark) 100%);
            border: 2px solid var(--tg-theme-silver-blue);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 8px 25px rgba(75, 93, 122, 0.2), 0 4px 10px rgba(0,0,0,0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .trade-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 40px rgba(75, 93, 122, 0.4), 0 8px 20px rgba(0,0,0,0.4);
            border-color: var(--tg-theme-silver-light);
        }

        .trade-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--tg-theme-silver-blue), transparent);
            opacity: 0.6;
        }

        .collapsible-header {
            cursor: pointer;
            background: var(--tg-theme-card-bg);
            border: 1px solid var(--tg-theme-border-color);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            margin-bottom: 0;
            transition: all 0.2s ease;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .collapsible-header:hover {
            border-color: var(--tg-theme-button-color);
            box-shadow: 0 2px 8px rgba(74, 144, 226, 0.15);
        }

        .collapsible-content {
            background: var(--tg-theme-card-bg);
            border: 1px solid var(--tg-theme-border-color);
            border-top: none;
            border-radius: 0 0 10px 10px;
            padding: 0 1rem;
            margin-bottom: 1rem;
            max-height: 0;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .collapsible-content.expanded {
            max-height: none;
            padding: 0.75rem 1rem 1rem 1rem;
            border-top: 1px solid var(--tg-theme-border-color);
            overflow: visible;
            -webkit-overflow-scrolling: touch;
        }

        .collapsible-header.expanded {
            border-radius: 10px 10px 0 0;
            border-bottom: none;
        }

        .expand-icon {
            transition: transform 0.2s ease;
            font-size: 1rem;
            color: var(--tg-theme-button-color);
            font-weight: bold;
            opacity: 0.8;
        }

        .expand-icon.expanded {
            transform: rotate(180deg);
            opacity: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--tg-theme-silver-blue) 0%, var(--tg-theme-button-color) 100%);
            border: 2px solid var(--tg-theme-silver-blue);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            font-weight: 700;
            width: 100%;
            margin-bottom: 0.75rem;
            color: var(--tg-theme-button-text-color);
            transition: all 0.3s ease;
            font-size: 1rem;
            box-shadow: 0 4px 15px rgba(75, 93, 122, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--tg-theme-silver-light) 0%, var(--tg-theme-silver-blue) 100%);
            border-color: var(--tg-theme-silver-light);
            color: var(--tg-theme-button-text-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(75, 93, 122, 0.4);
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:active {
            transform: translateY(0px);
            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.4);
        }

        .btn-outline-primary {
            color: var(--tg-theme-text-color);
            border: 2px solid var(--tg-theme-button-color);
            background: var(--tg-theme-card-bg);
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .btn-outline-primary:hover {
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border-color: var(--tg-theme-button-color);
        }

        .btn-outline-danger {
            color: var(--tg-theme-danger);
            border: 2px solid var(--tg-theme-danger);
            background: rgba(244, 67, 54, 0.1);
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .btn-outline-danger:hover {
            background: var(--tg-theme-danger);
            color: white;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }

        .btn-outline-success {
            color: var(--tg-theme-success);
            border: 2px solid var(--tg-theme-success);
            background: rgba(76, 175, 80, 0.1);
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .btn-outline-success:hover {
            background: var(--tg-theme-success);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .btn-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.85rem;
            width: auto;
            margin: 0.25rem;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .form-control {
            background: var(--tg-theme-card-bg);
            border: 2px solid var(--tg-theme-border-color);
            color: var(--tg-theme-text-color);
            border-radius: 12px;
            padding: 1rem;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            background: var(--tg-theme-card-bg);
            border-color: var(--tg-theme-button-color);
            color: var(--tg-theme-text-color);
            box-shadow: 0 0 10px rgba(74, 144, 226, 0.6);
            outline: none;
        }

        .form-control::placeholder {
            color: var(--tg-theme-hint-color);
            opacity: 1;
        }

        .input-group-text {
            background: var(--tg-theme-card-bg);
            border: 2px solid var(--tg-theme-border-color);
            color: var(--tg-theme-text-color);
            font-weight: 700;
            border-radius: 12px 0 0 12px;
        }

        .form-select {
            background: var(--tg-theme-card-bg);
            border: 2px solid var(--tg-theme-border-color);
            color: var(--tg-theme-text-color);
            border-radius: 12px;
            padding: 1rem;
            font-weight: 600;
        }

        .form-select:focus {
            border-color: var(--tg-theme-button-color);
            box-shadow: 0 0 10px rgba(74, 144, 226, 0.6);
        }

        .form-select option {
            background: var(--tg-theme-card-bg);
            color: var(--tg-theme-text-color);
        }

        .form-label {
            color: var(--tg-theme-text-color);
            font-weight: 700;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .text-muted {
            color: var(--tg-theme-hint-color) !important;
            font-weight: 500;
        }

        .progress-indicator {
            font-family: monospace;
            font-size: 0.9rem;
            margin: 0.5rem 0;
            padding: 0.75rem;
            background: var(--tg-theme-card-bg);
            border: 2px solid var(--tg-theme-button-color);
            border-radius: 8px;
            color: var(--tg-theme-text-color);
            font-weight: 600;
        }

        .status-badge {
            padding: 0.35rem 0.7rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-active { 
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white; 
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }
        .status-configured { 
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white; 
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);
        }
        .status-pending { 
            background: linear-gradient(135deg, #2196f3, #1976d2);
            color: white; 
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
        }
        .status-stopped { 
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white; 
            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
        }

        .position-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 0 0.5rem;
        }

        .position-summary .stat-box {
            background: linear-gradient(135deg, var(--tg-theme-card-bg) 0%, var(--tg-theme-silver-dark) 100%);
            border: 2px solid var(--tg-theme-silver-blue);
            border-radius: 16px;
            padding: 1.5rem 1rem;
            text-align: center;
            box-shadow: 0 8px 20px rgba(75, 93, 122, 0.25), 0 4px 10px rgba(0,0,0,0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .position-summary .stat-box:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(75, 93, 122, 0.35), 0 6px 15px rgba(0,0,0,0.4);
        }

        .position-summary .stat-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--tg-theme-silver-blue), transparent);
            opacity: 0.8;
        }

        .position-summary .stat-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--tg-theme-text-color);
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 0.5rem;
        }

        .position-summary .stat-label {
            font-size: 0.9rem;
            color: var(--tg-theme-silver-light);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        /* Compact position summary for single row layout */
        .position-summary-compact {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.2rem;
            margin-bottom: 0.5rem;
            padding: 0.25rem 0.4rem;
            background: linear-gradient(135deg, var(--tg-theme-card-bg) 0%, var(--tg-theme-silver-dark) 100%);
            border: 1px solid var(--tg-theme-silver-blue);
            border-radius: 6px;
            box-shadow: 0 1px 4px rgba(75, 93, 122, 0.08), 0 1px 2px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
        }

        .position-summary-compact::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--tg-theme-silver-blue), transparent);
            opacity: 0.8;
        }

        .position-summary-compact .stat-item {
            text-align: center;
            flex: 1;
            padding: 0.1rem;
        }

        .position-summary-compact .stat-item:not(:last-child) {
            border-right: 1px solid rgba(var(--tg-theme-silver-blue-rgb, 168, 181, 200), 0.3);
        }

        .position-summary-compact .stat-value {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--tg-theme-text-color);
            text-shadow: 0 1px 1px rgba(0,0,0,0.15);
            margin-bottom: 0.05rem;
            line-height: 1.1;
        }

        .position-summary-compact .stat-label {
            font-size: 0.5rem;
            color: var(--tg-theme-silver-light);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.1px;
            line-height: 1;
        }


        .portfolio-summary {
            background: linear-gradient(135deg, var(--tg-theme-card-bg) 0%, var(--tg-theme-silver-dark) 50%, var(--tg-theme-secondary-bg-color) 100%);
            border: 1px solid var(--tg-theme-silver-blue);
            border-radius: 10px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 4px 12px rgba(75, 93, 122, 0.2), 0 2px 6px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        .portfolio-summary::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--tg-theme-silver-light), transparent);
        }

        .portfolio-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.4rem;
            align-items: stretch;
        }

        .portfolio-stat {
            text-align: center;
            padding: 0.5rem 0.3rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--tg-theme-border-color);
            border-radius: 6px;
        }

        .portfolio-stat .stat-value {
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 0.15rem;
            color: var(--tg-theme-text-color);
        }

        .portfolio-stat .stat-label {
            font-size: 0.6rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.2px;
            opacity: 0.8;
            color: var(--tg-theme-hint-color);
        }

        .stat-box {
            text-align: center;
            padding: 1rem;
            background: linear-gradient(135deg, var(--tg-theme-card-bg) 0%, var(--tg-theme-silver-dark) 100%);
            border: 2px solid var(--tg-theme-silver-blue);
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(75, 93, 122, 0.2), 0 2px 6px rgba(0,0,0,0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(75, 93, 122, 0.3), 0 4px 10px rgba(0,0,0,0.4);
        }

        .stat-box::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(168, 181, 200, 0.05), transparent 50%);
            pointer-events: none;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--tg-theme-text-color);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--tg-theme-text-color);
            margin-top: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .trade-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.25rem;
            margin-top: 1rem;
        }

        .trade-controls .btn-sm {
            font-size: 0.75rem;
            padding: 0.375rem 0.5rem;
        }

        .hidden { display: none; }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--tg-theme-hint-color);
        }

        .modal {
            z-index: 2000;
        }

        .modal-content {
            background: var(--tg-theme-card-bg);
            color: var(--tg-theme-text-color);
            border: 2px solid var(--tg-theme-border-color);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
        }

        .modal-header {
            border-bottom: 2px solid var(--tg-theme-border-color);
            background: linear-gradient(135deg, var(--tg-theme-secondary-bg-color), var(--tg-theme-card-bg));
            border-radius: 20px 20px 0 0;
        }

        .modal-header .modal-title {
            color: var(--tg-theme-text-color);
            font-weight: 700;
            font-size: 1.25rem;
        }

        .modal-footer {
            border-top: 2px solid var(--tg-theme-border-color);
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 0 0 20px 20px;
        }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.8);
        }

        .btn-close {
            filter: invert(1) brightness(1.5);
            opacity: 0.8;
        }

        .btn-close:hover {
            opacity: 1;
        }

        .form-label {
            color: var(--tg-theme-text-color);
            font-weight: 600;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
        }

        .text-muted {
            color: var(--tg-theme-hint-color) !important;
        }

        .loading {
            color: var(--tg-theme-hint-color);
        }

        /* Enhanced Mobile Responsive Design */
        @media (max-width: 576px) {
            /* Optimized container padding for mobile */
            .mini-app-container {
                padding: 0;
                margin: 0;
                max-width: 100vw;
                overflow-x: hidden;
            }

            /* Reduce header padding on mobile */
            .header {
                padding: 1rem;
            }

            .header h1 {
                font-size: 1.3rem;
            }

            /* Mobile-optimized tab navigation */
            .nav-tabs {
                padding: 0 0.5rem;
                border-bottom: 1px solid var(--tg-theme-border-color);
            }

            .nav-tabs .nav-link {
                padding: 0.75rem 0.5rem;
                font-size: 0.85rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* Compact tab content padding */
            .tab-content {
                padding: 0.75rem;
            }

            /* Optimized card layout for mobile */
            .trade-card {
                padding: 1rem;
                margin-bottom: 1rem;
                border-radius: 12px;
            }

            .collapsible-header {
                padding: 0.6rem 0.8rem;
                border-radius: 8px;
                font-size: 0.85rem;
            }

            .collapsible-content {
                border-radius: 0 0 8px 8px;
                margin-bottom: 0.75rem;
            }

            .collapsible-header.expanded {
                border-radius: 8px 8px 0 0;
            }

            .collapsible-content.expanded {
                padding: 0.6rem 0.8rem 0.8rem 0.8rem;
                max-height: none;
                overflow: visible;
                -webkit-overflow-scrolling: touch;
            }

            /* Mobile-friendly position summary grid */
            .position-summary {
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem;
                margin-bottom: 1rem;
                padding: 0 0.25rem;
            }

            .position-summary .stat-box {
                padding: 0.75rem 0.5rem;
                border-radius: 10px;
            }

            .position-summary .stat-value {
                font-size: 1.3rem;
            }

            .position-summary .stat-label {
                font-size: 0.75rem;
                margin-top: 0.5rem;
            }

            /* Mobile-friendly compact position summary */
            .position-summary-compact {
                padding: 0.75rem;
                margin-bottom: 1rem;
                gap: 0.25rem;
            }

            .position-summary-compact .stat-item {
                padding: 0.2rem;
            }

            .position-summary-compact .stat-value {
                font-size: 1.1rem;
            }

            .position-summary-compact .stat-label {
                font-size: 0.6rem;
            }

            .portfolio-grid {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 0.25rem;
            }

            .portfolio-stat {
                padding: 0.4rem 0.25rem;
            }

            .portfolio-stat .stat-value {
                font-size: 0.8rem;
            }

            .portfolio-stat .stat-label {
                font-size: 0.55rem;
            }

            .stat-value {
                font-size: 1.3rem;
            }

            .stat-label {
                font-size: 0.8rem;
                margin-top: 0.5rem;
            }

            /* Enhanced button sizing for touch with micro-interactions */
            .btn-primary {
                padding: 0.875rem 1.25rem;
                font-size: 0.95rem;
                border-radius: 10px;
                margin-bottom: 0.5rem;
                min-height: 48px; /* iOS minimum touch target */
                transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
                transform: translateY(0);
                box-shadow: 0 2px 8px rgba(13, 110, 253, 0.15);
            }

            .btn-primary:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(13, 110, 253, 0.25);
            }

            .btn-primary:active {
                transform: translateY(0);
                box-shadow: 0 1px 4px rgba(13, 110, 253, 0.2);
                transition: all 0.1s ease;
            }

            .btn-sm {
                padding: 0.6rem 0.75rem;
                font-size: 0.8rem;
                min-height: 40px;
                margin: 0.125rem;
                transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
                transform: translateY(0);
                position: relative;
                overflow: hidden;
            }

            .btn-sm:hover {
                transform: translateY(-1px);
                box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
            }

            .btn-sm:active {
                transform: translateY(0);
                transition: all 0.1s ease;
            }

            /* Ripple effect for buttons */
            .btn-sm::before {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.3);
                transform: translate(-50%, -50%);
                transition: width 0.3s ease, height 0.3s ease;
                pointer-events: none;
            }

            .btn-sm:active::before {
                width: 100px;
                height: 100px;
            }

            /* Specific button type micro-interactions */
            .btn-success {
                box-shadow: 0 2px 8px rgba(25, 135, 84, 0.15);
                transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
                transform: translateY(0);
            }

            .btn-success:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(25, 135, 84, 0.25);
                background-color: #1e7e34 !important;
            }

            .btn-success:active {
                transform: scale(0.98);
                transition: all 0.1s ease;
            }

            .btn-warning {
                box-shadow: 0 2px 8px rgba(255, 193, 7, 0.15);
                transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
                transform: translateY(0);
            }

            .btn-warning:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(255, 193, 7, 0.25);
                background-color: #e0a800 !important;
            }

            .btn-warning:active {
                transform: scale(0.98);
                transition: all 0.1s ease;
            }

            .btn-danger {
                box-shadow: 0 2px 8px rgba(220, 53, 69, 0.15);
                transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
                transform: translateY(0);
            }

            .btn-danger:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(220, 53, 69, 0.25);
                background-color: #c82333 !important;
            }

            .btn-danger:active {
                transform: scale(0.98);
                transition: all 0.1s ease;
            }

            .btn-outline-secondary {
                box-shadow: 0 2px 8px rgba(108, 117, 125, 0.1);
                transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
                transform: translateY(0);
            }

            .btn-outline-secondary:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(108, 117, 125, 0.2);
            }

            .btn-outline-secondary:active {
                transform: scale(0.98);
                transition: all 0.1s ease;
            }

            /* Loading animation for buttons */
            .btn-loading {
                position: relative;
                color: transparent !important;
                pointer-events: none;
            }

            .btn-loading::after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 16px;
                height: 16px;
                margin: -8px 0 0 -8px;
                border: 2px solid #ffffff;
                border-radius: 50%;
                border-top-color: transparent;
                animation: spin 0.8s linear infinite;
            }

            @keyframes spin {
                to { transform: rotate(360deg); }
            }

            /* Pulse animation for important actions */
            .btn-pulse {
                animation: pulse 2s infinite;
            }

            @keyframes pulse {
                0% {
                    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.15);
                }
                50% {
                    box-shadow: 0 4px 16px rgba(13, 110, 253, 0.3);
                }
                100% {
                    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.15);
                }
            }

            /* Mobile-optimized trade controls */
            .trade-controls {
                grid-template-columns: 1fr;
                gap: 0.5rem;
                margin-top: 0.75rem;
            }

            .trade-controls .btn-sm {
                width: 100%;
                font-size: 0.85rem;
                padding: 0.625rem 1rem;
                margin: 0.125rem 0;
            }

            /* Form controls optimized for mobile */
            .form-control {
                padding: 0.875rem;
                font-size: 16px; /* Prevents iOS zoom */
                border-radius: 10px;
            }

            .form-select {
                padding: 0.875rem;
                font-size: 16px;
                border-radius: 10px;
            }

            .input-group-text {
                padding: 0.875rem;
                font-size: 0.9rem;
                border-radius: 10px 0 0 10px;
            }

            /* Modal optimization for mobile */
            .modal-dialog {
                margin: 0.5rem;
                max-width: calc(100vw - 1rem);
            }

            .modal-content {
                border-radius: 16px;
            }

            .modal-header {
                padding: 1rem;
                border-radius: 16px 16px 0 0;
            }

            .modal-body {
                padding: 1rem;
            }

            .modal-footer {
                padding: 1rem;
                border-radius: 0 0 16px 16px;
            }

            /* Status badges mobile optimization */
            .status-badge {
                padding: 0.4rem 0.8rem;
                font-size: 0.7rem;
            }

            /* Progress indicator mobile sizing */
            .progress-indicator {
                padding: 0.625rem;
                font-size: 0.85rem;
                border-radius: 6px;
            }
        }

        /* Tablet and medium screens */
        @media (min-width: 577px) and (max-width: 768px) {
            .position-summary {
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
            }

            .trade-controls {
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem;
            }

            .nav-tabs .nav-link {
                padding: 0.875rem 1rem;
                font-size: 0.9rem;
            }

            .header h1 {
                font-size: 1.4rem;
            }
        }

        /* Large screens optimization */
        @media (min-width: 992px) {
            .position-summary {
                grid-template-columns: 1fr 1fr 1fr;
            }

            .portfolio-grid {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 0.75rem;
            }
        }

        /* Touch-friendly enhancements */
        @media (hover: none) and (pointer: coarse) {
            /* Enhanced touch targets */
            .btn, .nav-link, .collapsible-header {
                min-height: 44px;
                padding: 0.75rem 1rem;
            }

            /* Remove hover effects on touch devices */
            .btn:hover,
            .nav-link:hover,
            .collapsible-header:hover,
            .trade-card:hover,
            .stat-box:hover {
                transform: none;
                box-shadow: initial;
            }

            /* Enhanced tap feedback */
            .btn:active,
            .nav-link:active,
            .collapsible-header:active {
                transform: scale(0.98);
                opacity: 0.8;
                transition: all 0.1s ease;
            }
        }

        /* High DPI display optimization */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .text-primary,
            .stat-value,
            .form-label {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
        }

        /* Landscape orientation adjustments */
        @media (orientation: landscape) and (max-height: 500px) {
            .header {
                padding: 0.75rem;
            }

            .header h1 {
                font-size: 1.2rem;
            }

            .nav-tabs .nav-link {
                padding: 0.5rem 0.75rem;
            }

            .tab-content {
                padding: 0.5rem;
            }

            .trade-card {
                padding: 0.75rem;
                margin-bottom: 0.75rem;
            }
        }

        .text-center {
            color: var(--tg-theme-text-color);
        }

        small {
            color: var(--tg-theme-hint-color);
            font-weight: 500;
        }

        h1, h2, h3, h4, h5, h6 {
            color: var(--tg-theme-text-color);
            font-weight: 700;
        }

        /* Form input styling for dark mode */
        .form-control, .form-select {
            background: var(--tg-theme-card-bg) !important;
            border: 2px solid var(--tg-theme-border-color) !important;
            color: var(--tg-theme-text-color) !important;
        }

        .form-control:focus, .form-select:focus {
            background: var(--tg-theme-card-bg) !important;
            border-color: var(--tg-theme-button-color) !important;
            color: var(--tg-theme-text-color) !important;
            box-shadow: 0 0 10px rgba(74, 144, 226, 0.3) !important;
        }

        .form-control::placeholder {
            color: var(--tg-theme-hint-color) !important;
        }

        .form-label {
            color: var(--tg-theme-text-color) !important;
        }

        .list-group-item {
            background: var(--tg-theme-secondary-bg-color, #1a2332);
            border: 1px solid var(--tg-theme-border-color, #3a4a5c);
            color: var(--tg-theme-text-color, #e8eaed);
        }

        .badge {
            font-weight: 600;
            padding: 0.5rem 0.75rem;
        }

        .bg-success {
            background: linear-gradient(135deg, #28a745, #20c997) !important;
            color: white !important;
        }

        .bg-warning {
            background: linear-gradient(135deg, #ffc107, #fd7e14) !important;
            color: #212529 !important;
        }

        .bg-danger {
            background: linear-gradient(135deg, #dc3545, #e83e8c) !important;
            color: white !important;
        }

        .border-success {
            border-color: #28a745 !important;
        }

        .border-warning {
            border-color: #ffc107 !important;
        }

        .border-danger {
            border-color: #dc3545 !important;
        }



        .two-column-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        /* Hamburger Menu Styles */
        .hamburger-menu {
            position: relative;
            display: inline-block;
        }

        .hamburger-btn {
            background: none;
            border: none;
            color: var(--tg-theme-text-color);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .hamburger-btn:hover {
            background: var(--tg-theme-border-color);
        }

        .hamburger-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--tg-theme-secondary-bg-color);
            border: 2px solid var(--tg-theme-border-color);
            border-radius: 12px;
            min-width: 200px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .hamburger-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            padding: 0.875rem 1.25rem;
            color: var(--tg-theme-text-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-bottom: 1px solid var(--tg-theme-border-color);
            transition: background 0.2s ease;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .dropdown-item:hover {
            background: var(--tg-theme-border-color);
            color: var(--tg-theme-text-color);
        }

        .dropdown-item:last-child {
            border-bottom: none;
            border-radius: 0 0 10px 10px;
        }

        .dropdown-item:first-child {
            border-radius: 10px 10px 0 0;
        }

        .dropdown-item.single {
            border-radius: 10px;
        }

        /* Enhanced visual improvements for modern UI */
        .card {
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 16px 32px rgba(0, 0, 0, 0.4),
                        0 8px 16px rgba(75, 93, 122, 0.2);
        }
        
        .btn {
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.6s ease;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        /* Tab improvements */
        .nav-tabs {
            border-bottom: 1px solid rgba(107, 139, 179, 0.2);
            margin-bottom: 2rem;
        }
        
        .nav-tabs .nav-link:hover {
            background: rgba(74, 144, 226, 0.05);
            color: var(--tg-theme-text-color);
        }
        
        /* Content area improvements */
        .tab-content {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Micro-interactions for better UX */
        .position-item, .trade-item {
            transition: all 0.3s ease;
        }
        
        .position-item:hover, .trade-item:hover {
            transform: translateX(4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        /* Loading states */
        .loading {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* SMC Signals Styling */
        .smc-signal-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--tg-theme-border-color);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .smc-signal-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            border-color: var(--tg-theme-button-color);
        }

        .smc-signal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .smc-signal-symbol {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--tg-theme-text-color);
            font-family: 'JetBrains Mono', monospace;
        }

        .smc-signal-direction {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .smc-signal-direction.long {
            background: rgba(82, 196, 26, 0.2);
            color: #52c41a;
            border: 1px solid rgba(82, 196, 26, 0.3);
        }

        .smc-signal-direction.short {
            background: rgba(255, 77, 79, 0.2);
            color: #ff4d4f;
            border: 1px solid rgba(255, 77, 79, 0.3);
        }

        .smc-confidence-bar {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.75rem 0;
        }

        .smc-confidence-progress {
            flex: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }

        .smc-confidence-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.8s ease;
            background: linear-gradient(90deg, #ff4d4f 0%, #faad14 50%, #52c41a 100%);
        }

        .smc-confidence-text {
            font-size: 0.8rem;
            font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            min-width: 45px;
            text-align: right;
        }

        .smc-signal-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin: 0.75rem 0;
        }

        .smc-detail-item {
            text-align: center;
            padding: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(107, 139, 179, 0.1);
        }

        .smc-detail-label {
            font-size: 0.7rem;
            color: var(--tg-theme-hint-color);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            margin-bottom: 0.25rem;
        }

        .smc-detail-value {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--tg-theme-text-color);
            font-family: 'JetBrains Mono', monospace;
        }

        .smc-reasoning {
            margin: 0.75rem 0;
            padding: 0.75rem;
            background: rgba(107, 139, 179, 0.05);
            border-radius: 8px;
            border-left: 3px solid var(--tg-theme-button-color);
        }

        .smc-reasoning-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--tg-theme-button-color);
            margin-bottom: 0.5rem;
        }

        .smc-reasoning-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .smc-reasoning-list li {
            font-size: 0.75rem;
            color: var(--tg-theme-hint-color);
            margin-bottom: 0.25rem;
            padding-left: 1rem;
            position: relative;
        }

        .smc-reasoning-list li::before {
            content: '▸';
            position: absolute;
            left: 0;
            color: var(--tg-theme-button-color);
        }

        .smc-signal-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .smc-signal-actions .btn {
            flex: 1;
            font-size: 0.8rem;
            padding: 0.5rem;
        }

        .smc-auto-trade-btn {
            background: linear-gradient(135deg, #52c41a, #73d13d);
            border: none;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .smc-auto-trade-btn:hover {
            background: linear-gradient(135deg, #73d13d, #95de64);
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(82, 196, 26, 0.4);
        }

        .smc-auto-trade-btn::after {
            content: '⚡';
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .smc-signal-strength {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .smc-signal-strength.weak {
            background: rgba(250, 173, 20, 0.2);
            color: #faad14;
            border: 1px solid rgba(250, 173, 20, 0.3);
        }

        .smc-signal-strength.moderate {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .smc-signal-strength.strong {
            background: rgba(82, 196, 26, 0.2);
            color: #52c41a;
            border: 1px solid rgba(82, 196, 26, 0.3);
        }

        .smc-signal-strength.very_strong {
            background: rgba(24, 144, 255, 0.2);
            color: #1890ff;
            border: 1px solid rgba(24, 144, 255, 0.3);
        }

        .smc-no-signals {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--tg-theme-hint-color);
        }

        .smc-no-signals-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .smc-no-signals-text {
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }

        .smc-no-signals-subtitle {
            font-size: 0.85rem;
            opacity: 0.7;
        }

        /* Auto-refresh indicator */
        .smc-auto-refresh {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: rgba(24, 144, 255, 0.1);
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid rgba(24, 144, 255, 0.2);
        }

        .smc-auto-refresh-text {
            font-size: 0.8rem;
            color: #1890ff;
        }

        .smc-auto-refresh-dot {
            width: 6px;
            height: 6px;
            background: #1890ff;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        @media (max-width: 576px) {
            .smc-signal-details {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .smc-signal-actions {
                flex-direction: column;
            }
            
            .smc-signal-actions .btn {
                width: 100%;
                margin: 0.25rem 0;
            }
        }
    </style>
</head>
<body>
    <div class="mini-app-container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">
                        <div class="live-indicator-dot"></div>
                    </div>
                    <div>
                        <h1>Trading Expert</h1>
                    </div>
                </div>
                
                <!-- Hamburger menu in top right corner -->
                <div class="hamburger-menu">
                    <div class="hamburger-button" onclick="toggleHamburgerMenu()">
                        <div class="hamburger-icon">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                    <div class="hamburger-dropdown" id="hamburger-dropdown">
                        <a href="#" class="dropdown-item" onclick="togglePaperTrading()">
                            <i data-feather="shield"></i>
                            <span id="paper-trading-text">Paper Trading: On</span>
                        </a>
                        <a href="#" class="dropdown-item" onclick="openApiKeysSettings()">
                            <i data-feather="key"></i>
                            API Keys
                        </a>
                        <a href="#" class="dropdown-item" onclick="showDiagnosticInfo()">
                            <i data-feather="activity"></i>
                            Trading Status
                        </a>
                    </div>
                </div>
            </div>
            <div id="user-info" style="margin-top: 0.25rem; font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; color: #ffffff !important; font-size: 0.8rem; text-shadow: 0 1px 4px rgba(0,0,0,0.8); font-weight: 500;">Loading...</div>
        </div>

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs justify-content-center" id="main-tabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="positions-tab" data-bs-toggle="tab" data-bs-target="#positions" type="button">
                    ▲ Positions
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="trading-tab" data-bs-toggle="tab" data-bs-target="#trading" type="button">
                    ⊞ Trading
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="portfolio-tab" data-bs-toggle="tab" data-bs-target="#portfolio" type="button">
                    ◈ Portfolio
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="smc-tab" data-bs-toggle="tab" data-bs-target="#smc-signals" type="button">
                    ⚡ SMC
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="main-tab-content">
            <!-- Positions Tab -->
            <div class="tab-pane fade show active" id="positions" role="tabpanel">
                <div class="position-summary-compact">
                    <div class="stat-item">
                        <div class="stat-value" id="total-positions">0</div>
                        <div class="stat-label">Positions</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-unrealized-pnl">$0.00</div>
                        <div class="stat-label">Unrealized</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-realized-pnl">$0.00</div>
                        <div class="stat-label">Realized</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-pnl">$0.00</div>
                        <div class="stat-label">Total P&L</div>
                    </div>
                </div>
                
                <!-- Close All Trades Button -->
                <div class="d-flex justify-content-center mb-3" id="close-all-container" style="display: none !important;">
                    <button class="btn btn-outline-warning" onclick="closeAllTrades()" id="close-all-btn">
                        ✕ Close All Trades
                    </button>
                </div>
                
                <div id="positions-list">
                    <div class="loading">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        Loading positions...
                    </div>
                </div>
            </div>

            <!-- Trading Tab -->
            <div class="tab-pane fade" id="trading" role="tabpanel">
                <div class="mb-3">
                    <button class="btn btn-primary" onclick="createNewTrade()">
                        ⊕ New Trade
                    </button>
                </div>
                
                <div id="trade-configs-list">
                    <div class="loading">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        Loading trade configurations...
                    </div>
                </div>
            </div>

            <!-- Portfolio Tab -->
            <div class="tab-pane fade" id="portfolio" role="tabpanel">
                <!-- Account Summary - Compact 2x3 Grid -->
                <div class="portfolio-summary">
                    <div class="portfolio-grid">
                        <div class="portfolio-stat">
                            <div class="stat-value" id="account-balance">$0.00</div>
                            <div class="stat-label">Balance</div>
                        </div>
                        <div class="portfolio-stat">
                            <div class="stat-value" id="margin-used">$0.00</div>
                            <div class="stat-label">Used</div>
                        </div>
                        <div class="portfolio-stat">
                            <div class="stat-value" id="free-margin">$0.00</div>
                            <div class="stat-label">Free</div>
                        </div>
                        <div class="portfolio-stat">
                            <div class="stat-value" id="margin-ratio">0%</div>
                            <div class="stat-label">Ratio</div>
                        </div>
                        <div class="portfolio-stat">
                            <div class="stat-value" id="realized-pnl">$0.00</div>
                            <div class="stat-label">Realized P&L</div>
                        </div>
                        <div class="portfolio-stat">
                            <div class="stat-value" id="total-pnl-portfolio">$0.00</div>
                            <div class="stat-label">Total P&L</div>
                        </div>
                    </div>
                </div>
                
                <div id="portfolio-details">
                    <div class="loading">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        Loading portfolio data...
                    </div>
                </div>
                
                <!-- Reset History Button -->
                <div class="d-flex justify-content-center mt-3">
                    <button class="btn btn-outline-warning" onclick="confirmResetHistory()" id="reset-history-btn">
                        🗑️ Reset History
                    </button>
                </div>
            </div>

            <!-- SMC Signals Tab -->
            <div class="tab-pane fade" id="smc-signals" role="tabpanel">
                <!-- SMC Controls -->
                <div class="smc-controls mb-3">
                    <div class="row g-2">
                        <div class="col-6">
                            <button class="btn btn-primary btn-sm w-100" onclick="refreshSmcSignals()">
                                <i data-feather="refresh-cw"></i> Refresh
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-outline-primary btn-sm w-100" onclick="openSymbolAnalysis()">
                                <i data-feather="search"></i> Analyze
                            </button>
                        </div>
                    </div>
                </div>

                <!-- SMC Status -->
                <div class="smc-status mb-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-muted">Smart Money Analysis</span>
                        <div class="d-flex align-items-center gap-2">
                            <div class="live-indicator-dot" id="smc-indicator"></div>
                            <span class="text-muted" id="smc-last-update">Never</span>
                        </div>
                    </div>
                </div>

                <!-- Signals Summary -->
                <div class="smc-summary mb-3">
                    <div class="position-summary-compact">
                        <div class="stat-item">
                            <div class="stat-value" id="smc-total-signals">0</div>
                            <div class="stat-label">Total Signals</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="smc-strong-signals">0</div>
                            <div class="stat-label">Strong</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="smc-bullish-signals">0</div>
                            <div class="stat-label">Bullish</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="smc-bearish-signals">0</div>
                            <div class="stat-label">Bearish</div>
                        </div>
                    </div>
                </div>

                <!-- Signal Strength Filter -->
                <div class="smc-filter mb-3">
                    <label class="form-label text-muted">Minimum Confidence</label>
                    <select class="form-control form-control-sm" id="confidence-filter" onchange="filterSignals()">
                        <option value="0">All Signals</option>
                        <option value="0.5">50%+ Confidence</option>
                        <option value="0.7" selected>70%+ Confidence</option>
                        <option value="0.8">80%+ Confidence</option>
                        <option value="0.9">90%+ Confidence</option>
                    </select>
                </div>

                <!-- Signals List -->
                <div id="smc-signals-list">
                    <div class="loading">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        Loading SMC signals...
                    </div>
                </div>
            </div>


            <!-- Credentials Tab -->
            <div class="tab-pane fade" id="credentials" role="tabpanel">
                <div class="mb-3">
                    <h6 class="text-primary">⚿ API Credentials Management</h6>
                    <p class="text-muted">Manage your exchange API credentials for live trading</p>
                </div>
                
                <div id="credentials-status" class="mb-4">
                    <div class="loading">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        Loading credentials status...
                    </div>
                </div>

                <div id="credentials-setup" class="hidden">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Add API Credentials</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Exchange</label>
                                <select class="form-control" id="exchange-select" onchange="handleExchangeChange()">
                                    <option value="binance" selected>Binance</option>
                                    <option value="lbank">LBank</option>
                                    <option value="okx">OKX</option>
                                    <option value="toobit">Toobit (Live Only)</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">API Key</label>
                                <input type="text" class="form-control" id="api-key-input" placeholder="Enter your API key">
                                <small class="text-muted">Your API key will be encrypted and stored securely</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">API Secret</label>
                                <input type="password" class="form-control" id="api-secret-input" placeholder="Enter your API secret">
                                <small class="text-muted">Your secret will be encrypted and stored securely</small>
                            </div>
                            <div class="mb-3" id="passphrase-group" style="display: none;">
                                <label class="form-label">Passphrase (if required)</label>
                                <input type="password" class="form-control" id="passphrase-input" placeholder="Enter passphrase if required">
                            </div>
                            <div class="mb-3" id="testnet-toggle-group" style="display: none;">
                                <label class="form-label">Trading Mode</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="testnet-mode-toggle" onchange="updateTestnetToggleLabel()">
                                    <label class="form-check-label" for="testnet-mode-toggle">
                                        <span id="testnet-mode-label">🔥 Live Mode (Real Trading)</span>
                                    </label>
                                </div>
                                <small class="text-muted" id="testnet-mode-description">Switch to testnet mode for safe testing</small>
                            </div>
                            <div class="two-column-grid">
                                <button class="btn btn-outline-secondary" onclick="cancelCredentialsSetup()">Cancel</button>
                                <button class="btn btn-primary" onclick="saveCredentials()">Save Credentials</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <div class="alert alert-info">
                        <strong>🔐 Security Information:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Your API credentials are encrypted using military-grade encryption</li>
                            <li>Only trading permissions are required - never share withdrawal access</li>
                            <li>All credentials are stored securely and never shared</li>
                            <li>You can delete your credentials at any time</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trade Configuration Modal -->
    <div class="modal fade" id="tradeModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title" id="tradeModalTitle">Configure Trade</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Trade Configuration Form - Single Page -->
                    <form id="tradeConfigForm" class="single-page-form">
                        <!-- Basic Configuration Section -->
                        <div class="config-section mb-4">
                            <h6 class="section-title">Basic Configuration</h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label required">Trading Pair</label>
                                    <select class="form-control" id="trade-symbol-select" required>
                                        <option value="">Select Symbol</option>
                                        <option value="BTCUSDT">BTC/USDT</option>
                                        <option value="ETHUSDT">ETH/USDT</option>
                                        <option value="BNBUSDT">BNB/USDT</option>
                                        <option value="ADAUSDT">ADA/USDT</option>
                                        <option value="SOLUSDT">SOL/USDT</option>
                                        <option value="XRPUSDT">XRP/USDT</option>
                                        <option value="DOTUSDT">DOT/USDT</option>
                                        <option value="DOGEUSDT">DOGE/USDT</option>
                                        <option value="LINKUSDT">LINK/USDT</option>
                                        <option value="LTCUSDT">LTC/USDT</option>
                                        <option value="MATICUSDT">MATIC/USDT</option>
                                        <option value="AVAXUSDT">AVAX/USDT</option>
                                        <option value="UNIUSDT">UNI/USDT</option>
                                    </select>
                                    <div class="validation-error" id="symbol-error"></div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label required">Position Side</label>
                                    <div class="two-column-grid">
                                        <button type="button" class="btn btn-outline-primary side-btn" data-side="long" onclick="setTradeSide('long')">
                                            ▲ Long
                                        </button>
                                        <button type="button" class="btn btn-outline-primary side-btn" data-side="short" onclick="setTradeSide('short')">
                                            ▼ Short
                                        </button>
                                    </div>
                                    <div class="validation-error" id="side-error"></div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label required">Margin</label>
                                    <div class="input-group">
                                        <span class="input-group-text">$</span>
                                        <input type="number" class="form-control" id="amount-input" placeholder="Enter amount" step="0.01" required>
                                    </div>
                                    <div class="validation-error" id="amount-error"></div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Leverage</label>
                                    <select class="form-control" id="leverage-select">
                                        <option value="1">1x</option>
                                        <option value="2">2x</option>
                                        <option value="5">5x</option>
                                        <option value="10" selected>10x</option>
                                        <option value="20">20x</option>
                                        <option value="50">50x</option>
                                        <option value="100">100x</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Entry Configuration Section -->
                        <div class="config-section mb-4">
                            <h6 class="section-title">Entry Configuration</h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label required">Entry Type</label>
                                    <div class="two-column-grid">
                                        <button type="button" class="btn btn-outline-primary entry-btn" data-type="market" onclick="setEntryType('market')">
                                            ⦿ Market
                                        </button>
                                        <button type="button" class="btn btn-outline-primary entry-btn" data-type="limit" onclick="setEntryType('limit')">
                                            ◉ Limit
                                        </button>
                                    </div>
                                    <div class="validation-error" id="entry-type-error"></div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div id="limit-price-input" class="hidden">
                                        <label class="form-label">Limit Price</label>
                                        <div class="input-group">
                                            <span class="input-group-text">$</span>
                                            <input type="number" class="form-control" id="entry-price" placeholder="Entry price" step="0.0001">
                                        </div>
                                        <div class="validation-error" id="entry-price-error"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Take Profit & Stop Loss Section -->
                        <div class="config-section mb-4">
                            <h6 class="section-title">Risk Management</h6>
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label class="form-label required">Take Profit Levels</label>
                                    <div id="tp-levels">
                                        <div class="input-group mb-2">
                                            <span class="input-group-text">TP1 %</span>
                                            <input type="number" class="form-control tp-percent" data-level="1" placeholder="5" step="0.1">
                                            <span class="input-group-text">Size %</span>
                                            <input type="number" class="form-control tp-allocation" data-level="1" placeholder="30" step="1" oninput="updateAllocationSummary()">
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-outline-primary btn-sm mb-2" onclick="addTpLevel()">+ Add TP Level</button>
                                    <div class="mt-2">
                                        <small class="text-muted">Total Position Allocation: <span id="total-allocation">0</span>% (remaining: <span id="remaining-allocation">100</span>%)</small>
                                    </div>
                                    <div class="validation-error" id="tp-error"></div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label required">Stop Loss</label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" id="stop-loss" placeholder="2" step="0.1" required>
                                        <span class="input-group-text">%</span>
                                    </div>
                                    <div class="validation-error" id="sl-error"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Settings Section -->
                        <div class="config-section">
                            <h6 class="section-title">Advanced Settings</h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Break-even Settings</label>
                                    <select class="form-control" id="breakeven-select">
                                        <option value="disabled">Disabled</option>
                                        <option value="tp1">After TP1</option>
                                        <option value="tp2">After TP2</option>
                                        <option value="tp3">After TP3</option>
                                    </select>
                                    <small class="text-muted">Move stop loss to break-even after take profit levels</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Trailing Stop</label>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="trailing-enabled" onchange="toggleTrailingStop()">
                                        <label class="form-check-label" for="trailing-enabled">
                                            Enable Trailing Stop
                                        </label>
                                    </div>
                                    <div id="trailing-options" class="hidden">
                                        <div class="mb-2">
                                            <label class="form-label">Trail Percentage</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" id="trail-percentage" placeholder="2" step="0.1" min="0.1">
                                                <span class="input-group-text">%</span>
                                            </div>
                                            <small class="text-muted">Percentage to trail behind best price</small>
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label">Activation Price (Optional)</label>
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control" id="trail-activation" placeholder="45500" step="0.01">
                                            </div>
                                            <small class="text-muted">Price at which trailing stop activates</small>
                                        </div>
                                    </div>
                                    <div class="validation-error" id="trailing-error"></div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="validateAndSaveTrade()">Save Trade Configuration</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Telegram Web App integration
        let tg = window.Telegram.WebApp;
        let currentUser = null;
        let currentTrade = null;
        let configStep = 0;
        const configSteps = ['symbol', 'side', 'amount', 'entry', 'tp', 'sl', 'breakeven', 'trailing'];
        
        // CRITICAL: Telegram WebApp Authentication
        // This handles sending initData to backend for authentication on page load
        function handleTelegramAuth() {
            try {
                if (window.Telegram?.WebApp) {
                    const initData = window.Telegram.WebApp.initData || '';
                    const urlParams = new URLSearchParams(window.location.search);
                    const authProcessed = urlParams.get('tg_auth_processed');
                    
                    // If we have initData but haven't processed auth yet, send auth data via AJAX
                    if (initData && !authProcessed) {
                        console.log('Telegram WebApp initData found, processing authentication...');
                        
                        // Check if URL already has tg_init_data to prevent double processing
                        const hasInitData = urlParams.get('tg_init_data');
                        if (!hasInitData) {
                            // Send auth data to server without page reload
                            fetch('/auth', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                },
                                body: new URLSearchParams({
                                    'tg_init_data': initData
                                })
                            }).then(response => {
                                if (response.ok) {
                                    console.log('Authentication successful, updating URL without reload');
                                    // Update URL without reload for clean state
                                    const newUrl = new URL(window.location);
                                    newUrl.searchParams.set('tg_auth_processed', '1');
                                    window.history.replaceState({}, '', newUrl.toString());
                                } else {
                                    console.error('Authentication failed:', response.status);
                                }
                            }).catch(error => {
                                console.error('Authentication error:', error);
                            });
                        } else {
                            console.log('Auth data already in URL, skipping auth');
                        }
                    }
                }
            } catch (error) {
                console.error('Telegram auth handling error:', error);
            }
        }
        
        // Call auth handler immediately
        handleTelegramAuth();
        
        // Initialize Telegram Web App with enhanced compatibility
        if (typeof tg !== 'undefined' && tg.ready) {
            tg.ready();
            tg.expand();
            
            // Check if showPopup is available (Telegram WebApp v6.1+)
            if (!tg.showPopup) {
                tg.showPopup = function(params) {
                    // Fallback to showAlert for older versions
                    if (tg.showAlert) {
                        tg.showAlert(params.message || 'Notification');
                    } else {
                        alert(params.message || 'Notification');
                    }
                };
            }
        } else {
            // Fallback for testing outside Telegram with dark theme
            tg = {
                backgroundColor: '#1a2332',
                textColor: '#e8eaed',
                buttonColor: '#2196f3',
                showAlert: function(message) { 
                    console.log('TG Alert:', message);
                    alert(message); 
                },
                showPopup: function(params) {
                    console.log('TG Popup:', params);
                    alert(params.message || 'Notification');
                },
                MainButton: {
                    setText: function() {},
                    show: function() {},
                    hide: function() {}
                }
            };
        }
        
        // Set up theme - Force high contrast colors for dark mode
        document.body.style.backgroundColor = '#000000';
        document.documentElement.style.setProperty('--tg-theme-bg-color', '#000000');
        document.documentElement.style.setProperty('--tg-theme-text-color', '#ffffff');
        document.documentElement.style.setProperty('--tg-theme-button-color', '#4a90e2');
        
        // Get user info
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            currentUser = tg.initDataUnsafe.user;
            document.getElementById('user-info').textContent = `Hi, ${currentUser.first_name}!`;
        } else {
            // Fallback for testing outside Telegram
            currentUser = { id: 123456789, first_name: 'Demo User' };
            document.getElementById('user-info').textContent = `Hi, ${currentUser.first_name}! (Demo Mode)`;
        }

        // Main button integration
        tg.MainButton.setText("Execute Trade");
        tg.MainButton.hide();

        // Helper function to get consistent user ID
        function getUserId() {
            return currentUser?.id || '123456789';
        }

        // Initialize Telegram WebApp
        let telegramWebApp = null;
        let telegramInitData = '';
        
        try {
            telegramWebApp = window.Telegram?.WebApp;
            if (telegramWebApp) {
                telegramWebApp.ready();
                telegramWebApp.expand();
                telegramInitData = telegramWebApp.initData || '';
                console.log('Telegram WebApp initialized:', telegramInitData ? 'initData captured' : 'no initData');
            }
        } catch (error) {
            console.log('Telegram WebApp not available:', error);
        }

        // API Functions with request deduplication
        const apiCallCache = new Map();
        const pendingRequests = new Map();
        
        async function apiCall(endpoint, options = {}) {
            // Create cache key based on endpoint and method
            const method = options.method || 'GET';
            const cacheKey = `${method}:${endpoint}`;
            
            // For GET requests, check if we have a recent cached result
            if (method === 'GET') {
                const cached = apiCallCache.get(cacheKey);
                if (cached && Date.now() - cached.timestamp < 1500) { // 1.5 second cache
                    console.log(`Using cached result for ${endpoint}`);
                    return cached.data;
                }
                
                // If there's already a pending request for this endpoint, wait for it
                if (pendingRequests.has(cacheKey)) {
                    console.log(`Waiting for pending request to ${endpoint}`);
                    return await pendingRequests.get(cacheKey);
                }
            }
            
            try {
                // Prepare headers with Telegram initData
                const headers = {
                    'Content-Type': 'application/json',
                    'X-Telegram-User-ID': getUserId(),
                    ...options.headers
                };
                
                // Add initData if available
                if (telegramInitData) {
                    headers['X-Telegram-Init-Data'] = telegramInitData;
                }
                
                const requestPromise = fetch(endpoint, {
                    headers: headers,
                    ...options
                }).then(async response => {
                    if (!response.ok) {
                        console.error(`HTTP error! status: ${response.status} for ${endpoint}`);
                        return null;
                    }
                    return await response.json();
                });
                
                // Store pending request to avoid duplicates
                if (method === 'GET') {
                    pendingRequests.set(cacheKey, requestPromise);
                }
                
                const result = await requestPromise;
                
                // Cache successful GET results
                if (method === 'GET' && result !== null) {
                    apiCallCache.set(cacheKey, {
                        data: result,
                        timestamp: Date.now()
                    });
                }
                
                // Clean up pending request
                if (method === 'GET') {
                    pendingRequests.delete(cacheKey);
                }
                
                return result;
            } catch (error) {
                console.error('API call failed:', error);
                pendingRequests.delete(cacheKey);
                return null;
            }
        }

        // State management for expanded positions
        function saveExpandedState(type, id, isExpanded) {
            const expandedStates = JSON.parse(localStorage.getItem('expandedStates') || '{}');
            if (!expandedStates[type]) expandedStates[type] = {};
            expandedStates[type][id] = isExpanded;
            localStorage.setItem('expandedStates', JSON.stringify(expandedStates));
        }

        function getExpandedState(type, id) {
            const expandedStates = JSON.parse(localStorage.getItem('expandedStates') || '{}');
            return expandedStates[type] && expandedStates[type][id];
        }

        // Toggle position collapse/expand
        function togglePosition(index) {
            const content = document.getElementById(`content-${index}`);
            const icon = document.getElementById(`icon-${index}`);
            const header = content.previousElementSibling;
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                header.classList.remove('expanded');
                icon.classList.remove('expanded');
                saveExpandedState('positions', index, false);
            } else {
                content.classList.add('expanded');
                header.classList.add('expanded');
                icon.classList.add('expanded');
                saveExpandedState('positions', index, true);
            }
        }

        // Toggle trade configuration collapse/expand
        function toggleTrade(index) {
            const content = document.getElementById(`trade-content-${index}`);
            const icon = document.getElementById(`trade-icon-${index}`);
            const header = content.previousElementSibling;
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                header.classList.remove('expanded');
                icon.classList.remove('expanded');
                saveExpandedState('trades', index, false);
            } else {
                content.classList.add('expanded');
                header.classList.add('expanded');
                icon.classList.add('expanded');
                saveExpandedState('trades', index, true);
            }
        }
        
        // Toggle history section collapse/expand
        function toggleHistorySection() {
            const content = document.getElementById('history-content');
            const icon = document.getElementById('history-icon');
            const header = content.previousElementSibling;
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                header.classList.remove('expanded');
                icon.classList.remove('expanded');
                saveExpandedState('sections', 'history', false);
            } else {
                content.classList.add('expanded');
                header.classList.add('expanded');
                icon.classList.add('expanded');
                saveExpandedState('sections', 'history', true);
            }
        }

        // Toggle active positions section collapse/expand
        function toggleActivePositionsSection() {
            const content = document.getElementById('active-positions-content');
            const icon = document.getElementById('active-positions-icon');
            const header = content.previousElementSibling;
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                header.classList.remove('expanded');
                icon.classList.remove('expanded');
                saveExpandedState('sections', 'active-positions', false);
            } else {
                content.classList.add('expanded');
                header.classList.add('expanded');
                icon.classList.add('expanded');
                saveExpandedState('sections', 'active-positions', true);
            }
        }

        // Live price update variables
        let livePriceInterval = null;
        let isLivePriceUpdateActive = false;
        const PRICE_UPDATE_INTERVAL = 10000; // 10 seconds - from centralized config
        const SLOW_RESPONSE_THRESHOLD = 3000; // 3 seconds - threshold for slow response
        const ERROR_RESPONSE_THRESHOLD = 8000; // 8 seconds - threshold for error status

        // Update live indicator status with tooltips
        function updateLiveIndicatorStatus(status) {
            const indicators = document.querySelectorAll('.live-indicator-dot');
            const statusMessages = {
                'connected': 'Connected - Fast API response',
                'slow': 'Slow connection - API response delayed',
                'error': 'Connection error - API not responding'
            };
            
            indicators.forEach(indicator => {
                // Remove all status classes
                indicator.classList.remove('connected', 'slow', 'error');
                // Add new status class
                indicator.classList.add(status);
                // Update tooltip
                indicator.title = statusMessages[status] || 'Unknown status';
            });
        }

        // Live price update function with connectivity monitoring
        async function updateLivePrices() {
            if (!isLivePriceUpdateActive) return;
            
            const startTime = Date.now();
            
            try {
                // Set indicator to show we're making a request
                const currentStatus = document.querySelector('.live-indicator-dot')?.classList.contains('error') ? 'error' : 'connected';
                
                const data = await apiCall(`/api/positions/live-update?user_id=${getUserId()}`);
                const responseTime = Date.now() - startTime;
                
                // Update indicator based on response time and data validity
                if (!data || !data.positions) {
                    updateLiveIndicatorStatus('error');
                    return;
                } else if (responseTime > ERROR_RESPONSE_THRESHOLD) {
                    updateLiveIndicatorStatus('error');
                } else if (responseTime > SLOW_RESPONSE_THRESHOLD) {
                    updateLiveIndicatorStatus('slow');
                } else {
                    updateLiveIndicatorStatus('connected');
                }
                
                // Update active position prices and P&L
                Object.entries(data.positions).forEach(([tradeId, positionData]) => {
                    updatePositionPriceDisplay(tradeId, positionData);
                });
                
                // Update total unrealized P&L (Active Positions section)
                const totalUnrealizedElement = document.getElementById('total-unrealized-pnl');
                if (totalUnrealizedElement && data.total_unrealized_pnl !== undefined) {
                    totalUnrealizedElement.textContent = `$${data.total_unrealized_pnl.toFixed(2)}`;
                    totalUnrealizedElement.style.color = data.total_unrealized_pnl >= 0 ? '#28a745' : '#dc3545';
                }
                
                // Update total realized P&L
                const totalRealizedElement = document.getElementById('total-realized-pnl');
                if (totalRealizedElement && data.total_realized_pnl !== undefined) {
                    totalRealizedElement.textContent = `$${data.total_realized_pnl.toFixed(2)}`;
                    totalRealizedElement.style.color = data.total_realized_pnl >= 0 ? '#28a745' : '#dc3545';
                }
                
                // Update total P&L
                const totalPnlElement = document.getElementById('total-pnl');
                if (totalPnlElement && data.total_pnl !== undefined) {
                    totalPnlElement.textContent = `$${data.total_pnl.toFixed(2)}`;
                    totalPnlElement.style.color = data.total_pnl >= 0 ? '#28a745' : '#dc3545';
                }
                
                // Update positions tab total P&L (main totals) - should include realized + unrealized
                const positionsTabTotalPnl = document.getElementById('total-pnl');
                if (positionsTabTotalPnl && data.total_pnl !== undefined) {
                    positionsTabTotalPnl.textContent = `$${data.total_pnl.toFixed(2)}`;
                    positionsTabTotalPnl.style.color = data.total_pnl >= 0 ? '#28a745' : '#dc3545';
                }
                
                // Update total active positions count
                const totalPositionsElement = document.getElementById('total-positions');
                if (totalPositionsElement && data.active_positions_count !== undefined) {
                    totalPositionsElement.textContent = data.active_positions_count;
                }
                
                // Update portfolio tab totals if on portfolio tab
                if (currentActiveTab === 'portfolio') {
                    // Refresh portfolio summary data
                    const portfolioData = await apiCall(`/api/positions?user_id=${getUserId()}`);
                    if (portfolioData && portfolioData.summary) {
                        const summary = portfolioData.summary;
                        document.getElementById('account-balance').textContent = `$${summary.account_balance?.toFixed(2) || '0.00'}`;
                        document.getElementById('margin-used').textContent = `$${summary.total_margin_used?.toFixed(2) || '0.00'}`;
                        document.getElementById('free-margin').textContent = `$${summary.free_margin?.toFixed(2) || '0.00'}`;
                        
                        // Update portfolio total P&L with real-time data
                        const portfolioTotalPnlElement = document.getElementById('total-pnl-portfolio');
                        if (portfolioTotalPnlElement) {
                            const totalPnl = summary.total_pnl || 0;
                            portfolioTotalPnlElement.textContent = `$${totalPnl.toFixed(2)}`;
                            portfolioTotalPnlElement.style.color = totalPnl >= 0 ? '#28a745' : '#dc3545';
                        }
                        
                        // Update margin ratio
                        const marginRatioElement = document.getElementById('margin-ratio');
                        if (marginRatioElement && summary.account_balance > 0) {
                            const ratio = ((summary.total_margin_used || 0) / summary.account_balance) * 100;
                            marginRatioElement.textContent = `${ratio.toFixed(1)}%`;
                        }
                    }
                }
                
                console.log('Live prices updated:', data.timestamp, `(${Date.now() - startTime}ms)`);
            } catch (error) {
                console.error('Error updating live prices:', error);
                // Set indicator to error state on API failure
                updateLiveIndicatorStatus('error');
            }
        }

        // Update initial totals when loading positions
        async function updateInitialTotals() {
            try {
                const data = await apiCall(`/api/positions/live-update?user_id=${getUserId()}`);
                if (!data) return;
                
                // Update total unrealized P&L
                const totalUnrealizedPnlElement = document.getElementById('total-unrealized-pnl');
                if (totalUnrealizedPnlElement && data.total_unrealized_pnl !== undefined) {
                    totalUnrealizedPnlElement.textContent = `$${data.total_unrealized_pnl.toFixed(2)}`;
                    totalUnrealizedPnlElement.style.color = data.total_unrealized_pnl >= 0 ? '#28a745' : '#dc3545';
                }
                
                // Update total realized P&L
                const totalRealizedPnlElement = document.getElementById('total-realized-pnl');
                if (totalRealizedPnlElement && data.total_realized_pnl !== undefined) {
                    totalRealizedPnlElement.textContent = `$${data.total_realized_pnl.toFixed(2)}`;
                    totalRealizedPnlElement.style.color = data.total_realized_pnl >= 0 ? '#28a745' : '#dc3545';
                }
                
                // Update total P&L (realized + unrealized)
                const totalPnlElement = document.getElementById('total-pnl');
                if (totalPnlElement && data.total_pnl !== undefined) {
                    totalPnlElement.textContent = `$${data.total_pnl.toFixed(2)}`;
                    totalPnlElement.style.color = data.total_pnl >= 0 ? '#28a745' : '#dc3545';
                }
                
                // Update active positions count
                const totalPositionsElement = document.getElementById('total-positions');
                if (totalPositionsElement && data.active_positions_count !== undefined) {
                    totalPositionsElement.textContent = data.active_positions_count;
                }
            } catch (error) {
                console.error('Error updating initial totals:', error);
            }
        }

        // Update individual position price display
        function updatePositionPriceDisplay(tradeId, positionData) {
            // Update current price
            const priceElement = document.querySelector(`[data-trade-id="${tradeId}"] .current-price`);
            if (priceElement && positionData.current_price) {
                priceElement.textContent = `$${positionData.current_price.toFixed(4)}`;
                
                // Add price change indicator
                if (positionData.price_change_percentage !== undefined) {
                    const changeClass = positionData.price_change_percentage >= 0 ? 'text-success' : 'text-danger';
                    const changeSymbol = positionData.price_change_percentage >= 0 ? '+' : '';
                    priceElement.innerHTML = `$${positionData.current_price.toFixed(4)} <small class="${changeClass}">${changeSymbol}${positionData.price_change_percentage.toFixed(2)}%</small>`;
                }
            }
            
            // Update unrealized P&L (detail view)
            const pnlElement = document.querySelector(`[data-trade-id="${tradeId}"] .unrealized-pnl`);
            if (pnlElement && positionData.unrealized_pnl !== undefined) {
                pnlElement.textContent = `$${positionData.unrealized_pnl.toFixed(2)}`;
                pnlElement.style.color = positionData.unrealized_pnl >= 0 ? '#28a745' : '#dc3545';
            }
            
            // Update floating P&L (detailed position view)
            const floatingPnlElement = document.querySelector(`[data-trade-id="${tradeId}"] .floating-pnl`);
            if (floatingPnlElement && positionData.unrealized_pnl !== undefined) {
                floatingPnlElement.textContent = `$${positionData.unrealized_pnl.toFixed(2)}`;
                floatingPnlElement.style.color = positionData.unrealized_pnl >= 0 ? '#28a745' : '#dc3545';
            }
            
            // Update realized P&L (detailed position view)
            const tradeCard = document.querySelector(`[data-trade-id="${tradeId}"]`);
            if (tradeCard && positionData.realized_pnl !== undefined) {
                // Find elements by traversing through small labels looking for "Realized P&L:"
                const smallElements = tradeCard.querySelectorAll('small.text-muted');
                smallElements.forEach(smallEl => {
                    if (smallEl.textContent && smallEl.textContent.includes('Realized P&L:')) {
                        // Find the next sibling strong element
                        let nextEl = smallEl.nextSibling;
                        while (nextEl) {
                            if (nextEl.nodeName === 'BR') {
                                nextEl = nextEl.nextSibling;
                                continue;
                            }
                            if (nextEl.nodeName === 'STRONG') {
                                nextEl.textContent = `$${positionData.realized_pnl.toFixed(2)}`;
                                nextEl.style.color = positionData.realized_pnl >= 0 ? '#28a745' : '#dc3545';
                                break;
                            }
                            nextEl = nextEl.nextSibling;
                        }
                    }
                });
            }
            
            // Update total P&L (header view) - use total_pnl from API response
            const totalPnlElement = document.querySelector(`[data-trade-id="${tradeId}"] .total-pnl`);
            if (totalPnlElement && positionData.total_pnl !== undefined) {
                totalPnlElement.textContent = `$${positionData.total_pnl.toFixed(2)}`;
                totalPnlElement.style.color = positionData.total_pnl >= 0 ? '#28a745' : '#dc3545';
            }
            
            // Update ROE percentage
            const roeElement = document.querySelector(`[data-trade-id="${tradeId}"] .roe-percentage`);
            if (roeElement && positionData.roe_percentage !== undefined) {
                roeElement.textContent = `${positionData.roe_percentage.toFixed(2)}%`;
                roeElement.style.color = positionData.roe_percentage >= 0 ? '#28a745' : '#dc3545';
            }
        }

        // Debounce mechanism to prevent rapid start/stop cycles
        let livePriceDebounceTimeout = null;
        
        // Start live price updates with debouncing
        function startLivePriceUpdates() {
            if (livePriceDebounceTimeout) {
                clearTimeout(livePriceDebounceTimeout);
                livePriceDebounceTimeout = null;
            }
            
            if (isLivePriceUpdateActive) return;
            
            isLivePriceUpdateActive = true;
            updateLivePrices(); // Initial update
            livePriceInterval = setInterval(updateLivePrices, PRICE_UPDATE_INTERVAL);
            console.log('Live price updates started');
        }

        // Stop live price updates with debouncing
        function stopLivePriceUpdates() {
            if (livePriceDebounceTimeout) {
                clearTimeout(livePriceDebounceTimeout);
            }
            
            livePriceDebounceTimeout = setTimeout(() => {
                if (!isLivePriceUpdateActive) return;
                
                isLivePriceUpdateActive = false;
                if (livePriceInterval) {
                    clearInterval(livePriceInterval);
                    livePriceInterval = null;
                }
                console.log('Live price updates stopped');
                livePriceDebounceTimeout = null;
            }, 100); // Small delay to prevent rapid cycling
        }

        // Load data functions
        async function loadPositions() {
            // Show loading state
            showTabLoading('positions-list', 'Loading positions...');
            
            // Always reload paper trading status to prevent flashing
            await loadPaperTradingStatus();
            
            const data = await apiCall(`/api/positions?user_id=${getUserId()}`);
            if (!data) return;
            
            const container = document.getElementById('positions-list');
            const activePositions = data.positions?.filter(t => t.status === 'active' || t.status === 'pending') || [];
            const closedPositions = data.positions?.filter(t => t.status === 'stopped') || [];
            
            document.getElementById('total-positions').textContent = activePositions.length;
            
            // Get initial PnL totals from API (to avoid conflicts with live updates)
            updateInitialTotals();
            
            // Show/hide Close All Trades button based on active positions
            const closeAllContainer = document.getElementById('close-all-container');
            if (closeAllContainer) {
                if (activePositions.length > 1) {
                    closeAllContainer.style.display = 'flex';
                } else {
                    closeAllContainer.style.display = 'none';
                }
            }
            
            let content = '';
            
            // Active Positions Section
            if (activePositions.length === 0) {
                content += '<div class="text-center py-4"><small class="text-muted">No active or pending positions</small></div>';
            } else {
            
            content += activePositions.map((pos, index) => `
                <div class="position-item" data-trade-id="${pos.trade_id}">
                    <div class="collapsible-header" onclick="togglePosition(${index})">
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <div>
                                <strong>${pos.symbol}</strong>
                                <span class="status-badge status-${pos.status} ms-2">${pos.side.toUpperCase()}</span>
                                ${pos.status === 'pending' ? '<small class="text-info ms-1">(PENDING)</small>' : ''}
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="text-end me-3">
                                    <div class="stat-value total-pnl" style="color: ${((pos.unrealized_pnl || 0) + (pos.realized_pnl || 0)) >= 0 ? '#28a745' : '#dc3545'}">
                                        $${((pos.unrealized_pnl || 0) + (pos.realized_pnl || 0)).toFixed(2)}
                                    </div>
                                    <small class="text-muted">Total P&L</small>
                                </div>
                                <span class="expand-icon" id="icon-${index}">▼</span>
                            </div>
                        </div>
                    </div>
                    <div class="collapsible-content" id="content-${index}">
                    
                    <!-- Position Details -->
                    <div class="row mt-2">
                        <div class="col-4">
                            <small class="text-muted">Position Size:</small><br>
                            <strong>$${pos.position_size || (pos.amount * pos.leverage) || '0'}</strong>
                            <br><small class="text-muted">Margin: $${pos.amount || '0'}</small>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Leverage:</small><br>
                            <strong>${pos.leverage}x</strong>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Entry:</small><br>
                            <strong>$${pos.entry_price || 'Market'}</strong>
                        </div>
                    </div>
                    
                    <!-- Current Price & ROE -->
                    ${pos.current_price ? `
                    <div class="row mt-2">
                        <div class="col-6">
                            <small class="text-muted">Current Price:</small><br>
                            <strong class="current-price">$${pos.current_price}</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">ROE:</small><br>
                            <strong class="roe-percentage" style="color: ${calculateROE(pos) >= 0 ? '#28a745' : '#dc3545'}">
                                ${calculateROE(pos).toFixed(2)}%
                            </strong>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Take Profit & Stop Loss with Prices and P&L -->
                    <div class="mt-2">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Take Profits:</small><br>
                                <div style="font-size: 0.85rem;">
                                    ${pos.tp_sl_calculations && pos.tp_sl_calculations.take_profits && pos.tp_sl_calculations.take_profits.length > 0 ? 
                                        (() => {
                                            let cumulativeAllocation = 0;
                                            return pos.tp_sl_calculations.take_profits.map(tp => {
                                                cumulativeAllocation += tp.allocation || 0;
                                                return `<div><strong>TP${tp.level} ${tp.percentage?.toFixed(1)}%(${tp.allocation || 0}%):</strong> $${tp.price.toFixed(4)} <span style="color: #28a745;">(+$${tp.profit_amount.toFixed(2)})</span></div>`;
                                            }).join('');
                                        })() : 
                                        '<strong>Not set</strong>'}
                                </div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Stop Loss:</small><br>
                                <div style="font-size: 0.85rem;">
                                    ${pos.tp_sl_calculations && pos.tp_sl_calculations.stop_loss && pos.tp_sl_calculations.stop_loss.price ? 
                                        (pos.tp_sl_calculations.stop_loss.is_breakeven ? 
                                            `<div><strong>SL:</strong> $${pos.tp_sl_calculations.stop_loss.price.toFixed(4)} <span style="color: #52c41a;">(Break-even)</span></div>` :
                                            `<div><strong>SL:</strong> $${pos.tp_sl_calculations.stop_loss.price.toFixed(4)} <span style="color: #dc3545;">(-$${pos.tp_sl_calculations.stop_loss.loss_amount.toFixed(2)})</span></div>`
                                        ) : 
                                        '<strong>Not set</strong>'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- P&L Breakdown -->
                    <div class="row mt-2">
                        <div class="col-6">
                            <small class="text-muted">Realized P&L:</small><br>
                            <strong style="color: ${(pos.realized_pnl || 0) >= 0 ? '#28a745' : '#dc3545'}">
                                $${(pos.realized_pnl || 0).toFixed(2)}
                            </strong>
                            ${(pos.realized_pnl || 0) > 0 ? '<br><small class="text-muted">(From TPs)</small>' : ''}
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Floating P&L:</small><br>
                            <strong class="floating-pnl" style="color: ${(pos.unrealized_pnl || 0) >= 0 ? '#28a745' : '#dc3545'}">
                                $${(pos.unrealized_pnl || 0).toFixed(2)}
                            </strong>
                            <br><small class="text-muted">(Current)</small>
                        </div>
                    </div>

                    <!-- Margin Info -->
                    <div class="row mt-2">
                        <div class="col-6">
                            <small class="text-muted">Margin Used:</small><br>
                            <strong>$${(pos.position_margin || 0).toFixed(2)}</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Status:</small><br>
                            <strong class="text-${pos.status === 'active' ? 'success' : pos.status === 'pending' ? 'warning' : 'danger'}">
                                ${pos.status.toUpperCase()}
                            </strong>
                        </div>
                    </div>
                    
                    <div class="trade-controls mt-2" style="display: grid; grid-template-columns: ${pos.status === 'pending' ? '1fr 1fr' : '1fr 1fr'}; gap: 0.5rem;">
                        ${pos.status === 'pending' ? 
                            `<button class="btn btn-outline-warning btn-sm" onclick="cancelPendingOrder('${pos.trade_id}')">
                                <i class="fas fa-times"></i> Cancel Order
                            </button>
                            <button class="btn btn-outline-primary btn-sm" onclick="editTrade('${pos.trade_id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>` :
                            `<button class="btn btn-outline-primary btn-sm" onclick="editTrade('${pos.trade_id}')">
                                ⚙ Edit
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="closeTrade('${pos.trade_id}')">
                                ✕ Close
                            </button>`}
                    </div>
                    </div>
                </div>
            `).join('');
            }
            

            
            container.innerHTML = content;
            
            // Restore expanded states after content update
            setTimeout(() => {
                activePositions.forEach((pos, index) => {
                    if (getExpandedState('positions', index)) {
                        const content = document.getElementById(`content-${index}`);
                        const icon = document.getElementById(`icon-${index}`);
                        const header = content?.previousElementSibling;
                        
                        if (content && icon && header) {
                            content.classList.add('expanded');
                            header.classList.add('expanded');
                            icon.classList.add('expanded');
                        }
                    }
                });
            }, 50);
            
            // Note: Live price updates are managed by handleTabSwitch function
        }

        async function loadTradeConfigs() {
            console.log('Loading trade configs...');
            // Show loading state
            showTabLoading('trade-configs-list', 'Loading trading configurations...');
            
            const data = await apiCall(`/api/user-trades?user_id=${getUserId()}`);
            if (!data) {
                console.log('No data received from API');
                return;
            }
            
            const container = document.getElementById('trade-configs-list');
            if (!container) {
                console.log('Trade configs container not found');
                return;
            }
            
            // Only show trades that are still in configuration phase (not executed)
            const trades = data.trades?.filter(t => t.status === 'configured' || !t.status) || [];
            console.log(`Found ${trades.length} configured trades:`, trades);
            
            if (trades.length === 0) {
                console.log('No configured trades found, showing empty state');
                container.innerHTML = '<div class="text-center py-4"><small class="text-muted">No trade configurations</small></div>';
                return;
            }
            
            console.log('Rendering trades...');
            
            const tradesHtml = trades.map((trade, index) => `
                <div class="position-item">
                    <div class="collapsible-header" onclick="toggleTrade(${index})">
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <div>
                                <strong>${trade.name}</strong>
                                <span class="status-badge status-${trade.status} ms-2">${trade.status}</span>
                            </div>
                            <div class="d-flex align-items-center">
                                ${trade.status === 'active' && trade.unrealized_pnl !== undefined ? 
                                    `<div class="text-end me-3">
                                        <div class="stat-value" style="color: ${trade.unrealized_pnl >= 0 ? '#28a745' : '#dc3545'}">
                                            $${trade.unrealized_pnl.toFixed(2)}
                                        </div>
                                        <small class="text-muted">P&L</small>
                                    </div>` : 
                                    `<div class="text-end me-3">
                                        <div class="stat-value" style="color: var(--tg-theme-text-color)">
                                            ${trade.symbol || 'No Symbol'}
                                        </div>
                                        <small class="text-muted">Symbol</small>
                                    </div>`
                                }
                                <span class="expand-icon" id="trade-icon-${index}">▼</span>
                            </div>
                        </div>
                    </div>
                    <div class="collapsible-content" id="trade-content-${index}">
                    <div class="progress-indicator">
                        ${getTradeProgress(trade)}
                    </div>
                    
                    <!-- Basic Trade Info -->
                    <div class="row mt-2">
                        <div class="col-6">
                            <small class="text-muted">Symbol:</small><br>
                            <strong>${trade.symbol || 'Not set'}</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Side:</small><br>
                            <strong>${trade.side ? trade.side.toUpperCase() : 'Not set'}</strong>
                        </div>
                    </div>
                    
                    ${trade.status === 'active' ? `
                    <!-- Active Trade Details -->
                    <div class="row mt-2">
                        <div class="col-4">
                            <small class="text-muted">Position Size:</small><br>
                            <strong>$${trade.position_size || (trade.amount * trade.leverage) || '0'}</strong>
                            <br><small class="text-muted">Margin: $${trade.amount || '0'}</small>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Leverage:</small><br>
                            <strong>${trade.leverage || '1'}x</strong>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Entry:</small><br>
                            <strong>$${trade.entry_price || 'Market'}</strong>
                        </div>
                    </div>
                    
                    <!-- Take Profit & Stop Loss with Prices and P&L -->
                    <div class="mt-2">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Take Profits:</small><br>
                                <div style="font-size: 0.85rem;">
                                    ${trade.tp_sl_calculations && trade.tp_sl_calculations.take_profits && trade.tp_sl_calculations.take_profits.length > 0 ? 
                                        (() => {
                                            let cumulativeAllocation = 0;
                                            return trade.tp_sl_calculations.take_profits.map(tp => {
                                                cumulativeAllocation += tp.allocation || 0;
                                                return `<div><strong>TP${tp.level} ${tp.percentage?.toFixed(1)}%(${tp.allocation || 0}%):</strong> $${tp.price.toFixed(4)} <span style="color: #28a745;">(+$${tp.profit_amount.toFixed(2)})</span></div>`;
                                            }).join('');
                                        })() : 
                                        '<strong>Not set</strong>'}
                                </div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Stop Loss:</small><br>
                                <div style="font-size: 0.85rem;">
                                    ${trade.tp_sl_calculations && trade.tp_sl_calculations.stop_loss && trade.tp_sl_calculations.stop_loss.price ? 
                                        (trade.tp_sl_calculations.stop_loss.is_breakeven ? 
                                            `<div><strong>SL:</strong> $${trade.tp_sl_calculations.stop_loss.price.toFixed(4)} <span style="color: #52c41a;">(Break-even)</span></div>` :
                                            `<div><strong>SL:</strong> $${trade.tp_sl_calculations.stop_loss.price.toFixed(4)} <span style="color: #dc3545;">(-$${trade.tp_sl_calculations.stop_loss.loss_amount.toFixed(2)})</span></div>`
                                        ) : 
                                        '<strong>Not set</strong>'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${trade.current_price ? `
                    <div class="row mt-2">
                        <div class="col-6">
                            <small class="text-muted">Current Price:</small><br>
                            <strong>$${trade.current_price}</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">ROE:</small><br>
                            <strong style="color: ${calculateROE(trade) >= 0 ? '#28a745' : '#dc3545'}">
                                ${calculateROE(trade).toFixed(2)}%
                            </strong>
                        </div>
                    </div>
                    
                    <!-- P&L Breakdown for Active Trades -->
                    <div class="row mt-2">
                        <div class="col-6">
                            <small class="text-muted">Realized P&L:</small><br>
                            <strong style="color: ${(trade.realized_pnl || 0) >= 0 ? '#28a745' : '#dc3545'}">
                                $${(trade.realized_pnl || 0).toFixed(2)}
                            </strong>
                            ${(trade.realized_pnl || 0) > 0 ? '<br><small class="text-muted">(From TPs)</small>' : ''}
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Floating P&L:</small><br>
                            <strong style="color: ${(trade.unrealized_pnl || 0) >= 0 ? '#28a745' : '#dc3545'}">
                                $${(trade.unrealized_pnl || 0).toFixed(2)}
                            </strong>
                            <br><small class="text-muted">(Current)</small>
                        </div>
                    </div>
                    ` : ''}
                    ` : `
                    <!-- Configuration Details for Non-Active Trades -->
                    <div class="row mt-2">
                        <div class="col-4">
                            <small class="text-muted">Position Size:</small><br>
                            <strong>${trade.position_size ? '$' + trade.position_size : trade.amount && trade.leverage ? '$' + (trade.amount * trade.leverage) : 'Not set'}</strong>
                            ${trade.amount ? '<br><small class="text-muted">Margin: $' + trade.amount + '</small>' : ''}
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Leverage:</small><br>
                            <strong>${trade.leverage ? trade.leverage + 'x' : 'Not set'}</strong>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Entry:</small><br>
                            <strong>${trade.entry_price ? '$' + trade.entry_price : trade.entry_type === 'market' ? 'Market' : 'Not set'}</strong>
                        </div>
                    </div>
                    
                    <!-- Take Profit & Stop Loss for Configured Trades with Prices and P&L -->
                    <div class="mt-2">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Take Profits:</small><br>
                                <div style="font-size: 0.85rem;">
                                    ${trade.tp_sl_calculations && trade.tp_sl_calculations.take_profits && trade.tp_sl_calculations.take_profits.length > 0 ? 
                                        (() => {
                                            let cumulativeAllocation = 0;
                                            return trade.tp_sl_calculations.take_profits.map(tp => {
                                                cumulativeAllocation += tp.allocation || 0;
                                                return `<div><strong>TP${tp.level} ${tp.percentage?.toFixed(1)}%(${tp.allocation || 0}%):</strong> $${tp.price.toFixed(4)} <span style="color: #28a745;">(+$${tp.profit_amount.toFixed(2)})</span></div>`;
                                            }).join('');
                                        })() : 
                                        trade.take_profits && trade.take_profits.length > 0 ? 
                                            (() => {
                                                let cumulativeAllocation = 0;
                                                return trade.take_profits.map((tp, idx) => {
                                                    const allocation = tp.allocation || 0;
                                                    return `<div><strong>TP${idx+1} ${tp.percentage || tp}%(${allocation}%):</strong></div>`;
                                                }).join('');
                                            })() :
                                        '<strong>Not set</strong>'}
                                </div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Stop Loss:</small><br>
                                <div style="font-size: 0.85rem;">
                                    ${trade.tp_sl_calculations && trade.tp_sl_calculations.stop_loss && trade.tp_sl_calculations.stop_loss.price ? 
                                        (trade.tp_sl_calculations.stop_loss.is_breakeven ? 
                                            `<div><strong>SL:</strong> $${trade.tp_sl_calculations.stop_loss.price.toFixed(4)} <span style="color: #52c41a;">(Break-even)</span></div>` :
                                            `<div><strong>SL:</strong> $${trade.tp_sl_calculations.stop_loss.price.toFixed(4)} <span style="color: #dc3545;">(-$${trade.tp_sl_calculations.stop_loss.loss_amount.toFixed(2)})</span></div>`
                                        ) : 
                                        trade.stop_loss_percent > 0 ? 
                                            `<div><strong>SL:</strong> ${trade.stop_loss_percent}%</div>` :
                                        (trade.stop_loss_percent == 0 && trade.status === 'active' ?
                                            `<div><strong>SL:</strong> Break-even</div>` :
                                        '<strong>Not set</strong>')}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configuration Status -->
                    <div class="row mt-2">
                        <div class="col-6">
                            <small class="text-muted">Entry Type:</small><br>
                            <strong>${trade.entry_type ? trade.entry_type.toUpperCase() : 'Not set'}</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Status:</small><br>
                            <strong class="text-${trade.status === 'configured' ? 'warning' : trade.status === 'active' ? 'success' : 'secondary'}">
                                ${trade.status ? trade.status.toUpperCase() : 'DRAFT'}
                            </strong>
                        </div>
                    </div>
                    `}
                    
                    <div class="trade-controls mt-2" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.25rem;">
                        <button class="btn btn-outline-primary btn-sm" onclick="editTradeConfig('${trade.trade_id}')">
                            ⚙ Edit
                        </button>
                        ${trade.symbol && trade.side && trade.amount && 
                          ((trade.entry_type === 'market') || (trade.entry_type === 'limit' && trade.entry_price)) &&
                          trade.take_profits && trade.take_profits.length > 0 && trade.stop_loss_percent ?
                          `<button class="btn btn-success btn-sm" onclick="executeTrade('${trade.trade_id}')">
                            ⚡ Execute
                          </button>` :
                          `<button class="btn btn-outline-secondary btn-sm" disabled title="Complete configuration first">
                            ⚡ Execute
                          </button>`
                        }
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteTrade('${trade.trade_id}')">
                            ✕ Delete
                        </button>
                    </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = tradesHtml;
            
            // Restore expanded states for trades after content update
            setTimeout(() => {
                trades.forEach((trade, index) => {
                    if (getExpandedState('trades', index)) {
                        const content = document.getElementById(`trade-content-${index}`);
                        const icon = document.getElementById(`trade-icon-${index}`);
                        const header = content?.previousElementSibling;
                        
                        if (content && icon && header) {
                            content.classList.add('expanded');
                            header.classList.add('expanded');
                            icon.classList.add('expanded');
                        }
                    }
                });
            }, 50);
            
            console.log('Trades rendered successfully. Container innerHTML set.');
        }

        async function loadPortfolio() {
            try {
                // Show loading state for all portfolio sections
                showTabLoading('portfolio-summary', 'Loading account balance...');
                showTabLoading('portfolio-positions', 'Loading active positions...');
                showInlineLoading('closed-positions-container', 'Loading trade history...');
                
                const data = await apiCall(`/api/margin-data?user_id=${getUserId() || '123456789'}`);
                if (!data) {
                    hideTabLoading('portfolio-summary', 'Unable to load account data');
                    hideTabLoading('portfolio-positions', 'Unable to load positions');
                    hideInlineLoading('closed-positions-container', 'Unable to load trade history');
                    return;
                }
                
                const tradesData = await apiCall(`/api/user-trades?user_id=${getUserId()}`);
                if (!tradesData) {
                    hideInlineLoading('closed-positions-container', 'Unable to load trade history');
                }
            
            const summary = data.summary || {};
            
            // Always fetch fresh paper trading status to prevent UI flashing
            let isPaperMode;
            let paperTradingStatus = null;
            
            // Fetch current trading mode status
            paperTradingStatus = await apiCall(`/api/paper-trading-status?user_id=${getUserId() || '123456789'}`);
            isPaperMode = paperTradingStatus && paperTradingStatus.paper_trading_active;
            
            // Update cached status only after fresh API call
            window.currentPaperTradingStatus = isPaperMode;
            const isLiveMode = !isPaperMode;
            
            if (isLiveMode) {
                // Fetch real exchange balance for live trading mode  
                const exchangeBalance = await apiCall(`/api/exchange/balance?user_id=${getUserId() || '123456789'}`);
                
                if (exchangeBalance && exchangeBalance.success && exchangeBalance.balance) {
                    const balance = exchangeBalance.balance;
                    
                    // Display real exchange balance
                    document.getElementById('account-balance').textContent = `$${balance.total_balance?.toFixed(2) || '0.00'}`;
                    document.getElementById('margin-used').textContent = `$${balance.used_margin?.toFixed(2) || '0.00'}`;
                    document.getElementById('free-margin').textContent = `$${balance.available_balance?.toFixed(2) || '0.00'}`;
                    document.getElementById('margin-ratio').textContent = `${balance.margin_ratio?.toFixed(1) || '0'}%`;
                    
                    // Show live trading indicator in balance
                    const balanceElement = document.getElementById('account-balance');
                    const balanceParent = balanceElement.closest('.portfolio-stat');
                    if (balanceParent) {
                        const indicator = balanceParent.querySelector('.live-indicator') || document.createElement('div');
                        indicator.className = 'live-indicator';
                        indicator.innerHTML = '🟢 Live';
                        indicator.style.cssText = 'font-size: 0.5rem; color: #28a745; font-weight: 600; margin-top: 2px;';
                        if (!balanceParent.querySelector('.live-indicator')) {
                            balanceParent.appendChild(indicator);
                        }
                    }
                } else {
                    // Fallback to simulated data if exchange balance fails
                    document.getElementById('account-balance').textContent = `$${summary.account_balance?.toFixed(2) || '0.00'}`;
                    document.getElementById('margin-used').textContent = `$${summary.total_margin_used?.toFixed(2) || '0.00'}`;
                    document.getElementById('free-margin').textContent = `$${summary.free_margin?.toFixed(2) || '0.00'}`;
                    document.getElementById('margin-ratio').textContent = `${summary.margin_utilization?.toFixed(1) || '0'}%`;
                }
            } else {
                // Paper trading mode - show paper balance (using config default)
                const paperBalance = paperTradingStatus?.paper_balance || window.appConfig?.defaultTrialBalance || 10000;
                
                document.getElementById('account-balance').textContent = `$${paperBalance.toFixed(2)}`;
                document.getElementById('margin-used').textContent = `$${summary.total_margin_used?.toFixed(2) || '0.00'}`;
                document.getElementById('free-margin').textContent = `$${(paperBalance - (summary.total_margin_used || 0)).toFixed(2)}`;
                document.getElementById('margin-ratio').textContent = `${summary.margin_utilization?.toFixed(1) || '0'}%`;
                
                // Show paper trading indicator
                const balanceElement = document.getElementById('account-balance');
                const balanceParent = balanceElement.closest('.portfolio-stat');
                if (balanceParent) {
                    const existingIndicator = balanceParent.querySelector('.live-indicator');
                    if (existingIndicator) {
                        existingIndicator.remove(); // Remove existing indicator first
                    }
                    
                    const indicator = document.createElement('div');
                    indicator.className = 'live-indicator';
                    indicator.innerHTML = '📄 Paper';
                    indicator.style.cssText = 'font-size: 0.5rem; color: #6bb6ff; font-weight: 600; margin-top: 2px;';
                    balanceParent.appendChild(indicator);
                }
            }
            
            // Update total P&L if elements exist
            const realizedPnlElement = document.getElementById('realized-pnl');
            const totalPnlElement = document.getElementById('total-pnl');
            if (realizedPnlElement) {
                realizedPnlElement.textContent = `$${(summary.realized_pnl || 0).toFixed(2)}`;
                realizedPnlElement.style.color = (summary.realized_pnl || 0) >= 0 ? '#28a745' : '#dc3545';
            }
            if (totalPnlElement) {
                totalPnlElement.textContent = `$${(summary.total_pnl || 0).toFixed(2)}`;
                totalPnlElement.style.color = (summary.total_pnl || 0) >= 0 ? '#28a745' : '#dc3545';
            }
            
            // Also update portfolio-specific total P&L element
            const portfolioTotalPnlElement = document.getElementById('total-pnl-portfolio');
            if (portfolioTotalPnlElement) {
                portfolioTotalPnlElement.textContent = `$${(summary.total_pnl || 0).toFixed(2)}`;
                portfolioTotalPnlElement.style.color = (summary.total_pnl || 0) >= 0 ? '#28a745' : '#dc3545';
            }
            
            const container = document.getElementById('portfolio-details');
            const positions = data.positions || [];
            const allTrades = tradesData?.trades || [];
            const activePositions = allTrades.filter(t => t.status === 'active' || t.status === 'pending');
            const closedPositions = allTrades.filter(t => t.status === 'stopped');
            
            let content = '';
            
            // Active Positions Section - Collapsible
            content += `<div class="mb-4">
                <div class="collapsible-header" onclick="toggleActivePositionsSection()">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">▲ Active Positions</h6>
                            <small class="text-muted">${activePositions.length} active position${activePositions.length !== 1 ? 's' : ''}</small>
                        </div>
                        <span class="expand-icon" id="active-positions-icon">▼</span>
                    </div>
                </div>
                <div class="collapsible-content" id="active-positions-content">
            `;
            
            if (activePositions.length > 0) {
                content += activePositions.map(pos => `
                    <div class="trade-card" data-trade-id="${pos.trade_id}">
                        <div class="d-flex justify-content-between mb-2">
                            <strong>${pos.symbol}</strong>
                            <span class="status-badge status-${pos.status}">${pos.side.toUpperCase()}</span>
                            ${pos.status === 'pending' ? '<small class="text-info ms-1">(PENDING)</small>' : ''}
                        </div>
                        <div class="row">
                            <div class="col-4">
                                <small class="text-muted">Size</small><br>
                                <strong>$${pos.position_size || (pos.amount * pos.leverage) || '0'}</strong>
                                <br><small class="text-muted">Margin: $${pos.amount || '0'}</small>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Current</small><br>
                                <strong class="current-price">$${pos.current_price || pos.entry_price || 'Market'}</strong>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">P&L</small><br>
                                <strong class="unrealized-pnl" style="color: ${(pos.unrealized_pnl || 0) >= 0 ? '#28a745' : '#dc3545'}">
                                    $${(pos.unrealized_pnl || 0).toFixed(2)}
                                </strong>
                                <br><small class="roe-percentage" style="color: ${calculateROE(pos) >= 0 ? '#28a745' : '#dc3545'}">
                                    ${calculateROE(pos).toFixed(2)}%
                                </small>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                content += '<div class="text-center py-4"><small class="text-muted">No active positions</small></div>';
            }
            
            content += `</div></div>`; // Close active positions collapsible content and container
            
            // Closed Positions History Section - Collapsible
            content += `<div class="mt-4">
                <div class="collapsible-header" onclick="toggleHistorySection()">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0 text-muted">◼ Closed Positions History</h6>
                            <small class="text-muted">${closedPositions.length} closed position${closedPositions.length !== 1 ? 's' : ''}</small>
                        </div>
                        <span class="expand-icon" id="history-icon">▼</span>
                    </div>
                </div>
                <div class="collapsible-content" id="history-content">
            `;
            
            if (closedPositions.length > 0) {
                content += closedPositions.slice(-10).reverse().map(pos => {
                    // Parse take profits if available
                    let takeProfits = [];
                    try {
                        takeProfits = pos.take_profits ? (typeof pos.take_profits === 'string' ? JSON.parse(pos.take_profits) : pos.take_profits) : [];
                    } catch (e) {
                        takeProfits = [];
                    }
                    
                    // Calculate ROE for closed position
                    const margin = pos.amount || 0;
                    const finalROE = margin > 0 ? ((pos.final_pnl || 0) / margin) * 100 : 0;
                    
                    // Prepare TP display
                    let tpDisplay = '';
                    if (takeProfits.length > 0) {
                        const tpInfo = takeProfits.map((tp, index) => 
                            `TP${index + 1}: ${tp.percentage}% (${tp.allocation || 0}%)`
                        ).join(', ');
                        tpDisplay = `
                        <div class="mt-2 pt-2" style="border-top: 1px solid rgba(108, 117, 125, 0.2);">
                            <small class="text-muted">Take Profits:</small><br>
                            <small style="color: #17a2b8; font-family: monospace;">${tpInfo}</small>
                        </div>`;
                    }
                    
                    // Breakeven status display
                    let breakevenDisplay = '';
                    if (pos.breakeven_after && pos.breakeven_after !== 'disabled') {
                        const breakevenStatus = pos.breakeven_sl_triggered ? '✓ Activated' : '○ Not triggered';
                        const statusColor = pos.breakeven_sl_triggered ? '#28a745' : '#ffc107';
                        breakevenDisplay = `
                        <div class="mt-1">
                            <small class="text-muted">Breakeven SL:</small>
                            <small style="color: ${statusColor}; font-weight: 600;">${breakevenStatus}</small>
                            <small class="text-muted">(after ${pos.breakeven_after})</small>
                        </div>`;
                    }
                    
                    // P&L breakdown display
                    const realizedPnL = pos.realized_pnl || 0;
                    const unrealizedPnL = (pos.final_pnl || 0) - realizedPnL;
                    let pnlBreakdown = '';
                    if (realizedPnL > 0) {
                        pnlBreakdown = `
                        <div class="mt-1">
                            <small class="text-muted">Realized: </small><small style="color: #28a745;">$${realizedPnL.toFixed(2)}</small>
                            <small class="text-muted"> | Final: </small><small style="color: ${unrealizedPnL >= 0 ? '#28a745' : '#dc3545'};">$${unrealizedPnL.toFixed(2)}</small>
                        </div>`;
                    }
                    
                    return `
                    <div class="trade-card" style="opacity: 0.85; border-left: 3px solid ${(pos.final_pnl || 0) >= 0 ? '#28a745' : '#dc3545'};">
                        <div class="d-flex justify-content-between mb-2">
                            <div>
                                <strong>${pos.symbol}</strong>
                                <span class="status-badge status-stopped ms-2">${pos.side.toUpperCase()}</span>
                                <small class="text-muted ms-2">CLOSED</small>
                            </div>
                            <div class="text-end">
                                <strong style="color: ${(pos.final_pnl || 0) >= 0 ? '#28a745' : '#dc3545'}">
                                    $${(pos.final_pnl || 0).toFixed(2)}
                                </strong>
                                <br><small style="color: ${finalROE >= 0 ? '#28a745' : '#dc3545'}; font-weight: 600;">
                                    ${finalROE.toFixed(2)}% ROE
                                </small>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-4">
                                <small class="text-muted">Position Size</small><br>
                                <strong>$${pos.position_size || (pos.amount * pos.leverage) || '0'}</strong>
                                <br><small class="text-muted">Margin: $${pos.amount || '0'}</small>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Entry Price</small><br>
                                <strong>$${pos.entry_price || 'Market'}</strong>
                                <br><small class="text-muted">${pos.leverage || '1'}x Leverage</small>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Stop Loss</small><br>
                                <strong>${pos.stop_loss_percent || '0'}%</strong>
                                ${pos.breakeven_sl_triggered ? '<br><small style="color: #28a745;">+ Breakeven</small>' : ''}
                            </div>
                        </div>
                        ${tpDisplay}
                        ${breakevenDisplay}
                        ${pnlBreakdown}
                        ${pos.closed_at ? `
                        <div class="mt-2 pt-2" style="border-top: 1px solid rgba(108, 117, 125, 0.2);">
                            <small class="text-muted">Closed: ${new Date(pos.closed_at).toLocaleString('en-US', {
                                year: 'numeric',
                                month: '2-digit', 
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: false
                            })}</small>
                        </div>
                        ` : ''}
                    </div>
                `;
                }).join('');
                
                if (closedPositions.length > 10) {
                    content += `<div class="text-center py-2">
                        <small class="text-muted">... and ${closedPositions.length - 10} more closed positions</small>
                    </div>`;
                }
            } else {
                content += `<div class="text-center py-4"><small class="text-muted">No closed positions yet</small></div>`;
            }
            
            content += `</div></div>`; // Close collapsible content and container
            
            container.innerHTML = content;
            
            // Hide loading states successfully
            hideTabLoading('portfolio-summary');
            hideTabLoading('portfolio-positions');
            hideInlineLoading('closed-positions-container');
            
            // Note: Removed auto-expansion behavior to keep sections collapsed by default
            // Users can manually expand sections as needed
            } catch (error) {
                console.error('Error in loadPortfolio:', error);
                hideTabLoading('portfolio-summary', 'Failed to load portfolio data');
                hideTabLoading('portfolio-positions', 'Failed to load positions');
                hideInlineLoading('closed-positions-container', 'Failed to load trade history');
            }
        }

        // Trade configuration functions
        function createNewTrade() {
            currentTrade = {
                trade_id: 'new_' + Date.now(),
                name: 'New Trade',
                symbol: '',
                side: '',
                amount: '',
                leverage: 10,
                entry_type: '',
                entry_price: '',
                take_profits: [],
                stop_loss_percent: '',
                breakeven_after: 'disabled',
                trailing_stop_enabled: false,
                trail_percentage: '',
                trail_activation_price: ''
            };
            configStep = 0;
            showTradeModal();
        }

        async function editTrade(tradeId) {
            const data = await apiCall(`/api/trade-config?trade_id=${tradeId}`);
            if (data) {
                currentTrade = data;
                configStep = 0;
                showTradeModal();
            }
        }

        async function closeTrade(tradeId) {
            if (!confirm('Are you sure you want to close this position?')) return;
            
            const result = await apiCall('/api/close-trade', {
                method: 'POST',
                body: JSON.stringify({
                    user_id: getUserId(),
                    trade_id: tradeId
                })
            });
            
            if (result && result.success) {
                alert(`Position closed successfully! P&L: $${result.final_pnl?.toFixed(2) || '0.00'}`);
                // Only reload the current tab to avoid conflicts  
                if (currentActiveTab === 'positions') {
                    loadPositions();
                } else if (currentActiveTab === 'portfolio') {
                    loadPortfolio();
                }
            } else {
                alert('Failed to close position. Please try again.');
            }
        }

        async function closeAllTrades() {
            if (!confirm('Are you sure you want to close ALL active trades? This action cannot be undone.')) return;
            
            // Show loading state
            const closeAllBtn = document.getElementById('close-all-btn');
            const originalText = closeAllBtn.textContent;
            closeAllBtn.textContent = '⏳ Closing Trades...';
            closeAllBtn.disabled = true;
            
            try {
                const result = await apiCall('/api/close-all-trades', {
                    method: 'POST',
                    body: JSON.stringify({
                        user_id: getUserId()
                    })
                });
                
                if (result && result.success) {
                    const message = result.closed_count > 0 
                        ? `Successfully closed ${result.closed_count} trades! Total P&L: $${result.total_final_pnl?.toFixed(2) || '0.00'}`
                        : 'No active trades to close.';
                    alert(message);
                    
                    // Reload positions and portfolio to reflect changes
                    if (currentActiveTab === 'positions') {
                        loadPositions();
                    } else if (currentActiveTab === 'portfolio') {
                        loadPortfolio();
                    }
                } else {
                    alert('Failed to close all trades. Please try again.');
                }
            } catch (error) {
                console.error('Error closing all trades:', error);
                alert('An error occurred while closing trades. Please try again.');
            } finally {
                // Restore button state
                closeAllBtn.textContent = originalText;
                closeAllBtn.disabled = false;
            }
        }

        async function deleteTrade(tradeId) {
            if (!confirm('Are you sure you want to permanently delete this trade configuration?')) return;
            
            const result = await apiCall('/api/delete-trade', {
                method: 'POST',
                body: JSON.stringify({
                    user_id: getUserId(),
                    trade_id: tradeId
                })
            });
            
            if (result && result.success) {
                // Use native alert instead of Telegram-specific showAlert
                alert('Trade configuration deleted successfully!');
                // Only reload the current tab to avoid conflicts
                if (currentActiveTab === 'trading') {
                    loadTradeConfigs();
                } else if (currentActiveTab === 'positions') {
                    loadPositions();
                } else if (currentActiveTab === 'portfolio') {
                    loadPortfolio();
                }
            } else {
                alert('Failed to delete trade configuration. Please try again.');
            }
        }

        async function cancelPendingOrder(tradeId) {
            if (!confirm('Are you sure you want to cancel this pending limit order?')) return;
            
            const result = await apiCall('/api/delete-trade', {
                method: 'POST',
                body: JSON.stringify({
                    user_id: getUserId(),
                    trade_id: tradeId
                })
            });
            
            if (result && result.success) {
                alert('Pending limit order cancelled successfully!');
                // Only reload the current tab to avoid conflicts
                if (currentActiveTab === 'positions') {
                    loadPositions();
                } else if (currentActiveTab === 'trading') {
                    loadTradeConfigs();
                } else if (currentActiveTab === 'portfolio') {
                    loadPortfolio();
                }
            } else {
                alert('Failed to cancel pending order. Please try again.');
            }
        }

        // Button micro-interaction utilities
        function addButtonLoading(button) {
            if (!button) return;
            button.disabled = true;
            button.classList.add('btn-loading');
            button.setAttribute('data-original-text', button.innerHTML);
        }

        function removeButtonLoading(button) {
            if (!button) return;
            button.disabled = false;
            button.classList.remove('btn-loading');
            const originalText = button.getAttribute('data-original-text');
            if (originalText) {
                button.innerHTML = originalText;
                button.removeAttribute('data-original-text');
            }
        }

        function animateButtonSuccess(button) {
            if (!button) return;
            button.style.transform = 'scale(1.05)';
            button.style.backgroundColor = '#28a745';
            button.style.borderColor = '#28a745';
            setTimeout(() => {
                button.style.transform = '';
                button.style.backgroundColor = '';
                button.style.borderColor = '';
            }, 300);
        }

        function animateButtonError(button) {
            if (!button) return;
            button.style.transform = 'translateX(-5px)';
            button.style.backgroundColor = '#dc3545';
            button.style.borderColor = '#dc3545';
            setTimeout(() => {
                button.style.transform = 'translateX(5px)';
            }, 100);
            setTimeout(() => {
                button.style.transform = '';
                button.style.backgroundColor = '';
                button.style.borderColor = '';
            }, 200);
        }

        function showSuccessMessage(message) {
            // Use Telegram WebApp haptic feedback if available
            if (typeof tg !== 'undefined' && tg.HapticFeedback) {
                tg.HapticFeedback.notificationOccurred('success');
            }
            alert(message); // Can be replaced with a more elegant toast notification
        }

        function showErrorMessage(message) {
            // Use Telegram WebApp haptic feedback if available
            if (typeof tg !== 'undefined' && tg.HapticFeedback) {
                tg.HapticFeedback.notificationOccurred('error');
            }
            alert(message); // Can be replaced with a more elegant toast notification
        }

        async function deleteTradeConfig(tradeId) {
            const button = event.target;
            
            // Add confirmation with micro-interaction
            if (!confirm('Are you sure you want to delete this trade configuration?')) {
                button.style.transform = 'scale(1.1)';
                setTimeout(() => button.style.transform = '', 150);
                return;
            }
            
            addButtonLoading(button);
            
            try {
                const response = await apiCall(`/api/delete-trade/${tradeId}`, {
                    method: 'DELETE'
                });
                
                if (response && response.success) {
                    animateButtonSuccess(button);
                    showSuccessMessage('Trade configuration deleted successfully!');
                    setTimeout(() => loadTradeConfigs(), 300);
                } else {
                    throw new Error(response?.error || 'Deletion failed');
                }
            } catch (error) {
                animateButtonError(button);
                showErrorMessage('Failed to delete trade configuration. Please try again.');
                console.error('Delete failed:', error);
            } finally {
                removeButtonLoading(button);
            }
        }

        async function selectTrade(tradeId) {
            const data = await apiCall(`/api/trade-config?trade_id=${tradeId}`);
            if (!data) return;
            
            // Check if trade is complete
            const isComplete = data.symbol && data.side && data.amount && 
                              (data.entry_type === 'market' || (data.entry_type === 'limit' && data.entry_price)) &&
                              data.take_profits?.length > 0 && data.stop_loss_percent;
            
            if (isComplete && data.status === 'configured') {
                // Ask user if they want to execute the trade
                if (confirm(`Execute trade for ${data.symbol} ${data.side.toUpperCase()}?`)) {
                    await executeTrade(tradeId);
                }
            } else {
                // Open for editing
                currentTrade = data;
                configStep = 0;
                showTradeModal();
            }
        }

        async function editTradeConfig(tradeId) {
            const button = event.target;
            addButtonLoading(button);
            
            try {
                const data = await apiCall(`/api/trade-config?trade_id=${tradeId}`);
                if (data) {
                    currentTrade = data;
                    configStep = 0;
                    animateButtonSuccess(button);
                    setTimeout(() => showTradeModal(), 200);
                } else {
                    throw new Error('Failed to load trade configuration');
                }
            } catch (error) {
                animateButtonError(button);
                console.error('Edit failed:', error);
            } finally {
                removeButtonLoading(button);
            }
        }

        async function executeTrade(tradeId) {
            const button = event.target;
            addButtonLoading(button);
            
            try {
                const result = await apiCall('/api/execute-trade', {
                    method: 'POST',
                    body: JSON.stringify({
                        user_id: getUserId(),
                        trade_id: tradeId
                    })
                });
                
                if (result && result.success) {
                    animateButtonSuccess(button);
                    showSuccessMessage('Trade executed successfully!');
                    if (typeof tg !== 'undefined' && tg.MainButton) {
                        tg.MainButton.hide();
                    }
                    // Reload after animation
                    setTimeout(() => {
                        if (currentActiveTab === 'trading') {
                            loadTradeConfigs();
                        } else if (currentActiveTab === 'positions') {
                            loadPositions();
                        } else if (currentActiveTab === 'portfolio') {
                            loadPortfolio();
                        }
                    }, 500);
                } else {
                    throw new Error(result?.error || 'Execution failed');
                }
            } catch (error) {
                animateButtonError(button);
                console.error('[RENDER DEBUG] Execute failed:', error);
                
                // Enhanced error handling for debugging
                let errorMessage = 'Failed to execute trade. Please try again.';
                
                if (error.message && error.message.includes('error')) {
                    try {
                        const errorData = JSON.parse(error.message.split('error: ')[1]);
                        console.log('[RENDER DEBUG] Parsed error data:', errorData);
                        
                        if (errorData.debug_info) {
                            // Show credential issues specifically
                            if (errorData.debug_info.has_api_key === false || errorData.debug_info.has_api_secret === false) {
                                errorMessage = 'Missing API credentials. Please set up your Toobit API keys in the hamburger menu (☰).';
                            } else if (errorData.troubleshooting) {
                                errorMessage = errorData.error + '\n\nTroubleshooting:\n• ' + errorData.troubleshooting.join('\n• ');
                            } else {
                                errorMessage = errorData.error || errorMessage;
                            }
                        } else {
                            errorMessage = errorData.error || errorMessage;
                        }
                    } catch (parseError) {
                        console.log('[RENDER DEBUG] Could not parse error details:', parseError);
                        errorMessage = error.message || errorMessage;
                    }
                }
                
                showErrorMessage(errorMessage);
            } finally {
                removeButtonLoading(button);
            }
        }

        function showTradeModal() {
            updateTradeModal();
            new bootstrap.Modal(document.getElementById('tradeModal')).show();
        }

        function updateTradeModal() {
            if (!currentTrade) return;
            
            // Update modal title
            document.getElementById('tradeModalTitle').textContent = currentTrade.name || 'Configure Trade';
            
            // Clear all validation errors
            clearAllValidationErrors();
            
            // Update form values from currentTrade
            if (currentTrade.symbol) document.getElementById('trade-symbol-select').value = currentTrade.symbol;
            if (currentTrade.amount) document.getElementById('amount-input').value = currentTrade.amount;
            if (currentTrade.leverage) document.getElementById('leverage-select').value = currentTrade.leverage;
            if (currentTrade.entry_price) document.getElementById('entry-price').value = currentTrade.entry_price;
            if (currentTrade.stop_loss_percent) document.getElementById('stop-loss').value = currentTrade.stop_loss_percent;
            if (currentTrade.breakeven_after) document.getElementById('breakeven-select').value = currentTrade.breakeven_after;
            if (currentTrade.trailing_stop_enabled) {
                document.getElementById('trailing-enabled').checked = currentTrade.trailing_stop_enabled;
                toggleTrailingStop();
            }
            if (currentTrade.trail_percentage) document.getElementById('trail-percentage').value = currentTrade.trail_percentage;
            if (currentTrade.trail_activation_price) document.getElementById('trail-activation').value = currentTrade.trail_activation_price;
            
            // Update button states
            if (currentTrade.side) {
                document.querySelectorAll('.side-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[data-side="${currentTrade.side}"]`)?.classList.add('active');
            }
            
            if (currentTrade.entry_type) {
                document.querySelectorAll('.entry-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[data-type="${currentTrade.entry_type}"]`)?.classList.add('active');
                if (currentTrade.entry_type === 'limit') {
                    document.getElementById('limit-price-input').classList.remove('hidden');
                }
            }
            
            // Update take profit levels
            if (currentTrade.take_profits && currentTrade.take_profits.length > 0) {
                updateTakeProfitLevels(currentTrade.take_profits);
            }
        }

        // New single-page validation function
        function validateAndSaveTrade() {
            if (validateAllFields()) {
                collectFormData();
                saveTrade();
            }
        }

        function validateAllFields() {
            let isValid = true;
            clearAllValidationErrors();

            // Validate symbol
            const symbol = document.getElementById('trade-symbol-select').value;
            if (!symbol) {
                showValidationError('symbol-error', 'Please select a trading pair');
                isValid = false;
            } else {
                currentTrade.symbol = symbol;
            }

            // Validate side
            if (!currentTrade.side) {
                showValidationError('side-error', 'Please select a position side (Long or Short)');
                isValid = false;
            }

            // Validate amount
            const amount = parseFloat(document.getElementById('amount-input').value);
            const leverage = parseInt(document.getElementById('leverage-select').value);
            if (!amount || amount <= 0) {
                showValidationError('amount-error', 'Please enter a valid amount');
                isValid = false;
            } else {
                currentTrade.amount = amount;
                currentTrade.leverage = leverage;
            }

            // Validate entry type
            if (!currentTrade.entry_type) {
                showValidationError('entry-type-error', 'Please select an entry type (Market or Limit)');
                isValid = false;
            } else if (currentTrade.entry_type === 'limit') {
                const entryPrice = parseFloat(document.getElementById('entry-price').value);
                if (!entryPrice || entryPrice <= 0) {
                    showValidationError('entry-price-error', 'Please enter a valid limit price');
                    isValid = false;
                } else {
                    currentTrade.entry_price = entryPrice;
                }
            } else {
                currentTrade.entry_price = ''; // Clear for market orders
            }

            // Validate take profits
            currentTrade.take_profits = [];
            document.querySelectorAll('#tp-levels .input-group').forEach((group, index) => {
                const percent = parseFloat(group.querySelector('.tp-percent').value);
                const allocation = parseFloat(group.querySelector('.tp-allocation').value);
                if (percent && allocation) {
                    currentTrade.take_profits.push({ percentage: percent, allocation: allocation });
                }
            });
            if (currentTrade.take_profits.length === 0) {
                showValidationError('tp-error', 'Please add at least one take profit level');
                isValid = false;
            }

            // Validate stop loss
            const stopLoss = parseFloat(document.getElementById('stop-loss').value);
            if (!stopLoss || stopLoss <= 0) {
                showValidationError('sl-error', 'Please set a stop loss percentage');
                isValid = false;
            } else {
                currentTrade.stop_loss_percent = stopLoss;
            }

            // Validate trailing stop (if enabled)
            const trailingEnabled = document.getElementById('trailing-enabled').checked;
            currentTrade.trailing_stop_enabled = trailingEnabled;
            
            if (trailingEnabled) {
                const trailPercent = parseFloat(document.getElementById('trail-percentage').value);
                if (!trailPercent || trailPercent <= 0) {
                    showValidationError('trailing-error', 'Please set a trail percentage when trailing stop is enabled');
                    isValid = false;
                } else {
                    currentTrade.trail_percentage = trailPercent;
                    const activationPrice = parseFloat(document.getElementById('trail-activation').value);
                    if (activationPrice) {
                        currentTrade.trail_activation_price = activationPrice;
                    }
                }
            } else {
                currentTrade.trail_percentage = '';
                currentTrade.trail_activation_price = '';
            }

            // Collect breakeven settings
            const breakeven = document.getElementById('breakeven-select').value;
            currentTrade.breakeven_after = breakeven;

            return isValid;
        }

        function collectFormData() {
            // All data is already collected in validateAllFields()
            // This function exists for consistency and future extensions
        }

        function showValidationError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.classList.add('show');
            }
        }

        function clearAllValidationErrors() {
            document.querySelectorAll('.validation-error').forEach(error => {
                error.classList.remove('show');
                error.textContent = '';
            });
        }

        function updateTakeProfitLevels(takeProfits) {
            const container = document.getElementById('tp-levels');
            container.innerHTML = '';
            
            takeProfits.forEach((tp, index) => {
                const level = index + 1;
                const tpRow = document.createElement('div');
                tpRow.className = 'input-group mb-2';
                tpRow.innerHTML = `
                    <span class="input-group-text">TP${level} %</span>
                    <input type="number" class="form-control tp-percent" data-level="${level}" placeholder="5" step="0.1" value="${tp.percentage}">
                    <span class="input-group-text">Size %</span>
                    <input type="number" class="form-control tp-allocation" data-level="${level}" placeholder="30" step="1" value="${tp.allocation}" oninput="updateAllocationSummary()">
                    ${level > 1 ? '<button type="button" class="btn btn-outline-danger btn-sm" onclick="removeTpLevel(this)">×</button>' : ''}
                `;
                container.appendChild(tpRow);
            });
            
            updateAllocationSummary();
        }

        function setTradeSide(side) {
            currentTrade.side = side;
            // Update button states
            document.querySelectorAll('.side-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-side="${side}"]`)?.classList.add('active');
        }

        function setEntryType(type) {
            currentTrade.entry_type = type;
            // Update button states
            document.querySelectorAll('.entry-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-type="${type}"]`)?.classList.add('active');
            
            const limitInput = document.getElementById('limit-price-input');
            if (type === 'limit') {
                limitInput.classList.remove('hidden');
            } else {
                limitInput.classList.add('hidden');
                currentTrade.entry_price = '';
            }
        }

        function addTpLevel() {
            const container = document.getElementById('tp-levels');
            const level = container.children.length + 1;
            
            const tpDiv = document.createElement('div');
            tpDiv.className = 'input-group mb-2';
            tpDiv.innerHTML = `
                <span class="input-group-text">TP${level} %</span>
                <input type="number" class="form-control tp-percent" data-level="${level}" placeholder="5" step="0.1">
                <span class="input-group-text">Size %</span>
                <input type="number" class="form-control tp-allocation" data-level="${level}" placeholder="30" step="1" oninput="updateAllocationSummary()">
                <button class="btn btn-outline-danger" onclick="this.parentElement.remove(); updateAllocationSummary()">×</button>
            `;
            container.appendChild(tpDiv);
            updateAllocationSummary();
        }

        function updateAllocationSummary() {
            let totalAllocation = 0;
            document.querySelectorAll('.tp-allocation').forEach(input => {
                const allocation = parseFloat(input.value) || 0;
                totalAllocation += allocation;
            });
            
            const totalElement = document.getElementById('total-allocation');
            const remainingElement = document.getElementById('remaining-allocation');
            
            if (totalElement) totalElement.textContent = totalAllocation;
            if (remainingElement) {
                const remaining = 100 - totalAllocation;
                remainingElement.textContent = remaining;
                remainingElement.style.color = remaining < 0 ? '#dc3545' : remaining === 0 ? '#28a745' : '#6c757d';
            }
        }

        async function saveTrade() {
            // Collect take profit data
            currentTrade.take_profits = [];
            document.querySelectorAll('#tp-levels .input-group').forEach((group, index) => {
                const percent = parseFloat(group.querySelector('.tp-percent').value);
                const allocation = parseFloat(group.querySelector('.tp-allocation').value);
                if (percent && allocation) {
                    currentTrade.take_profits.push({ percentage: percent, allocation: allocation });
                }
            });
            
            // Prepare trade data for saving
            let tradeDataToSave = { ...currentTrade };
            
            // For active/pending trades, only send risk management parameters
            // to avoid triggering core parameter change safety checks
            if (currentTrade.status === 'active' || currentTrade.status === 'pending') {
                tradeDataToSave = {
                    trade_id: currentTrade.trade_id,
                    take_profits: currentTrade.take_profits,
                    stop_loss_percent: currentTrade.stop_loss_percent,
                    breakeven_after: currentTrade.breakeven_after,
                    trailing_stop_enabled: currentTrade.trailing_stop_enabled,
                    trail_percentage: currentTrade.trail_percentage,
                    trail_activation_price: currentTrade.trail_activation_price
                };
            }
            
            // Save trade configuration
            const result = await apiCall('/api/save-trade', {
                method: 'POST',
                body: JSON.stringify({
                    user_id: getUserId(),
                    trade: tradeDataToSave
                })
            });
            
            if (result && result.success) {
                alert('Trade configuration saved successfully!');
                bootstrap.Modal.getInstance(document.getElementById('tradeModal')).hide();
                // Only reload the current tab to avoid conflicts
                if (currentActiveTab === 'trading') {
                    loadTradeConfigs();
                } else if (currentActiveTab === 'positions') {
                    loadPositions();
                }
            } else {
                alert('Failed to save trade configuration. Please try again.');
            }
        }

        function calculateROE(trade) {
            if (!trade.unrealized_pnl || !trade.amount || !trade.leverage) return 0;
            const positionSize = trade.amount;
            const margin = positionSize / (trade.leverage || 1);
            return margin > 0 ? (trade.unrealized_pnl / margin) * 100 : 0;
        }

        function getTradeProgress(trade) {
            const steps = {
                "Symbol": trade.symbol ? "●" : "○",
                "Side": trade.side ? "●" : "○", 
                "Amount": trade.amount ? "●" : "○",
                "Entry": (trade.entry_type === "market" || (trade.entry_type === "limit" && trade.entry_price)) ? "●" : "○",
                "TPs": trade.take_profits?.length > 0 ? "●" : "○",
                "SL": trade.stop_loss_percent > 0 ? "●" : (trade.stop_loss_percent == 0 && trade.status === 'active' ? "⚖" : "○")
            };
            
            const completed = Object.values(steps).filter(s => s === "●").length;
            const total = Object.keys(steps).length;
            const progress = "█".repeat(completed) + "░".repeat(total - completed);
            
            // Add advanced settings indicators
            const advancedSettings = [];
            if (trade.breakeven_after && trade.breakeven_after !== 'disabled') {
                advancedSettings.push('BE');
            }
            if (trade.trailing_stop_enabled) {
                advancedSettings.push('TS');
            }
            const advancedText = advancedSettings.length > 0 ? ` +${advancedSettings.join(',')}` : '';
            
            return `${completed}/${total} [${progress}] ${Object.entries(steps).map(([k,v]) => `${k}${v}`).join(' ')}${advancedText}`;
        }

        function toggleTrailingStop() {
            const enabled = document.getElementById('trailing-enabled').checked;
            const options = document.getElementById('trailing-options');
            if (enabled) {
                options.classList.remove('hidden');
            } else {
                options.classList.add('hidden');
            }
        }

        // API Credentials Management Functions
        async function loadCredentialsStatus() {
            const statusContainer = document.getElementById('credentials-status');
            const setupContainer = document.getElementById('credentials-setup');
            // Also handle modal elements
            const modalStatusContainer = document.getElementById('api-credentials-status');
            const modalSetupContainer = document.getElementById('api-credentials-setup');
            
            try {
                const data = await apiCall(`/api/user-credentials?user_id=${getUserId() || '123456789'}`);
                
                if (!data) {
                    const errorHTML = `
                        <div class="card border-danger">
                            <div class="card-header bg-danger text-white">
                                <h6 class="mb-0">✕ Error Loading Credentials</h6>
                            </div>
                            <div class="card-body">
                                <p class="mb-2">Unable to load credentials status. Please try again.</p>
                                <button class="btn btn-outline-primary" onclick="loadCredentialsStatus()">⟲ Retry</button>
                            </div>
                        </div>
                    `;
                    if (statusContainer) statusContainer.innerHTML = errorHTML;
                    if (modalStatusContainer) modalStatusContainer.innerHTML = errorHTML;
                    return;
                }
            
            if (data.has_credentials) {
                const successHTML = `
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">● API Credentials Active</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">Exchange:</small><br>
                                    <strong>${(data.exchange || 'Unknown').toUpperCase()}</strong>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Mode:</small><br>
                                    <strong>${data.testnet_mode ? '◐ Testnet' : '⚡ Live Trading'}</strong>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="two-column-grid">
                                    <button class="btn btn-outline-warning" onclick="showCredentialsSetup()">⟲ Update</button>
                                    <button class="btn btn-outline-danger" onclick="deleteCredentials()">✕ Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                if (statusContainer) statusContainer.innerHTML = successHTML;
                if (modalStatusContainer) modalStatusContainer.innerHTML = successHTML;
                if (setupContainer) setupContainer.classList.add('hidden');
                if (modalSetupContainer) modalSetupContainer.classList.add('hidden');
                
                // Show and populate testnet toggle section
                updateTestnetToggleSection(data);
            } else {
                const noCredsHTML = `
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0">○ No API Credentials</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-2">Add your exchange API credentials to enable live trading.</p>
                            <button class="btn btn-primary" onclick="showCredentialsSetup()">⚿ Add Credentials</button>
                        </div>
                    </div>
                `;
                if (statusContainer) statusContainer.innerHTML = noCredsHTML;
                if (modalStatusContainer) modalStatusContainer.innerHTML = noCredsHTML;
                if (setupContainer) setupContainer.classList.add('hidden');
                if (modalSetupContainer) modalSetupContainer.classList.add('hidden');
                
                // Hide testnet toggle section when no credentials
                hideTestnetToggleSection();
            }
            } catch (error) {
                console.error('Error loading credentials status:', error);
                const errorHTML = `
                    <div class="card border-danger">
                        <div class="card-header bg-danger text-white">
                            <h6 class="mb-0">✕ Error Loading Credentials</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-2">Failed to load credentials status. Please check your connection and try again.</p>
                            <button class="btn btn-outline-primary" onclick="loadCredentialsStatus()">⟲ Retry</button>
                        </div>
                    </div>
                `;
                if (statusContainer) statusContainer.innerHTML = errorHTML;
                if (modalStatusContainer) modalStatusContainer.innerHTML = errorHTML;
            }
        }

        function showCredentialsSetup() {
            const setupContainer = document.getElementById('credentials-setup');
            const modalSetupContainer = document.getElementById('api-credentials-setup');
            if (setupContainer) setupContainer.classList.remove('hidden');
            if (modalSetupContainer) modalSetupContainer.classList.remove('hidden');
            
            // Initialize form state and visibility based on current exchange selection
            handleExchangeChange();
        }

        function cancelCredentialsSetup() {
            const setupContainer = document.getElementById('credentials-setup');
            const modalSetupContainer = document.getElementById('api-credentials-setup');
            if (setupContainer) setupContainer.classList.add('hidden');
            if (modalSetupContainer) modalSetupContainer.classList.add('hidden');
            clearCredentialsForm();
        }

        function clearCredentialsForm() {
            document.getElementById('api-key-input').value = '';
            document.getElementById('api-secret-input').value = '';
            document.getElementById('passphrase-input').value = '';
            document.getElementById('exchange-select').value = 'binance';
            document.getElementById('testnet-mode-toggle').checked = false; // Default to live mode
            handleExchangeChange(); // Update visibility
        }

        async function saveCredentials() {
            const exchange = document.getElementById('exchange-select').value;
            const apiKey = document.getElementById('api-key-input').value.trim();
            const apiSecret = document.getElementById('api-secret-input').value.trim();
            const passphrase = document.getElementById('passphrase-input').value.trim();
            const testnetMode = document.getElementById('testnet-mode-toggle').checked;

            if (!apiKey || !apiSecret) {
                alert('Please enter both API key and secret');
                return;
            }

            // Show loading indicator
            showGlobalLoading('Saving API credentials...');

            try {
                const response = await fetch('/api/save-credentials', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: getUserId() || '123456789',
                        exchange: exchange,
                        api_key: apiKey,
                        api_secret: apiSecret,
                        passphrase: passphrase || null,
                        testnet_mode: testnetMode
                    })
                });

                if (response.ok) {
                    alert('● Credentials saved successfully!');
                    clearCredentialsForm();
                    cancelCredentialsSetup();
                    loadCredentialsStatus();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error || 'Failed to save credentials'}`);
                }
            } catch (error) {
                console.error('Error saving credentials:', error);
                alert('Error saving credentials. Please try again.');
            }
        }

        // Handle exchange selection changes to show/hide testnet toggle
        function handleExchangeChange() {
            const exchange = document.getElementById('exchange-select').value;
            const passphraseGroup = document.getElementById('passphrase-group');
            const testnetToggleGroup = document.getElementById('testnet-toggle-group');
            
            // Show passphrase for OKX
            if (exchange === 'okx') {
                passphraseGroup.style.display = 'block';
            } else {
                passphraseGroup.style.display = 'none';
            }
            
            // Show testnet toggle for all exchanges except Toobit
            if (exchange !== 'toobit') {
                testnetToggleGroup.style.display = 'block';
            } else {
                testnetToggleGroup.style.display = 'none';
            }
        }

        // Handle testnet toggle changes
        function updateTestnetToggleLabel() {
            const toggle = document.getElementById('testnet-mode-toggle');
            const label = document.getElementById('testnet-mode-label');
            const description = document.getElementById('testnet-mode-description');
            
            if (toggle.checked) {
                label.textContent = '🧪 Testnet Mode (Safe Testing)';
                description.textContent = 'Switch to live mode for real trading with actual funds';
            } else {
                label.textContent = '🔥 Live Mode (Real Trading)';
                description.textContent = 'Switch to testnet mode for safe testing';
            }
        }
        
        // Testnet Toggle Functions
        function updateTestnetToggleSection(data) {
            const toggleSection = document.getElementById('testnet-toggle-section');
            if (!toggleSection) return;
            
            // Show the section
            toggleSection.style.display = 'block';
            
            // Update toggle switch state
            const toggleSwitch = document.getElementById('testnet-mode-switch');
            const currentModeBadge = document.getElementById('current-mode-badge');
            const currentModeText = document.getElementById('current-mode-text');
            const modeDescription = document.getElementById('mode-description');
            const testnetWarning = document.getElementById('testnet-warning');
            
            if (toggleSwitch) toggleSwitch.checked = data.testnet_mode;
            
            if (data.testnet_mode) {
                if (currentModeBadge) {
                    currentModeBadge.className = 'badge bg-warning text-dark';
                    currentModeBadge.textContent = 'Testnet Mode';
                }
                if (currentModeText) currentModeText.textContent = 'Testnet Trading Mode';
                if (modeDescription) modeDescription.textContent = 'Safe testing with virtual funds';
            } else {
                if (currentModeBadge) {
                    currentModeBadge.className = 'badge bg-success';
                    currentModeBadge.textContent = 'Live Trading';
                }
                if (currentModeText) currentModeText.textContent = 'Live Trading Mode';
                if (modeDescription) modeDescription.textContent = 'Real money trading with actual market orders';
            }
            
            // Show warning for exchanges that don't support testnet
            if (testnetWarning) {
                if (!data.supports_testnet) {
                    testnetWarning.style.display = 'block';
                    testnetWarning.innerHTML = '<strong>⚠️ Warning:</strong> ' + 
                        (data.exchange || 'This exchange').toUpperCase() + ' does not support testnet mode.';
                    // Disable toggle for exchanges that don't support testnet
                    if (toggleSwitch) toggleSwitch.disabled = true;
                } else {
                    testnetWarning.style.display = 'none';
                    if (toggleSwitch) toggleSwitch.disabled = false;
                }
            }
        }
        
        function hideTestnetToggleSection() {
            const toggleSection = document.getElementById('testnet-toggle-section');
            if (toggleSection) {
                toggleSection.style.display = 'none';
            }
        }
        
        async function toggleTestnetModeFromModal() {
            const toggleSwitch = document.getElementById('testnet-mode-switch');
            if (!toggleSwitch) return;
            
            const newTestnetMode = toggleSwitch.checked;
            
            try {
                const response = await fetch('/api/toggle-testnet', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: getUserId() || '123456789',
                        testnet_mode: newTestnetMode
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show success message
                    const message = result.warning || result.message;
                    alert('✅ ' + message);
                    
                    // Refresh the credentials status to update the display
                    loadCredentialsStatus();
                } else {
                    // Revert toggle switch and show error
                    toggleSwitch.checked = !newTestnetMode;
                    alert('❌ ' + (result.error || 'Failed to change trading mode'));
                }
            } catch (error) {
                // Revert toggle switch and show error
                toggleSwitch.checked = !newTestnetMode;
                console.error('Error toggling testnet mode:', error);
                alert('❌ Error changing trading mode. Please try again.');
            }
        }

        async function deleteCredentials() {
            if (!confirm('Are you sure you want to delete your API credentials?')) {
                return;
            }

            try {
                const response = await fetch('/api/delete-credentials', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: getUserId() || '123456789' })
                });

                if (response.ok) {
                    alert('● Credentials deleted successfully');
                    loadCredentialsStatus();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error || 'Failed to delete credentials'}`);
                }
            } catch (error) {
                console.error('Error deleting credentials:', error);
                alert('Error deleting credentials. Please try again.');
            }
        }





        // Tab switching managed by handleTabSwitch function below

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            // Clean up any existing SMC localStorage cache on page load
            try {
                localStorage.removeItem('smcSignalsCache');
                console.log('Cleaned up existing SMC localStorage cache on page load');
            } catch (error) {
                console.warn('Failed to clean up SMC localStorage cache:', error);
            }
            // Load paper trading status first and wait for it to complete
            await loadPaperTradingStatus();
            // Only then load positions to avoid race condition
            await loadPositions(); 
        });

        // Auto-refresh for portfolio (configured interval) - positions use live price updates
        setInterval(() => {
            const activeTab = document.querySelector('.nav-link.active').getAttribute('data-bs-target');
            // Don't reload positions - live price updates handle that
            if (activeTab === '#portfolio') loadPortfolio();
        }, 30000); // 30 seconds - from centralized config

        async function loadPaperTradingStatus() {
            try {
                // Set loading state first
                const paperText = document.getElementById('paper-trading-text');
                paperText.textContent = 'Paper Trading: Loading...';
                
                const response = await apiCall(`/api/paper-trading-status?user_id=${getUserId()}`);
                if (response.paper_trading_active !== undefined) {
                    paperText.textContent = response.paper_trading_active ? 'Paper Trading: On' : 'Paper Trading: Off';
                    // Store the status for use in other functions
                    window.currentPaperTradingStatus = response.paper_trading_active;
                } else {
                    throw new Error('Invalid response format');
                }
            } catch (error) {
                console.error('Error loading paper trading status:', error);
                // Default to paper trading on for safety
                const paperText = document.getElementById('paper-trading-text');
                paperText.textContent = 'Paper Trading: On';
                window.currentPaperTradingStatus = true;
            }
        }

        // Mobile-specific enhancements
        function initializeMobileEnhancements() {
            // Prevent double-tap zoom on buttons
            document.querySelectorAll('.btn, .nav-link, .collapsible-header').forEach(element => {
                element.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    this.click();
                });
            });

            // Add swipe gesture support for tab navigation
            let startX = 0;
            let startY = 0;
            let isScrolling = false;

            document.addEventListener('touchstart', function(e) {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                isScrolling = false;
            });

            document.addEventListener('touchmove', function(e) {
                const deltaX = Math.abs(e.touches[0].clientX - startX);
                const deltaY = Math.abs(e.touches[0].clientY - startY);
                
                if (deltaY > deltaX) {
                    isScrolling = true;
                }
            });

            document.addEventListener('touchend', function(e) {
                if (isScrolling) return;
                
                const endX = e.changedTouches[0].clientX;
                const deltaX = endX - startX;
                
                if (Math.abs(deltaX) > 50) { // Minimum swipe distance
                    const tabs = document.querySelectorAll('.nav-link');
                    const activeTab = document.querySelector('.nav-link.active');
                    const currentIndex = Array.from(tabs).indexOf(activeTab);
                    
                    if (deltaX > 0 && currentIndex > 0) {
                        // Swipe right - previous tab
                        tabs[currentIndex - 1].click();
                    } else if (deltaX < 0 && currentIndex < tabs.length - 1) {
                        // Swipe left - next tab
                        tabs[currentIndex + 1].click();
                    }
                }
            });

            // Optimize scroll performance
            let ticking = false;
            function updateScrollElements() {
                // Add scroll-based effects here if needed
                ticking = false;
            }

            function requestTick() {
                if (!ticking) {
                    requestAnimationFrame(updateScrollElements);
                    ticking = true;
                }
            }

            document.addEventListener('scroll', requestTick);

            // Handle safe area insets for newer devices
            if (CSS.supports('padding: env(safe-area-inset-top)')) {
                document.documentElement.style.setProperty('--safe-area-top', 'env(safe-area-inset-top)');
                document.documentElement.style.setProperty('--safe-area-bottom', 'env(safe-area-inset-bottom)');
                
                // Adjust header and bottom spacing
                const header = document.querySelector('.header');
                if (header) {
                    header.style.paddingTop = 'calc(1.25rem + var(--safe-area-top, 0px))';
                }
            }

            // Improve form interactions on mobile
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('focus', function() {
                    // Scroll input into view with some padding
                    setTimeout(() => {
                        this.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center' 
                        });
                    }, 300);
                });

                // Format numbers for better readability
                input.addEventListener('blur', function() {
                    if (this.value && !isNaN(this.value)) {
                        const value = parseFloat(this.value);
                        if (this.step && this.step.includes('.')) {
                            const decimals = this.step.split('.')[1].length;
                            this.value = value.toFixed(decimals);
                        }
                    }
                });
            });

            // Add haptic feedback for touch interactions (if supported)
            if ('vibrate' in navigator) {
                document.querySelectorAll('.btn-primary, .btn-success, .btn-danger').forEach(button => {
                    button.addEventListener('click', function() {
                        navigator.vibrate(50); // Light haptic feedback
                    });
                });
            }

            // Optimize modal interactions for mobile
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('shown.bs.modal', function() {
                    // Prevent background scrolling
                    document.body.style.overflow = 'hidden';
                    
                    // Focus first input
                    const firstInput = this.querySelector('input, select, textarea');
                    if (firstInput) {
                        setTimeout(() => firstInput.focus(), 100);
                    }
                });

                modal.addEventListener('hidden.bs.modal', function() {
                    // Restore background scrolling
                    document.body.style.overflow = '';
                });
            });

            // Add pull-to-refresh functionality
            let pullStartY = 0;
            let pulling = false;
            const pullThreshold = 80;

            document.addEventListener('touchstart', function(e) {
                if (window.scrollY === 0) {
                    pullStartY = e.touches[0].clientY;
                    pulling = true;
                }
            });

            document.addEventListener('touchmove', function(e) {
                if (!pulling) return;
                
                const currentY = e.touches[0].clientY;
                const pullDistance = currentY - pullStartY;
                
                if (pullDistance > pullThreshold && window.scrollY === 0) {
                    // Visual feedback for pull-to-refresh
                    const header = document.querySelector('.header h1');
                    if (header && !header.textContent.includes('↓')) {
                        header.textContent = '↓ ' + header.textContent.replace('↓ ', '');
                    }
                }
            });

            document.addEventListener('touchend', function(e) {
                if (!pulling) return;
                pulling = false;
                
                const header = document.querySelector('.header h1');
                if (header && header.textContent.includes('↓')) {
                    header.textContent = header.textContent.replace('↓ ', '');
                    
                    // Trigger refresh
                    const activeTab = document.querySelector('.nav-link.active').getAttribute('data-bs-target');
                    if (activeTab === '#positions') loadPositions();
                    else if (activeTab === '#trading') loadTradeConfigs();
                    else if (activeTab === '#portfolio') loadPortfolio();
                    else if (activeTab === '#credentials') loadCredentialsStatus();
                }
            });

            // Optimize touch targets for better accessibility
            document.querySelectorAll('.btn-sm').forEach(button => {
                if (button.offsetHeight < 44) {
                    button.style.minHeight = '44px';
                    button.style.display = 'flex';
                    button.style.alignItems = 'center';
                    button.style.justifyContent = 'center';
                }
            });
        }

        // Track current active tab to prevent conflicts
        let currentActiveTab = 'positions';
        
        // ============================================================================
        // LOADING INDICATORS SYSTEM
        // ============================================================================
        
        // Global loading overlay
        function showGlobalLoading(message = 'Loading...') {
            const overlay = document.getElementById('global-loading-overlay') || createGlobalLoadingOverlay();
            const messageElement = overlay.querySelector('.loading-message');
            if (messageElement) {
                messageElement.textContent = message;
            }
            overlay.style.display = 'flex';
        }
        
        function hideGlobalLoading() {
            const overlay = document.getElementById('global-loading-overlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }
        
        function createGlobalLoadingOverlay() {
            const overlay = document.createElement('div');
            overlay.id = 'global-loading-overlay';
            overlay.className = 'loading-overlay';
            overlay.innerHTML = `
                <div class="loading-spinner">
                    <div class="spinner-ring"></div>
                    <div class="loading-message">Loading...</div>
                </div>
            `;
            document.body.appendChild(overlay);
            return overlay;
        }
        
        // Button loading state
        function setButtonLoading(buttonId, loading = true) {
            const button = document.getElementById(buttonId);
            if (!button) return;
            
            if (loading) {
                button.dataset.originalText = button.textContent;
                button.classList.add('btn-loading');
                button.disabled = true;
            } else {
                button.classList.remove('btn-loading');
                button.disabled = false;
                if (button.dataset.originalText) {
                    button.textContent = button.dataset.originalText;
                }
            }
        }
        
        // Inline loading for components
        function showInlineLoading(containerId, message = 'Loading...') {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = `
                <div class="inline-loading">
                    <div class="inline-spinner"></div>
                    <span>${message}</span>
                </div>
            `;
        }
        
        // Tab loading state
        function showTabLoading(containerId, message = 'Loading data...') {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = `
                <div class="tab-loading">
                    <div class="spinner-ring"></div>
                    <div>${message}</div>
                </div>
            `;
        }
        
        // Hide tab loading state with error fallback
        function hideTabLoading(containerId, errorMessage = null) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            if (errorMessage) {
                container.innerHTML = `
                    <div class="text-center text-muted p-3">
                        <i data-feather="alert-circle" class="mb-2"></i>
                        <div>${errorMessage}</div>
                    </div>
                `;
                feather.replace();
            } else {
                container.innerHTML = '';
            }
        }
        
        // Hide inline loading state with error fallback  
        function hideInlineLoading(containerId, errorMessage = null) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            if (errorMessage) {
                container.innerHTML = `
                    <div class="text-center text-muted p-2">
                        <small>${errorMessage}</small>
                    </div>
                `;
            } else {
                container.innerHTML = '';
            }
        }
        
        // Skeleton loading for lists
        function showSkeletonLoading(containerId, itemCount = 3) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            let skeletonHTML = '';
            for (let i = 0; i < itemCount; i++) {
                skeletonHTML += `
                    <div class="card mb-2">
                        <div class="card-body">
                            <div class="skeleton skeleton-line medium"></div>
                            <div class="skeleton skeleton-line short"></div>
                            <div class="skeleton skeleton-line long"></div>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = skeletonHTML;
        }
        
        // Price loading indicator
        function setPriceLoading(elementId, loading = true) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            if (loading) {
                element.classList.add('price-loading');
            } else {
                element.classList.remove('price-loading');
            }
        }
        
        // Card shimmer loading
        function setCardLoading(cardId, loading = true) {
            const card = document.getElementById(cardId);
            if (!card) return;
            
            if (loading) {
                card.classList.add('card-loading');
            } else {
                card.classList.remove('card-loading');
            }
        }
        
        // Tab switching management for live price updates
        function handleTabSwitch(tabName) {
            currentActiveTab = tabName;
            
            if (tabName === 'positions') {
                // Load positions and start live updates
                loadPositions().then(() => {
                    // Only start updates if still on positions tab
                    if (currentActiveTab === 'positions') {
                        const activePositions = document.querySelectorAll('[data-trade-id]');
                        if (activePositions.length > 0) {
                            startLivePriceUpdates();
                        } else {
                            stopLivePriceUpdates();
                        }
                    }
                });
            } else if (tabName === 'trading') {
                // Stop live updates and load trade configs
                stopLivePriceUpdates();
                loadTradeConfigs();
            } else if (tabName === 'portfolio') {
                // Load portfolio and start updates for active positions
                loadPortfolio().then(() => {
                    // Only start updates if still on portfolio tab
                    if (currentActiveTab === 'portfolio') {
                        const activePositions = document.querySelectorAll('[data-trade-id]');
                        if (activePositions.length > 0) {
                            startLivePriceUpdates();
                        } else {
                            stopLivePriceUpdates();
                        }
                    }
                });
            } else if (tabName === 'credentials') {
                // Stop live updates and load credentials
                stopLivePriceUpdates();
                loadCredentialsStatus();
            }
        }

        // Add live price indicator to header with connectivity status
        function addLivePriceIndicator() {
            const header = document.querySelector('.header h5');
            if (header && !header.querySelector('.live-indicator')) {
                const indicator = document.createElement('span');
                indicator.className = 'live-indicator';
                indicator.innerHTML = ' <div class="live-indicator-dot connected" title="Connected - Fast API response"></div><small style="margin-left: 4px; color: var(--tg-theme-hint-color);">LIVE</small>';
                header.appendChild(indicator);
            }
        }

        function removeLivePriceIndicator() {
            const indicator = document.querySelector('.live-indicator');
            if (indicator) indicator.remove();
        }

        // Override start/stop functions to manage indicator
        const originalStartLivePriceUpdates = startLivePriceUpdates;
        const originalStopLivePriceUpdates = stopLivePriceUpdates;
        
        startLivePriceUpdates = function() {
            originalStartLivePriceUpdates();
            addLivePriceIndicator();
            // Initialize with connecting status
            setTimeout(() => updateLiveIndicatorStatus('connected'), 100);
        };
        
        stopLivePriceUpdates = function() {
            originalStopLivePriceUpdates();
            // Set to error status before removing to show disconnection
            updateLiveIndicatorStatus('error');
            setTimeout(() => removeLivePriceIndicator(), 300);
        };

        // Reset History Functions
        async function confirmResetHistory() {
            if (!getUserId()) {
                alert('⚠️ Please set up your Telegram user first');
                return;
            }
            
            const confirmed = confirm(
                "⚠️ WARNING: This will permanently delete all your trade history and reset your P&L to zero.\n\n" +
                "Your API credentials will NOT be affected.\n\n" + 
                "Are you sure you want to continue?"
            );
            
            if (confirmed) {
                await resetTradeHistory();
            }
        }
        
        async function resetTradeHistory() {
            const resetBtn = document.getElementById('reset-history-btn');
            if (!resetBtn) return;
            
            try {
                // Show loading state
                const originalText = resetBtn.innerHTML;
                resetBtn.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Resetting...';
                resetBtn.disabled = true;
                resetBtn.classList.add('btn-loading');
                
                const result = await apiCall('/api/reset-history', {
                    method: 'POST',
                    body: JSON.stringify({
                        user_id: getUserId()
                    })
                });
                
                if (result && result.success) {
                    showSuccessMessage('✅ Trade history reset successfully');
                    
                    // Reset UI elements to paper trading initial balance - works with any credentials
                    const uiElements = {
                        'account-balance': '$10,000.00',
                        'margin-used': '$0.00', 
                        'free-margin': '$10,000.00',
                        'margin-ratio': '0%',
                        'realized-pnl': '$0.00',
                        'total-pnl-portfolio': '$0.00'
                    };
                    
                    // Update UI elements safely
                    for (const [id, value] of Object.entries(uiElements)) {
                        const element = document.getElementById(id);
                        if (element) {
                            element.textContent = value;
                            if (id === 'total-pnl-portfolio') {
                                element.style.color = '#28a745'; // Green for neutral
                            }
                        }
                    }
                    
                    // Clear portfolio details
                    const portfolioDetails = document.getElementById('portfolio-details');
                    if (portfolioDetails) {
                        portfolioDetails.innerHTML = '<div class="text-center py-4"><small class="text-muted">No trade history</small></div>';
                    }
                    
                    console.log('[RENDER DEBUG] Refreshing UI after history reset...');
                    
                    // Force refresh all tabs with optimized loading for Render
                    try {
                        await Promise.all([
                            loadPortfolio(),
                            currentActiveTab === 'positions' ? loadPositions() : Promise.resolve(),
                            currentActiveTab === 'trading' ? loadTradeConfigs() : Promise.resolve()
                        ]);
                    } catch (refreshError) {
                        console.warn('[RENDER DEBUG] Some tabs failed to refresh:', refreshError);
                        // Continue anyway - the reset was successful
                    }
                    
                } else {
                    const errorMsg = result?.error || 'Failed to reset history';
                    showErrorMessage(`❌ ${errorMsg}`);
                }
            } catch (error) {
                console.error('[RENDER DEBUG] Reset history error:', error);
                showErrorMessage('❌ Failed to reset history - please try again');
            } finally {
                // Restore button state
                resetBtn.innerHTML = '🗑️ Reset History';
                resetBtn.disabled = false;
                resetBtn.classList.remove('btn-loading');
            }
        }

        // Hamburger menu functionality
        function toggleHamburgerMenu() {
            const dropdown = document.getElementById('hamburger-dropdown');
            dropdown.classList.toggle('show');
        }

        function openApiKeysSettings() {
            // Hide hamburger menu
            document.getElementById('hamburger-dropdown').classList.remove('show');
            
            // Show API Keys modal
            const modal = new bootstrap.Modal(document.getElementById('apiKeysModal'));
            modal.show();
            
            // Load current credentials status
            loadCredentialsStatus();
        }

        // Simple notification function for Telegram Web App
        function showNotification(type, message) {
            try {
                // Use Telegram Web App haptic feedback if available
                if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) {
                    if (type === 'error') {
                        window.Telegram.WebApp.HapticFeedback.notificationOccurred('error');
                    } else if (type === 'info' || type === 'success') {
                        window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                    }
                }
                
                // Show message using browser alert for now (can be enhanced later)
                const emoji = type === 'error' ? '❌' : type === 'success' ? '✅' : 'ℹ️';
                alert(`${emoji} ${message}`);
            } catch (error) {
                console.error('Error showing notification:', error);
                // Fallback to console log
                console.log(`${type.toUpperCase()}: ${message}`);
            }
        }

        async function togglePaperTrading() {
            // Hide hamburger menu
            document.getElementById('hamburger-dropdown').classList.remove('show');
            
            const response = await apiCall('/api/toggle-paper-trading', {
                method: 'POST',
                body: JSON.stringify({
                    user_id: getUserId()
                })
            });
            
            if (response && response.success) {
                // Update the UI text and cached status
                const paperText = document.getElementById('paper-trading-text');
                paperText.textContent = response.paper_trading_active ? 'Paper Trading: On' : 'Paper Trading: Off';
                window.currentPaperTradingStatus = response.paper_trading_active;
                
                // Show success notification
                showNotification('info', `Paper trading ${response.paper_trading_active ? 'enabled' : 'disabled'}`);
                
                // Refresh the portfolio and active positions since the mode changed
                await loadPositions();
                await loadPortfolio();
            } else {
                console.error('Error toggling paper trading:', response);
                showNotification('error', response?.message || 'Failed to toggle paper trading mode');
            }
        }

        async function showDiagnosticInfo() {
            // Hide hamburger menu
            document.getElementById('hamburger-dropdown').classList.remove('show');
            
            try {
                const diagnostic = await apiCall(`/api/debug/trading-status?user_id=${getUserId()}`);
                
                let diagMessage = '🔍 TRADING STATUS DIAGNOSTIC\n\n';
                
                // Environment Info
                diagMessage += '🌐 ENVIRONMENT:\n';
                diagMessage += `Platform: ${diagnostic.environment.is_replit ? 'Replit' : 
                                         diagnostic.environment.is_render ? 'Render' : 
                                         diagnostic.environment.is_vercel ? 'Vercel' : 'Unknown'}\n`;
                diagMessage += `Database: ${diagnostic.environment.database_type}\n\n`;
                
                // Credentials Status
                diagMessage += '🔑 API CREDENTIALS:\n';
                diagMessage += `Status: ${diagnostic.credentials.has_credentials_in_db ? '✅ Found' : '❌ Not Set'}\n`;
                if (diagnostic.credentials.has_credentials_in_db) {
                    diagMessage += `API Key: ${diagnostic.credentials.has_api_key ? '✅' : '❌'}\n`;
                    diagMessage += `API Secret: ${diagnostic.credentials.has_api_secret ? '✅' : '❌'}\n`;
                    diagMessage += `Passphrase: ${diagnostic.credentials.has_passphrase ? '✅' : '❌'}\n`;
                    diagMessage += `Exchange: ${diagnostic.credentials.exchange_name || 'Unknown'}\n`;
                }
                diagMessage += '\n';
                
                // Trading Mode
                diagMessage += '📊 TRADING MODE:\n';
                diagMessage += `Paper Trading: ${diagnostic.trading_mode.manual_paper_mode ? 'ON' : 'OFF'}\n`;
                diagMessage += `Paper Balance: $${diagnostic.trading_mode.paper_balance.toLocaleString()}\n`;
                diagMessage += `Will Use Paper Mode: ${diagnostic.trading_mode.would_use_paper_mode ? 'YES' : 'NO'}\n`;
                diagMessage += `Active Trades: ${diagnostic.active_trades}\n\n`;
                
                // Toobit Connection
                if (diagnostic.toobit_connection) {
                    diagMessage += '🔗 TOOBIT CONNECTION:\n';
                    diagMessage += `Status: ${diagnostic.toobit_connection.status === 'success' ? '✅ Connected' : '❌ Failed'}\n`;
                    if (diagnostic.toobit_connection.status === 'failed') {
                        diagMessage += `Error: ${diagnostic.toobit_connection.error}\n`;
                    } else {
                        diagMessage += `Balance Data: ${diagnostic.toobit_connection.has_balance_data ? '✅ Available' : '❌ None'}\n`;
                    }
                } else {
                    diagMessage += '🔗 TOOBIT CONNECTION:\n❌ No credentials to test\n';
                }
                
                console.log('[RENDER DEBUG] Full diagnostic data:', diagnostic);
                alert(diagMessage);
                
            } catch (error) {
                console.error('[RENDER DEBUG] Diagnostic failed:', error);
                alert('Failed to load diagnostic information. Check console for details.');
            }
        }

        // Close hamburger menu when clicking outside
        document.addEventListener('click', function(event) {
            const hamburgerMenu = document.querySelector('.hamburger-menu');
            const dropdown = document.getElementById('hamburger-dropdown');
            
            if (hamburgerMenu && !hamburgerMenu.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // API Keys modal functions
        function showApiCredentialsSetup() {
            document.getElementById('api-credentials-setup').classList.remove('hidden');
            
            // Clear form
            document.getElementById('api-exchange-select').value = 'toobit';
            document.getElementById('api-key-modal-input').value = '';
            document.getElementById('api-secret-modal-input').value = '';
            document.getElementById('api-passphrase-modal-input').value = '';
            
            // Show/hide passphrase based on exchange
            const exchange = document.getElementById('api-exchange-select').value;
            const passphraseGroup = document.getElementById('api-passphrase-group');
            passphraseGroup.style.display = exchange === 'okx' ? 'block' : 'none';
        }

        function cancelApiCredentialsSetup() {
            document.getElementById('api-credentials-setup').classList.add('hidden');
        }

        async function saveApiCredentials() {
            const exchange = document.getElementById('api-exchange-select').value;
            const apiKey = document.getElementById('api-key-modal-input').value.trim();
            const apiSecret = document.getElementById('api-secret-modal-input').value.trim();
            const passphrase = document.getElementById('api-passphrase-modal-input').value.trim();

            if (!apiKey || !apiSecret) {
                alert('Please enter both API key and secret');
                return;
            }

            if (exchange === 'okx' && !passphrase) {
                alert('Passphrase is required for OKX');
                return;
            }

            try {
                const response = await apiCall('/api/save-credentials', {
                    method: 'POST',
                    body: JSON.stringify({
                        user_id: getUserId(),
                        exchange: exchange,
                        api_key: apiKey,
                        api_secret: apiSecret,
                        passphrase: passphrase || null
                    })
                });

                if (response && response.success) {
                    alert('API credentials saved successfully!');
                    cancelApiCredentialsSetup();
                    loadCredentialsStatus();
                } else {
                    alert('Failed to save credentials: ' + (response?.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Save credentials error:', error);
                alert('Failed to save credentials. Please try again.');
            }
        }

        async function toggleTestnetMode(newTestnetMode) {
            const confirmMessage = newTestnetMode 
                ? 'Switch to testnet mode? This will use virtual funds for testing.'
                : '⚠️ WARNING: Switch to live trading mode? This will use REAL MONEY for trades!';
                
            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                const response = await apiCall('/api/toggle-testnet', {
                    method: 'POST',
                    body: JSON.stringify({
                        user_id: getUserId(),
                        testnet_mode: newTestnetMode
                    })
                });

                if (response && response.success) {
                    if (response.warning) {
                        alert(response.warning);
                    } else {
                        alert(response.message);
                    }
                    loadCredentialsStatus();
                    
                    // If user is on portfolio tab, refresh it to show the new balance data
                    if (currentActiveTab === 'portfolio') {
                        loadPortfolio();
                    }
                } else {
                    alert('Failed to toggle mode: ' + (response?.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Toggle testnet error:', error);
                alert('Failed to toggle trading mode. Please try again.');
            }
        }

        async function deleteApiCredentials() {
            if (!confirm('Are you sure you want to delete your API credentials?')) {
                return;
            }

            try {
                const response = await apiCall('/api/delete-credentials', {
                    method: 'POST',
                    body: JSON.stringify({
                        user_id: getUserId()
                    })
                });

                if (response && response.success) {
                    alert('API credentials deleted successfully!');
                    loadCredentialsStatus();
                } else {
                    alert('Failed to delete credentials: ' + (response?.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Delete credentials error:', error);
                alert('Failed to delete credentials. Please try again.');
            }
        }

        // Exchange change handler for modal
        document.addEventListener('DOMContentLoaded', function() {
            const exchangeSelect = document.getElementById('api-exchange-select');
            if (exchangeSelect) {
                exchangeSelect.addEventListener('change', function() {
                    const exchange = this.value;
                    const passphraseGroup = document.getElementById('api-passphrase-group');
                    passphraseGroup.style.display = exchange === 'okx' ? 'block' : 'none';
                });
            }
        });

        // Initialize mobile enhancements after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeMobileEnhancements();
            
            // Set up tab click handlers for live price management
            document.querySelectorAll('.nav-link').forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-bs-target')?.replace('#', '');
                    if (targetTab) {
                        setTimeout(() => handleTabSwitch(targetTab), 100);
                    }
                });
            });
            
            // Auto-load positions tab data if it's the default active tab
            const activeTab = document.querySelector('.nav-link.active')?.getAttribute('data-bs-target')?.replace('#', '');
            if (activeTab === 'positions') {
                handleTabSwitch('positions');
            }
        });

        // SMC Signal Functions
        let smcSignalsData = [];
        let smcAutoRefreshInterval = null;

        async function loadSmcSignals() {
            const container = document.getElementById('smc-signals-list');
            const indicator = document.getElementById('smc-indicator');
            const lastUpdate = document.getElementById('smc-last-update');
            
            // Try to load cached signals first
            const cachedSignals = loadCachedSmcSignals();
            if (cachedSignals && cachedSignals.data && cachedSignals.data.length > 0) {
                // Show cached signals immediately
                smcSignalsData = cachedSignals.data;
                updateSmcSummary();
                renderSmcSignals();
                
                // Show cached indicator
                if (indicator) {
                    indicator.className = 'live-indicator-dot warning';
                }
                if (lastUpdate) {
                    const cacheTime = new Date(cachedSignals.timestamp);
                    lastUpdate.textContent = `📋 Cached: ${cacheTime.toLocaleTimeString()}`;
                }
                
                // Add a small loading indicator for background refresh
                const loadingBadge = document.createElement('div');
                loadingBadge.id = 'background-loading';
                loadingBadge.className = 'badge bg-primary ms-2';
                loadingBadge.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status"></span>Refreshing...';
                loadingBadge.style.fontSize = '10px';
                if (lastUpdate && !document.getElementById('background-loading')) {
                    lastUpdate.appendChild(loadingBadge);
                }
            } else {
                // No cache, show loading state
                if (indicator) {
                    indicator.className = 'live-indicator-dot slow';
                }
                
                container.innerHTML = `
                    <div class="loading">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        Analyzing Smart Money Concepts...
                    </div>
                `;
            }
            
            try {
                // Always fetch fresh data in background
                const response = await fetch('/api/smc-signals');
                const data = await response.json();

                if (data.signals) {
                    const newSignalsData = Object.entries(data.signals).map(([symbol, signal]) => ({
                        symbol,
                        ...signal
                    }));
                    
                    // Cache the new signals
                    cacheSmcSignals(newSignalsData);
                    
                    // Update display with fresh data
                    smcSignalsData = newSignalsData;
                    updateSmcSummary();
                    renderSmcSignals();
                    
                    // Update status to connected
                    if (indicator) {
                        indicator.className = 'live-indicator-dot connected';
                    }
                    if (lastUpdate) {
                        lastUpdate.textContent = new Date().toLocaleTimeString();
                        // Remove background loading indicator
                        const loadingBadge = document.getElementById('background-loading');
                        if (loadingBadge) {
                            loadingBadge.remove();
                        }
                    }
                } else {
                    throw new Error('Invalid response format');
                }
            } catch (error) {
                console.error('Error loading SMC signals:', error);
                
                // Only show error if we don't have cached data
                if (!cachedSignals || !cachedSignals.data || cachedSignals.data.length === 0) {
                    container.innerHTML = `
                        <div class="smc-no-signals">
                            <div class="smc-no-signals-icon">⚠️</div>
                            <div class="smc-no-signals-text">Error Loading Signals</div>
                            <div class="smc-no-signals-subtitle">Please try refreshing or check your connection</div>
                        </div>
                    `;
                }
                
                // Update status to error
                if (indicator) {
                    indicator.className = 'live-indicator-dot error';
                }
                if (lastUpdate) {
                    const loadingBadge = document.getElementById('background-loading');
                    if (loadingBadge) {
                        loadingBadge.textContent = 'Failed to refresh';
                        loadingBadge.className = 'badge bg-danger ms-2';
                        loadingBadge.style.fontSize = '10px';
                    }
                }
            }
        }

        // Cache management functions for SMC signals (DISABLED - localStorage cache disabled)
        function cacheSmcSignals(signalsData) {
            // localStorage cache disabled - SMC signals will always fetch fresh data from backend
            console.log('SMC localStorage cache disabled - using fresh data from backend');
            return;
        }

        function loadCachedSmcSignals() {
            // localStorage cache disabled - always return null to force fresh data from backend
            console.log('SMC localStorage cache disabled - returning null to force fresh backend fetch');
            return null;
        }

        function updateSmcSummary() {
            const totalSignals = smcSignalsData.filter(s => s.direction).length;
            const strongSignals = smcSignalsData.filter(s => s.confidence >= 0.7).length;
            const bullishSignals = smcSignalsData.filter(s => s.direction === 'long').length;
            const bearishSignals = smcSignalsData.filter(s => s.direction === 'short').length;

            document.getElementById('smc-total-signals').textContent = totalSignals;
            document.getElementById('smc-strong-signals').textContent = strongSignals;
            document.getElementById('smc-bullish-signals').textContent = bullishSignals;
            document.getElementById('smc-bearish-signals').textContent = bearishSignals;
        }

        function renderSmcSignals() {
            const container = document.getElementById('smc-signals-list');
            const minConfidence = parseFloat(document.getElementById('confidence-filter').value);
            
            const filteredSignals = smcSignalsData.filter(signal => 
                signal.direction && signal.confidence >= minConfidence
            );

            if (filteredSignals.length === 0) {
                container.innerHTML = `
                    <div class="smc-no-signals">
                        <div class="smc-no-signals-icon">🔍</div>
                        <div class="smc-no-signals-text">No Signals Found</div>
                        <div class="smc-no-signals-subtitle">Try lowering the confidence filter or check back later</div>
                    </div>
                `;
                return;
            }

            const signalsHtml = filteredSignals.map(signal => `
                <div class="smc-signal-item">
                    <div class="smc-signal-header">
                        <div class="smc-signal-symbol">${signal.symbol}</div>
                        <div class="smc-signal-direction ${signal.direction}">${signal.direction}</div>
                    </div>
                    
                    <div class="smc-confidence-bar">
                        <div class="smc-confidence-progress">
                            <div class="smc-confidence-fill" style="width: ${(signal.confidence * 100)}%"></div>
                        </div>
                        <div class="smc-confidence-text">${(signal.confidence * 100).toFixed(0)}%</div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div class="smc-signal-strength ${signal.signal_strength.toLowerCase()}">
                            ${signal.signal_strength.replace('_', ' ')}
                        </div>
                        <div class="text-muted" style="font-size: 0.8rem; font-family: 'JetBrains Mono', monospace;">
                            R:R 1:${signal.risk_reward_ratio?.toFixed(1) || 'N/A'}
                        </div>
                    </div>
                    
                    <div class="smc-signal-details">
                        <div class="smc-detail-item">
                            <div class="smc-detail-label">Entry</div>
                            <div class="smc-detail-value">$${signal.entry_price?.toFixed(4) || 'N/A'}</div>
                        </div>
                        <div class="smc-detail-item">
                            <div class="smc-detail-label">Stop Loss</div>
                            <div class="smc-detail-value">$${signal.stop_loss?.toFixed(4) || 'N/A'}</div>
                        </div>
                    </div>
                    
                    ${signal.reasoning && signal.reasoning.length > 0 ? `
                        <div class="smc-reasoning">
                            <div class="smc-reasoning-title">Analysis</div>
                            <ul class="smc-reasoning-list">
                                ${signal.reasoning.slice(0, 3).map(reason => `<li>${reason}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    <div class="smc-signal-actions">
                        <button class="btn btn-outline-primary btn-sm" onclick="viewSignalDetails('${signal.symbol}')">
                            <i data-feather="eye"></i> Details
                        </button>
                        ${signal.confidence >= 0.7 ? `
                            <button class="btn smc-auto-trade-btn btn-sm" onclick="createAutoTrade('${signal.symbol}')">
                                Auto Trade
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');

            container.innerHTML = signalsHtml;
            
            // Re-initialize feather icons
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        }

        function filterSignals() {
            renderSmcSignals();
        }

        async function refreshSmcSignals() {
            // localStorage cache disabled - no need to clear cache, always using fresh backend data
            console.log('Refreshing SMC signals from backend (localStorage cache disabled)');
            
            await loadSmcSignals();
            alert('✅ SMC signals refreshed');
        }

        async function viewSignalDetails(symbol) {
            try {
                const response = await fetch(`/api/smc-analysis/${symbol}`);
                const data = await response.json();
                
                if (data.status === 'cached_signal' || data.status === 'new_signal_generated') {
                    // Create detailed analysis modal
                    const modalHtml = `
                        <div class="modal fade" id="smcDetailsModal" tabindex="-1">
                            <div class="modal-dialog modal-xl">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h6 class="modal-title">SMC Analysis - ${symbol}</h6>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="row mb-2 g-2">
                                            <div class="col-6">
                                                <div class="smc-detail-item compact">
                                                    <div class="smc-detail-label">Direction</div>
                                                    <div class="smc-detail-value">${data.direction}</div>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="smc-detail-item compact">
                                                    <div class="smc-detail-label">Confidence</div>
                                                    <div class="smc-detail-value">${(data.confidence * 100).toFixed(1)}%</div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="row mb-2 g-2">
                                            <div class="col-4">
                                                <div class="smc-detail-item compact">
                                                    <div class="smc-detail-label">Entry Price</div>
                                                    <div class="smc-detail-value">$${data.entry_price?.toFixed(4)}</div>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="smc-detail-item compact">
                                                    <div class="smc-detail-label">Stop Loss</div>
                                                    <div class="smc-detail-value">$${data.stop_loss?.toFixed(4)}</div>
                                                </div>
                                            </div>
                                            <div class="col-4">
                                                <div class="smc-detail-item compact">
                                                    <div class="smc-detail-label">Risk:Reward</div>
                                                    <div class="smc-detail-value">1:${data.risk_reward_ratio?.toFixed(1)}</div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        ${data.take_profit_levels && data.take_profit_levels.length > 0 ? `
                                            <h6 class="mb-1 fs-7">Take Profit Levels</h6>
                                            <div class="row mb-2 g-2">
                                                ${data.take_profit_levels.map((tp, index) => `
                                                    <div class="col-4">
                                                        <div class="smc-detail-item compact">
                                                            <div class="smc-detail-label">TP ${index + 1}</div>
                                                            <div class="smc-detail-value">$${tp?.toFixed(4)}</div>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                        
                                        <!-- Chart Visualization Section -->
                                        <div class="mb-4">
                                            <div class="d-flex justify-content-between align-items-center mb-3">
                                                <h6 class="mb-0">Market Analysis Chart</h6>
                                                <div class="d-flex gap-2">
                                                    <button class="btn btn-outline-secondary btn-sm" onclick="resetChartZoom()" id="reset-zoom-btn" style="display: none;">
                                                        <i data-feather="zoom-out"></i> Reset Zoom
                                                    </button>
                                                    <button class="btn btn-outline-primary btn-sm" onclick="loadSmcChart('${symbol}')" id="load-chart-btn">
                                                        <i data-feather="bar-chart-2"></i> Load Chart
                                                    </button>
                                                </div>
                                            </div>
                                            <div id="chart-container" style="display: none;">
                                                <div class="smc-chart-wrapper" style="height: 600px; background: var(--tg-theme-card-bg); border-radius: 12px; padding: 8px; border: 1px solid var(--tg-theme-border-color);">
                                                    <canvas id="smc-chart"></canvas>
                                                </div>
                                                <div class="mt-3 p-2" style="background: rgba(107, 139, 179, 0.05); border-radius: 6px;">
                                                    <div class="d-flex flex-wrap justify-content-center gap-3">
                                                        <small class="text-muted d-flex align-items-center">
                                                            <span style="width: 12px; height: 12px; background: rgba(34, 139, 34, 0.6); border-radius: 2px; margin-right: 4px;"></span>
                                                            Order Blocks
                                                        </small>
                                                        <small class="text-muted d-flex align-items-center">
                                                            <span style="width: 12px; height: 12px; background: rgba(255, 193, 7, 0.6); border-radius: 2px; margin-right: 4px;"></span>
                                                            Fair Value Gaps
                                                        </small>
                                                        <small class="text-muted d-flex align-items-center">
                                                            <span style="width: 12px; height: 12px; background: rgba(255, 77, 79, 0.6); border-radius: 2px; margin-right: 4px;"></span>
                                                            Sell Liquidity
                                                        </small>
                                                        <small class="text-muted d-flex align-items-center">
                                                            <span style="width: 12px; height: 12px; background: rgba(52, 196, 26, 0.6); border-radius: 2px; margin-right: 4px;"></span>
                                                            Buy Liquidity
                                                        </small>
                                                    </div>
                                                    <div class="text-center mt-2">
                                                        <small class="text-muted">💡 Tip: Use mouse wheel to zoom, drag to pan, double-click to reset</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div id="chart-loading" style="display: none; text-align: center; padding: 2rem;">
                                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                                <div class="mt-2"><small class="text-muted">Loading chart data...</small></div>
                                            </div>
                                        </div>
                                        
                                        <h6 class="mb-1 fs-7">Analysis Reasoning</h6>
                                        <ul class="smc-reasoning-list">
                                            ${data.reasoning.map(reason => `<li>${reason}</li>`).join('')}
                                        </ul>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                                        ${data.confidence >= 0.7 ? `
                                            <button type="button" class="btn smc-auto-trade-btn" onclick="createAutoTrade('${symbol}'); bootstrap.Modal.getInstance(document.getElementById('smcDetailsModal')).hide();">
                                                Create Auto Trade
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Remove existing modal if any
                    const existingModal = document.getElementById('smcDetailsModal');
                    if (existingModal) {
                        existingModal.remove();
                    }
                    
                    // Add new modal to body
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                    
                    // Show modal
                    const modal = new bootstrap.Modal(document.getElementById('smcDetailsModal'));
                    modal.show();
                } else {
                    alert(`⚠️ No detailed analysis available for ${symbol}`);
                }
            } catch (error) {
                console.error('Error fetching signal details:', error);
                alert('❌ Error loading signal details');
            }
        }

        async function createAutoTrade(symbol) {
            try {
                const marginAmount = prompt(`Enter margin amount for ${symbol} trade:`, '100');
                if (!marginAmount || isNaN(marginAmount) || parseFloat(marginAmount) <= 0) {
                    return;
                }

                const response = await fetch('/api/smc-auto-trade', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        user_id: getUserId() || '123456789',
                        margin_amount: parseFloat(marginAmount)
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`✅ Auto-trade created for ${symbol}!`);
                    
                    // Switch to trading tab and explicitly refresh
                    const tradingTab = document.getElementById('trading-tab');
                    if (tradingTab) {
                        tradingTab.click();
                        // Wait a moment for tab switch, then reload
                        setTimeout(() => {
                            loadTradeConfigs();
                        }, 200);
                    } else {
                        // If tab button not found, just reload current view if on trading tab
                        if (currentActiveTab === 'trading') {
                            loadTradeConfigs();
                        }
                    }
                } else {
                    alert(`❌ ${result.error || 'Failed to create auto-trade'}`);
                }
            } catch (error) {
                console.error('Error creating auto-trade:', error);
                alert('❌ Error creating auto-trade');
            }
        }

        // SMC Chart Visualization Functions
        let smcChart = null;

        function resetChartZoom() {
            if (smcChart) {
                smcChart.resetZoom();
                // Hide reset zoom button
                const resetBtn = document.getElementById('reset-zoom-btn');
                if (resetBtn) resetBtn.style.display = 'none';
            }
        }

        async function loadSmcChart(symbol) {
            try {
                const loadBtn = document.getElementById('load-chart-btn');
                const chartContainer = document.getElementById('chart-container');
                const loadingDiv = document.getElementById('chart-loading');
                
                // Show loading state
                loadBtn.disabled = true;
                loadBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Loading...';
                loadingDiv.style.display = 'block';
                
                // Fetch chart data
                const response = await fetch(`/api/smc-chart-data/${symbol}`);
                const chartData = await response.json();
                
                if (chartData.error) {
                    throw new Error(chartData.error);
                }
                
                // Hide loading and show chart
                loadingDiv.style.display = 'none';
                chartContainer.style.display = 'block';
                
                // Create the chart
                renderSmcChart(chartData);
                
                // Update button
                loadBtn.innerHTML = '<i data-feather="refresh-cw"></i> Refresh Chart';
                loadBtn.disabled = false;
                
                // Re-initialize feather icons
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
                
            } catch (error) {
                console.error('Error loading SMC chart:', error);
                document.getElementById('chart-loading').style.display = 'none';
                document.getElementById('load-chart-btn').innerHTML = '<i data-feather="bar-chart-2"></i> Load Chart';
                document.getElementById('load-chart-btn').disabled = false;
                alert('Failed to load chart data: ' + error.message);
            }
        }

        function renderSmcChart(chartData) {
            const ctx = document.getElementById('smc-chart').getContext('2d');
            
            // Destroy existing chart if any
            if (smcChart) {
                smcChart.destroy();
            }
            
            // Chart.js Financial plugin provides candlestick support
            // Register required components
            // Prepare candlestick data for Chart.js Financial
            const candlestickData = chartData.candlesticks.map(candle => ({
                x: candle.time,
                o: candle.open,
                h: candle.high,
                l: candle.low,
                c: candle.close
            }));
            
            // Create annotations for SMC elements
            const annotations = {};
            let annotationId = 0;
            
            // Add Order Blocks as rectangles
            chartData.order_blocks.forEach(ob => {
                const color = ob.direction === 'bullish' ? 'rgba(34, 139, 34, 0.3)' : 'rgba(220, 53, 69, 0.3)';
                const borderColor = ob.direction === 'bullish' ? 'rgba(34, 139, 34, 0.8)' : 'rgba(220, 53, 69, 0.8)';
                
                annotations[`ob_${annotationId++}`] = {
                    type: 'box',
                    xMin: ob.time,
                    xMax: ob.time + (1000 * 60 * 60 * 4), // 4 hours width
                    yMin: Math.min(ob.high, ob.low),
                    yMax: Math.max(ob.high, ob.low),
                    backgroundColor: color,
                    borderColor: borderColor,
                    borderWidth: 1,
                    label: {
                        display: true,
                        content: `OB (${ob.direction})`,
                        position: 'start'
                    }
                };
            });
            
            // Add Fair Value Gaps as rectangles
            chartData.fair_value_gaps.forEach(fvg => {
                if (!fvg.filled) {
                    const color = fvg.direction === 'bullish' ? 'rgba(255, 193, 7, 0.4)' : 'rgba(255, 87, 34, 0.4)';
                    const borderColor = fvg.direction === 'bullish' ? 'rgba(255, 193, 7, 0.8)' : 'rgba(255, 87, 34, 0.8)';
                    
                    annotations[`fvg_${annotationId++}`] = {
                        type: 'box',
                        xMin: fvg.time,
                        xMax: fvg.time + (1000 * 60 * 60 * 8), // 8 hours width
                        yMin: Math.min(fvg.high, fvg.low),
                        yMax: Math.max(fvg.high, fvg.low),
                        backgroundColor: color,
                        borderColor: borderColor,
                        borderWidth: 1,
                        borderDash: [5, 5],
                        label: {
                            display: true,
                            content: `FVG (${fvg.direction})`,
                            position: 'start'
                        }
                    };
                }
            });
            
            // Add Liquidity Levels as horizontal lines
            chartData.liquidity_pools.forEach(lp => {
                const color = lp.type === 'buy_side' ? 'rgba(52, 196, 26, 0.8)' : 'rgba(255, 77, 79, 0.8)';
                
                annotations[`lp_${annotationId++}`] = {
                    type: 'line',
                    mode: 'horizontal',
                    scaleID: 'y',
                    value: lp.price,
                    borderColor: color,
                    borderWidth: 2,
                    borderDash: lp.swept ? [2, 4] : [8, 4],
                    label: {
                        display: true,
                        content: `${lp.type.replace('_', ' ')} liquidity`,
                        position: 'end'
                    }
                };
            });
            
            // Chart configuration
            const config = {
                type: 'candlestick',
                data: {
                    datasets: [{
                        label: chartData.symbol,
                        data: candlestickData,
                        borderColor: '#6bb6ff',
                        backgroundColor: 'rgba(107, 182, 255, 0.1)',
                        borderWidth: 1,
                        // Candlestick specific styling
                        color: {
                            up: '#52c41a',   // Green for bullish candles
                            down: '#ff4d4f', // Red for bearish candles
                            unchanged: '#6bb6ff'
                        },
                        borderColor: {
                            up: '#389e0d',   // Darker green border
                            down: '#cf1322', // Darker red border
                            unchanged: '#4096ff'
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 15,
                            right: 15,
                            bottom: 15,
                            left: 15
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'hour',
                                displayFormats: {
                                    hour: 'MMM dd HH:mm'
                                }
                            },
                            ticks: {
                                color: '#8b9dc3',
                                maxRotation: 45
                            },
                            grid: {
                                color: 'rgba(139, 157, 195, 0.2)'
                            }
                        },
                        y: {
                            position: 'right',
                            ticks: {
                                color: '#8b9dc3',
                                callback: function(value) {
                                    return '$' + value.toFixed(4);
                                }
                            },
                            grid: {
                                color: 'rgba(139, 157, 195, 0.2)'
                            }
                        }
                    },
                    plugins: {
                        zoom: {
                            zoom: {
                                wheel: {
                                    enabled: true,
                                    speed: 0.1
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'xy',
                                scaleMode: 'x',
                                onZoomComplete: function() {
                                    // Show reset zoom button when zoomed
                                    const resetBtn = document.getElementById('reset-zoom-btn');
                                    if (resetBtn) resetBtn.style.display = 'inline-block';
                                }
                            },
                            pan: {
                                enabled: true,
                                mode: 'xy',
                                modifierKey: null,
                                onPanComplete: function() {
                                    // Show reset zoom button when panned
                                    const resetBtn = document.getElementById('reset-zoom-btn');
                                    if (resetBtn) resetBtn.style.display = 'inline-block';
                                }
                            }
                        },
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            titleColor: '#e8eef7',
                            bodyColor: '#e8eef7',
                            backgroundColor: 'rgba(15, 20, 25, 0.9)',
                            borderColor: '#3a4658',
                            borderWidth: 1,
                            callbacks: {
                                afterBody: function(context) {
                                    const point = context[0];
                                    if (point && point.raw && point.raw.ohlc) {
                                        const ohlc = point.raw.ohlc;
                                        return [
                                            `Open: $${ohlc.open.toFixed(4)}`,
                                            `High: $${ohlc.high.toFixed(4)}`,
                                            `Low: $${ohlc.low.toFixed(4)}`,
                                            `Close: $${ohlc.close.toFixed(4)}`
                                        ];
                                    }
                                    return [];
                                }
                            }
                        },
                        annotation: {
                            annotations: annotations
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    },
                    onResize: function(chart, size) {
                        // Ensure chart remains responsive
                        chart.update('none');
                    }
                }
            };
            
            // Create the chart
            smcChart = new Chart(ctx, config);
        }

        function openSymbolAnalysis() {
            const symbol = prompt('Enter symbol to analyze (e.g., BTCUSDT):');
            if (symbol) {
                viewSignalDetails(symbol.toUpperCase());
            }
        }

        function startSmcAutoRefresh() {
            if (smcAutoRefreshInterval) {
                clearInterval(smcAutoRefreshInterval);
            }
            
            // Refresh every 2 minutes
            smcAutoRefreshInterval = setInterval(() => {
                const currentTab = document.querySelector('.nav-link.active')?.getAttribute('data-bs-target')?.replace('#', '');
                if (currentTab === 'smc-signals') {
                    loadSmcSignals();
                }
            }, 120000);
        }

        function stopSmcAutoRefresh() {
            if (smcAutoRefreshInterval) {
                clearInterval(smcAutoRefreshInterval);
                smcAutoRefreshInterval = null;
            }
        }

        // Update handleTabSwitch to include SMC signals and admin panel
        const originalHandleTabSwitch = handleTabSwitch;
        handleTabSwitch = function(tabName) {
            originalHandleTabSwitch(tabName);
            
            if (tabName === 'smc-signals') {
                stopLivePriceUpdates();
                loadSmcSignals();
                startSmcAutoRefresh();
            } else {
                stopSmcAutoRefresh();
            }
            
            if (tabName === 'admin-panel') {
                checkAdminAccess();
            }
        };

        // =====================================
        // ADMIN PANEL FUNCTIONS
        // =====================================
        
        let whitelistData = [];
        let filteredWhitelistData = [];
        
        async function checkAdminAccess() {
            try {
                // Show loading state
                document.getElementById('admin-access-check').classList.remove('d-none');
                document.getElementById('admin-access-denied').classList.add('d-none');
                document.getElementById('admin-panel-content').classList.add('d-none');
                
                const response = await apiCall('/api/whitelist/status');
                
                if (response.is_bot_owner) {
                    // User is bot owner, show admin panel
                    document.getElementById('admin-access-check').classList.add('d-none');
                    document.getElementById('admin-panel-content').classList.remove('d-none');
                    await loadWhitelistData();
                } else {
                    // User is not bot owner, show access denied
                    document.getElementById('admin-access-check').classList.add('d-none');
                    document.getElementById('admin-access-denied').classList.remove('d-none');
                }
                
            } catch (error) {
                console.error('Error checking admin access:', error);
                document.getElementById('admin-access-check').classList.add('d-none');
                document.getElementById('admin-access-denied').classList.remove('d-none');
            }
        }
        
        async function loadWhitelistData() {
            try {
                // Load whitelist stats
                const statsResponse = await apiCall('/api/admin/whitelist/stats');
                if (statsResponse.success) {
                    const stats = statsResponse.stats;
                    document.getElementById('admin-total-users').textContent = stats.total_users;
                    document.getElementById('admin-pending-users').textContent = stats.pending_users;
                    document.getElementById('admin-approved-users').textContent = stats.approved_users;
                    document.getElementById('admin-recent-requests').textContent = stats.recent_requests_7_days;
                }
                
                // Load users list
                const usersResponse = await apiCall('/api/admin/whitelist/users');
                if (usersResponse.success) {
                    whitelistData = usersResponse.users;
                    filteredWhitelistData = [...whitelistData];
                    renderWhitelistUsers();
                }
                
            } catch (error) {
                console.error('Error loading whitelist data:', error);
                document.getElementById('admin-users-list').innerHTML = `
                    <div class="text-center text-danger py-3">
                        <i data-feather="alert-circle"></i>
                        <p class="mb-0">Error loading whitelist data</p>
                    </div>
                `;
            }
        }
        
        function renderWhitelistUsers() {
            const container = document.getElementById('admin-users-list');
            
            if (!filteredWhitelistData || filteredWhitelistData.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i data-feather="users" style="width: 32px; height: 32px; opacity: 0.5;"></i>
                        <p class="mb-0 mt-2">No users found</p>
                    </div>
                `;
                feather.replace();
                return;
            }
            
            const html = filteredWhitelistData.map(user => {
                const statusClass = getStatusClass(user.status);
                const statusIcon = getStatusIcon(user.status);
                const displayName = user.first_name ? 
                    `${user.first_name} ${user.last_name || ''}`.trim() : 
                    user.telegram_username || `User ${user.telegram_user_id}`;
                
                return `
                    <div class="admin-user-item mb-2">
                        <div class="card">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center gap-2 mb-1">
                                            <strong class="text-primary">${displayName}</strong>
                                            <span class="badge ${statusClass}">${statusIcon} ${user.status.toUpperCase()}</span>
                                        </div>
                                        <div class="text-muted small">
                                            <div>ID: ${user.telegram_user_id}</div>
                                            ${user.telegram_username ? `<div>@${user.telegram_username}</div>` : ''}
                                            <div>Requested: ${user.requested_at}</div>
                                            ${user.last_access ? `<div>Last access: ${user.last_access} (${user.access_count} times)</div>` : ''}
                                            ${user.review_notes ? `<div class="text-warning">Notes: ${user.review_notes}</div>` : ''}
                                        </div>
                                    </div>
                                    <div class="admin-user-actions">
                                        ${renderUserActions(user)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = html;
            feather.replace();
        }
        
        function renderUserActions(user) {
            if (user.status === 'pending') {
                return `
                    <div class="btn-group-vertical btn-group-sm">
                        <button class="btn btn-success btn-sm" onclick="approveUser('${user.telegram_user_id}')">
                            <i data-feather="check"></i> Approve
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="rejectUser('${user.telegram_user_id}')">
                            <i data-feather="x"></i> Reject
                        </button>
                    </div>
                `;
            } else if (user.status === 'approved') {
                return `
                    <div class="btn-group-vertical btn-group-sm">
                        <button class="btn btn-warning btn-sm" onclick="rejectUser('${user.telegram_user_id}')">
                            <i data-feather="x"></i> Revoke
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="banUser('${user.telegram_user_id}')">
                            <i data-feather="shield"></i> Ban
                        </button>
                    </div>
                `;
            } else if (user.status === 'rejected') {
                return `
                    <div class="btn-group-vertical btn-group-sm">
                        <button class="btn btn-success btn-sm" onclick="approveUser('${user.telegram_user_id}')">
                            <i data-feather="check"></i> Approve
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="banUser('${user.telegram_user_id}')">
                            <i data-feather="shield"></i> Ban
                        </button>
                    </div>
                `;
            } else if (user.status === 'banned') {
                return `
                    <button class="btn btn-success btn-sm" onclick="approveUser('${user.telegram_user_id}')">
                        <i data-feather="check"></i> Unban
                    </button>
                `;
            }
            return '';
        }
        
        function getStatusClass(status) {
            switch (status) {
                case 'pending': return 'bg-warning text-dark';
                case 'approved': return 'bg-success';
                case 'rejected': return 'bg-secondary';
                case 'banned': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }
        
        function getStatusIcon(status) {
            switch (status) {
                case 'pending': return '⏳';
                case 'approved': return '✅';
                case 'rejected': return '❌';
                case 'banned': return '🚫';
                default: return '❓';
            }
        }
        
        function filterWhitelistUsers() {
            const statusFilter = document.getElementById('status-filter').value;
            
            if (statusFilter === 'all') {
                filteredWhitelistData = [...whitelistData];
            } else {
                filteredWhitelistData = whitelistData.filter(user => user.status === statusFilter);
            }
            
            renderWhitelistUsers();
        }
        
        async function approveUser(userId) {
            const notes = prompt('Optional approval notes:') || '';
            
            try {
                const response = await apiCall('/api/admin/whitelist/approve', {
                    method: 'POST',
                    body: JSON.stringify({
                        target_user_id: userId,
                        notes: notes
                    })
                });
                
                if (response.success) {
                    alert('✅ User approved successfully');
                    await loadWhitelistData();
                } else {
                    alert(`❌ Error: ${response.error}`);
                }
            } catch (error) {
                console.error('Error approving user:', error);
                alert('❌ Error approving user');
            }
        }
        
        async function rejectUser(userId) {
            const notes = prompt('Rejection reason (optional):') || '';
            
            try {
                const response = await apiCall('/api/admin/whitelist/reject', {
                    method: 'POST',
                    body: JSON.stringify({
                        target_user_id: userId,
                        notes: notes
                    })
                });
                
                if (response.success) {
                    alert('✅ User rejected successfully');
                    await loadWhitelistData();
                } else {
                    alert(`❌ Error: ${response.error}`);
                }
            } catch (error) {
                console.error('Error rejecting user:', error);
                alert('❌ Error rejecting user');
            }
        }
        
        async function banUser(userId) {
            const notes = prompt('Ban reason (required):');
            if (!notes) {
                alert('Ban reason is required');
                return;
            }
            
            if (!confirm('Are you sure you want to ban this user?')) {
                return;
            }
            
            try {
                const response = await apiCall('/api/admin/whitelist/ban', {
                    method: 'POST',
                    body: JSON.stringify({
                        target_user_id: userId,
                        notes: notes
                    })
                });
                
                if (response.success) {
                    alert('✅ User banned successfully');
                    await loadWhitelistData();
                } else {
                    alert(`❌ Error: ${response.error}`);
                }
            } catch (error) {
                console.error('Error banning user:', error);
                alert('❌ Error banning user');
            }
        }
        
        async function refreshWhitelistData() {
            await loadWhitelistData();
            alert('✅ Whitelist data refreshed');
        }
    </script>

    <!-- API Keys Settings Modal -->
    <div class="modal fade" id="apiKeysModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title">⚿ API Keys Settings</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <p class="text-muted">Manage your exchange API credentials for live trading</p>
                    </div>
                    
                    <div id="api-credentials-status" class="mb-4">
                        <div class="loading">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            Loading credentials status...
                        </div>
                    </div>
                    
                    <!-- Testnet/Live Mode Toggle -->
                    <div id="testnet-toggle-section" class="mb-4" style="display: none;">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">Trading Mode</h6>
                                <span id="current-mode-badge" class="badge bg-success">Live Trading</span>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong id="current-mode-text">Live Trading Mode</strong>
                                        <div class="text-muted small" id="mode-description">
                                            Real money trading with actual market orders
                                        </div>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" role="switch" id="testnet-mode-switch" onchange="toggleTestnetModeFromModal()">
                                        <label class="form-check-label" for="testnet-mode-switch">
                                            Testnet Mode
                                        </label>
                                    </div>
                                </div>
                                <div id="testnet-warning" class="alert alert-warning mt-3" style="display: none;">
                                    <strong>⚠️ Warning:</strong> Some exchanges (like Toobit) don't support testnet mode.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="api-credentials-setup" class="hidden">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Add API Credentials</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Exchange</label>
                                    <select class="form-control" id="api-exchange-select">
                                        <option value="toobit">Toobit</option>
                                        <option value="lbank">LBank</option>
                                        <option value="hyperliquid">Hyperliquid DEX</option>
                                        <option value="binance">Binance</option>
                                        <option value="okx">OKX</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">API Key</label>
                                    <input type="text" class="form-control" id="api-key-modal-input" placeholder="Enter your API key">
                                    <small class="text-muted">Your API key will be encrypted and stored securely</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">API Secret</label>
                                    <input type="password" class="form-control" id="api-secret-modal-input" placeholder="Enter your API secret">
                                    <small class="text-muted">Your secret will be encrypted and stored securely</small>
                                </div>
                                <div class="mb-3" id="api-passphrase-group" style="display: none;">
                                    <label class="form-label">Passphrase (if required)</label>
                                    <input type="password" class="form-control" id="api-passphrase-modal-input" placeholder="Enter passphrase if required">
                                </div>
                                <div class="two-column-grid">
                                    <button class="btn btn-outline-secondary" onclick="cancelApiCredentialsSetup()">Cancel</button>
                                    <button class="btn btn-primary" onclick="saveApiCredentials()">Save Credentials</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <div class="alert alert-info">
                            <strong>🔐 Security Information:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Your API credentials are encrypted using military-grade encryption</li>
                                <li>Only trading permissions are required - never share withdrawal access</li>
                                <li>All credentials are stored securely and never shared</li>
                                <li>You can delete your credentials at any time</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>