<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Toobit Trading Mini-App</title>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Feather Icons -->
    <link href="https://cdn.jsdelivr.net/npm/feather-icons@4.29.0/dist/feather.css" rel="stylesheet">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">

    
    <style>
        :root {
            --tg-theme-bg-color: #0f1419;
            --tg-theme-text-color: #e8eef7;
            --tg-theme-hint-color: #8b9dc3;
            --tg-theme-link-color: #6bb6ff;
            --tg-theme-button-color: #4a5d7a;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #1a202c;
            --tg-theme-accent-color: #5b7394;
            --tg-theme-card-bg: #212836;
            --tg-theme-border-color: #3a4658;
            --tg-theme-success: #52c41a;
            --tg-theme-warning: #faad14;
            --tg-theme-danger: #ff4d4f;
            --tg-theme-silver-blue: #6b8bb3;
            --tg-theme-silver-light: #a8b5c8;
            --tg-theme-silver-dark: #2d3748;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            font-weight: 400;
            font-display: swap;
            background: var(--tg-theme-bg-color) !important;
            color: var(--tg-theme-text-color) !important;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            -webkit-user-select: none;
            user-select: none;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            letter-spacing: -0.005em;
            line-height: 1.5;
        }

        /* Ensure all text elements use proper colors for dark mode */
        * {
            color: inherit;
        }

        .text-muted {
            color: var(--tg-theme-hint-color) !important;
        }

        .text-primary {
            color: var(--tg-theme-button-color) !important;
        }

        small {
            color: var(--tg-theme-hint-color) !important;
        }

        /* Enhanced Typography */
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 600;
            letter-spacing: -0.02em;
            margin-bottom: 0.5rem;
        }

        /* Live price indicator animation */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .live-indicator {
            animation: pulse 2s infinite;
        }

        /* Dedicated live indicator dot styling */
        .live-indicator-dot {
            width: 8px;
            height: 8px;
            background: #52c41a;
            border-radius: 50%;
            opacity: 0.7;
            animation: pulse 2s infinite;
            position: relative;
            z-index: 10;
        }

        .header h5 {
            font-weight: 700;
            font-size: 1.25rem;
            letter-spacing: -0.015em;
        }

        .nav-tabs .nav-link {
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            font-size: 0.9rem;
            letter-spacing: -0.005em;
        }

        /* Monospace font for numbers, prices, and data */
        .stat-value, .price-display, .amount-display {
            font-family: 'JetBrains Mono', 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
            font-weight: 500;
            letter-spacing: -0.02em;
        }

        /* Button typography */
        .btn {
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            font-size: 0.875rem;
            letter-spacing: -0.005em;
        }

        /* Card titles and labels */
        .card-title, .form-label {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        /* Status and badge typography */
        .status-badge, .badge {
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            font-size: 0.75rem;
            letter-spacing: 0.025em;
            text-transform: uppercase;
        }

        /* Dark mode card styling */
        .card {
            background: var(--tg-theme-secondary-bg-color) !important;
            border: 2px solid var(--tg-theme-border-color) !important;
            color: var(--tg-theme-text-color) !important;
        }

        .card-header {
            background: var(--tg-theme-secondary-bg-color) !important;
            border-bottom: 2px solid var(--tg-theme-border-color) !important;
            color: var(--tg-theme-text-color) !important;
        }

        .card-body {
            background: var(--tg-theme-secondary-bg-color) !important;
            color: var(--tg-theme-text-color) !important;
        }

        /* Alert styling for dark mode */
        .alert {
            background: var(--tg-theme-secondary-bg-color) !important;
            border: 2px solid var(--tg-theme-border-color) !important;
            color: var(--tg-theme-text-color) !important;
        }

        .alert-info {
            background: rgba(74, 144, 226, 0.1) !important;
            border-color: var(--tg-theme-button-color) !important;
            color: var(--tg-theme-text-color) !important;
        }

        /* Ensure list items are properly styled */
        ul, li {
            color: var(--tg-theme-text-color) !important;
        }

        .mini-app-container {
            max-width: 100vw;
            padding: 0;
            margin: 0;
        }

        .header {
            background: linear-gradient(135deg, #0f1419 0%, #1a2332 25%, #2d3e5a 75%, #4a6186 100%);
            color: #ffffff;
            padding: 0.75rem 0 0.5rem 0;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 1px solid rgba(107, 139, 179, 0.4);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6), 
                        0 4px 16px rgba(75, 93, 122, 0.3),
                        inset 0 1px 0 rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            margin: 0;
            position: relative;
            padding: 0 1rem;
        }

        .header .logo-section {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            justify-content: center;
        }

        .header .logo-icon {
            width: 28px;
            height: 28px;
            background: transparent;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            position: relative;
        }

        .header h1 {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            letter-spacing: -0.025em;
            color: #ffffff !important;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8), 
                         0 1px 2px rgba(0, 0, 0, 0.6);
            position: relative;
            line-height: 1.2;
            /* Remove gradient to fix fogginess */
            background: none !important;
            -webkit-background-clip: unset !important;
            background-clip: unset !important;
            -webkit-text-fill-color: #ffffff !important;
        }

        .header .subtitle {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.95) !important;
            font-weight: 500;
            margin-top: 0.25rem;
            letter-spacing: 0.8px;
            text-transform: uppercase;
            text-shadow: 0 1px 4px rgba(0, 0, 0, 0.8);
        }

        /* Hamburger Menu Styling */
        .hamburger-menu {
            position: relative;
            z-index: 1001;
            flex-shrink: 0;
        }

        .hamburger-button {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .hamburger-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .hamburger-icon {
            width: 18px;
            height: 12px;
            position: relative;
        }

        .hamburger-icon span {
            display: block;
            width: 100%;
            height: 2px;
            background: #ffffff;
            border-radius: 1px;
            position: absolute;
            transition: all 0.3s ease;
        }

        .hamburger-icon span:nth-child(1) {
            top: 0;
        }

        .hamburger-icon span:nth-child(2) {
            top: 5px;
        }

        .hamburger-icon span:nth-child(3) {
            top: 10px;
        }

        .hamburger-button.active .hamburger-icon span:nth-child(1) {
            transform: rotate(45deg);
            top: 5px;
        }

        .hamburger-button.active .hamburger-icon span:nth-child(2) {
            opacity: 0;
        }

        .hamburger-button.active .hamburger-icon span:nth-child(3) {
            transform: rotate(-45deg);
            top: 5px;
        }

        .hamburger-dropdown {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background: linear-gradient(135deg, #1a2332 0%, #2d3748 100%);
            border: 1px solid rgba(107, 139, 179, 0.3);
            border-radius: 12px;
            min-width: 200px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5),
                        0 4px 16px rgba(75, 93, 122, 0.3);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 1002;
        }

        .hamburger-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .hamburger-dropdown .dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 18px;
            color: var(--tg-theme-text-color);
            text-decoration: none;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            font-weight: 500;
            font-size: 0.9rem;
            border-bottom: 1px solid rgba(107, 139, 179, 0.1);
            transition: all 0.3s ease;
        }

        .hamburger-dropdown .dropdown-item:last-child {
            border-bottom: none;
        }

        .hamburger-dropdown .dropdown-item:hover {
            background: rgba(74, 144, 226, 0.1);
            color: #4a90e2;
        }

        .hamburger-dropdown .dropdown-item:first-child {
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
        }

        .hamburger-dropdown .dropdown-item:last-child {
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        .hamburger-dropdown .dropdown-item i {
            font-size: 16px;
            width: 20px;
            text-align: center;
        }

        .nav-tabs {
            background: var(--tg-theme-secondary-bg-color);
            border-bottom: 2px solid var(--tg-theme-border-color);
            padding: 0 1rem;
        }

        .nav-tabs .nav-link {
            color: var(--tg-theme-hint-color);
            border: none;
            padding: 1rem 1.5rem;
            font-size: 0.95rem;
            border-radius: 0;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
            text-align: center;
        }

        .nav-tabs .nav-link::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 3px;
            background: linear-gradient(90deg, #4a90e2, #357abd);
            transition: all 0.3s ease;
            transform: translateX(-50%);
        }

        .nav-tabs .nav-link.active {
            color: var(--tg-theme-text-color);
            background: rgba(74, 144, 226, 0.1);
        }

        .nav-tabs .nav-link.active::after {
            width: 80%;
            font-weight: 700;
            box-shadow: 0 -2px 10px rgba(107, 139, 179, 0.2);
        }

        .nav-tabs .nav-link:hover:not(.active) {
            color: var(--tg-theme-text-color);
            background: var(--tg-theme-card-bg);
        }

        .tab-content {
            padding: 1rem;
        }

        .trade-card {
            background: linear-gradient(135deg, var(--tg-theme-card-bg) 0%, var(--tg-theme-silver-dark) 100%);
            border: 2px solid var(--tg-theme-silver-blue);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 8px 25px rgba(75, 93, 122, 0.2), 0 4px 10px rgba(0,0,0,0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .trade-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 40px rgba(75, 93, 122, 0.4), 0 8px 20px rgba(0,0,0,0.4);
            border-color: var(--tg-theme-silver-light);
        }

        .trade-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--tg-theme-silver-blue), transparent);
            opacity: 0.6;
        }

        .collapsible-header {
            cursor: pointer;
            background: var(--tg-theme-card-bg);
            border: 1px solid var(--tg-theme-border-color);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            margin-bottom: 0;
            transition: all 0.2s ease;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .collapsible-header:hover {
            border-color: var(--tg-theme-button-color);
            box-shadow: 0 2px 8px rgba(74, 144, 226, 0.15);
        }

        .collapsible-content {
            background: var(--tg-theme-card-bg);
            border: 1px solid var(--tg-theme-border-color);
            border-top: none;
            border-radius: 0 0 10px 10px;
            padding: 0 1rem;
            margin-bottom: 1rem;
            max-height: 0;
            overflow: hidden;
            transition: all 0.2s ease;
        }

        .collapsible-content.expanded {
            max-height: none;
            padding: 0.75rem 1rem 1rem 1rem;
            border-top: 1px solid var(--tg-theme-border-color);
            overflow: visible;
            -webkit-overflow-scrolling: touch;
        }

        .collapsible-header.expanded {
            border-radius: 10px 10px 0 0;
            border-bottom: none;
        }

        .expand-icon {
            transition: transform 0.2s ease;
            font-size: 1rem;
            color: var(--tg-theme-button-color);
            font-weight: bold;
            opacity: 0.8;
        }

        .expand-icon.expanded {
            transform: rotate(180deg);
            opacity: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--tg-theme-silver-blue) 0%, var(--tg-theme-button-color) 100%);
            border: 2px solid var(--tg-theme-silver-blue);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            font-weight: 700;
            width: 100%;
            margin-bottom: 0.75rem;
            color: var(--tg-theme-button-text-color);
            transition: all 0.3s ease;
            font-size: 1rem;
            box-shadow: 0 4px 15px rgba(75, 93, 122, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--tg-theme-silver-light) 0%, var(--tg-theme-silver-blue) 100%);
            border-color: var(--tg-theme-silver-light);
            color: var(--tg-theme-button-text-color);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(75, 93, 122, 0.4);
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:active {
            transform: translateY(0px);
            box-shadow: 0 4px 15px rgba(25, 118, 210, 0.4);
        }

        .btn-outline-primary {
            color: var(--tg-theme-text-color);
            border: 2px solid var(--tg-theme-button-color);
            background: var(--tg-theme-card-bg);
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .btn-outline-primary:hover {
            background: var(--tg-theme-button-color);
            color: var(--tg-theme-button-text-color);
            border-color: var(--tg-theme-button-color);
        }

        .btn-outline-danger {
            color: var(--tg-theme-danger);
            border: 2px solid var(--tg-theme-danger);
            background: rgba(244, 67, 54, 0.1);
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .btn-outline-danger:hover {
            background: var(--tg-theme-danger);
            color: white;
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
        }

        .btn-outline-success {
            color: var(--tg-theme-success);
            border: 2px solid var(--tg-theme-success);
            background: rgba(76, 175, 80, 0.1);
            font-weight: 600;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .btn-outline-success:hover {
            background: var(--tg-theme-success);
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }

        .btn-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.85rem;
            width: auto;
            margin: 0.25rem;
        }

        .input-group {
            margin-bottom: 1rem;
        }

        .form-control {
            background: var(--tg-theme-card-bg);
            border: 2px solid var(--tg-theme-border-color);
            color: var(--tg-theme-text-color);
            border-radius: 12px;
            padding: 1rem;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .form-control:focus {
            background: var(--tg-theme-card-bg);
            border-color: var(--tg-theme-button-color);
            color: var(--tg-theme-text-color);
            box-shadow: 0 0 10px rgba(74, 144, 226, 0.6);
            outline: none;
        }

        .form-control::placeholder {
            color: var(--tg-theme-hint-color);
            opacity: 1;
        }

        .input-group-text {
            background: var(--tg-theme-card-bg);
            border: 2px solid var(--tg-theme-border-color);
            color: var(--tg-theme-text-color);
            font-weight: 700;
            border-radius: 12px 0 0 12px;
        }

        .form-select {
            background: var(--tg-theme-card-bg);
            border: 2px solid var(--tg-theme-border-color);
            color: var(--tg-theme-text-color);
            border-radius: 12px;
            padding: 1rem;
            font-weight: 600;
        }

        .form-select:focus {
            border-color: var(--tg-theme-button-color);
            box-shadow: 0 0 10px rgba(74, 144, 226, 0.6);
        }

        .form-select option {
            background: var(--tg-theme-card-bg);
            color: var(--tg-theme-text-color);
        }

        .form-label {
            color: var(--tg-theme-text-color);
            font-weight: 700;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .text-muted {
            color: var(--tg-theme-hint-color) !important;
            font-weight: 500;
        }

        .progress-indicator {
            font-family: monospace;
            font-size: 0.9rem;
            margin: 0.5rem 0;
            padding: 0.75rem;
            background: var(--tg-theme-card-bg);
            border: 2px solid var(--tg-theme-button-color);
            border-radius: 8px;
            color: var(--tg-theme-text-color);
            font-weight: 600;
        }

        .status-badge {
            padding: 0.35rem 0.7rem;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-active { 
            background: linear-gradient(135deg, #4caf50, #45a049);
            color: white; 
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }
        .status-configured { 
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white; 
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);
        }
        .status-pending { 
            background: linear-gradient(135deg, #2196f3, #1976d2);
            color: white; 
            box-shadow: 0 2px 8px rgba(33, 150, 243, 0.3);
        }
        .status-stopped { 
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white; 
            box-shadow: 0 2px 8px rgba(244, 67, 54, 0.3);
        }

        .position-summary {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 0 0.5rem;
        }

        .position-summary .stat-box {
            background: linear-gradient(135deg, var(--tg-theme-card-bg) 0%, var(--tg-theme-silver-dark) 100%);
            border: 2px solid var(--tg-theme-silver-blue);
            border-radius: 16px;
            padding: 1.5rem 1rem;
            text-align: center;
            box-shadow: 0 8px 20px rgba(75, 93, 122, 0.25), 0 4px 10px rgba(0,0,0,0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .position-summary .stat-box:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(75, 93, 122, 0.35), 0 6px 15px rgba(0,0,0,0.4);
        }

        .position-summary .stat-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--tg-theme-silver-blue), transparent);
            opacity: 0.8;
        }

        .position-summary .stat-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--tg-theme-text-color);
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 0.5rem;
        }

        .position-summary .stat-label {
            font-size: 0.9rem;
            color: var(--tg-theme-silver-light);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.8px;
        }

        /* Compact position summary for single row layout */
        .position-summary-compact {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: linear-gradient(135deg, var(--tg-theme-card-bg) 0%, var(--tg-theme-silver-dark) 100%);
            border: 2px solid var(--tg-theme-silver-blue);
            border-radius: 16px;
            box-shadow: 0 8px 20px rgba(75, 93, 122, 0.25), 0 4px 10px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }

        .position-summary-compact::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--tg-theme-silver-blue), transparent);
            opacity: 0.8;
        }

        .position-summary-compact .stat-item {
            text-align: center;
            flex: 1;
            padding: 0.5rem;
        }

        .position-summary-compact .stat-item:not(:last-child) {
            border-right: 1px solid rgba(var(--tg-theme-silver-blue-rgb, 168, 181, 200), 0.3);
        }

        .position-summary-compact .stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--tg-theme-text-color);
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 0.25rem;
        }

        .position-summary-compact .stat-label {
            font-size: 0.75rem;
            color: var(--tg-theme-silver-light);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .portfolio-summary {
            background: linear-gradient(135deg, var(--tg-theme-card-bg) 0%, var(--tg-theme-silver-dark) 50%, var(--tg-theme-secondary-bg-color) 100%);
            border: 1px solid var(--tg-theme-silver-blue);
            border-radius: 10px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 4px 12px rgba(75, 93, 122, 0.2), 0 2px 6px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        .portfolio-summary::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--tg-theme-silver-light), transparent);
        }

        .portfolio-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.4rem;
            align-items: stretch;
        }

        .portfolio-stat {
            text-align: center;
            padding: 0.5rem 0.3rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--tg-theme-border-color);
            border-radius: 6px;
        }

        .portfolio-stat .stat-value {
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 0.15rem;
            color: var(--tg-theme-text-color);
        }

        .portfolio-stat .stat-label {
            font-size: 0.6rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.2px;
            opacity: 0.8;
            color: var(--tg-theme-hint-color);
        }

        .stat-box {
            text-align: center;
            padding: 1rem;
            background: linear-gradient(135deg, var(--tg-theme-card-bg) 0%, var(--tg-theme-silver-dark) 100%);
            border: 2px solid var(--tg-theme-silver-blue);
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(75, 93, 122, 0.2), 0 2px 6px rgba(0,0,0,0.3);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(75, 93, 122, 0.3), 0 4px 10px rgba(0,0,0,0.4);
        }

        .stat-box::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(168, 181, 200, 0.05), transparent 50%);
            pointer-events: none;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--tg-theme-text-color);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--tg-theme-text-color);
            margin-top: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .trade-controls {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 0.25rem;
            margin-top: 1rem;
        }

        .trade-controls .btn-sm {
            font-size: 0.75rem;
            padding: 0.375rem 0.5rem;
        }

        .hidden { display: none; }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--tg-theme-hint-color);
        }

        .modal {
            z-index: 2000;
        }

        .modal-content {
            background: var(--tg-theme-card-bg);
            color: var(--tg-theme-text-color);
            border: 2px solid var(--tg-theme-border-color);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
        }

        .modal-header {
            border-bottom: 2px solid var(--tg-theme-border-color);
            background: linear-gradient(135deg, var(--tg-theme-secondary-bg-color), var(--tg-theme-card-bg));
            border-radius: 20px 20px 0 0;
        }

        .modal-header .modal-title {
            color: var(--tg-theme-text-color);
            font-weight: 700;
            font-size: 1.25rem;
        }

        .modal-footer {
            border-top: 2px solid var(--tg-theme-border-color);
            background: var(--tg-theme-secondary-bg-color);
            border-radius: 0 0 20px 20px;
        }

        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.8);
        }

        .btn-close {
            filter: invert(1) brightness(1.5);
            opacity: 0.8;
        }

        .btn-close:hover {
            opacity: 1;
        }

        .form-label {
            color: var(--tg-theme-text-color);
            font-weight: 600;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
        }

        .text-muted {
            color: var(--tg-theme-hint-color) !important;
        }

        .loading {
            color: var(--tg-theme-hint-color);
        }

        /* Enhanced Mobile Responsive Design */
        @media (max-width: 576px) {
            /* Optimized container padding for mobile */
            .mini-app-container {
                padding: 0;
                margin: 0;
                max-width: 100vw;
                overflow-x: hidden;
            }

            /* Reduce header padding on mobile */
            .header {
                padding: 1rem;
            }

            .header h1 {
                font-size: 1.3rem;
            }

            /* Mobile-optimized tab navigation */
            .nav-tabs {
                padding: 0 0.5rem;
                border-bottom: 1px solid var(--tg-theme-border-color);
            }

            .nav-tabs .nav-link {
                padding: 0.75rem 0.5rem;
                font-size: 0.85rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* Compact tab content padding */
            .tab-content {
                padding: 0.75rem;
            }

            /* Optimized card layout for mobile */
            .trade-card {
                padding: 1rem;
                margin-bottom: 1rem;
                border-radius: 12px;
            }

            .collapsible-header {
                padding: 0.6rem 0.8rem;
                border-radius: 8px;
                font-size: 0.85rem;
            }

            .collapsible-content {
                border-radius: 0 0 8px 8px;
                margin-bottom: 0.75rem;
            }

            .collapsible-header.expanded {
                border-radius: 8px 8px 0 0;
            }

            .collapsible-content.expanded {
                padding: 0.6rem 0.8rem 0.8rem 0.8rem;
                max-height: none;
                overflow: visible;
                -webkit-overflow-scrolling: touch;
            }

            /* Mobile-friendly position summary grid */
            .position-summary {
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem;
                margin-bottom: 1rem;
                padding: 0 0.25rem;
            }

            .position-summary .stat-box {
                padding: 0.75rem 0.5rem;
                border-radius: 10px;
            }

            .position-summary .stat-value {
                font-size: 1.3rem;
            }

            .position-summary .stat-label {
                font-size: 0.75rem;
                margin-top: 0.5rem;
            }

            /* Mobile-friendly compact position summary */
            .position-summary-compact {
                padding: 0.75rem;
                margin-bottom: 1rem;
                gap: 0.25rem;
            }

            .position-summary-compact .stat-item {
                padding: 0.2rem;
            }

            .position-summary-compact .stat-value {
                font-size: 1.1rem;
            }

            .position-summary-compact .stat-label {
                font-size: 0.6rem;
            }

            .portfolio-grid {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 0.25rem;
            }

            .portfolio-stat {
                padding: 0.4rem 0.25rem;
            }

            .portfolio-stat .stat-value {
                font-size: 0.8rem;
            }

            .portfolio-stat .stat-label {
                font-size: 0.55rem;
            }

            .stat-value {
                font-size: 1.3rem;
            }

            .stat-label {
                font-size: 0.8rem;
                margin-top: 0.5rem;
            }

            /* Enhanced button sizing for touch with micro-interactions */
            .btn-primary {
                padding: 0.875rem 1.25rem;
                font-size: 0.95rem;
                border-radius: 10px;
                margin-bottom: 0.5rem;
                min-height: 48px; /* iOS minimum touch target */
                transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
                transform: translateY(0);
                box-shadow: 0 2px 8px rgba(13, 110, 253, 0.15);
            }

            .btn-primary:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(13, 110, 253, 0.25);
            }

            .btn-primary:active {
                transform: translateY(0);
                box-shadow: 0 1px 4px rgba(13, 110, 253, 0.2);
                transition: all 0.1s ease;
            }

            .btn-sm {
                padding: 0.6rem 0.75rem;
                font-size: 0.8rem;
                min-height: 40px;
                margin: 0.125rem;
                transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
                transform: translateY(0);
                position: relative;
                overflow: hidden;
            }

            .btn-sm:hover {
                transform: translateY(-1px);
                box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
            }

            .btn-sm:active {
                transform: translateY(0);
                transition: all 0.1s ease;
            }

            /* Ripple effect for buttons */
            .btn-sm::before {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.3);
                transform: translate(-50%, -50%);
                transition: width 0.3s ease, height 0.3s ease;
                pointer-events: none;
            }

            .btn-sm:active::before {
                width: 100px;
                height: 100px;
            }

            /* Specific button type micro-interactions */
            .btn-success {
                box-shadow: 0 2px 8px rgba(25, 135, 84, 0.15);
                transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
                transform: translateY(0);
            }

            .btn-success:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(25, 135, 84, 0.25);
                background-color: #1e7e34 !important;
            }

            .btn-success:active {
                transform: scale(0.98);
                transition: all 0.1s ease;
            }

            .btn-warning {
                box-shadow: 0 2px 8px rgba(255, 193, 7, 0.15);
                transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
                transform: translateY(0);
            }

            .btn-warning:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(255, 193, 7, 0.25);
                background-color: #e0a800 !important;
            }

            .btn-warning:active {
                transform: scale(0.98);
                transition: all 0.1s ease;
            }

            .btn-danger {
                box-shadow: 0 2px 8px rgba(220, 53, 69, 0.15);
                transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
                transform: translateY(0);
            }

            .btn-danger:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(220, 53, 69, 0.25);
                background-color: #c82333 !important;
            }

            .btn-danger:active {
                transform: scale(0.98);
                transition: all 0.1s ease;
            }

            .btn-outline-secondary {
                box-shadow: 0 2px 8px rgba(108, 117, 125, 0.1);
                transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
                transform: translateY(0);
            }

            .btn-outline-secondary:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(108, 117, 125, 0.2);
            }

            .btn-outline-secondary:active {
                transform: scale(0.98);
                transition: all 0.1s ease;
            }

            /* Loading animation for buttons */
            .btn-loading {
                position: relative;
                color: transparent !important;
                pointer-events: none;
            }

            .btn-loading::after {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 16px;
                height: 16px;
                margin: -8px 0 0 -8px;
                border: 2px solid #ffffff;
                border-radius: 50%;
                border-top-color: transparent;
                animation: spin 0.8s linear infinite;
            }

            @keyframes spin {
                to { transform: rotate(360deg); }
            }

            /* Pulse animation for important actions */
            .btn-pulse {
                animation: pulse 2s infinite;
            }

            @keyframes pulse {
                0% {
                    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.15);
                }
                50% {
                    box-shadow: 0 4px 16px rgba(13, 110, 253, 0.3);
                }
                100% {
                    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.15);
                }
            }

            /* Mobile-optimized trade controls */
            .trade-controls {
                grid-template-columns: 1fr;
                gap: 0.5rem;
                margin-top: 0.75rem;
            }

            .trade-controls .btn-sm {
                width: 100%;
                font-size: 0.85rem;
                padding: 0.625rem 1rem;
                margin: 0.125rem 0;
            }

            /* Form controls optimized for mobile */
            .form-control {
                padding: 0.875rem;
                font-size: 16px; /* Prevents iOS zoom */
                border-radius: 10px;
            }

            .form-select {
                padding: 0.875rem;
                font-size: 16px;
                border-radius: 10px;
            }

            .input-group-text {
                padding: 0.875rem;
                font-size: 0.9rem;
                border-radius: 10px 0 0 10px;
            }

            /* Modal optimization for mobile */
            .modal-dialog {
                margin: 0.5rem;
                max-width: calc(100vw - 1rem);
            }

            .modal-content {
                border-radius: 16px;
            }

            .modal-header {
                padding: 1rem;
                border-radius: 16px 16px 0 0;
            }

            .modal-body {
                padding: 1rem;
            }

            .modal-footer {
                padding: 1rem;
                border-radius: 0 0 16px 16px;
            }

            /* Status badges mobile optimization */
            .status-badge {
                padding: 0.4rem 0.8rem;
                font-size: 0.7rem;
            }

            /* Progress indicator mobile sizing */
            .progress-indicator {
                padding: 0.625rem;
                font-size: 0.85rem;
                border-radius: 6px;
            }
        }

        /* Tablet and medium screens */
        @media (min-width: 577px) and (max-width: 768px) {
            .position-summary {
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
            }

            .trade-controls {
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem;
            }

            .nav-tabs .nav-link {
                padding: 0.875rem 1rem;
                font-size: 0.9rem;
            }

            .header h1 {
                font-size: 1.4rem;
            }
        }

        /* Large screens optimization */
        @media (min-width: 992px) {
            .position-summary {
                grid-template-columns: 1fr 1fr 1fr;
            }

            .portfolio-grid {
                grid-template-columns: 1fr 1fr 1fr;
                gap: 0.75rem;
            }
        }

        /* Touch-friendly enhancements */
        @media (hover: none) and (pointer: coarse) {
            /* Enhanced touch targets */
            .btn, .nav-link, .collapsible-header {
                min-height: 44px;
                padding: 0.75rem 1rem;
            }

            /* Remove hover effects on touch devices */
            .btn:hover,
            .nav-link:hover,
            .collapsible-header:hover,
            .trade-card:hover,
            .stat-box:hover {
                transform: none;
                box-shadow: initial;
            }

            /* Enhanced tap feedback */
            .btn:active,
            .nav-link:active,
            .collapsible-header:active {
                transform: scale(0.98);
                opacity: 0.8;
                transition: all 0.1s ease;
            }
        }

        /* High DPI display optimization */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .text-primary,
            .stat-value,
            .form-label {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
        }

        /* Landscape orientation adjustments */
        @media (orientation: landscape) and (max-height: 500px) {
            .header {
                padding: 0.75rem;
            }

            .header h1 {
                font-size: 1.2rem;
            }

            .nav-tabs .nav-link {
                padding: 0.5rem 0.75rem;
            }

            .tab-content {
                padding: 0.5rem;
            }

            .trade-card {
                padding: 0.75rem;
                margin-bottom: 0.75rem;
            }
        }

        .text-center {
            color: var(--tg-theme-text-color);
        }

        small {
            color: var(--tg-theme-hint-color);
            font-weight: 500;
        }

        h1, h2, h3, h4, h5, h6 {
            color: var(--tg-theme-text-color);
            font-weight: 700;
        }

        /* Form input styling for dark mode */
        .form-control, .form-select {
            background: var(--tg-theme-card-bg) !important;
            border: 2px solid var(--tg-theme-border-color) !important;
            color: var(--tg-theme-text-color) !important;
        }

        .form-control:focus, .form-select:focus {
            background: var(--tg-theme-card-bg) !important;
            border-color: var(--tg-theme-button-color) !important;
            color: var(--tg-theme-text-color) !important;
            box-shadow: 0 0 10px rgba(74, 144, 226, 0.3) !important;
        }

        .form-control::placeholder {
            color: var(--tg-theme-hint-color) !important;
        }

        .form-label {
            color: var(--tg-theme-text-color) !important;
        }

        .list-group-item {
            background: var(--tg-theme-secondary-bg-color, #1a2332);
            border: 1px solid var(--tg-theme-border-color, #3a4a5c);
            color: var(--tg-theme-text-color, #e8eaed);
        }

        .badge {
            font-weight: 600;
            padding: 0.5rem 0.75rem;
        }

        .bg-success {
            background: linear-gradient(135deg, #28a745, #20c997) !important;
            color: white !important;
        }

        .bg-warning {
            background: linear-gradient(135deg, #ffc107, #fd7e14) !important;
            color: #212529 !important;
        }

        .bg-danger {
            background: linear-gradient(135deg, #dc3545, #e83e8c) !important;
            color: white !important;
        }

        .border-success {
            border-color: #28a745 !important;
        }

        .border-warning {
            border-color: #ffc107 !important;
        }

        .border-danger {
            border-color: #dc3545 !important;
        }



        .two-column-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        /* Hamburger Menu Styles */
        .hamburger-menu {
            position: relative;
            display: inline-block;
        }

        .hamburger-btn {
            background: none;
            border: none;
            color: var(--tg-theme-text-color);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .hamburger-btn:hover {
            background: var(--tg-theme-border-color);
        }

        .hamburger-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--tg-theme-secondary-bg-color);
            border: 2px solid var(--tg-theme-border-color);
            border-radius: 12px;
            min-width: 200px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .hamburger-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            padding: 0.875rem 1.25rem;
            color: var(--tg-theme-text-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-bottom: 1px solid var(--tg-theme-border-color);
            transition: background 0.2s ease;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .dropdown-item:hover {
            background: var(--tg-theme-border-color);
            color: var(--tg-theme-text-color);
        }

        .dropdown-item:last-child {
            border-bottom: none;
            border-radius: 0 0 10px 10px;
        }

        .dropdown-item:first-child {
            border-radius: 10px 10px 0 0;
        }

        .dropdown-item.single {
            border-radius: 10px;
        }

        /* Enhanced visual improvements for modern UI */
        .card {
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 16px 32px rgba(0, 0, 0, 0.4),
                        0 8px 16px rgba(75, 93, 122, 0.2);
        }
        
        .btn {
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.6s ease;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        /* Tab improvements */
        .nav-tabs {
            border-bottom: 1px solid rgba(107, 139, 179, 0.2);
            margin-bottom: 2rem;
        }
        
        .nav-tabs .nav-link:hover {
            background: rgba(74, 144, 226, 0.05);
            color: var(--tg-theme-text-color);
        }
        
        /* Content area improvements */
        .tab-content {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Micro-interactions for better UX */
        .position-item, .trade-item {
            transition: all 0.3s ease;
        }
        
        .position-item:hover, .trade-item:hover {
            transform: translateX(4px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }
        
        /* Loading states */
        .loading {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
    </style>
</head>
<body>
    <div class="mini-app-container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">
                        <div class="live-indicator-dot"></div>
                    </div>
                    <div>
                        <h1>Trading Expert</h1>
                    </div>
                </div>
                
                <!-- Hamburger menu in top right corner -->
                <div class="hamburger-menu">
                    <div class="hamburger-button" onclick="toggleHamburgerMenu()">
                        <div class="hamburger-icon">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                    <div class="hamburger-dropdown" id="hamburger-dropdown">
                        <a href="#" class="dropdown-item" onclick="toggleMockTrading()">
                            <i data-feather="play-circle"></i>
                            <span id="mock-trading-text">Mock Trading: Off</span>
                        </a>
                        <a href="#" class="dropdown-item" onclick="openApiKeysSettings()">
                            <i data-feather="key"></i>
                            API Keys
                        </a>
                    </div>
                </div>
            </div>
            <div id="user-info" style="margin-top: 0.25rem; font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; color: #ffffff !important; font-size: 0.8rem; text-shadow: 0 1px 4px rgba(0,0,0,0.8); font-weight: 500;">Loading...</div>
        </div>

        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs justify-content-center" id="main-tabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" id="positions-tab" data-bs-toggle="tab" data-bs-target="#positions" type="button">
                    ▲ Positions
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="trading-tab" data-bs-toggle="tab" data-bs-target="#trading" type="button">
                    ⊞ Trading
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" id="portfolio-tab" data-bs-toggle="tab" data-bs-target="#portfolio" type="button">
                    ◈ Portfolio
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="main-tab-content">
            <!-- Positions Tab -->
            <div class="tab-pane fade show active" id="positions" role="tabpanel">
                <div class="position-summary-compact">
                    <div class="stat-item">
                        <div class="stat-value" id="total-positions">0</div>
                        <div class="stat-label">Positions</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-unrealized-pnl">$0.00</div>
                        <div class="stat-label">Unrealized</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-realized-pnl">$0.00</div>
                        <div class="stat-label">Realized</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-pnl">$0.00</div>
                        <div class="stat-label">Total P&L</div>
                    </div>
                </div>
                
                <!-- Close All Trades Button -->
                <div class="d-flex justify-content-center mb-3" id="close-all-container" style="display: none !important;">
                    <button class="btn btn-outline-warning" onclick="closeAllTrades()" id="close-all-btn">
                        ✕ Close All Trades
                    </button>
                </div>
                
                <div id="positions-list">
                    <div class="loading">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        Loading positions...
                    </div>
                </div>
            </div>

            <!-- Trading Tab -->
            <div class="tab-pane fade" id="trading" role="tabpanel">
                <div class="mb-3">
                    <button class="btn btn-primary" onclick="createNewTrade()">
                        ⊕ New Trade
                    </button>
                </div>
                
                <div id="trade-configs-list">
                    <div class="loading">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        Loading trade configurations...
                    </div>
                </div>
            </div>

            <!-- Portfolio Tab -->
            <div class="tab-pane fade" id="portfolio" role="tabpanel">
                <!-- Account Summary - Compact 2x3 Grid -->
                <div class="portfolio-summary">
                    <div class="portfolio-grid">
                        <div class="portfolio-stat">
                            <div class="stat-value" id="account-balance">$0.00</div>
                            <div class="stat-label">Balance</div>
                        </div>
                        <div class="portfolio-stat">
                            <div class="stat-value" id="margin-used">$0.00</div>
                            <div class="stat-label">Used</div>
                        </div>
                        <div class="portfolio-stat">
                            <div class="stat-value" id="free-margin">$0.00</div>
                            <div class="stat-label">Free</div>
                        </div>
                        <div class="portfolio-stat">
                            <div class="stat-value" id="margin-ratio">0%</div>
                            <div class="stat-label">Ratio</div>
                        </div>
                        <div class="portfolio-stat">
                            <div class="stat-value" id="realized-pnl">$0.00</div>
                            <div class="stat-label">Realized P&L</div>
                        </div>
                        <div class="portfolio-stat">
                            <div class="stat-value" id="total-pnl-portfolio">$0.00</div>
                            <div class="stat-label">Total P&L</div>
                        </div>
                    </div>
                </div>
                
                <div id="portfolio-details">
                    <div class="loading">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        Loading portfolio data...
                    </div>
                </div>
                
                <!-- Reset History Button -->
                <div class="d-flex justify-content-center mt-3">
                    <button class="btn btn-outline-warning" onclick="confirmResetHistory()" id="reset-history-btn">
                        🗑️ Reset History
                    </button>
                </div>
            </div>

            <!-- Credentials Tab -->
            <div class="tab-pane fade" id="credentials" role="tabpanel">
                <div class="mb-3">
                    <h6 class="text-primary">⚿ API Credentials Management</h6>
                    <p class="text-muted">Manage your exchange API credentials for live trading</p>
                </div>
                
                <div id="credentials-status" class="mb-4">
                    <div class="loading">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        Loading credentials status...
                    </div>
                </div>

                <div id="credentials-setup" class="hidden">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">Add API Credentials</h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label">Exchange</label>
                                <select class="form-control" id="exchange-select">
                                    <option value="toobit">Toobit</option>
                                    <option value="binance">Binance</option>
                                    <option value="okx">OKX</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">API Key</label>
                                <input type="text" class="form-control" id="api-key-input" placeholder="Enter your API key">
                                <small class="text-muted">Your API key will be encrypted and stored securely</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">API Secret</label>
                                <input type="password" class="form-control" id="api-secret-input" placeholder="Enter your API secret">
                                <small class="text-muted">Your secret will be encrypted and stored securely</small>
                            </div>
                            <div class="mb-3" id="passphrase-group" style="display: none;">
                                <label class="form-label">Passphrase (if required)</label>
                                <input type="password" class="form-control" id="passphrase-input" placeholder="Enter passphrase if required">
                            </div>
                            <div class="two-column-grid">
                                <button class="btn btn-outline-secondary" onclick="cancelCredentialsSetup()">Cancel</button>
                                <button class="btn btn-primary" onclick="saveCredentials()">Save Credentials</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-4">
                    <div class="alert alert-info">
                        <strong>🔐 Security Information:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Your API credentials are encrypted using military-grade encryption</li>
                            <li>Only trading permissions are required - never share withdrawal access</li>
                            <li>All credentials are stored securely and never shared</li>
                            <li>You can delete your credentials at any time</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trade Configuration Modal -->
    <div class="modal fade" id="tradeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title" id="tradeModalTitle">Configure Trade</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="trade-progress" class="progress-indicator mb-3"></div>
                    
                    <!-- Symbol Selection -->
                    <div id="symbol-step" class="config-step">
                        <label class="form-label">Trading Pair</label>
                        <select class="form-control" id="trade-symbol-select">
                            <option value="">Select Symbol</option>
                            <option value="BTCUSDT">BTC/USDT</option>
                            <option value="ETHUSDT">ETH/USDT</option>
                            <option value="BNBUSDT">BNB/USDT</option>
                            <option value="ADAUSDT">ADA/USDT</option>
                            <option value="SOLUSDT">SOL/USDT</option>
                            <option value="XRPUSDT">XRP/USDT</option>
                            <option value="DOTUSDT">DOT/USDT</option>
                            <option value="DOGEUSDT">DOGE/USDT</option>
                            <option value="LINKUSDT">LINK/USDT</option>
                            <option value="LTCUSDT">LTC/USDT</option>
                            <option value="MATICUSDT">MATIC/USDT</option>
                            <option value="AVAXUSDT">AVAX/USDT</option>
                            <option value="UNIUSDT">UNI/USDT</option>
                        </select>
                    </div>

                    <!-- Side Selection -->
                    <div id="side-step" class="config-step hidden">
                        <label class="form-label">Position Side</label>
                        <div class="two-column-grid">
                            <button class="btn btn-outline-primary" onclick="setTradeSide('long')">
                                ▲ Long
                            </button>
                            <button class="btn btn-outline-primary" onclick="setTradeSide('short')">
                                ▼ Short
                            </button>
                        </div>
                    </div>

                    <!-- Amount & Leverage -->
                    <div id="amount-step" class="config-step hidden">
                        <label class="form-label">Margin</label>
                        <div class="input-group mb-2">
                            <span class="input-group-text">$</span>
                            <input type="number" class="form-control" id="amount-input" placeholder="Enter amount" step="0.01">
                        </div>
                        <label class="form-label">Leverage</label>
                        <select class="form-control" id="leverage-select">
                            <option value="1">1x</option>
                            <option value="2">2x</option>
                            <option value="5">5x</option>
                            <option value="10" selected>10x</option>
                            <option value="20">20x</option>
                            <option value="50">50x</option>
                            <option value="100">100x</option>
                        </select>
                    </div>

                    <!-- Entry Configuration -->
                    <div id="entry-step" class="config-step hidden">
                        <label class="form-label">Entry Type</label>
                        <div class="two-column-grid mb-2">
                            <button class="btn btn-outline-primary" onclick="setEntryType('market')">
                                ⦿ Market
                            </button>
                            <button class="btn btn-outline-primary" onclick="setEntryType('limit')">
                                ◉ Limit
                            </button>
                        </div>
                        <div id="limit-price-input" class="hidden">
                            <label class="form-label">Limit Price</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="entry-price" placeholder="Entry price" step="0.0001">
                            </div>
                        </div>
                    </div>

                    <!-- Take Profits -->
                    <div id="tp-step" class="config-step hidden">
                        <label class="form-label">Take Profit Levels</label>
                        <div id="tp-levels">
                            <div class="input-group mb-2">
                                <span class="input-group-text">TP1 %</span>
                                <input type="number" class="form-control tp-percent" data-level="1" placeholder="5" step="0.1">
                                <span class="input-group-text">Size %</span>
                                <input type="number" class="form-control tp-allocation" data-level="1" placeholder="30" step="1">
                            </div>
                        </div>
                        <button class="btn btn-outline-primary btn-sm" onclick="addTpLevel()">+ Add TP Level</button>
                    </div>

                    <!-- Stop Loss -->
                    <div id="sl-step" class="config-step hidden">
                        <label class="form-label">Stop Loss</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="stop-loss" placeholder="2" step="0.1">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>

                    <!-- Breakeven Settings -->
                    <div id="breakeven-step" class="config-step hidden">
                        <label class="form-label">Break-even Settings</label>
                        <select class="form-control" id="breakeven-select">
                            <option value="disabled">Disabled</option>
                            <option value="tp1">After TP1</option>
                            <option value="tp2">After TP2</option>
                            <option value="tp3">After TP3</option>
                        </select>
                        <small class="text-muted">Move stop loss to break-even after take profit levels</small>
                    </div>

                    <!-- Trailing Stop Settings -->
                    <div id="trailing-step" class="config-step hidden">
                        <label class="form-label">Trailing Stop</label>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="trailing-enabled" onchange="toggleTrailingStop()">
                            <label class="form-check-label" for="trailing-enabled">
                                Enable Trailing Stop
                            </label>
                        </div>
                        <div id="trailing-options" class="hidden">
                            <div class="mb-3">
                                <label class="form-label">Trail Percentage</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="trail-percentage" placeholder="2" step="0.1" min="0.1">
                                    <span class="input-group-text">%</span>
                                </div>
                                <small class="text-muted">Percentage to trail behind best price</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Activation Price (Optional)</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="trail-activation" placeholder="45500" step="0.01">
                                </div>
                                <small class="text-muted">Price at which trailing stop activates</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" onclick="previousStep()">← Back</button>
                    <button type="button" class="btn btn-primary" onclick="nextStep()">Next →</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Telegram Web App integration
        let tg = window.Telegram.WebApp;
        let currentUser = null;
        let currentTrade = null;
        let configStep = 0;
        const configSteps = ['symbol', 'side', 'amount', 'entry', 'tp', 'sl', 'breakeven', 'trailing'];
        
        // Initialize Telegram Web App with enhanced compatibility
        if (typeof tg !== 'undefined' && tg.ready) {
            tg.ready();
            tg.expand();
            
            // Check if showPopup is available (Telegram WebApp v6.1+)
            if (!tg.showPopup) {
                tg.showPopup = function(params) {
                    // Fallback to showAlert for older versions
                    if (tg.showAlert) {
                        tg.showAlert(params.message || 'Notification');
                    } else {
                        alert(params.message || 'Notification');
                    }
                };
            }
        } else {
            // Fallback for testing outside Telegram with dark theme
            tg = {
                backgroundColor: '#1a2332',
                textColor: '#e8eaed',
                buttonColor: '#2196f3',
                showAlert: function(message) { 
                    console.log('TG Alert:', message);
                    alert(message); 
                },
                showPopup: function(params) {
                    console.log('TG Popup:', params);
                    alert(params.message || 'Notification');
                },
                MainButton: {
                    setText: function() {},
                    show: function() {},
                    hide: function() {}
                }
            };
        }
        
        // Set up theme - Force high contrast colors for dark mode
        document.body.style.backgroundColor = '#000000';
        document.documentElement.style.setProperty('--tg-theme-bg-color', '#000000');
        document.documentElement.style.setProperty('--tg-theme-text-color', '#ffffff');
        document.documentElement.style.setProperty('--tg-theme-button-color', '#4a90e2');
        
        // Get user info
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            currentUser = tg.initDataUnsafe.user;
            document.getElementById('user-info').textContent = `Hi, ${currentUser.first_name}!`;
        } else {
            // Fallback for testing outside Telegram
            currentUser = { id: 123456789, first_name: 'Demo User' };
            document.getElementById('user-info').textContent = `Hi, ${currentUser.first_name}! (Demo Mode)`;
        }

        // Main button integration
        tg.MainButton.setText("Execute Trade");
        tg.MainButton.hide();

        // API Functions
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(endpoint, {
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Telegram-User-ID': currentUser?.id || 'anonymous'
                    },
                    ...options
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                // Use fallback alert instead of tg.showAlert for compatibility
                if (typeof tg !== 'undefined' && tg.showAlert) {
                    tg.showAlert(`Error: ${error.message}`);
                } else {
                    console.error(`Error: ${error.message}`);
                }
                return null;
            }
        }

        // State management for expanded positions
        function saveExpandedState(type, id, isExpanded) {
            const expandedStates = JSON.parse(localStorage.getItem('expandedStates') || '{}');
            if (!expandedStates[type]) expandedStates[type] = {};
            expandedStates[type][id] = isExpanded;
            localStorage.setItem('expandedStates', JSON.stringify(expandedStates));
        }

        function getExpandedState(type, id) {
            const expandedStates = JSON.parse(localStorage.getItem('expandedStates') || '{}');
            return expandedStates[type] && expandedStates[type][id];
        }

        // Toggle position collapse/expand
        function togglePosition(index) {
            const content = document.getElementById(`content-${index}`);
            const icon = document.getElementById(`icon-${index}`);
            const header = content.previousElementSibling;
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                header.classList.remove('expanded');
                icon.classList.remove('expanded');
                saveExpandedState('positions', index, false);
            } else {
                content.classList.add('expanded');
                header.classList.add('expanded');
                icon.classList.add('expanded');
                saveExpandedState('positions', index, true);
            }
        }

        // Toggle trade configuration collapse/expand
        function toggleTrade(index) {
            const content = document.getElementById(`trade-content-${index}`);
            const icon = document.getElementById(`trade-icon-${index}`);
            const header = content.previousElementSibling;
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                header.classList.remove('expanded');
                icon.classList.remove('expanded');
                saveExpandedState('trades', index, false);
            } else {
                content.classList.add('expanded');
                header.classList.add('expanded');
                icon.classList.add('expanded');
                saveExpandedState('trades', index, true);
            }
        }
        
        // Toggle history section collapse/expand
        function toggleHistorySection() {
            const content = document.getElementById('history-content');
            const icon = document.getElementById('history-icon');
            const header = content.previousElementSibling;
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                header.classList.remove('expanded');
                icon.classList.remove('expanded');
                saveExpandedState('sections', 'history', false);
            } else {
                content.classList.add('expanded');
                header.classList.add('expanded');
                icon.classList.add('expanded');
                saveExpandedState('sections', 'history', true);
            }
        }

        // Toggle active positions section collapse/expand
        function toggleActivePositionsSection() {
            const content = document.getElementById('active-positions-content');
            const icon = document.getElementById('active-positions-icon');
            const header = content.previousElementSibling;
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                header.classList.remove('expanded');
                icon.classList.remove('expanded');
                saveExpandedState('sections', 'active-positions', false);
            } else {
                content.classList.add('expanded');
                header.classList.add('expanded');
                icon.classList.add('expanded');
                saveExpandedState('sections', 'active-positions', true);
            }
        }

        // Live price update variables
        let livePriceInterval = null;
        let isLivePriceUpdateActive = false;
        const PRICE_UPDATE_INTERVAL = {{ price_update_interval }}; // From centralized config

        // Live price update function
        async function updateLivePrices() {
            if (!isLivePriceUpdateActive) return;
            
            try {
                const data = await apiCall(`/api/positions/live-update?user_id=${currentUser?.id}`);
                if (!data || !data.positions) return;
                
                // Update active position prices and P&L
                Object.entries(data.positions).forEach(([tradeId, positionData]) => {
                    updatePositionPriceDisplay(tradeId, positionData);
                });
                
                // Update total unrealized P&L (Active Positions section)
                const totalUnrealizedElement = document.getElementById('total-unrealized-pnl');
                if (totalUnrealizedElement && data.total_unrealized_pnl !== undefined) {
                    totalUnrealizedElement.textContent = `$${data.total_unrealized_pnl.toFixed(2)}`;
                    totalUnrealizedElement.style.color = data.total_unrealized_pnl >= 0 ? '#28a745' : '#dc3545';
                }
                
                // Update total realized P&L
                const totalRealizedElement = document.getElementById('total-realized-pnl');
                if (totalRealizedElement && data.total_realized_pnl !== undefined) {
                    totalRealizedElement.textContent = `$${data.total_realized_pnl.toFixed(2)}`;
                    totalRealizedElement.style.color = data.total_realized_pnl >= 0 ? '#28a745' : '#dc3545';
                }
                
                // Update total P&L
                const totalPnlElement = document.getElementById('total-pnl');
                if (totalPnlElement && data.total_pnl !== undefined) {
                    totalPnlElement.textContent = `$${data.total_pnl.toFixed(2)}`;
                    totalPnlElement.style.color = data.total_pnl >= 0 ? '#28a745' : '#dc3545';
                }
                
                // Update positions tab total P&L (main totals) - should include realized + unrealized
                const positionsTabTotalPnl = document.getElementById('total-pnl');
                if (positionsTabTotalPnl && data.total_pnl !== undefined) {
                    positionsTabTotalPnl.textContent = `$${data.total_pnl.toFixed(2)}`;
                    positionsTabTotalPnl.style.color = data.total_pnl >= 0 ? '#28a745' : '#dc3545';
                }
                
                // Update total active positions count
                const totalPositionsElement = document.getElementById('total-positions');
                if (totalPositionsElement && data.active_positions_count !== undefined) {
                    totalPositionsElement.textContent = data.active_positions_count;
                }
                
                // Update portfolio tab totals if on portfolio tab
                if (currentActiveTab === 'portfolio') {
                    // Refresh portfolio summary data
                    const portfolioData = await apiCall(`/api/positions?user_id=${currentUser?.id}`);
                    if (portfolioData && portfolioData.summary) {
                        const summary = portfolioData.summary;
                        document.getElementById('account-balance').textContent = `$${summary.account_balance?.toFixed(2) || '0.00'}`;
                        document.getElementById('margin-used').textContent = `$${summary.total_margin_used?.toFixed(2) || '0.00'}`;
                        document.getElementById('free-margin').textContent = `$${summary.free_margin?.toFixed(2) || '0.00'}`;
                        
                        // Update portfolio total P&L with real-time data
                        const portfolioTotalPnlElement = document.getElementById('total-pnl-portfolio');
                        if (portfolioTotalPnlElement) {
                            const totalPnl = summary.total_pnl || 0;
                            portfolioTotalPnlElement.textContent = `$${totalPnl.toFixed(2)}`;
                            portfolioTotalPnlElement.style.color = totalPnl >= 0 ? '#28a745' : '#dc3545';
                        }
                        
                        // Update margin ratio
                        const marginRatioElement = document.getElementById('margin-ratio');
                        if (marginRatioElement && summary.account_balance > 0) {
                            const ratio = ((summary.total_margin_used || 0) / summary.account_balance) * 100;
                            marginRatioElement.textContent = `${ratio.toFixed(1)}%`;
                        }
                    }
                }
                
                console.log('Live prices updated:', data.timestamp);
            } catch (error) {
                console.error('Error updating live prices:', error);
            }
        }

        // Update initial totals when loading positions
        async function updateInitialTotals() {
            try {
                const data = await apiCall(`/api/positions/live-update?user_id=${currentUser?.id}`);
                if (!data) return;
                
                // Update total unrealized P&L
                const totalUnrealizedPnlElement = document.getElementById('total-unrealized-pnl');
                if (totalUnrealizedPnlElement && data.total_unrealized_pnl !== undefined) {
                    totalUnrealizedPnlElement.textContent = `$${data.total_unrealized_pnl.toFixed(2)}`;
                    totalUnrealizedPnlElement.style.color = data.total_unrealized_pnl >= 0 ? '#28a745' : '#dc3545';
                }
                
                // Update total realized P&L
                const totalRealizedPnlElement = document.getElementById('total-realized-pnl');
                if (totalRealizedPnlElement && data.total_realized_pnl !== undefined) {
                    totalRealizedPnlElement.textContent = `$${data.total_realized_pnl.toFixed(2)}`;
                    totalRealizedPnlElement.style.color = data.total_realized_pnl >= 0 ? '#28a745' : '#dc3545';
                }
                
                // Update total P&L (realized + unrealized)
                const totalPnlElement = document.getElementById('total-pnl');
                if (totalPnlElement && data.total_pnl !== undefined) {
                    totalPnlElement.textContent = `$${data.total_pnl.toFixed(2)}`;
                    totalPnlElement.style.color = data.total_pnl >= 0 ? '#28a745' : '#dc3545';
                }
                
                // Update active positions count
                const totalPositionsElement = document.getElementById('total-positions');
                if (totalPositionsElement && data.active_positions_count !== undefined) {
                    totalPositionsElement.textContent = data.active_positions_count;
                }
            } catch (error) {
                console.error('Error updating initial totals:', error);
            }
        }

        // Update individual position price display
        function updatePositionPriceDisplay(tradeId, positionData) {
            // Update current price
            const priceElement = document.querySelector(`[data-trade-id="${tradeId}"] .current-price`);
            if (priceElement && positionData.current_price) {
                priceElement.textContent = `$${positionData.current_price.toFixed(4)}`;
                
                // Add price change indicator
                if (positionData.price_change_percentage !== undefined) {
                    const changeClass = positionData.price_change_percentage >= 0 ? 'text-success' : 'text-danger';
                    const changeSymbol = positionData.price_change_percentage >= 0 ? '+' : '';
                    priceElement.innerHTML = `$${positionData.current_price.toFixed(4)} <small class="${changeClass}">${changeSymbol}${positionData.price_change_percentage.toFixed(2)}%</small>`;
                }
            }
            
            // Update unrealized P&L (detail view)
            const pnlElement = document.querySelector(`[data-trade-id="${tradeId}"] .unrealized-pnl`);
            if (pnlElement && positionData.unrealized_pnl !== undefined) {
                pnlElement.textContent = `$${positionData.unrealized_pnl.toFixed(2)}`;
                pnlElement.style.color = positionData.unrealized_pnl >= 0 ? '#28a745' : '#dc3545';
            }
            
            // Update floating P&L (detailed position view)
            const floatingPnlElement = document.querySelector(`[data-trade-id="${tradeId}"] .floating-pnl`);
            if (floatingPnlElement && positionData.unrealized_pnl !== undefined) {
                floatingPnlElement.textContent = `$${positionData.unrealized_pnl.toFixed(2)}`;
                floatingPnlElement.style.color = positionData.unrealized_pnl >= 0 ? '#28a745' : '#dc3545';
            }
            
            // Update total P&L (header view) - use total_pnl from API response
            const totalPnlElement = document.querySelector(`[data-trade-id="${tradeId}"] .total-pnl`);
            if (totalPnlElement && positionData.total_pnl !== undefined) {
                totalPnlElement.textContent = `$${positionData.total_pnl.toFixed(2)}`;
                totalPnlElement.style.color = positionData.total_pnl >= 0 ? '#28a745' : '#dc3545';
            }
            
            // Update ROE percentage
            const roeElement = document.querySelector(`[data-trade-id="${tradeId}"] .roe-percentage`);
            if (roeElement && positionData.roe_percentage !== undefined) {
                roeElement.textContent = `${positionData.roe_percentage.toFixed(2)}%`;
                roeElement.style.color = positionData.roe_percentage >= 0 ? '#28a745' : '#dc3545';
            }
        }

        // Debounce mechanism to prevent rapid start/stop cycles
        let livePriceDebounceTimeout = null;
        
        // Start live price updates with debouncing
        function startLivePriceUpdates() {
            if (livePriceDebounceTimeout) {
                clearTimeout(livePriceDebounceTimeout);
                livePriceDebounceTimeout = null;
            }
            
            if (isLivePriceUpdateActive) return;
            
            isLivePriceUpdateActive = true;
            updateLivePrices(); // Initial update
            livePriceInterval = setInterval(updateLivePrices, PRICE_UPDATE_INTERVAL);
            console.log('Live price updates started');
        }

        // Stop live price updates with debouncing
        function stopLivePriceUpdates() {
            if (livePriceDebounceTimeout) {
                clearTimeout(livePriceDebounceTimeout);
            }
            
            livePriceDebounceTimeout = setTimeout(() => {
                if (!isLivePriceUpdateActive) return;
                
                isLivePriceUpdateActive = false;
                if (livePriceInterval) {
                    clearInterval(livePriceInterval);
                    livePriceInterval = null;
                }
                console.log('Live price updates stopped');
                livePriceDebounceTimeout = null;
            }, 100); // Small delay to prevent rapid cycling
        }

        // Load data functions
        async function loadPositions() {
            const data = await apiCall(`/api/user-trades?user_id=${currentUser?.id}`);
            if (!data) return;
            
            const container = document.getElementById('positions-list');
            const activePositions = data.trades?.filter(t => t.status === 'active' || t.status === 'pending') || [];
            const closedPositions = data.trades?.filter(t => t.status === 'stopped') || [];
            
            document.getElementById('total-positions').textContent = activePositions.length;
            
            // Get initial PnL totals from API (to avoid conflicts with live updates)
            updateInitialTotals();
            
            // Show/hide Close All Trades button based on active positions
            const closeAllContainer = document.getElementById('close-all-container');
            if (closeAllContainer) {
                if (activePositions.length > 1) {
                    closeAllContainer.style.display = 'flex';
                } else {
                    closeAllContainer.style.display = 'none';
                }
            }
            
            let content = '';
            
            // Active Positions Section
            if (activePositions.length === 0) {
                content += '<div class="text-center py-4"><small class="text-muted">No active or pending positions</small></div>';
            } else {
            
            content += activePositions.map((pos, index) => `
                <div class="position-item" data-trade-id="${pos.trade_id}">
                    <div class="collapsible-header" onclick="togglePosition(${index})">
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <div>
                                <strong>${pos.symbol}</strong>
                                <span class="status-badge status-${pos.status} ms-2">${pos.side.toUpperCase()}</span>
                                ${pos.status === 'pending' ? '<small class="text-info ms-1">(PENDING)</small>' : ''}
                            </div>
                            <div class="d-flex align-items-center">
                                <div class="text-end me-3">
                                    <div class="stat-value total-pnl" style="color: ${((pos.unrealized_pnl || 0) + (pos.realized_pnl || 0)) >= 0 ? '#28a745' : '#dc3545'}">
                                        $${((pos.unrealized_pnl || 0) + (pos.realized_pnl || 0)).toFixed(2)}
                                    </div>
                                    <small class="text-muted">Total P&L</small>
                                </div>
                                <span class="expand-icon" id="icon-${index}">▼</span>
                            </div>
                        </div>
                    </div>
                    <div class="collapsible-content" id="content-${index}">
                    
                    <!-- Position Details -->
                    <div class="row mt-2">
                        <div class="col-4">
                            <small class="text-muted">Position Size:</small><br>
                            <strong>$${pos.position_size || (pos.amount * pos.leverage) || '0'}</strong>
                            <br><small class="text-muted">Margin: $${pos.amount || '0'}</small>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Leverage:</small><br>
                            <strong>${pos.leverage}x</strong>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Entry:</small><br>
                            <strong>$${pos.entry_price || 'Market'}</strong>
                        </div>
                    </div>
                    
                    <!-- Current Price & ROE -->
                    ${pos.current_price ? `
                    <div class="row mt-2">
                        <div class="col-6">
                            <small class="text-muted">Current Price:</small><br>
                            <strong class="current-price">$${pos.current_price}</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">ROE:</small><br>
                            <strong class="roe-percentage" style="color: ${calculateROE(pos) >= 0 ? '#28a745' : '#dc3545'}">
                                ${calculateROE(pos).toFixed(2)}%
                            </strong>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Take Profit & Stop Loss with Prices and P&L -->
                    <div class="mt-2">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Take Profits:</small><br>
                                <div style="font-size: 0.85rem;">
                                    ${pos.tp_sl_calculations && pos.tp_sl_calculations.take_profits && pos.tp_sl_calculations.take_profits.length > 0 ? 
                                        pos.tp_sl_calculations.take_profits.map(tp => 
                                            `<div><strong>TP${tp.level}:</strong> $${tp.price.toFixed(4)} <span style="color: #28a745;">(+$${tp.profit_amount.toFixed(2)})</span></div>`
                                        ).join('') : 
                                        '<strong>Not set</strong>'}
                                </div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Stop Loss:</small><br>
                                <div style="font-size: 0.85rem;">
                                    ${pos.tp_sl_calculations && pos.tp_sl_calculations.stop_loss && pos.tp_sl_calculations.stop_loss.price ? 
                                        (pos.tp_sl_calculations.stop_loss.is_breakeven ? 
                                            `<div><strong>SL:</strong> $${pos.tp_sl_calculations.stop_loss.price.toFixed(4)} <span style="color: #52c41a;">(Break-even)</span></div>` :
                                            `<div><strong>SL:</strong> $${pos.tp_sl_calculations.stop_loss.price.toFixed(4)} <span style="color: #dc3545;">(-$${pos.tp_sl_calculations.stop_loss.loss_amount.toFixed(2)})</span></div>`
                                        ) : 
                                        '<strong>Not set</strong>'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- P&L Breakdown -->
                    <div class="row mt-2">
                        <div class="col-6">
                            <small class="text-muted">Realized P&L:</small><br>
                            <strong style="color: ${(pos.realized_pnl || 0) >= 0 ? '#28a745' : '#dc3545'}">
                                $${(pos.realized_pnl || 0).toFixed(2)}
                            </strong>
                            ${(pos.realized_pnl || 0) > 0 ? '<br><small class="text-muted">(From TPs)</small>' : ''}
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Floating P&L:</small><br>
                            <strong class="floating-pnl" style="color: ${(pos.unrealized_pnl || 0) >= 0 ? '#28a745' : '#dc3545'}">
                                $${(pos.unrealized_pnl || 0).toFixed(2)}
                            </strong>
                            <br><small class="text-muted">(Current)</small>
                        </div>
                    </div>

                    <!-- Margin Info -->
                    <div class="row mt-2">
                        <div class="col-6">
                            <small class="text-muted">Margin Used:</small><br>
                            <strong>$${(pos.position_margin || 0).toFixed(2)}</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Status:</small><br>
                            <strong class="text-${pos.status === 'active' ? 'success' : pos.status === 'pending' ? 'warning' : 'danger'}">
                                ${pos.status.toUpperCase()}
                            </strong>
                        </div>
                    </div>
                    
                    <div class="trade-controls mt-2" style="display: grid; grid-template-columns: ${pos.status === 'pending' ? '1fr 1fr' : '1fr 1fr'}; gap: 0.5rem;">
                        ${pos.status === 'pending' ? 
                            `<button class="btn btn-outline-warning btn-sm" onclick="cancelPendingOrder('${pos.trade_id}')">
                                <i class="fas fa-times"></i> Cancel Order
                            </button>
                            <button class="btn btn-outline-primary btn-sm" onclick="editTrade('${pos.trade_id}')">
                                <i class="fas fa-edit"></i> Edit
                            </button>` :
                            `<button class="btn btn-outline-primary btn-sm" onclick="editTrade('${pos.trade_id}')">
                                ⚙ Edit
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="closeTrade('${pos.trade_id}')">
                                ✕ Close
                            </button>`}
                    </div>
                    </div>
                </div>
            `).join('');
            }
            

            
            container.innerHTML = content;
            
            // Restore expanded states after content update
            setTimeout(() => {
                activePositions.forEach((pos, index) => {
                    if (getExpandedState('positions', index)) {
                        const content = document.getElementById(`content-${index}`);
                        const icon = document.getElementById(`icon-${index}`);
                        const header = content?.previousElementSibling;
                        
                        if (content && icon && header) {
                            content.classList.add('expanded');
                            header.classList.add('expanded');
                            icon.classList.add('expanded');
                        }
                    }
                });
            }, 50);
            
            // Note: Live price updates are managed by handleTabSwitch function
        }

        async function loadTradeConfigs() {
            console.log('Loading trade configs...');
            const data = await apiCall(`/api/user-trades?user_id=${currentUser?.id}`);
            if (!data) {
                console.log('No data received from API');
                return;
            }
            
            const container = document.getElementById('trade-configs-list');
            if (!container) {
                console.log('Trade configs container not found');
                return;
            }
            
            // Only show trades that are still in configuration phase (not executed)
            const trades = data.trades?.filter(t => t.status === 'configured' || !t.status) || [];
            console.log(`Found ${trades.length} configured trades:`, trades);
            
            if (trades.length === 0) {
                console.log('No configured trades found, showing empty state');
                container.innerHTML = '<div class="text-center py-4"><small class="text-muted">No trade configurations</small></div>';
                return;
            }
            
            console.log('Rendering trades...');
            
            const tradesHtml = trades.map((trade, index) => `
                <div class="position-item">
                    <div class="collapsible-header" onclick="toggleTrade(${index})">
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <div>
                                <strong>${trade.name}</strong>
                                <span class="status-badge status-${trade.status} ms-2">${trade.status}</span>
                            </div>
                            <div class="d-flex align-items-center">
                                ${trade.status === 'active' && trade.unrealized_pnl !== undefined ? 
                                    `<div class="text-end me-3">
                                        <div class="stat-value" style="color: ${trade.unrealized_pnl >= 0 ? '#28a745' : '#dc3545'}">
                                            $${trade.unrealized_pnl.toFixed(2)}
                                        </div>
                                        <small class="text-muted">P&L</small>
                                    </div>` : 
                                    `<div class="text-end me-3">
                                        <div class="stat-value" style="color: var(--tg-theme-text-color)">
                                            ${trade.symbol || 'No Symbol'}
                                        </div>
                                        <small class="text-muted">Symbol</small>
                                    </div>`
                                }
                                <span class="expand-icon" id="trade-icon-${index}">▼</span>
                            </div>
                        </div>
                    </div>
                    <div class="collapsible-content" id="trade-content-${index}">
                    <div class="progress-indicator">
                        ${getTradeProgress(trade)}
                    </div>
                    
                    <!-- Basic Trade Info -->
                    <div class="row mt-2">
                        <div class="col-6">
                            <small class="text-muted">Symbol:</small><br>
                            <strong>${trade.symbol || 'Not set'}</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Side:</small><br>
                            <strong>${trade.side ? trade.side.toUpperCase() : 'Not set'}</strong>
                        </div>
                    </div>
                    
                    ${trade.status === 'active' ? `
                    <!-- Active Trade Details -->
                    <div class="row mt-2">
                        <div class="col-4">
                            <small class="text-muted">Position Size:</small><br>
                            <strong>$${trade.position_size || (trade.amount * trade.leverage) || '0'}</strong>
                            <br><small class="text-muted">Margin: $${trade.amount || '0'}</small>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Leverage:</small><br>
                            <strong>${trade.leverage || '1'}x</strong>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Entry:</small><br>
                            <strong>$${trade.entry_price || 'Market'}</strong>
                        </div>
                    </div>
                    
                    <!-- Take Profit & Stop Loss with Prices and P&L -->
                    <div class="mt-2">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Take Profits:</small><br>
                                <div style="font-size: 0.85rem;">
                                    ${trade.tp_sl_calculations && trade.tp_sl_calculations.take_profits && trade.tp_sl_calculations.take_profits.length > 0 ? 
                                        trade.tp_sl_calculations.take_profits.map(tp => 
                                            `<div><strong>TP${tp.level}:</strong> $${tp.price.toFixed(4)} <span style="color: #28a745;">(+$${tp.profit_amount.toFixed(2)})</span></div>`
                                        ).join('') : 
                                        '<strong>Not set</strong>'}
                                </div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Stop Loss:</small><br>
                                <div style="font-size: 0.85rem;">
                                    ${trade.tp_sl_calculations && trade.tp_sl_calculations.stop_loss && trade.tp_sl_calculations.stop_loss.price ? 
                                        (trade.tp_sl_calculations.stop_loss.is_breakeven ? 
                                            `<div><strong>SL:</strong> $${trade.tp_sl_calculations.stop_loss.price.toFixed(4)} <span style="color: #52c41a;">(Break-even)</span></div>` :
                                            `<div><strong>SL:</strong> $${trade.tp_sl_calculations.stop_loss.price.toFixed(4)} <span style="color: #dc3545;">(-$${trade.tp_sl_calculations.stop_loss.loss_amount.toFixed(2)})</span></div>`
                                        ) : 
                                        '<strong>Not set</strong>'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    ${trade.current_price ? `
                    <div class="row mt-2">
                        <div class="col-6">
                            <small class="text-muted">Current Price:</small><br>
                            <strong>$${trade.current_price}</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">ROE:</small><br>
                            <strong style="color: ${calculateROE(trade) >= 0 ? '#28a745' : '#dc3545'}">
                                ${calculateROE(trade).toFixed(2)}%
                            </strong>
                        </div>
                    </div>
                    
                    <!-- P&L Breakdown for Active Trades -->
                    <div class="row mt-2">
                        <div class="col-6">
                            <small class="text-muted">Realized P&L:</small><br>
                            <strong style="color: ${(trade.realized_pnl || 0) >= 0 ? '#28a745' : '#dc3545'}">
                                $${(trade.realized_pnl || 0).toFixed(2)}
                            </strong>
                            ${(trade.realized_pnl || 0) > 0 ? '<br><small class="text-muted">(From TPs)</small>' : ''}
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Floating P&L:</small><br>
                            <strong style="color: ${(trade.unrealized_pnl || 0) >= 0 ? '#28a745' : '#dc3545'}">
                                $${(trade.unrealized_pnl || 0).toFixed(2)}
                            </strong>
                            <br><small class="text-muted">(Current)</small>
                        </div>
                    </div>
                    ` : ''}
                    ` : `
                    <!-- Configuration Details for Non-Active Trades -->
                    <div class="row mt-2">
                        <div class="col-4">
                            <small class="text-muted">Position Size:</small><br>
                            <strong>${trade.position_size ? '$' + trade.position_size : trade.amount && trade.leverage ? '$' + (trade.amount * trade.leverage) : 'Not set'}</strong>
                            ${trade.amount ? '<br><small class="text-muted">Margin: $' + trade.amount + '</small>' : ''}
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Leverage:</small><br>
                            <strong>${trade.leverage ? trade.leverage + 'x' : 'Not set'}</strong>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Entry:</small><br>
                            <strong>${trade.entry_price ? '$' + trade.entry_price : trade.entry_type === 'market' ? 'Market' : 'Not set'}</strong>
                        </div>
                    </div>
                    
                    <!-- Take Profit & Stop Loss for Configured Trades with Prices and P&L -->
                    <div class="mt-2">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Take Profits:</small><br>
                                <div style="font-size: 0.85rem;">
                                    ${trade.tp_sl_calculations && trade.tp_sl_calculations.take_profits && trade.tp_sl_calculations.take_profits.length > 0 ? 
                                        trade.tp_sl_calculations.take_profits.map(tp => 
                                            `<div><strong>TP${tp.level}:</strong> $${tp.price.toFixed(4)} <span style="color: #28a745;">(+$${tp.profit_amount.toFixed(2)})</span></div>`
                                        ).join('') : 
                                        trade.take_profits && trade.take_profits.length > 0 ? 
                                            trade.take_profits.map((tp, idx) => `<div><strong>TP${idx+1}:</strong> ${tp.percentage || tp}%</div>`).join('') :
                                        '<strong>Not set</strong>'}
                                </div>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Stop Loss:</small><br>
                                <div style="font-size: 0.85rem;">
                                    ${trade.tp_sl_calculations && trade.tp_sl_calculations.stop_loss && trade.tp_sl_calculations.stop_loss.price ? 
                                        (trade.tp_sl_calculations.stop_loss.is_breakeven ? 
                                            `<div><strong>SL:</strong> $${trade.tp_sl_calculations.stop_loss.price.toFixed(4)} <span style="color: #52c41a;">(Break-even)</span></div>` :
                                            `<div><strong>SL:</strong> $${trade.tp_sl_calculations.stop_loss.price.toFixed(4)} <span style="color: #dc3545;">(-$${trade.tp_sl_calculations.stop_loss.loss_amount.toFixed(2)})</span></div>`
                                        ) : 
                                        trade.stop_loss_percent > 0 ? 
                                            `<div><strong>SL:</strong> ${trade.stop_loss_percent}%</div>` :
                                        (trade.stop_loss_percent == 0 && trade.status === 'active' ?
                                            `<div><strong>SL:</strong> Break-even</div>` :
                                        '<strong>Not set</strong>')}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Configuration Status -->
                    <div class="row mt-2">
                        <div class="col-6">
                            <small class="text-muted">Entry Type:</small><br>
                            <strong>${trade.entry_type ? trade.entry_type.toUpperCase() : 'Not set'}</strong>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Status:</small><br>
                            <strong class="text-${trade.status === 'configured' ? 'warning' : trade.status === 'active' ? 'success' : 'secondary'}">
                                ${trade.status ? trade.status.toUpperCase() : 'DRAFT'}
                            </strong>
                        </div>
                    </div>
                    `}
                    
                    <div class="trade-controls mt-2" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.25rem;">
                        <button class="btn btn-outline-primary btn-sm" onclick="editTradeConfig('${trade.trade_id}')">
                            ⚙ Edit
                        </button>
                        ${trade.symbol && trade.side && trade.amount && 
                          ((trade.entry_type === 'market') || (trade.entry_type === 'limit' && trade.entry_price)) &&
                          trade.take_profits && trade.take_profits.length > 0 && trade.stop_loss_percent ?
                          `<button class="btn btn-success btn-sm" onclick="executeTrade('${trade.trade_id}')">
                            ⚡ Execute
                          </button>` :
                          `<button class="btn btn-outline-secondary btn-sm" disabled title="Complete configuration first">
                            ⚡ Execute
                          </button>`
                        }
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteTrade('${trade.trade_id}')">
                            ✕ Delete
                        </button>
                    </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = tradesHtml;
            
            // Restore expanded states for trades after content update
            setTimeout(() => {
                trades.forEach((trade, index) => {
                    if (getExpandedState('trades', index)) {
                        const content = document.getElementById(`trade-content-${index}`);
                        const icon = document.getElementById(`trade-icon-${index}`);
                        const header = content?.previousElementSibling;
                        
                        if (content && icon && header) {
                            content.classList.add('expanded');
                            header.classList.add('expanded');
                            icon.classList.add('expanded');
                        }
                    }
                });
            }, 50);
            
            console.log('Trades rendered successfully. Container innerHTML set.');
        }

        async function loadPortfolio() {
            const data = await apiCall(`/api/margin-data?user_id=${currentUser?.id || '123456789'}`);
            const tradesData = await apiCall(`/api/user-trades?user_id=${currentUser?.id}`);
            if (!data) return;
            
            const summary = data.summary || {};
            
            // Check if user is in live trading mode and has credentials
            const credsData = await apiCall(`/api/user-credentials?user_id=${currentUser?.id || '123456789'}`);
            const isLiveMode = credsData && credsData.has_credentials && !credsData.testnet_mode;
            
            if (isLiveMode) {
                // Fetch real exchange balance for live trading mode
                try {
                    const exchangeBalance = await apiCall(`/api/exchange/balance?user_id=${currentUser?.id || '123456789'}`);
                    
                    if (exchangeBalance && exchangeBalance.success && exchangeBalance.balance) {
                        const balance = exchangeBalance.balance;
                        
                        // Display real exchange balance
                        document.getElementById('account-balance').textContent = `$${balance.total_balance?.toFixed(2) || '0.00'}`;
                        document.getElementById('margin-used').textContent = `$${balance.used_margin?.toFixed(2) || '0.00'}`;
                        document.getElementById('free-margin').textContent = `$${balance.available_balance?.toFixed(2) || '0.00'}`;
                        document.getElementById('margin-ratio').textContent = `${balance.margin_ratio?.toFixed(1) || '0'}%`;
                        
                        // Show live trading indicator in balance
                        const balanceElement = document.getElementById('account-balance');
                        const balanceParent = balanceElement.closest('.portfolio-stat');
                        if (balanceParent) {
                            const indicator = balanceParent.querySelector('.live-indicator') || document.createElement('div');
                            indicator.className = 'live-indicator';
                            indicator.innerHTML = '🟢 Live';
                            indicator.style.cssText = 'font-size: 0.5rem; color: #28a745; font-weight: 600; margin-top: 2px;';
                            if (!balanceParent.querySelector('.live-indicator')) {
                                balanceParent.appendChild(indicator);
                            }
                        }
                    } else {
                        // Fallback to simulated data if exchange balance fails
                        document.getElementById('account-balance').textContent = `$${summary.account_balance?.toFixed(2) || '0.00'}`;
                        document.getElementById('margin-used').textContent = `$${summary.total_margin_used?.toFixed(2) || '0.00'}`;
                        document.getElementById('free-margin').textContent = `$${summary.free_margin?.toFixed(2) || '0.00'}`;
                        document.getElementById('margin-ratio').textContent = `${summary.margin_utilization?.toFixed(1) || '0'}%`;
                    }
                } catch (error) {
                    console.error('Error fetching exchange balance:', error);
                    // Fallback to simulated data if API call fails
                    document.getElementById('account-balance').textContent = `$${summary.account_balance?.toFixed(2) || '0.00'}`;
                    document.getElementById('margin-used').textContent = `$${summary.total_margin_used?.toFixed(2) || '0.00'}`;
                    document.getElementById('free-margin').textContent = `$${summary.free_margin?.toFixed(2) || '0.00'}`;
                    document.getElementById('margin-ratio').textContent = `${summary.margin_utilization?.toFixed(1) || '0'}%`;
                }
            } else {
                // Use simulated balance for testnet mode
                document.getElementById('account-balance').textContent = `$${summary.account_balance?.toFixed(2) || '0.00'}`;
                document.getElementById('margin-used').textContent = `$${summary.total_margin_used?.toFixed(2) || '0.00'}`;
                document.getElementById('free-margin').textContent = `$${summary.free_margin?.toFixed(2) || '0.00'}`;
                document.getElementById('margin-ratio').textContent = `${summary.margin_utilization?.toFixed(1) || '0'}%`;
                
                // Show testnet indicator
                const balanceElement = document.getElementById('account-balance');
                const balanceParent = balanceElement.closest('.portfolio-stat');
                if (balanceParent) {
                    const indicator = balanceParent.querySelector('.live-indicator') || document.createElement('div');
                    indicator.className = 'live-indicator';
                    indicator.innerHTML = '🧪 Test';
                    indicator.style.cssText = 'font-size: 0.5rem; color: #007bff; font-weight: 600; margin-top: 2px;';
                    if (!balanceParent.querySelector('.live-indicator')) {
                        balanceParent.appendChild(indicator);
                    }
                }
            }
            
            // Update total P&L if elements exist
            const realizedPnlElement = document.getElementById('realized-pnl');
            const totalPnlElement = document.getElementById('total-pnl');
            if (realizedPnlElement) {
                realizedPnlElement.textContent = `$${(summary.realized_pnl || 0).toFixed(2)}`;
                realizedPnlElement.style.color = (summary.realized_pnl || 0) >= 0 ? '#28a745' : '#dc3545';
            }
            if (totalPnlElement) {
                totalPnlElement.textContent = `$${(summary.total_pnl || 0).toFixed(2)}`;
                totalPnlElement.style.color = (summary.total_pnl || 0) >= 0 ? '#28a745' : '#dc3545';
            }
            
            // Also update portfolio-specific total P&L element
            const portfolioTotalPnlElement = document.getElementById('total-pnl-portfolio');
            if (portfolioTotalPnlElement) {
                portfolioTotalPnlElement.textContent = `$${(summary.total_pnl || 0).toFixed(2)}`;
                portfolioTotalPnlElement.style.color = (summary.total_pnl || 0) >= 0 ? '#28a745' : '#dc3545';
            }
            
            const container = document.getElementById('portfolio-details');
            const positions = data.positions || [];
            const allTrades = tradesData?.trades || [];
            const activePositions = allTrades.filter(t => t.status === 'active' || t.status === 'pending');
            const closedPositions = allTrades.filter(t => t.status === 'stopped');
            
            let content = '';
            
            // Active Positions Section - Collapsible
            content += `<div class="mb-4">
                <div class="collapsible-header" onclick="toggleActivePositionsSection()" style="cursor: pointer; padding: 0.75rem; background: rgba(107, 139, 179, 0.1); border-radius: 8px; margin-bottom: 1rem;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">▲ Active Positions</h6>
                            <small class="text-muted">${activePositions.length} active position${activePositions.length !== 1 ? 's' : ''}</small>
                        </div>
                        <span class="expand-icon" id="active-positions-icon">▼</span>
                    </div>
                </div>
                <div class="collapsible-content" id="active-positions-content">
            `;
            
            if (activePositions.length > 0) {
                content += activePositions.map(pos => `
                    <div class="trade-card" data-trade-id="${pos.trade_id}">
                        <div class="d-flex justify-content-between mb-2">
                            <strong>${pos.symbol}</strong>
                            <span class="status-badge status-${pos.status}">${pos.side.toUpperCase()}</span>
                            ${pos.status === 'pending' ? '<small class="text-info ms-1">(PENDING)</small>' : ''}
                        </div>
                        <div class="row">
                            <div class="col-4">
                                <small class="text-muted">Size</small><br>
                                <strong>$${pos.position_size || (pos.amount * pos.leverage) || '0'}</strong>
                                <br><small class="text-muted">Margin: $${pos.amount || '0'}</small>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Current</small><br>
                                <strong class="current-price">$${pos.current_price || pos.entry_price || 'Market'}</strong>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">P&L</small><br>
                                <strong class="unrealized-pnl" style="color: ${(pos.unrealized_pnl || 0) >= 0 ? '#28a745' : '#dc3545'}">
                                    $${(pos.unrealized_pnl || 0).toFixed(2)}
                                </strong>
                                <br><small class="roe-percentage" style="color: ${calculateROE(pos) >= 0 ? '#28a745' : '#dc3545'}">
                                    ${calculateROE(pos).toFixed(2)}%
                                </small>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                content += '<div class="text-center py-4"><small class="text-muted">No active positions</small></div>';
            }
            
            content += `</div></div>`; // Close active positions collapsible content and container
            
            // Closed Positions History Section - Collapsible
            content += `<div class="mt-4">
                <div class="collapsible-header" onclick="toggleHistorySection()" style="cursor: pointer; padding: 0.75rem; background: rgba(108, 117, 125, 0.1); border-radius: 8px; margin-bottom: 1rem;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0 text-muted">◼ Closed Positions History</h6>
                            <small class="text-muted">${closedPositions.length} closed position${closedPositions.length !== 1 ? 's' : ''}</small>
                        </div>
                        <span class="expand-icon" id="history-icon">▼</span>
                    </div>
                </div>
                <div class="collapsible-content" id="history-content">
            `;
            
            if (closedPositions.length > 0) {
                content += closedPositions.slice(-10).reverse().map(pos => {
                    // Parse take profits if available
                    let takeProfits = [];
                    try {
                        takeProfits = pos.take_profits ? (typeof pos.take_profits === 'string' ? JSON.parse(pos.take_profits) : pos.take_profits) : [];
                    } catch (e) {
                        takeProfits = [];
                    }
                    
                    // Calculate ROE for closed position
                    const margin = pos.amount || 0;
                    const finalROE = margin > 0 ? ((pos.final_pnl || 0) / margin) * 100 : 0;
                    
                    // Prepare TP display
                    let tpDisplay = '';
                    if (takeProfits.length > 0) {
                        const tpInfo = takeProfits.map((tp, index) => 
                            `TP${index + 1}: ${tp.percentage}% (${tp.allocation}%)`
                        ).join(', ');
                        tpDisplay = `
                        <div class="mt-2 pt-2" style="border-top: 1px solid rgba(108, 117, 125, 0.2);">
                            <small class="text-muted">Take Profits:</small><br>
                            <small style="color: #17a2b8; font-family: monospace;">${tpInfo}</small>
                        </div>`;
                    }
                    
                    // Breakeven status display
                    let breakevenDisplay = '';
                    if (pos.breakeven_after && pos.breakeven_after !== 'disabled') {
                        const breakevenStatus = pos.breakeven_sl_triggered ? '✓ Activated' : '○ Not triggered';
                        const statusColor = pos.breakeven_sl_triggered ? '#28a745' : '#ffc107';
                        breakevenDisplay = `
                        <div class="mt-1">
                            <small class="text-muted">Breakeven SL:</small>
                            <small style="color: ${statusColor}; font-weight: 600;">${breakevenStatus}</small>
                            <small class="text-muted">(after ${pos.breakeven_after})</small>
                        </div>`;
                    }
                    
                    // P&L breakdown display
                    const realizedPnL = pos.realized_pnl || 0;
                    const unrealizedPnL = (pos.final_pnl || 0) - realizedPnL;
                    let pnlBreakdown = '';
                    if (realizedPnL > 0) {
                        pnlBreakdown = `
                        <div class="mt-1">
                            <small class="text-muted">Realized: </small><small style="color: #28a745;">$${realizedPnL.toFixed(2)}</small>
                            <small class="text-muted"> | Final: </small><small style="color: ${unrealizedPnL >= 0 ? '#28a745' : '#dc3545'};">$${unrealizedPnL.toFixed(2)}</small>
                        </div>`;
                    }
                    
                    return `
                    <div class="trade-card" style="opacity: 0.85; border-left: 3px solid ${(pos.final_pnl || 0) >= 0 ? '#28a745' : '#dc3545'};">
                        <div class="d-flex justify-content-between mb-2">
                            <div>
                                <strong>${pos.symbol}</strong>
                                <span class="status-badge status-stopped ms-2">${pos.side.toUpperCase()}</span>
                                <small class="text-muted ms-2">CLOSED</small>
                            </div>
                            <div class="text-end">
                                <strong style="color: ${(pos.final_pnl || 0) >= 0 ? '#28a745' : '#dc3545'}">
                                    $${(pos.final_pnl || 0).toFixed(2)}
                                </strong>
                                <br><small style="color: ${finalROE >= 0 ? '#28a745' : '#dc3545'}; font-weight: 600;">
                                    ${finalROE.toFixed(2)}% ROE
                                </small>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-4">
                                <small class="text-muted">Position Size</small><br>
                                <strong>$${pos.position_size || (pos.amount * pos.leverage) || '0'}</strong>
                                <br><small class="text-muted">Margin: $${pos.amount || '0'}</small>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Entry Price</small><br>
                                <strong>$${pos.entry_price || 'Market'}</strong>
                                <br><small class="text-muted">${pos.leverage || '1'}x Leverage</small>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Stop Loss</small><br>
                                <strong>${pos.stop_loss_percent || '0'}%</strong>
                                ${pos.breakeven_sl_triggered ? '<br><small style="color: #28a745;">+ Breakeven</small>' : ''}
                            </div>
                        </div>
                        ${tpDisplay}
                        ${breakevenDisplay}
                        ${pnlBreakdown}
                        ${pos.closed_at ? `
                        <div class="mt-2 pt-2" style="border-top: 1px solid rgba(108, 117, 125, 0.2);">
                            <small class="text-muted">Closed: ${new Date(pos.closed_at).toLocaleString('en-US', {
                                year: 'numeric',
                                month: '2-digit', 
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: false
                            })}</small>
                        </div>
                        ` : ''}
                    </div>
                `;
                }).join('');
                
                if (closedPositions.length > 10) {
                    content += `<div class="text-center py-2">
                        <small class="text-muted">... and ${closedPositions.length - 10} more closed positions</small>
                    </div>`;
                }
            } else {
                content += `<div class="text-center py-4"><small class="text-muted">No closed positions yet</small></div>`;
            }
            
            content += `</div></div>`; // Close collapsible content and container
            
            container.innerHTML = content;
            
            // Note: Removed auto-expansion behavior to keep sections collapsed by default
            // Users can manually expand sections as needed
        }

        // Trade configuration functions
        function createNewTrade() {
            currentTrade = {
                trade_id: 'new_' + Date.now(),
                name: 'New Trade',
                symbol: '',
                side: '',
                amount: '',
                leverage: 10,
                entry_type: '',
                entry_price: '',
                take_profits: [],
                stop_loss_percent: '',
                breakeven_after: 'disabled',
                trailing_stop_enabled: false,
                trail_percentage: '',
                trail_activation_price: ''
            };
            configStep = 0;
            showTradeModal();
        }

        async function editTrade(tradeId) {
            const data = await apiCall(`/api/trade-config?trade_id=${tradeId}`);
            if (data) {
                currentTrade = data;
                configStep = 0;
                showTradeModal();
            }
        }

        async function closeTrade(tradeId) {
            if (!confirm('Are you sure you want to close this position?')) return;
            
            const result = await apiCall('/api/close-trade', {
                method: 'POST',
                body: JSON.stringify({
                    user_id: currentUser?.id,
                    trade_id: tradeId
                })
            });
            
            if (result && result.success) {
                alert(`Position closed successfully! P&L: $${result.final_pnl?.toFixed(2) || '0.00'}`);
                // Only reload the current tab to avoid conflicts  
                if (currentActiveTab === 'positions') {
                    loadPositions();
                } else if (currentActiveTab === 'portfolio') {
                    loadPortfolio();
                }
            } else {
                alert('Failed to close position. Please try again.');
            }
        }

        async function closeAllTrades() {
            if (!confirm('Are you sure you want to close ALL active trades? This action cannot be undone.')) return;
            
            // Show loading state
            const closeAllBtn = document.getElementById('close-all-btn');
            const originalText = closeAllBtn.textContent;
            closeAllBtn.textContent = '⏳ Closing Trades...';
            closeAllBtn.disabled = true;
            
            try {
                const result = await apiCall('/api/close-all-trades', {
                    method: 'POST',
                    body: JSON.stringify({
                        user_id: currentUser?.id
                    })
                });
                
                if (result && result.success) {
                    const message = result.closed_count > 0 
                        ? `Successfully closed ${result.closed_count} trades! Total P&L: $${result.total_final_pnl?.toFixed(2) || '0.00'}`
                        : 'No active trades to close.';
                    alert(message);
                    
                    // Reload positions and portfolio to reflect changes
                    if (currentActiveTab === 'positions') {
                        loadPositions();
                    } else if (currentActiveTab === 'portfolio') {
                        loadPortfolio();
                    }
                } else {
                    alert('Failed to close all trades. Please try again.');
                }
            } catch (error) {
                console.error('Error closing all trades:', error);
                alert('An error occurred while closing trades. Please try again.');
            } finally {
                // Restore button state
                closeAllBtn.textContent = originalText;
                closeAllBtn.disabled = false;
            }
        }

        async function deleteTrade(tradeId) {
            if (!confirm('Are you sure you want to permanently delete this trade configuration?')) return;
            
            const result = await apiCall('/api/delete-trade', {
                method: 'POST',
                body: JSON.stringify({
                    user_id: currentUser?.id,
                    trade_id: tradeId
                })
            });
            
            if (result && result.success) {
                // Use native alert instead of Telegram-specific showAlert
                alert('Trade configuration deleted successfully!');
                // Only reload the current tab to avoid conflicts
                if (currentActiveTab === 'trading') {
                    loadTradeConfigs();
                } else if (currentActiveTab === 'positions') {
                    loadPositions();
                } else if (currentActiveTab === 'portfolio') {
                    loadPortfolio();
                }
            } else {
                alert('Failed to delete trade configuration. Please try again.');
            }
        }

        async function cancelPendingOrder(tradeId) {
            if (!confirm('Are you sure you want to cancel this pending limit order?')) return;
            
            const result = await apiCall('/api/delete-trade', {
                method: 'POST',
                body: JSON.stringify({
                    user_id: currentUser?.id,
                    trade_id: tradeId
                })
            });
            
            if (result && result.success) {
                alert('Pending limit order cancelled successfully!');
                // Only reload the current tab to avoid conflicts
                if (currentActiveTab === 'positions') {
                    loadPositions();
                } else if (currentActiveTab === 'trading') {
                    loadTradeConfigs();
                } else if (currentActiveTab === 'portfolio') {
                    loadPortfolio();
                }
            } else {
                alert('Failed to cancel pending order. Please try again.');
            }
        }

        // Button micro-interaction utilities
        function addButtonLoading(button) {
            if (!button) return;
            button.disabled = true;
            button.classList.add('btn-loading');
            button.setAttribute('data-original-text', button.innerHTML);
        }

        function removeButtonLoading(button) {
            if (!button) return;
            button.disabled = false;
            button.classList.remove('btn-loading');
            const originalText = button.getAttribute('data-original-text');
            if (originalText) {
                button.innerHTML = originalText;
                button.removeAttribute('data-original-text');
            }
        }

        function animateButtonSuccess(button) {
            if (!button) return;
            button.style.transform = 'scale(1.05)';
            button.style.backgroundColor = '#28a745';
            button.style.borderColor = '#28a745';
            setTimeout(() => {
                button.style.transform = '';
                button.style.backgroundColor = '';
                button.style.borderColor = '';
            }, 300);
        }

        function animateButtonError(button) {
            if (!button) return;
            button.style.transform = 'translateX(-5px)';
            button.style.backgroundColor = '#dc3545';
            button.style.borderColor = '#dc3545';
            setTimeout(() => {
                button.style.transform = 'translateX(5px)';
            }, 100);
            setTimeout(() => {
                button.style.transform = '';
                button.style.backgroundColor = '';
                button.style.borderColor = '';
            }, 200);
        }

        function showSuccessMessage(message) {
            // Use Telegram WebApp haptic feedback if available
            if (typeof tg !== 'undefined' && tg.HapticFeedback) {
                tg.HapticFeedback.notificationOccurred('success');
            }
            alert(message); // Can be replaced with a more elegant toast notification
        }

        function showErrorMessage(message) {
            // Use Telegram WebApp haptic feedback if available
            if (typeof tg !== 'undefined' && tg.HapticFeedback) {
                tg.HapticFeedback.notificationOccurred('error');
            }
            alert(message); // Can be replaced with a more elegant toast notification
        }

        async function deleteTradeConfig(tradeId) {
            const button = event.target;
            
            // Add confirmation with micro-interaction
            if (!confirm('Are you sure you want to delete this trade configuration?')) {
                button.style.transform = 'scale(1.1)';
                setTimeout(() => button.style.transform = '', 150);
                return;
            }
            
            addButtonLoading(button);
            
            try {
                const response = await apiCall(`/api/delete-trade/${tradeId}`, {
                    method: 'DELETE'
                });
                
                if (response && response.success) {
                    animateButtonSuccess(button);
                    showSuccessMessage('Trade configuration deleted successfully!');
                    setTimeout(() => loadTradeConfigs(), 300);
                } else {
                    throw new Error(response?.error || 'Deletion failed');
                }
            } catch (error) {
                animateButtonError(button);
                showErrorMessage('Failed to delete trade configuration. Please try again.');
                console.error('Delete failed:', error);
            } finally {
                removeButtonLoading(button);
            }
        }

        async function selectTrade(tradeId) {
            const data = await apiCall(`/api/trade-config?trade_id=${tradeId}`);
            if (!data) return;
            
            // Check if trade is complete
            const isComplete = data.symbol && data.side && data.amount && 
                              (data.entry_type === 'market' || (data.entry_type === 'limit' && data.entry_price)) &&
                              data.take_profits?.length > 0 && data.stop_loss_percent;
            
            if (isComplete && data.status === 'configured') {
                // Ask user if they want to execute the trade
                if (confirm(`Execute trade for ${data.symbol} ${data.side.toUpperCase()}?`)) {
                    await executeTrade(tradeId);
                }
            } else {
                // Open for editing
                currentTrade = data;
                configStep = 0;
                showTradeModal();
            }
        }

        async function editTradeConfig(tradeId) {
            const button = event.target;
            addButtonLoading(button);
            
            try {
                const data = await apiCall(`/api/trade-config?trade_id=${tradeId}`);
                if (data) {
                    currentTrade = data;
                    configStep = 0;
                    animateButtonSuccess(button);
                    setTimeout(() => showTradeModal(), 200);
                } else {
                    throw new Error('Failed to load trade configuration');
                }
            } catch (error) {
                animateButtonError(button);
                console.error('Edit failed:', error);
            } finally {
                removeButtonLoading(button);
            }
        }

        async function executeTrade(tradeId) {
            const button = event.target;
            addButtonLoading(button);
            
            try {
                const result = await apiCall('/api/execute-trade', {
                    method: 'POST',
                    body: JSON.stringify({
                        user_id: currentUser?.id,
                        trade_id: tradeId
                    })
                });
                
                if (result && result.success) {
                    animateButtonSuccess(button);
                    showSuccessMessage('Trade executed successfully!');
                    if (typeof tg !== 'undefined' && tg.MainButton) {
                        tg.MainButton.hide();
                    }
                    // Reload after animation
                    setTimeout(() => {
                        if (currentActiveTab === 'trading') {
                            loadTradeConfigs();
                        } else if (currentActiveTab === 'positions') {
                            loadPositions();
                        } else if (currentActiveTab === 'portfolio') {
                            loadPortfolio();
                        }
                    }, 500);
                } else {
                    throw new Error(result?.error || 'Execution failed');
                }
            } catch (error) {
                animateButtonError(button);
                showErrorMessage('Failed to execute trade. Please try again.');
                console.error('Execute failed:', error);
            } finally {
                removeButtonLoading(button);
            }
        }

        function showTradeModal() {
            updateTradeModal();
            new bootstrap.Modal(document.getElementById('tradeModal')).show();
        }

        function updateTradeModal() {
            if (!currentTrade) return;
            
            // Update progress indicator
            const progress = getTradeProgress(currentTrade);
            document.getElementById('trade-progress').innerHTML = progress;
            
            // Hide all steps
            document.querySelectorAll('.config-step').forEach(step => step.classList.add('hidden'));
            
            // Show current step
            const currentStepElement = document.getElementById(configSteps[configStep] + '-step');
            if (currentStepElement) {
                currentStepElement.classList.remove('hidden');
            }
            
            // Update modal title
            document.getElementById('tradeModalTitle').textContent = 
                `${currentTrade.name} - Step ${configStep + 1}/${configSteps.length}`;
            
            // Update form values
            if (currentTrade.symbol) document.getElementById('trade-symbol-select').value = currentTrade.symbol;
            if (currentTrade.amount) document.getElementById('amount-input').value = currentTrade.amount;
            if (currentTrade.leverage) document.getElementById('leverage-select').value = currentTrade.leverage;
            if (currentTrade.entry_price) document.getElementById('entry-price').value = currentTrade.entry_price;
            if (currentTrade.stop_loss_percent) document.getElementById('stop-loss').value = currentTrade.stop_loss_percent;
            if (currentTrade.breakeven_after) document.getElementById('breakeven-select').value = currentTrade.breakeven_after;
            if (currentTrade.trailing_stop_enabled) {
                document.getElementById('trailing-enabled').checked = currentTrade.trailing_stop_enabled;
                toggleTrailingStop();
            }
            if (currentTrade.trail_percentage) document.getElementById('trail-percentage').value = currentTrade.trail_percentage;
            if (currentTrade.trail_activation_price) document.getElementById('trail-activation').value = currentTrade.trail_activation_price;
        }

        function nextStep() {
            if (!validateCurrentStep()) return;
            
            if (configStep < configSteps.length - 1) {
                configStep++;
                updateTradeModal();
            } else {
                saveTrade();
            }
        }

        function previousStep() {
            if (configStep > 0) {
                configStep--;
                updateTradeModal();
            }
        }

        function validateCurrentStep() {
            const step = configSteps[configStep];
            
            switch (step) {
                case 'symbol':
                    const symbol = document.getElementById('trade-symbol-select').value;
                    if (!symbol) {
                        tg.showAlert('Please select a trading pair');
                        return false;
                    }
                    currentTrade.symbol = symbol;
                    break;
                    
                case 'side':
                    if (!currentTrade.side) {
                        tg.showAlert('Please select a position side (Long or Short)');
                        return false;
                    }
                    break;
                    
                case 'amount':
                    const amount = parseFloat(document.getElementById('amount-input').value);
                    const leverage = parseInt(document.getElementById('leverage-select').value);
                    if (!amount || amount <= 0) {
                        tg.showAlert('Please enter a valid amount');
                        return false;
                    }
                    currentTrade.amount = amount;
                    currentTrade.leverage = leverage;
                    break;
                    
                case 'entry':
                    if (!currentTrade.entry_type) {
                        tg.showAlert('Please select an entry type (Market or Limit)');
                        return false;
                    }
                    if (currentTrade.entry_type === 'limit') {
                        const entryPrice = parseFloat(document.getElementById('entry-price').value);
                        if (!entryPrice || entryPrice <= 0) {
                            tg.showAlert('Please enter a valid limit price');
                            return false;
                        }
                        currentTrade.entry_price = entryPrice;
                    } else {
                        currentTrade.entry_price = ''; // Clear for market orders
                    }
                    break;
                    
                case 'tp':
                    // Collect take profit data
                    currentTrade.take_profits = [];
                    document.querySelectorAll('#tp-levels .input-group').forEach((group, index) => {
                        const percent = parseFloat(group.querySelector('.tp-percent').value);
                        const allocation = parseFloat(group.querySelector('.tp-allocation').value);
                        if (percent && allocation) {
                            currentTrade.take_profits.push({ percentage: percent, allocation: allocation });
                        }
                    });
                    if (currentTrade.take_profits.length === 0) {
                        tg.showAlert('Please add at least one take profit level');
                        return false;
                    }
                    break;
                    
                case 'sl':
                    const stopLoss = parseFloat(document.getElementById('stop-loss').value);
                    if (!stopLoss || stopLoss <= 0) {
                        tg.showAlert('Please set a stop loss percentage');
                        return false;
                    }
                    currentTrade.stop_loss_percent = stopLoss;
                    break;
                    
                case 'breakeven':
                    const breakeven = document.getElementById('breakeven-select').value;
                    currentTrade.breakeven_after = breakeven;
                    break;
                    
                case 'trailing':
                    const trailingEnabled = document.getElementById('trailing-enabled').checked;
                    currentTrade.trailing_stop_enabled = trailingEnabled;
                    
                    if (trailingEnabled) {
                        const trailPercent = parseFloat(document.getElementById('trail-percentage').value);
                        if (!trailPercent || trailPercent <= 0) {
                            tg.showAlert('Please set a trail percentage');
                            return false;
                        }
                        currentTrade.trail_percentage = trailPercent;
                        
                        const activationPrice = parseFloat(document.getElementById('trail-activation').value);
                        if (activationPrice) {
                            currentTrade.trail_activation_price = activationPrice;
                        }
                    } else {
                        currentTrade.trail_percentage = '';
                        currentTrade.trail_activation_price = '';
                    }
                    break;
            }
            
            return true;
        }

        function setTradeSide(side) {
            currentTrade.side = side;
            document.querySelectorAll('#side-step .btn').forEach(btn => btn.classList.remove('btn-primary'));
            event.target.classList.add('btn-primary');
        }

        function setEntryType(type) {
            currentTrade.entry_type = type;
            document.querySelectorAll('#entry-step .btn').forEach(btn => btn.classList.remove('btn-primary'));
            event.target.classList.add('btn-primary');
            
            const limitInput = document.getElementById('limit-price-input');
            if (type === 'limit') {
                limitInput.classList.remove('hidden');
            } else {
                limitInput.classList.add('hidden');
                currentTrade.entry_price = '';
            }
        }

        function addTpLevel() {
            const container = document.getElementById('tp-levels');
            const level = container.children.length + 1;
            
            const tpDiv = document.createElement('div');
            tpDiv.className = 'input-group mb-2';
            tpDiv.innerHTML = `
                <span class="input-group-text">TP${level} %</span>
                <input type="number" class="form-control tp-percent" data-level="${level}" placeholder="5" step="0.1">
                <span class="input-group-text">Size %</span>
                <input type="number" class="form-control tp-allocation" data-level="${level}" placeholder="30" step="1">
                <button class="btn btn-outline-danger" onclick="this.parentElement.remove()">×</button>
            `;
            container.appendChild(tpDiv);
        }

        async function saveTrade() {
            // Collect take profit data
            currentTrade.take_profits = [];
            document.querySelectorAll('#tp-levels .input-group').forEach((group, index) => {
                const percent = parseFloat(group.querySelector('.tp-percent').value);
                const allocation = parseFloat(group.querySelector('.tp-allocation').value);
                if (percent && allocation) {
                    currentTrade.take_profits.push({ percentage: percent, allocation: allocation });
                }
            });
            
            // Prepare trade data for saving
            let tradeDataToSave = { ...currentTrade };
            
            // For active/pending trades, only send risk management parameters
            // to avoid triggering core parameter change safety checks
            if (currentTrade.status === 'active' || currentTrade.status === 'pending') {
                tradeDataToSave = {
                    trade_id: currentTrade.trade_id,
                    take_profits: currentTrade.take_profits,
                    stop_loss_percent: currentTrade.stop_loss_percent,
                    breakeven_after: currentTrade.breakeven_after,
                    trailing_stop_enabled: currentTrade.trailing_stop_enabled,
                    trail_percentage: currentTrade.trail_percentage,
                    trail_activation_price: currentTrade.trail_activation_price
                };
            }
            
            // Save trade configuration
            const result = await apiCall('/api/save-trade', {
                method: 'POST',
                body: JSON.stringify({
                    user_id: currentUser?.id,
                    trade: tradeDataToSave
                })
            });
            
            if (result && result.success) {
                alert('Trade configuration saved successfully!');
                bootstrap.Modal.getInstance(document.getElementById('tradeModal')).hide();
                // Only reload the current tab to avoid conflicts
                if (currentActiveTab === 'trading') {
                    loadTradeConfigs();
                } else if (currentActiveTab === 'positions') {
                    loadPositions();
                }
            } else {
                alert('Failed to save trade configuration. Please try again.');
            }
        }

        function calculateROE(trade) {
            if (!trade.unrealized_pnl || !trade.amount || !trade.leverage) return 0;
            const positionSize = trade.amount;
            const margin = positionSize / (trade.leverage || 1);
            return margin > 0 ? (trade.unrealized_pnl / margin) * 100 : 0;
        }

        function getTradeProgress(trade) {
            const steps = {
                "Symbol": trade.symbol ? "●" : "○",
                "Side": trade.side ? "●" : "○", 
                "Amount": trade.amount ? "●" : "○",
                "Entry": (trade.entry_type === "market" || (trade.entry_type === "limit" && trade.entry_price)) ? "●" : "○",
                "TPs": trade.take_profits?.length > 0 ? "●" : "○",
                "SL": trade.stop_loss_percent > 0 ? "●" : (trade.stop_loss_percent == 0 && trade.status === 'active' ? "⚖" : "○")
            };
            
            const completed = Object.values(steps).filter(s => s === "●").length;
            const total = Object.keys(steps).length;
            const progress = "█".repeat(completed) + "░".repeat(total - completed);
            
            // Add advanced settings indicators
            const advancedSettings = [];
            if (trade.breakeven_after && trade.breakeven_after !== 'disabled') {
                advancedSettings.push('BE');
            }
            if (trade.trailing_stop_enabled) {
                advancedSettings.push('TS');
            }
            const advancedText = advancedSettings.length > 0 ? ` +${advancedSettings.join(',')}` : '';
            
            return `${completed}/${total} [${progress}] ${Object.entries(steps).map(([k,v]) => `${k}${v}`).join(' ')}${advancedText}`;
        }

        function toggleTrailingStop() {
            const enabled = document.getElementById('trailing-enabled').checked;
            const options = document.getElementById('trailing-options');
            if (enabled) {
                options.classList.remove('hidden');
            } else {
                options.classList.add('hidden');
            }
        }

        // API Credentials Management Functions
        async function loadCredentialsStatus() {
            const data = await apiCall(`/api/user-credentials?user_id=${currentUser?.id || '123456789'}`);
            const statusContainer = document.getElementById('credentials-status');
            const setupContainer = document.getElementById('credentials-setup');
            
            if (!data) return;
            
            if (data.has_credentials) {
                statusContainer.innerHTML = `
                    <div class="card border-success">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0">● API Credentials Active</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-6">
                                    <small class="text-muted">Exchange:</small><br>
                                    <strong>${(data.exchange || 'Unknown').toUpperCase()}</strong>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">Mode:</small><br>
                                    <strong>${data.testnet_mode ? '◐ Testnet' : '⚡ Live Trading'}</strong>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div class="two-column-grid">
                                    <button class="btn btn-outline-warning" onclick="showCredentialsSetup()">⟲ Update</button>
                                    <button class="btn btn-outline-danger" onclick="deleteCredentials()">✕ Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                setupContainer.classList.add('hidden');
            } else {
                statusContainer.innerHTML = `
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0">○ No API Credentials</h6>
                        </div>
                        <div class="card-body">
                            <p class="mb-2">Add your exchange API credentials to enable live trading.</p>
                            <button class="btn btn-primary" onclick="showCredentialsSetup()">⚿ Add Credentials</button>
                        </div>
                    </div>
                `;
                setupContainer.classList.add('hidden');
            }
        }

        function showCredentialsSetup() {
            document.getElementById('credentials-setup').classList.remove('hidden');
        }

        function cancelCredentialsSetup() {
            document.getElementById('credentials-setup').classList.add('hidden');
            clearCredentialsForm();
        }

        function clearCredentialsForm() {
            document.getElementById('api-key-input').value = '';
            document.getElementById('api-secret-input').value = '';
            document.getElementById('passphrase-input').value = '';
            document.getElementById('exchange-select').value = 'toobit';
        }

        async function saveCredentials() {
            const exchange = document.getElementById('exchange-select').value;
            const apiKey = document.getElementById('api-key-input').value.trim();
            const apiSecret = document.getElementById('api-secret-input').value.trim();
            const passphrase = document.getElementById('passphrase-input').value.trim();

            if (!apiKey || !apiSecret) {
                alert('Please enter both API key and secret');
                return;
            }

            try {
                const response = await fetch('/api/save-credentials', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUser?.id || '123456789',
                        exchange: exchange,
                        api_key: apiKey,
                        api_secret: apiSecret,
                        passphrase: passphrase || null
                    })
                });

                if (response.ok) {
                    alert('● Credentials saved successfully!');
                    clearCredentialsForm();
                    cancelCredentialsSetup();
                    loadCredentialsStatus();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error || 'Failed to save credentials'}`);
                }
            } catch (error) {
                console.error('Error saving credentials:', error);
                alert('Error saving credentials. Please try again.');
            }
        }

        async function deleteCredentials() {
            if (!confirm('Are you sure you want to delete your API credentials?')) {
                return;
            }

            try {
                const response = await fetch('/api/delete-credentials', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentUser?.id || '123456789' })
                });

                if (response.ok) {
                    alert('● Credentials deleted successfully');
                    loadCredentialsStatus();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.error || 'Failed to delete credentials'}`);
                }
            } catch (error) {
                console.error('Error deleting credentials:', error);
                alert('Error deleting credentials. Please try again.');
            }
        }





        // Tab switching managed by handleTabSwitch function below

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadMockTradingStatus(); // Load mock trading status first
            loadPositions(); // Start with positions tab
        });

        // Auto-refresh for portfolio (configured interval) - positions use live price updates
        setInterval(() => {
            const activeTab = document.querySelector('.nav-link.active').getAttribute('data-bs-target');
            // Don't reload positions - live price updates handle that
            if (activeTab === '#portfolio') loadPortfolio();
        }, {{ portfolio_refresh_interval }});

        async function loadMockTradingStatus() {
            try {
                const response = await apiCall(`/api/mock-trading-status?user_id=${currentUser?.id}`);
                if (response.success) {
                    const mockText = document.getElementById('mock-trading-text');
                    mockText.textContent = response.mock_mode ? 'Mock Trading: On' : 'Mock Trading: Off';
                }
            } catch (error) {
                console.error('Error loading mock trading status:', error);
                // Default to mock trading on for safety
                const mockText = document.getElementById('mock-trading-text');
                mockText.textContent = 'Mock Trading: On';
            }
        }

        // Mobile-specific enhancements
        function initializeMobileEnhancements() {
            // Prevent double-tap zoom on buttons
            document.querySelectorAll('.btn, .nav-link, .collapsible-header').forEach(element => {
                element.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    this.click();
                });
            });

            // Add swipe gesture support for tab navigation
            let startX = 0;
            let startY = 0;
            let isScrolling = false;

            document.addEventListener('touchstart', function(e) {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                isScrolling = false;
            });

            document.addEventListener('touchmove', function(e) {
                const deltaX = Math.abs(e.touches[0].clientX - startX);
                const deltaY = Math.abs(e.touches[0].clientY - startY);
                
                if (deltaY > deltaX) {
                    isScrolling = true;
                }
            });

            document.addEventListener('touchend', function(e) {
                if (isScrolling) return;
                
                const endX = e.changedTouches[0].clientX;
                const deltaX = endX - startX;
                
                if (Math.abs(deltaX) > 50) { // Minimum swipe distance
                    const tabs = document.querySelectorAll('.nav-link');
                    const activeTab = document.querySelector('.nav-link.active');
                    const currentIndex = Array.from(tabs).indexOf(activeTab);
                    
                    if (deltaX > 0 && currentIndex > 0) {
                        // Swipe right - previous tab
                        tabs[currentIndex - 1].click();
                    } else if (deltaX < 0 && currentIndex < tabs.length - 1) {
                        // Swipe left - next tab
                        tabs[currentIndex + 1].click();
                    }
                }
            });

            // Optimize scroll performance
            let ticking = false;
            function updateScrollElements() {
                // Add scroll-based effects here if needed
                ticking = false;
            }

            function requestTick() {
                if (!ticking) {
                    requestAnimationFrame(updateScrollElements);
                    ticking = true;
                }
            }

            document.addEventListener('scroll', requestTick);

            // Handle safe area insets for newer devices
            if (CSS.supports('padding: env(safe-area-inset-top)')) {
                document.documentElement.style.setProperty('--safe-area-top', 'env(safe-area-inset-top)');
                document.documentElement.style.setProperty('--safe-area-bottom', 'env(safe-area-inset-bottom)');
                
                // Adjust header and bottom spacing
                const header = document.querySelector('.header');
                if (header) {
                    header.style.paddingTop = 'calc(1.25rem + var(--safe-area-top, 0px))';
                }
            }

            // Improve form interactions on mobile
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('focus', function() {
                    // Scroll input into view with some padding
                    setTimeout(() => {
                        this.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center' 
                        });
                    }, 300);
                });

                // Format numbers for better readability
                input.addEventListener('blur', function() {
                    if (this.value && !isNaN(this.value)) {
                        const value = parseFloat(this.value);
                        if (this.step && this.step.includes('.')) {
                            const decimals = this.step.split('.')[1].length;
                            this.value = value.toFixed(decimals);
                        }
                    }
                });
            });

            // Add haptic feedback for touch interactions (if supported)
            if ('vibrate' in navigator) {
                document.querySelectorAll('.btn-primary, .btn-success, .btn-danger').forEach(button => {
                    button.addEventListener('click', function() {
                        navigator.vibrate(50); // Light haptic feedback
                    });
                });
            }

            // Optimize modal interactions for mobile
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('shown.bs.modal', function() {
                    // Prevent background scrolling
                    document.body.style.overflow = 'hidden';
                    
                    // Focus first input
                    const firstInput = this.querySelector('input, select, textarea');
                    if (firstInput) {
                        setTimeout(() => firstInput.focus(), 100);
                    }
                });

                modal.addEventListener('hidden.bs.modal', function() {
                    // Restore background scrolling
                    document.body.style.overflow = '';
                });
            });

            // Add pull-to-refresh functionality
            let pullStartY = 0;
            let pulling = false;
            const pullThreshold = 80;

            document.addEventListener('touchstart', function(e) {
                if (window.scrollY === 0) {
                    pullStartY = e.touches[0].clientY;
                    pulling = true;
                }
            });

            document.addEventListener('touchmove', function(e) {
                if (!pulling) return;
                
                const currentY = e.touches[0].clientY;
                const pullDistance = currentY - pullStartY;
                
                if (pullDistance > pullThreshold && window.scrollY === 0) {
                    // Visual feedback for pull-to-refresh
                    const header = document.querySelector('.header h1');
                    if (header && !header.textContent.includes('↓')) {
                        header.textContent = '↓ ' + header.textContent.replace('↓ ', '');
                    }
                }
            });

            document.addEventListener('touchend', function(e) {
                if (!pulling) return;
                pulling = false;
                
                const header = document.querySelector('.header h1');
                if (header && header.textContent.includes('↓')) {
                    header.textContent = header.textContent.replace('↓ ', '');
                    
                    // Trigger refresh
                    const activeTab = document.querySelector('.nav-link.active').getAttribute('data-bs-target');
                    if (activeTab === '#positions') loadPositions();
                    else if (activeTab === '#trading') loadTradeConfigs();
                    else if (activeTab === '#portfolio') loadPortfolio();
                    else if (activeTab === '#credentials') loadCredentialsStatus();
                }
            });

            // Optimize touch targets for better accessibility
            document.querySelectorAll('.btn-sm').forEach(button => {
                if (button.offsetHeight < 44) {
                    button.style.minHeight = '44px';
                    button.style.display = 'flex';
                    button.style.alignItems = 'center';
                    button.style.justifyContent = 'center';
                }
            });
        }

        // Track current active tab to prevent conflicts
        let currentActiveTab = 'positions';
        
        // Tab switching management for live price updates
        function handleTabSwitch(tabName) {
            currentActiveTab = tabName;
            
            if (tabName === 'positions') {
                // Load positions and start live updates
                loadPositions().then(() => {
                    // Only start updates if still on positions tab
                    if (currentActiveTab === 'positions') {
                        const activePositions = document.querySelectorAll('[data-trade-id]');
                        if (activePositions.length > 0) {
                            startLivePriceUpdates();
                        } else {
                            stopLivePriceUpdates();
                        }
                    }
                });
            } else if (tabName === 'trading') {
                // Stop live updates and load trade configs
                stopLivePriceUpdates();
                loadTradeConfigs();
            } else if (tabName === 'portfolio') {
                // Load portfolio and start updates for active positions
                loadPortfolio().then(() => {
                    // Only start updates if still on portfolio tab
                    if (currentActiveTab === 'portfolio') {
                        const activePositions = document.querySelectorAll('[data-trade-id]');
                        if (activePositions.length > 0) {
                            startLivePriceUpdates();
                        } else {
                            stopLivePriceUpdates();
                        }
                    }
                });
            } else if (tabName === 'credentials') {
                // Stop live updates and load credentials
                stopLivePriceUpdates();
                loadCredentialsStatus();
            }
        }

        // Add live price indicator to header
        function addLivePriceIndicator() {
            const header = document.querySelector('.header h5');
            if (header && !header.querySelector('.live-indicator')) {
                const indicator = document.createElement('span');
                indicator.className = 'live-indicator';
                indicator.innerHTML = ' <small style="color: #28a745; animation: pulse 2s infinite;">● LIVE</small>';
                header.appendChild(indicator);
            }
        }

        function removeLivePriceIndicator() {
            const indicator = document.querySelector('.live-indicator');
            if (indicator) indicator.remove();
        }

        // Override start/stop functions to manage indicator
        const originalStartLivePriceUpdates = startLivePriceUpdates;
        const originalStopLivePriceUpdates = stopLivePriceUpdates;
        
        startLivePriceUpdates = function() {
            originalStartLivePriceUpdates();
            addLivePriceIndicator();
        };
        
        stopLivePriceUpdates = function() {
            originalStopLivePriceUpdates();
            removeLivePriceIndicator();
        };

        // Reset History Functions
        async function confirmResetHistory() {
            if (!currentUser?.id) {
                showToast('Please set up your Telegram user first', 'error');
                return;
            }
            
            const confirmed = confirm(
                "⚠️ WARNING: This will permanently delete all your trade history and reset your P&L to zero.\n\n" +
                "Your API credentials will NOT be affected.\n\n" + 
                "Are you sure you want to continue?"
            );
            
            if (confirmed) {
                await resetTradeHistory();
            }
        }
        
        async function resetTradeHistory() {
            const resetBtn = document.getElementById('reset-history-btn');
            if (!resetBtn) return;
            
            try {
                // Show loading state
                const originalText = resetBtn.innerHTML;
                resetBtn.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> Resetting...';
                resetBtn.disabled = true;
                resetBtn.classList.add('btn-loading');
                
                const response = await fetch('/api/reset-history', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentUser.id
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showToast('Trade history reset successfully', 'success');
                    
                    // Reset UI elements to zero
                    document.getElementById('account-balance').textContent = '$1000.00';
                    document.getElementById('margin-used').textContent = '$0.00';
                    document.getElementById('free-margin').textContent = '$1000.00';
                    document.getElementById('margin-ratio').textContent = '0%';
                    document.getElementById('realized-pnl').textContent = '$0.00';
                    document.getElementById('total-pnl-portfolio').textContent = '$0.00';
                    document.getElementById('total-pnl-portfolio').style.color = '#28a745';
                    
                    // Clear portfolio details
                    const portfolioDetails = document.getElementById('portfolio-details');
                    if (portfolioDetails) {
                        portfolioDetails.innerHTML = '<div class="text-center py-4"><small class="text-muted">No trade history</small></div>';
                    }
                    
                    // Refresh other tabs if they're active
                    if (currentActiveTab === 'positions') {
                        await loadPositions();
                    } else if (currentActiveTab === 'trading') {
                        await loadTradeConfigs();
                    }
                } else {
                    showToast(result.error || 'Failed to reset history', 'error');
                }
            } catch (error) {
                console.error('Reset history error:', error);
                showToast('Failed to reset history', 'error');
            } finally {
                // Restore button state
                resetBtn.innerHTML = '🗑️ Reset History';
                resetBtn.disabled = false;
                resetBtn.classList.remove('btn-loading');
            }
        }

        // Hamburger menu functionality
        function toggleHamburgerMenu() {
            const dropdown = document.getElementById('hamburger-dropdown');
            dropdown.classList.toggle('show');
        }

        function openApiKeysSettings() {
            // Hide hamburger menu
            document.getElementById('hamburger-dropdown').classList.remove('show');
            
            // Show API Keys modal
            const modal = new bootstrap.Modal(document.getElementById('apiKeysModal'));
            modal.show();
            
            // Load current credentials status
            loadCredentialsStatus();
        }

        async function toggleMockTrading() {
            // Hide hamburger menu
            document.getElementById('hamburger-dropdown').classList.remove('show');
            
            try {
                const response = await apiCall('/api/toggle-mock-trading', {
                    method: 'POST',
                    body: JSON.stringify({
                        user_id: currentUser?.id
                    })
                });
                
                if (response.success) {
                    // Update the UI text
                    const mockText = document.getElementById('mock-trading-text');
                    mockText.textContent = response.mock_mode ? 'Mock Trading: On' : 'Mock Trading: Off';
                    
                    // Show success notification
                    showNotification('info', `${response.mock_mode ? 'Enabled' : 'Disabled'} mock trading mode`);
                    
                    // Refresh the portfolio and active positions since the mode changed
                    await loadActivePositions();
                    await loadPortfolio();
                } else {
                    showNotification('error', response.message || 'Failed to toggle mock trading mode');
                }
            } catch (error) {
                console.error('Error toggling mock trading:', error);
                showNotification('error', 'Failed to toggle mock trading mode');
            }
        }

        // Close hamburger menu when clicking outside
        document.addEventListener('click', function(event) {
            const hamburgerMenu = document.querySelector('.hamburger-menu');
            const dropdown = document.getElementById('hamburger-dropdown');
            
            if (hamburgerMenu && !hamburgerMenu.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // API Keys modal functions (reusing existing functionality)
        async function loadCredentialsStatus() {
            const statusContainer = document.getElementById('api-credentials-status');
            const setupContainer = document.getElementById('api-credentials-setup');
            
            try {
                const data = await apiCall(`/api/user-credentials?user_id=${currentUser?.id}`);
                
                if (data && data.has_credentials) {
                    const modeText = data.testnet_mode ? '🧪 Testnet Mode' : '🚀 Live Trading';
                    const modeClass = data.testnet_mode ? 'text-info' : 'text-warning';
                    const toggleText = data.testnet_mode ? 'Switch to Live Trading' : 'Switch to Testnet';
                    const toggleClass = data.testnet_mode ? 'btn-warning' : 'btn-info';
                    
                    statusContainer.innerHTML = `
                        <div class="card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <h6 class="mb-1">✅ ${data.exchange} Credentials</h6>
                                        <small class="text-muted">API Key: ${data.api_key_preview}</small>
                                    </div>
                                    <div>
                                        <button class="btn btn-outline-danger btn-sm" onclick="deleteApiCredentials()">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                                <div class="border-top pt-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1 ${modeClass}">${modeText}</h6>
                                            <small class="text-muted">${data.testnet_mode ? 'Safe for testing with virtual funds' : '⚠️ Real money trading mode'}</small>
                                        </div>
                                        <div>
                                            <button class="btn ${toggleClass} btn-sm" onclick="toggleTestnetMode(${!data.testnet_mode})">
                                                ${toggleText}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    setupContainer.classList.add('hidden');
                } else {
                    statusContainer.innerHTML = `
                        <div class="text-center">
                            <h6 class="text-muted">No API credentials configured</h6>
                            <button class="btn btn-primary" onclick="showApiCredentialsSetup()">
                                Add API Credentials
                            </button>
                        </div>
                    `;
                    setupContainer.classList.add('hidden');
                }
            } catch (error) {
                console.error('Failed to load credentials status:', error);
                statusContainer.innerHTML = `
                    <div class="text-center">
                        <div class="text-danger">Failed to load credentials status</div>
                        <button class="btn btn-primary mt-2" onclick="loadCredentialsStatus()">
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        function showApiCredentialsSetup() {
            document.getElementById('api-credentials-setup').classList.remove('hidden');
            
            // Clear form
            document.getElementById('api-exchange-select').value = 'toobit';
            document.getElementById('api-key-modal-input').value = '';
            document.getElementById('api-secret-modal-input').value = '';
            document.getElementById('api-passphrase-modal-input').value = '';
            
            // Show/hide passphrase based on exchange
            const exchange = document.getElementById('api-exchange-select').value;
            const passphraseGroup = document.getElementById('api-passphrase-group');
            passphraseGroup.style.display = exchange === 'okx' ? 'block' : 'none';
        }

        function cancelApiCredentialsSetup() {
            document.getElementById('api-credentials-setup').classList.add('hidden');
        }

        async function saveApiCredentials() {
            const exchange = document.getElementById('api-exchange-select').value;
            const apiKey = document.getElementById('api-key-modal-input').value.trim();
            const apiSecret = document.getElementById('api-secret-modal-input').value.trim();
            const passphrase = document.getElementById('api-passphrase-modal-input').value.trim();

            if (!apiKey || !apiSecret) {
                alert('Please enter both API key and secret');
                return;
            }

            if (exchange === 'okx' && !passphrase) {
                alert('Passphrase is required for OKX');
                return;
            }

            try {
                const response = await apiCall('/api/save-credentials', {
                    method: 'POST',
                    body: JSON.stringify({
                        user_id: currentUser?.id,
                        exchange: exchange,
                        api_key: apiKey,
                        api_secret: apiSecret,
                        passphrase: passphrase || null
                    })
                });

                if (response && response.success) {
                    alert('API credentials saved successfully!');
                    cancelApiCredentialsSetup();
                    loadCredentialsStatus();
                } else {
                    alert('Failed to save credentials: ' + (response?.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Save credentials error:', error);
                alert('Failed to save credentials. Please try again.');
            }
        }

        async function toggleTestnetMode(newTestnetMode) {
            const confirmMessage = newTestnetMode 
                ? 'Switch to testnet mode? This will use virtual funds for testing.'
                : '⚠️ WARNING: Switch to live trading mode? This will use REAL MONEY for trades!';
                
            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                const response = await apiCall('/api/toggle-testnet', {
                    method: 'POST',
                    body: JSON.stringify({
                        user_id: currentUser?.id,
                        testnet_mode: newTestnetMode
                    })
                });

                if (response && response.success) {
                    if (response.warning) {
                        alert(response.warning);
                    } else {
                        alert(response.message);
                    }
                    loadCredentialsStatus();
                    
                    // If user is on portfolio tab, refresh it to show the new balance data
                    if (currentActiveTab === 'portfolio') {
                        loadPortfolio();
                    }
                } else {
                    alert('Failed to toggle mode: ' + (response?.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Toggle testnet error:', error);
                alert('Failed to toggle trading mode. Please try again.');
            }
        }

        async function deleteApiCredentials() {
            if (!confirm('Are you sure you want to delete your API credentials?')) {
                return;
            }

            try {
                const response = await apiCall('/api/delete-credentials', {
                    method: 'POST',
                    body: JSON.stringify({
                        user_id: currentUser?.id
                    })
                });

                if (response && response.success) {
                    alert('API credentials deleted successfully!');
                    loadCredentialsStatus();
                } else {
                    alert('Failed to delete credentials: ' + (response?.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Delete credentials error:', error);
                alert('Failed to delete credentials. Please try again.');
            }
        }

        // Exchange change handler for modal
        document.addEventListener('DOMContentLoaded', function() {
            const exchangeSelect = document.getElementById('api-exchange-select');
            if (exchangeSelect) {
                exchangeSelect.addEventListener('change', function() {
                    const exchange = this.value;
                    const passphraseGroup = document.getElementById('api-passphrase-group');
                    passphraseGroup.style.display = exchange === 'okx' ? 'block' : 'none';
                });
            }
        });

        // Initialize mobile enhancements after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializeMobileEnhancements();
            
            // Set up tab click handlers for live price management
            document.querySelectorAll('.nav-link').forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-bs-target')?.replace('#', '');
                    if (targetTab) {
                        setTimeout(() => handleTabSwitch(targetTab), 100);
                    }
                });
            });
            
            // Auto-load positions tab data if it's the default active tab
            const activeTab = document.querySelector('.nav-link.active')?.getAttribute('data-bs-target')?.replace('#', '');
            if (activeTab === 'positions') {
                handleTabSwitch('positions');
            }
        });
    </script>

    <!-- API Keys Settings Modal -->
    <div class="modal fade" id="apiKeysModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h6 class="modal-title">⚿ API Keys Settings</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <p class="text-muted">Manage your exchange API credentials for live trading</p>
                    </div>
                    
                    <div id="api-credentials-status" class="mb-4">
                        <div class="loading">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            Loading credentials status...
                        </div>
                    </div>

                    <div id="api-credentials-setup" class="hidden">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Add API Credentials</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Exchange</label>
                                    <select class="form-control" id="api-exchange-select">
                                        <option value="toobit">Toobit</option>
                                        <option value="binance">Binance</option>
                                        <option value="okx">OKX</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">API Key</label>
                                    <input type="text" class="form-control" id="api-key-modal-input" placeholder="Enter your API key">
                                    <small class="text-muted">Your API key will be encrypted and stored securely</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">API Secret</label>
                                    <input type="password" class="form-control" id="api-secret-modal-input" placeholder="Enter your API secret">
                                    <small class="text-muted">Your secret will be encrypted and stored securely</small>
                                </div>
                                <div class="mb-3" id="api-passphrase-group" style="display: none;">
                                    <label class="form-label">Passphrase (if required)</label>
                                    <input type="password" class="form-control" id="api-passphrase-modal-input" placeholder="Enter passphrase if required">
                                </div>
                                <div class="two-column-grid">
                                    <button class="btn btn-outline-secondary" onclick="cancelApiCredentialsSetup()">Cancel</button>
                                    <button class="btn btn-primary" onclick="saveApiCredentials()">Save Credentials</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <div class="alert alert-info">
                            <strong>🔐 Security Information:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Your API credentials are encrypted using military-grade encryption</li>
                                <li>Only trading permissions are required - never share withdrawal access</li>
                                <li>All credentials are stored securely and never shared</li>
                                <li>You can delete your credentials at any time</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>