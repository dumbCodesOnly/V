<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Trading Expert</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-size: 14px;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 1rem 1.5rem;
        }
        .card-header h5 {
            margin: 0;
            font-weight: 600;
        }
        .stats-card {
            transition: all 0.3s ease;
            height: 100%;
        }
        .stats-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }
        
        /* Mobile-first responsive design */
        @media (max-width: 768px) {
            .container-fluid {
                padding: 0.5rem;
            }
            .card {
                margin-bottom: 1rem;
            }
            .card-header {
                padding: 0.75rem 1rem;
            }
            .card-header h5 {
                font-size: 1rem;
            }
            .stats-card .card-body {
                padding: 1rem 0.5rem;
            }
            .stats-card .fs-1 {
                font-size: 2rem !important;
            }
            .stats-card h4 {
                font-size: 1.25rem;
            }
        }
        
        /* Button styles */
        .btn {
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
            min-height: 38px;
        }
        .btn-sm {
            min-height: 32px;
            font-size: 0.85rem;
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            border: none;
        }
        .btn-danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            border: none;
        }
        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
        }
        .btn-info {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            border: none;
        }
        
        /* Mobile-responsive button groups */
        .mobile-btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }
        @media (max-width: 768px) {
            .mobile-btn-group {
                flex-direction: column;
                align-items: stretch;
            }
            .mobile-btn-group .btn {
                width: 100%;
                justify-content: center;
            }
            .mobile-header {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 1rem;
            }
            .mobile-header > div {
                width: 100%;
            }
        }
        
        /* Table improvements */
        .table {
            border-radius: 10px;
            overflow: hidden;
            background: white;
        }
        .table-responsive {
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        /* Enhanced mobile table */
        @media (max-width: 768px) {
            .mobile-table-card {
                display: block;
                width: 100%;
                background: white;
                border-radius: 10px;
                padding: 1rem;
                margin-bottom: 1rem;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            .mobile-table-header {
                font-weight: 600;
                color: #333;
                margin-bottom: 0.5rem;
            }
            .mobile-table-content {
                font-size: 0.9rem;
                color: #666;
            }
        }
        
        /* Status badges */
        .status-badge {
            font-size: 0.75rem;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-weight: 500;
        }
        
        /* Loading states */
        .loading {
            display: none;
        }
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
        
        /* Modal enhancements */
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0;
        }
        .modal-content {
            border-radius: 15px;
            border: none;
            overflow: hidden;
        }
        
        /* Form enhancements */
        .form-select, .form-control {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: all 0.2s ease;
        }
        .form-select:focus, .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        /* System status indicators */
        .system-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        .system-indicator.healthy {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
            border: 1px solid rgba(40, 167, 69, 0.3);
        }
        .system-indicator.warning {
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }
        .system-indicator.error {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }
        
        /* Improved spacing and layout */
        .section-spacing {
            margin-bottom: 2rem;
        }
        @media (max-width: 768px) {
            .section-spacing {
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-shield-check"></i>
                Trading Expert Admin
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/admin/logout">
                    <i class="bi bi-box-arrow-right"></i>
                    Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Statistics Cards -->
        <div class="row section-spacing g-3">
            <div class="col-6 col-lg-3">
                <div class="card stats-card text-center h-100">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <i class="bi bi-clock-history text-warning fs-1"></i>
                        <h4 class="mt-2 mb-1" id="pending-count">-</h4>
                        <p class="text-muted mb-0 small">Pending</p>
                    </div>
                </div>
            </div>
            <div class="col-6 col-lg-3">
                <div class="card stats-card text-center h-100">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <i class="bi bi-check-circle text-success fs-1"></i>
                        <h4 class="mt-2 mb-1" id="approved-count">-</h4>
                        <p class="text-muted mb-0 small">Approved</p>
                    </div>
                </div>
            </div>
            <div class="col-6 col-lg-3">
                <div class="card stats-card text-center h-100">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <i class="bi bi-x-circle text-danger fs-1"></i>
                        <h4 class="mt-2 mb-1" id="rejected-count">-</h4>
                        <p class="text-muted mb-0 small">Rejected</p>
                    </div>
                </div>
            </div>
            <div class="col-6 col-lg-3">
                <div class="card stats-card text-center h-100">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <i class="bi bi-ban text-dark fs-1"></i>
                        <h4 class="mt-2 mb-1" id="banned-count">-</h4>
                        <p class="text-muted mb-0 small">Banned</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Database Management -->
        <div class="card section-spacing">
            <div class="card-header mobile-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-database me-2"></i>
                    Database Management
                </h5>
                <div class="mobile-btn-group">
                    <button class="btn btn-sm btn-info" onclick="loadDatabaseStats()" title="Refresh Stats">
                        <i class="bi bi-arrow-clockwise me-1"></i>
                        <span class="d-none d-sm-inline">Refresh</span>
                    </button>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-warning dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-trash me-1"></i>
                            <span class="d-none d-sm-inline">Cache Actions</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="restartCacheWorker()">
                                <i class="bi bi-arrow-clockwise me-2"></i>Restart Cache Worker
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="clearCache('all')">
                                <i class="bi bi-trash me-2"></i>Clear All Cache
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="clearSMCSignals()">
                                <i class="bi bi-graph-down me-2"></i>Clear SMC Signals
                            </a></li>
                        </ul>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-danger dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-tools me-1"></i>
                            <span class="d-none d-sm-inline">Database Tools</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="migrateDatabase()">
                                <i class="bi bi-database-gear me-2"></i>Migrate Schema
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="backupDatabase()">
                                <i class="bi bi-download me-2"></i>Backup Data
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Database Stats Row -->
                <div class="row g-3 mb-4">
                    <div class="col-lg-6">
                        <div class="card h-100 border-0 bg-light">
                            <div class="card-body">
                                <h6 class="card-title mb-3">
                                    <i class="bi bi-table text-primary me-2"></i>Database Tables
                                </h6>
                                <div id="database-tables" class="table-responsive">
                                    <div class="text-center p-3">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                        <span class="ms-2">Loading database stats...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card h-100 border-0 bg-light">
                            <div class="card-body">
                                <h6 class="card-title mb-3">
                                    <i class="bi bi-cpu text-success me-2"></i>System Status
                                </h6>
                                <div id="system-status">
                                    <div class="text-center p-3">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                        <span class="ms-2">Loading system status...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Table Viewer -->
                <div class="card border-0 bg-light">
                    <div class="card-body">
                        <h6 class="card-title mb-3">
                            <i class="bi bi-eye text-info me-2"></i>Table Viewer
                        </h6>
                        <div class="row g-3 mb-3">
                            <div class="col-md-8">
                                <select class="form-select" id="table-selector" onchange="loadTableData()">
                                    <option value="">Select a table to view...</option>
                                    <option value="userwhitelist">üë• User Whitelist</option>
                                    <option value="usercredentials">üîê User Credentials</option>
                                    <option value="tradeconfiguration">üìà Trade Configurations</option>
                                    <option value="usertradingsession">‚ö° Trading Sessions</option>
                                    <option value="smcsignalcache">üìä SMC Signal Cache</option>
                                    <option value="klinescache">üíπ Klines Cache</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-outline-primary w-100" onclick="loadTableData()">
                                    <i class="bi bi-search me-2"></i>Load Data
                                </button>
                            </div>
                        </div>
                        <div id="table-data" class="border rounded bg-white">
                            <div class="text-center text-muted p-4">
                                <i class="bi bi-table fs-1 text-muted d-block mb-2"></i>
                                Select a table above to view its contents
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Management -->
        <div class="card section-spacing">
            <div class="card-header mobile-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-people me-2"></i>
                    User Whitelist Management
                </h5>
                <div class="mobile-btn-group">
                    <select class="form-select form-select-sm" id="status-filter" style="min-width: 120px;">
                        <option value="">All Status</option>
                        <option value="pending">‚è≥ Pending</option>
                        <option value="approved">‚úÖ Approved</option>
                        <option value="rejected">‚ùå Rejected</option>
                        <option value="banned">üö´ Banned</option>
                    </select>
                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshData()" title="Refresh Data">
                        <i class="bi bi-arrow-clockwise me-1"></i>
                        <span class="d-none d-sm-inline">Refresh</span>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="loading" class="text-center p-4 loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>User</th>
                                <th>Status</th>
                                <th>Requested</th>
                                <th>Last Access</th>
                                <th>Access Count</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Modal -->
    <div class="modal fade" id="actionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="actionModalTitle">Confirm Action</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="action-notes" class="form-label">Notes (optional):</label>
                        <textarea class="form-control" id="action-notes" rows="3" placeholder="Enter any notes about this action..."></textarea>
                    </div>
                    <p id="action-confirmation" class="mb-0"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn" id="confirm-action-btn">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let whitelistData = [];
        let currentAction = null;

        // Load initial data
        document.addEventListener('DOMContentLoaded', function() {
            loadWhitelistData();
            loadDatabaseStats();
            
            // Filter events
            document.getElementById('status-filter').addEventListener('change', filterUsers);
        });

        async function loadWhitelistData() {
            try {
                showLoading(true);
                
                // Load stats
                const statsResponse = await fetch('/api/admin/whitelist/stats');
                if (statsResponse.ok) {
                    const statsData = await statsResponse.json();
                    updateStats(statsData.stats);
                }

                // Load users
                const usersResponse = await fetch('/api/admin/whitelist/users');
                if (usersResponse.ok) {
                    const usersData = await usersResponse.json();
                    whitelistData = usersData.users;
                    filterUsers();
                }
            } catch (error) {
                console.error('Error loading whitelist data:', error);
                showError('Failed to load data: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function updateStats(stats) {
            document.getElementById('pending-count').textContent = stats.pending || 0;
            document.getElementById('approved-count').textContent = stats.approved || 0;
            document.getElementById('rejected-count').textContent = stats.rejected || 0;
            document.getElementById('banned-count').textContent = stats.banned || 0;
        }

        function filterUsers() {
            const filter = document.getElementById('status-filter').value;
            let filteredData = whitelistData;
            
            if (filter) {
                filteredData = whitelistData.filter(user => user.status === filter);
            }
            
            renderUsers(filteredData);
        }

        function renderUsers(users) {
            const tbody = document.getElementById('users-table');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">No users found</td></tr>';
                return;
            }

            const html = users.map(user => {
                const statusColor = getStatusColor(user.status);
                const displayName = getUserDisplayName(user);
                
                return `
                    <tr>
                        <td>
                            <div>
                                <strong>${displayName}</strong>
                                ${user.telegram_username ? `<br><small class="text-muted">@${user.telegram_username}</small>` : ''}
                                <br><small class="text-muted">ID: ${user.telegram_user_id}</small>
                            </div>
                        </td>
                        <td>
                            <span class="badge ${statusColor} status-badge">${user.status.toUpperCase()}</span>
                            ${user.review_notes ? `<br><small class="text-muted" title="${user.review_notes}">üìù ${user.review_notes.substring(0, 30)}${user.review_notes.length > 30 ? '...' : ''}</small>` : ''}
                        </td>
                        <td>
                            <small>${user.requested_at || '-'}</small>
                            ${user.reviewed_at ? `<br><small class="text-muted">Reviewed: ${user.reviewed_at}</small>` : ''}
                        </td>
                        <td><small>${user.last_access || 'Never'}</small></td>
                        <td><span class="badge bg-info">${user.access_count}</span></td>
                        <td>
                            <div class="btn-group-vertical btn-group-sm">
                                ${user.status !== 'approved' ? `<button class="btn btn-success btn-sm" onclick="showActionModal('approve', '${user.telegram_user_id}', '${displayName}')">
                                    <i class="bi bi-check"></i> Approve
                                </button>` : ''}
                                ${user.status !== 'rejected' ? `<button class="btn btn-danger btn-sm" onclick="showActionModal('reject', '${user.telegram_user_id}', '${displayName}')">
                                    <i class="bi bi-x"></i> Reject
                                </button>` : ''}
                                ${user.status !== 'banned' ? `<button class="btn btn-warning btn-sm" onclick="showActionModal('ban', '${user.telegram_user_id}', '${displayName}')">
                                    <i class="bi bi-ban"></i> Ban
                                </button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = html;
        }

        function getUserDisplayName(user) {
            if (user.first_name || user.last_name) {
                return `${user.first_name || ''} ${user.last_name || ''}`.trim();
            }
            return user.telegram_username || `User ${user.telegram_user_id}`;
        }

        function getStatusColor(status) {
            switch (status) {
                case 'pending': return 'bg-warning text-dark';
                case 'approved': return 'bg-success';
                case 'rejected': return 'bg-danger';
                case 'banned': return 'bg-dark';
                default: return 'bg-secondary';
            }
        }

        function showActionModal(action, userId, userName) {
            currentAction = { action, userId, userName };
            
            const modal = new bootstrap.Modal(document.getElementById('actionModal'));
            const title = document.getElementById('actionModalTitle');
            const confirmation = document.getElementById('action-confirmation');
            const confirmBtn = document.getElementById('confirm-action-btn');
            
            title.textContent = `${action.charAt(0).toUpperCase() + action.slice(1)} User`;
            confirmation.textContent = `Are you sure you want to ${action} ${userName}?`;
            
            // Style confirm button based on action
            confirmBtn.className = 'btn ';
            switch (action) {
                case 'approve':
                    confirmBtn.className += 'btn-success';
                    break;
                case 'reject':
                    confirmBtn.className += 'btn-danger';
                    break;
                case 'ban':
                    confirmBtn.className += 'btn-warning';
                    break;
            }
            
            confirmBtn.onclick = executeAction;
            
            // Clear notes
            document.getElementById('action-notes').value = '';
            
            modal.show();
        }

        async function executeAction() {
            if (!currentAction) return;
            
            const notes = document.getElementById('action-notes').value.trim();
            
            try {
                const response = await fetch(`/api/admin/whitelist/${currentAction.action}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentAction.userId,
                        notes: notes
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showSuccess(`User ${currentAction.userName} ${currentAction.action}ed successfully`);
                    loadWhitelistData(); // Reload data
                    bootstrap.Modal.getInstance(document.getElementById('actionModal')).hide();
                } else {
                    showError(result.error || 'Action failed');
                }
            } catch (error) {
                console.error('Error executing action:', error);
                showError('Action failed: ' + error.message);
            }
        }

        function refreshData() {
            loadWhitelistData();
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showSuccess(message) {
            // Create a dismissible success alert at the top of the page
            const alertContainer = document.querySelector('.container-fluid');
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                <i class="bi bi-check-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.insertBefore(alertDiv, alertContainer.firstChild);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function showError(message) {
            // Create a dismissible error alert at the top of the page
            const alertContainer = document.querySelector('.container-fluid');
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                <i class="bi bi-exclamation-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.insertBefore(alertDiv, alertContainer.firstChild);
            
            // Auto-dismiss after 7 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 7000);
        }

        // DATABASE MANAGEMENT FUNCTIONS
        async function loadDatabaseStats() {
            try {
                const response = await fetch('/api/admin/database/stats');
                if (response.ok) {
                    const data = await response.json();
                    updateDatabaseStats(data.stats);
                    updateSystemStatus(data.stats);
                }
            } catch (error) {
                console.error('Error loading database stats:', error);
                showError('Failed to load database stats: ' + error.message);
            }
        }

        function updateDatabaseStats(stats) {
            const tablesDiv = document.getElementById('database-tables');
            
            if (!stats.tables) {
                tablesDiv.innerHTML = '<div class="text-danger p-3">Failed to load table stats</div>';
                return;
            }

            let html = '<table class="table table-sm"><thead><tr><th>Table</th><th>Records</th><th>Status</th></tr></thead><tbody>';
            
            Object.entries(stats.tables).forEach(([tableName, info]) => {
                const statusColor = info.status === 'healthy' ? 'text-success' : 'text-danger';
                html += `
                    <tr>
                        <td><strong>${tableName}</strong></td>
                        <td><span class="badge bg-primary">${info.count}</span></td>
                        <td><span class="${statusColor}">${info.status}</span></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            tablesDiv.innerHTML = html;
        }

        function updateSystemStatus(stats) {
            const statusDiv = document.getElementById('system-status');
            
            let html = '<div class="row g-2">';
            
            // Database status
            const dbColor = stats.database_status === 'healthy' ? 'success' : 'danger';
            html += `
                <div class="col-12">
                    <div class="alert alert-${dbColor} py-2 mb-1">
                        <i class="bi bi-database"></i> Database: ${stats.database_status}
                    </div>
                </div>
            `;
            
            // Cache status
            if (stats.cache) {
                const cacheColor = stats.cache.enabled ? 'info' : 'warning';
                html += `
                    <div class="col-12">
                        <div class="alert alert-${cacheColor} py-2 mb-1">
                            <i class="bi bi-cpu"></i> Cache: ${stats.cache.cache_size} items
                            ${stats.cache.enabled ? '(Worker enabled)' : '(Worker disabled)'}
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            statusDiv.innerHTML = html;
        }

        async function loadTableData() {
            const tableName = document.getElementById('table-selector').value;
            const tableDataDiv = document.getElementById('table-data');
            
            if (!tableName) {
                tableDataDiv.innerHTML = '<div class="text-center text-muted p-4">Select a table above to view its contents</div>';
                return;
            }
            
            try {
                tableDataDiv.innerHTML = '<div class="text-center p-4"><div class="spinner-border spinner-border-sm"></div> Loading table data...</div>';
                
                const response = await fetch(`/api/admin/database/table/${tableName}?limit=20`);
                if (response.ok) {
                    const data = await response.json();
                    renderTableData(data.data);
                } else {
                    const error = await response.json();
                    tableDataDiv.innerHTML = `<div class="text-danger p-4">Error: ${error.error}</div>`;
                }
            } catch (error) {
                console.error('Error loading table data:', error);
                tableDataDiv.innerHTML = `<div class="text-danger p-4">Error loading table data: ${error.message}</div>`;
            }
        }

        function renderTableData(data) {
            const tableDataDiv = document.getElementById('table-data');
            
            if (!data.records || data.records.length === 0) {
                tableDataDiv.innerHTML = '<div class="text-center text-muted p-4">No records found in this table</div>';
                return;
            }
            
            let html = `
                <div class="p-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">
                            <i class="bi bi-table"></i> ${data.table_name} 
                            <span class="badge bg-secondary">${data.total_count} total records</span>
                        </h6>
                        <small class="text-muted">Showing ${data.records.length} of ${data.total_count}</small>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead class="table-light">
                                <tr>
            `;
            
            // Add column headers
            data.columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // Add data rows
            data.records.forEach(record => {
                html += '<tr>';
                data.columns.forEach(col => {
                    let value = record[col] || '';
                    // Truncate long values
                    if (value.length > 50) {
                        value = value.substring(0, 50) + '...';
                    }
                    html += `<td><small>${value}</small></td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div></div>';
            tableDataDiv.innerHTML = html;
        }

        async function clearCache(cacheType = 'all') {
            if (!confirm(`Are you sure you want to clear ${cacheType} cache? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/database/cache/clear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        cache_type: cacheType
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showSuccess(`Cache cleared: ${result.cleared_caches.join(', ')}`);
                    loadDatabaseStats(); // Refresh stats
                } else {
                    showError(result.error || 'Failed to clear cache');
                }
            } catch (error) {
                console.error('Error clearing cache:', error);
                showError('Failed to clear cache: ' + error.message);
            }
        }

        async function clearSMCSignals() {
            if (!confirm('Are you sure you want to clear all SMC signals from the database?\n\nThis will remove all cached SMC analysis data but will not affect other data.\n\nThis action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/database/smc/clear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showSuccess(`SMC Signals cleared successfully!\n\nRemoved ${result.cleared_count} signals\nCleaned up expired entries: ${result.expired_count}`);
                    loadDatabaseStats(); // Refresh stats
                } else {
                    showError(result.error || 'Failed to clear SMC signals');
                }
            } catch (error) {
                console.error('Error clearing SMC signals:', error);
                showError('Failed to clear SMC signals: ' + error.message);
            }
        }

        async function restartCacheWorker() {
            if (!confirm('Are you sure you want to restart the cache cleanup worker?\n\nThis will restart the background worker responsible for cleaning up expired cache entries.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/database/cache/restart-worker', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showSuccess('Cache cleanup worker restarted successfully!\n\nThe worker should now be active and running.');
                    loadDatabaseStats(); // Refresh stats to show updated worker status
                } else {
                    showError(result.error || 'Failed to restart cache cleanup worker');
                }
            } catch (error) {
                console.error('Error restarting cache worker:', error);
                showError('Failed to restart cache cleanup worker: ' + error.message);
            }
        }

        async function migrateDatabase() {
            if (!confirm('‚ö†Ô∏è WARNING: This will drop and recreate all database tables!\n\nThis will DELETE ALL DATA in the database.\n\nOnly proceed if this is a development environment.\n\nAre you absolutely sure?')) {
                return;
            }
            
            if (!confirm('‚ö†Ô∏è FINAL WARNING: This action is IRREVERSIBLE!\n\nAll data will be permanently lost.\n\nClick OK only if you understand the consequences.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/database/migrate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showSuccess(`Database migrated successfully!\n\nTables created: ${result.tables_created.join(', ')}`);
                    loadDatabaseStats(); // Refresh stats
                } else {
                    showError(`Migration failed: ${result.error}\n\nResults: ${result.results ? result.results.join('\n') : 'No details available'}`);
                }
            } catch (error) {
                console.error('Error migrating database:', error);
                showError('Failed to migrate database: ' + error.message);
            }
        }

        async function backupDatabase() {
            if (!confirm('Create a development backup of important data?\n\nThis will export user credentials, whitelist, and trade configurations as JSON.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/database/backup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    let message = `Backup created successfully!\n\n`;
                    Object.entries(result.backup_summary).forEach(([table, count]) => {
                        message += `${table}: ${count} records\n`;
                    });
                    message += `\nNote: ${result.note}`;
                    showSuccess(message);
                } else {
                    showError('Backup failed: ' + result.error);
                }
            } catch (error) {
                console.error('Error creating backup:', error);
                showError('Failed to create backup: ' + error.message);
            }
        }
    </script>
</body>
</html>