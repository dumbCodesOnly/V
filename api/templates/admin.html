<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Trading Expert</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-size: 14px;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 1rem 1.5rem;
        }
        .card-header h5 {
            margin: 0;
            font-weight: 600;
        }
        .stats-card {
            transition: all 0.3s ease;
            height: 100%;
        }
        .stats-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }
        
        /* Mobile-first responsive design */
        @media (max-width: 768px) {
            .container-fluid {
                padding: 0.5rem;
            }
            .card {
                margin-bottom: 1rem;
            }
            .card-header {
                padding: 0.75rem 1rem;
            }
            .card-header h5 {
                font-size: 1rem;
            }
            .stats-card .card-body {
                padding: 1rem 0.5rem;
            }
            .stats-card .fs-1 {
                font-size: 2rem !important;
            }
            .stats-card h4 {
                font-size: 1.25rem;
            }
        }
        
        /* Button styles */
        .btn {
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
            min-height: 38px;
        }
        .btn-sm {
            min-height: 32px;
            font-size: 0.85rem;
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            border: none;
        }
        .btn-danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            border: none;
        }
        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
        }
        .btn-info {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            border: none;
        }
        
        /* Mobile-responsive button groups */
        .mobile-btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }
        @media (max-width: 768px) {
            .mobile-btn-group {
                flex-direction: column;
                align-items: stretch;
            }
            .mobile-btn-group .btn {
                width: 100%;
                justify-content: center;
            }
            .mobile-header {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 1rem;
            }
            .mobile-header > div {
                width: 100%;
            }
        }
        
        /* Table improvements */
        .table {
            border-radius: 10px;
            overflow: hidden;
            background: white;
        }
        .table-responsive {
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        /* Enhanced mobile table */
        @media (max-width: 768px) {
            .mobile-table-card {
                display: block;
                width: 100%;
                background: white;
                border-radius: 10px;
                padding: 1rem;
                margin-bottom: 1rem;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            .mobile-table-header {
                font-weight: 600;
                color: #333;
                margin-bottom: 0.5rem;
            }
            .mobile-table-content {
                font-size: 0.9rem;
                color: #666;
            }
        }
        
        /* Status badges */
        .status-badge {
            font-size: 0.75rem;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-weight: 500;
        }
        
        /* Loading states */
        .loading {
            display: none;
        }
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
        
        /* Modal enhancements */
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0;
        }
        .modal-content {
            border-radius: 15px;
            border: none;
            overflow: hidden;
        }
        
        /* Form enhancements */
        .form-select, .form-control {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            transition: all 0.2s ease;
        }
        .form-select:focus, .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        /* System status indicators */
        .system-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        .system-indicator.healthy {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
            border: 1px solid rgba(40, 167, 69, 0.3);
        }
        .system-indicator.warning {
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }
        .system-indicator.error {
            background: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.3);
        }
        
        /* Improved spacing and layout */
        .section-spacing {
            margin-bottom: 2rem;
        }
        @media (max-width: 768px) {
            .section-spacing {
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-shield-check"></i>
                Trading Expert Admin
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/admin/logout">
                    <i class="bi bi-box-arrow-right"></i>
                    Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Statistics Cards -->
        <div class="row section-spacing g-3">
            <div class="col-6 col-lg-3">
                <div class="card stats-card text-center h-100">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <i class="bi bi-clock-history text-warning fs-1"></i>
                        <h4 class="mt-2 mb-1" id="pending-count">-</h4>
                        <p class="text-muted mb-0 small">Pending</p>
                    </div>
                </div>
            </div>
            <div class="col-6 col-lg-3">
                <div class="card stats-card text-center h-100">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <i class="bi bi-check-circle text-success fs-1"></i>
                        <h4 class="mt-2 mb-1" id="approved-count">-</h4>
                        <p class="text-muted mb-0 small">Approved</p>
                    </div>
                </div>
            </div>
            <div class="col-6 col-lg-3">
                <div class="card stats-card text-center h-100">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <i class="bi bi-x-circle text-danger fs-1"></i>
                        <h4 class="mt-2 mb-1" id="rejected-count">-</h4>
                        <p class="text-muted mb-0 small">Rejected</p>
                    </div>
                </div>
            </div>
            <div class="col-6 col-lg-3">
                <div class="card stats-card text-center h-100">
                    <div class="card-body d-flex flex-column justify-content-center">
                        <i class="bi bi-ban text-dark fs-1"></i>
                        <h4 class="mt-2 mb-1" id="banned-count">-</h4>
                        <p class="text-muted mb-0 small">Banned</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Database Management -->
        <div class="card section-spacing">
            <div class="card-header mobile-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-database me-2"></i>
                    Database Management
                </h5>
                <div class="mobile-btn-group">
                    <button class="btn btn-sm btn-info" onclick="loadDatabaseStats()" title="Refresh Stats">
                        <i class="bi bi-arrow-clockwise me-1"></i>
                        <span class="d-none d-sm-inline">Refresh</span>
                    </button>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-warning dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-trash me-1"></i>
                            <span class="d-none d-sm-inline">Cache Actions</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="restartCacheWorker()">
                                <i class="bi bi-arrow-clockwise me-2"></i>Restart Cache Worker
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="clearCache('all')">
                                <i class="bi bi-trash me-2"></i>Clear All Cache
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="clearSMCSignals()">
                                <i class="bi bi-graph-down me-2"></i>Clear SMC Signals
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="clearKlinesCache()">
                                <i class="bi bi-bar-chart me-2"></i>Clear Klines Cache
                            </a></li>
                        </ul>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-success dropdown-toggle" type="button" data-bs-toggle="dropdown" id="dataSyncDropdown">
                            <i class="bi bi-arrow-repeat me-1"></i>
                            <span class="d-none d-sm-inline">Data Sync</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="checkDataSyncStatus()">
                                <i class="bi bi-info-circle me-2"></i>Check Status
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="stopDataSync()">
                                <i class="bi bi-stop-circle me-2"></i>Stop Service
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="startDataSync()">
                                <i class="bi bi-play-circle me-2"></i>Start Service
                            </a></li>
                        </ul>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-danger dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-tools me-1"></i>
                            <span class="d-none d-sm-inline">Database Tools</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="migrateDatabase()">
                                <i class="bi bi-database-gear me-2"></i>Migrate Schema
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="backupDatabase()">
                                <i class="bi bi-download me-2"></i>Backup Data
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Database Stats Row -->
                <div class="row g-3 mb-4">
                    <div class="col-lg-6">
                        <div class="card h-100 border-0 bg-light">
                            <div class="card-body">
                                <h6 class="card-title mb-3">
                                    <i class="bi bi-table text-primary me-2"></i>Database Tables
                                </h6>
                                <div id="database-tables" class="table-responsive">
                                    <div class="text-center p-3">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                        <span class="ms-2">Loading database stats...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card h-100 border-0 bg-light">
                            <div class="card-body">
                                <h6 class="card-title mb-3">
                                    <i class="bi bi-cpu text-success me-2"></i>System Status
                                </h6>
                                <div id="system-status">
                                    <div class="text-center p-3">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                        <span class="ms-2">Loading system status...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Table Viewer -->
                <div class="card border-0 bg-light">
                    <div class="card-body">
                        <h6 class="card-title mb-3">
                            <i class="bi bi-eye text-info me-2"></i>Table Viewer
                        </h6>
                        <div class="row g-3 mb-3">
                            <div class="col-md-8">
                                <select class="form-select" id="table-selector" onchange="loadTableData()">
                                    <option value="">Select a table to view...</option>
                                    <option value="userwhitelist">👥 User Whitelist</option>
                                    <option value="usercredentials">🔐 User Credentials</option>
                                    <option value="tradeconfiguration">📈 Trade Configurations</option>
                                    <option value="usertradingsession">⚡ Trading Sessions</option>
                                    <option value="smcsignalcache">📊 SMC Signal Cache</option>
                                    <option value="klinescache">💹 Klines Cache</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-outline-primary w-100" onclick="loadTableData()">
                                    <i class="bi bi-search me-2"></i>Load Data
                                </button>
                            </div>
                        </div>
                        <div id="table-data" class="border rounded bg-white">
                            <div class="text-center text-muted p-4">
                                <i class="bi bi-table fs-1 text-muted d-block mb-2"></i>
                                Select a table above to view its contents
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Klines Debugging -->
        <div class="card section-spacing">
            <div class="card-header mobile-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-bar-chart me-2"></i>
                    Klines Debugging
                </h5>
                <div class="mobile-btn-group">
                    <button class="btn btn-sm btn-info" onclick="loadKlinesDebugData()" title="Refresh Klines Data">
                        <i class="bi bi-arrow-clockwise me-1"></i>
                        <span class="d-none d-sm-inline">Refresh</span>
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="showKlinesGaps()" title="Show Data Gaps">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        <span class="d-none d-sm-inline">View Gaps</span>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Summary Stats -->
                <div class="row g-3 mb-4">
                    <div class="col-lg-3 col-md-6">
                        <div class="card h-100 border-0 bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title mb-3">
                                    <i class="bi bi-database text-primary me-2"></i>Total Candles
                                </h6>
                                <h4 id="total-candles" class="text-primary">-</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="card h-100 border-0 bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title mb-3">
                                    <i class="bi bi-check-circle text-success me-2"></i>Complete
                                </h6>
                                <h4 id="complete-candles" class="text-success">-</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="card h-100 border-0 bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title mb-3">
                                    <i class="bi bi-clock text-warning me-2"></i>Incomplete
                                </h6>
                                <h4 id="incomplete-candles" class="text-warning">-</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="card h-100 border-0 bg-light">
                            <div class="card-body text-center">
                                <h6 class="card-title mb-3">
                                    <i class="bi bi-hourglass text-danger me-2"></i>Expiring Soon
                                </h6>
                                <h4 id="expiring-candles" class="text-danger">-</h4>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Symbol/Timeframe Analysis -->
                <div class="row g-3 mb-4">
                    <div class="col-lg-8">
                        <div class="card border-0 bg-light">
                            <div class="card-body">
                                <h6 class="card-title mb-3">
                                    <i class="bi bi-graph-up text-info me-2"></i>Symbol & Timeframe Analysis
                                </h6>
                                <div id="klines-symbol-stats">
                                    <div class="text-center p-3">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                        <span class="ms-2">Loading klines data...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card border-0 bg-light">
                            <div class="card-body">
                                <h6 class="card-title mb-3">
                                    <i class="bi bi-clock-history text-warning me-2"></i>Expiring Candles
                                </h6>
                                <div id="expiring-candles-list">
                                    <div class="text-center p-3">
                                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                        <span class="ms-2">Loading expiring data...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Gaps Section -->
                <div class="card border-0 bg-light" id="klines-gaps-section" style="display: none;">
                    <div class="card-body">
                        <h6 class="card-title mb-3">
                            <i class="bi bi-exclamation-triangle text-danger me-2"></i>Data Gaps Analysis
                        </h6>
                        <div id="klines-gaps-data">
                            <!-- Gaps will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SMC Analysis Diagnostic -->
        <div class="card section-spacing">
            <div class="card-header mobile-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up-arrow me-2"></i>
                    SMC Analysis Diagnostic
                </h5>
                <div class="mobile-btn-group">
                    <button class="btn btn-sm btn-info" onclick="showSMCConfig()" title="SMC Configuration">
                        <i class="bi bi-gear me-1"></i>
                        <span class="d-none d-sm-inline">Config</span>
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="clearSMCResults()" title="Clear Results">
                        <i class="bi bi-trash me-1"></i>
                        <span class="d-none d-sm-inline">Clear</span>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Analysis Control -->
                <div class="row g-3 mb-4">
                    <div class="col-md-8">
                        <label for="smc-symbol" class="form-label">Symbol to Analyze:</label>
                        <input type="text" class="form-control" id="smc-symbol" value="BTCUSDT" placeholder="Enter trading symbol (e.g., BTCUSDT)">
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button class="btn btn-primary w-100" id="start-smc-analysis" onclick="startSMCAnalysis()">
                            <i class="bi bi-play-circle me-2"></i>Start Analysis
                        </button>
                    </div>
                </div>

                <!-- Overall Progress -->
                <div class="card border-0 bg-light mb-4" id="smc-progress-card" style="display: none;">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">
                                <i class="bi bi-activity text-primary me-2"></i>Analysis Progress
                            </h6>
                            <span id="smc-progress-text" class="badge bg-primary">0/7 steps</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 id="smc-progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div id="smc-current-step" class="mt-2 small text-muted">Ready to start analysis...</div>
                    </div>
                </div>

                <!-- Analysis Steps -->
                <div id="smc-steps-container" style="display: none;">
                    <!-- Step 1: Data Acquisition -->
                    <div class="card border-0 bg-light mb-3 smc-step-card" id="smc-step-1">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-2">
                                <div class="step-icon me-3" id="step-1-icon">
                                    <div class="spinner-border spinner-border-sm d-none text-primary" role="status"></div>
                                    <i class="bi bi-circle text-muted step-waiting"></i>
                                    <i class="bi bi-check-circle text-success step-success d-none"></i>
                                    <i class="bi bi-x-circle text-danger step-error d-none"></i>
                                </div>
                                <h6 class="mb-0">Step 1: Data Acquisition</h6>
                                <span class="badge bg-secondary ms-auto step-status" id="step-1-status">Waiting</span>
                            </div>
                            <div id="step-1-details" class="step-details" style="display: none;">
                                <div class="row g-2 mt-2">
                                    <div class="col-4">
                                        <div class="text-center p-2 bg-white rounded">
                                            <small class="text-muted d-block">1H Candles</small>
                                            <strong id="step-1-h1-count">-</strong>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="text-center p-2 bg-white rounded">
                                            <small class="text-muted d-block">4H Candles</small>
                                            <strong id="step-1-h4-count">-</strong>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="text-center p-2 bg-white rounded">
                                            <small class="text-muted d-block">1D Candles</small>
                                            <strong id="step-1-d1-count">-</strong>
                                        </div>
                                    </div>
                                </div>
                                <div id="step-1-message" class="mt-2 small text-muted"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Market Structure -->
                    <div class="card border-0 bg-light mb-3 smc-step-card" id="smc-step-2">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-2">
                                <div class="step-icon me-3" id="step-2-icon">
                                    <div class="spinner-border spinner-border-sm d-none text-primary" role="status"></div>
                                    <i class="bi bi-circle text-muted step-waiting"></i>
                                    <i class="bi bi-check-circle text-success step-success d-none"></i>
                                    <i class="bi bi-x-circle text-danger step-error d-none"></i>
                                </div>
                                <h6 class="mb-0">Step 2: Market Structure Analysis</h6>
                                <span class="badge bg-secondary ms-auto step-status" id="step-2-status">Waiting</span>
                            </div>
                            <div id="step-2-details" class="step-details" style="display: none;">
                                <div class="row g-2 mt-2">
                                    <div class="col-4">
                                        <div class="text-center p-2 bg-white rounded">
                                            <small class="text-muted d-block">1H Structure</small>
                                            <strong id="step-2-h1-structure" class="text-truncate d-block">-</strong>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="text-center p-2 bg-white rounded">
                                            <small class="text-muted d-block">4H Structure</small>
                                            <strong id="step-2-h4-structure" class="text-truncate d-block">-</strong>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="text-center p-2 bg-white rounded">
                                            <small class="text-muted d-block">1D Structure</small>
                                            <strong id="step-2-d1-structure" class="text-truncate d-block">-</strong>
                                        </div>
                                    </div>
                                </div>
                                <div id="step-2-message" class="mt-2 small text-muted"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Order Blocks -->
                    <div class="card border-0 bg-light mb-3 smc-step-card" id="smc-step-3">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-2">
                                <div class="step-icon me-3" id="step-3-icon">
                                    <div class="spinner-border spinner-border-sm d-none text-primary" role="status"></div>
                                    <i class="bi bi-circle text-muted step-waiting"></i>
                                    <i class="bi bi-check-circle text-success step-success d-none"></i>
                                    <i class="bi bi-x-circle text-danger step-error d-none"></i>
                                </div>
                                <h6 class="mb-0">Step 3: Order Block Detection</h6>
                                <span class="badge bg-secondary ms-auto step-status" id="step-3-status">Waiting</span>
                            </div>
                            <div id="step-3-details" class="step-details" style="display: none;">
                                <div class="row g-2 mt-2">
                                    <div class="col-3">
                                        <div class="text-center p-2 bg-white rounded">
                                            <small class="text-muted d-block">Total</small>
                                            <strong id="step-3-total-blocks">-</strong>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="text-center p-2 bg-white rounded">
                                            <small class="text-muted d-block">Bullish</small>
                                            <strong id="step-3-bullish-blocks" class="text-success">-</strong>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="text-center p-2 bg-white rounded">
                                            <small class="text-muted d-block">Bearish</small>
                                            <strong id="step-3-bearish-blocks" class="text-danger">-</strong>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="text-center p-2 bg-white rounded">
                                            <small class="text-muted d-block">Validated</small>
                                            <strong id="step-3-validated-blocks" class="text-primary">-</strong>
                                        </div>
                                    </div>
                                </div>
                                <div id="step-3-message" class="mt-2 small text-muted"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Fair Value Gaps -->
                    <div class="card border-0 bg-light mb-3 smc-step-card" id="smc-step-4">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-2">
                                <div class="step-icon me-3" id="step-4-icon">
                                    <div class="spinner-border spinner-border-sm d-none text-primary" role="status"></div>
                                    <i class="bi bi-circle text-muted step-waiting"></i>
                                    <i class="bi bi-check-circle text-success step-success d-none"></i>
                                    <i class="bi bi-x-circle text-danger step-error d-none"></i>
                                </div>
                                <h6 class="mb-0">Step 4: Fair Value Gap Analysis</h6>
                                <span class="badge bg-secondary ms-auto step-status" id="step-4-status">Waiting</span>
                            </div>
                            <div id="step-4-details" class="step-details" style="display: none;">
                                <div class="row g-2 mt-2">
                                    <div class="col-3">
                                        <div class="text-center p-2 bg-white rounded">
                                            <small class="text-muted d-block">Total FVGs</small>
                                            <strong id="step-4-total-fvgs">-</strong>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="text-center p-2 bg-white rounded">
                                            <small class="text-muted d-block">Bullish</small>
                                            <strong id="step-4-bullish-fvgs" class="text-success">-</strong>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="text-center p-2 bg-white rounded">
                                            <small class="text-muted d-block">Bearish</small>
                                            <strong id="step-4-bearish-fvgs" class="text-danger">-</strong>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="text-center p-2 bg-white rounded">
                                            <small class="text-muted d-block">Unfilled</small>
                                            <strong id="step-4-unfilled-fvgs" class="text-warning">-</strong>
                                        </div>
                                    </div>
                                </div>
                                <div id="step-4-message" class="mt-2 small text-muted"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 5: Liquidity Pools -->
                    <div class="card border-0 bg-light mb-3 smc-step-card" id="smc-step-5">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-2">
                                <div class="step-icon me-3" id="step-5-icon">
                                    <div class="spinner-border spinner-border-sm d-none text-primary" role="status"></div>
                                    <i class="bi bi-circle text-muted step-waiting"></i>
                                    <i class="bi bi-check-circle text-success step-success d-none"></i>
                                    <i class="bi bi-x-circle text-danger step-error d-none"></i>
                                </div>
                                <h6 class="mb-0">Step 5: Liquidity Pool Analysis</h6>
                                <span class="badge bg-secondary ms-auto step-status" id="step-5-status">Waiting</span>
                            </div>
                            <div id="step-5-details" class="step-details" style="display: none;">
                                <div class="row g-2 mt-2">
                                    <div class="col-3">
                                        <div class="text-center p-2 bg-white rounded">
                                            <small class="text-muted d-block">Total Pools</small>
                                            <strong id="step-5-total-pools">-</strong>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="text-center p-2 bg-white rounded">
                                            <small class="text-muted d-block">Buy Side</small>
                                            <strong id="step-5-buy-pools" class="text-success">-</strong>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="text-center p-2 bg-white rounded">
                                            <small class="text-muted d-block">Sell Side</small>
                                            <strong id="step-5-sell-pools" class="text-danger">-</strong>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="text-center p-2 bg-white rounded">
                                            <small class="text-muted d-block">Swept</small>
                                            <strong id="step-5-swept-pools" class="text-warning">-</strong>
                                        </div>
                                    </div>
                                </div>
                                <div id="step-5-message" class="mt-2 small text-muted"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 6: Technical Indicators -->
                    <div class="card border-0 bg-light mb-3 smc-step-card" id="smc-step-6">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-2">
                                <div class="step-icon me-3" id="step-6-icon">
                                    <div class="spinner-border spinner-border-sm d-none text-primary" role="status"></div>
                                    <i class="bi bi-circle text-muted step-waiting"></i>
                                    <i class="bi bi-check-circle text-success step-success d-none"></i>
                                    <i class="bi bi-x-circle text-danger step-error d-none"></i>
                                </div>
                                <h6 class="mb-0">Step 6: Technical Indicators</h6>
                                <span class="badge bg-secondary ms-auto step-status" id="step-6-status">Waiting</span>
                            </div>
                            <div id="step-6-details" class="step-details" style="display: none;">
                                <div class="row g-2 mt-2">
                                    <div class="col-3">
                                        <div class="text-center p-2 bg-white rounded">
                                            <small class="text-muted d-block">Current Price</small>
                                            <strong id="step-6-current-price">-</strong>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="text-center p-2 bg-white rounded">
                                            <small class="text-muted d-block">RSI</small>
                                            <strong id="step-6-rsi">-</strong>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="text-center p-2 bg-white rounded">
                                            <small class="text-muted d-block">MA 20</small>
                                            <strong id="step-6-ma20">-</strong>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="text-center p-2 bg-white rounded">
                                            <small class="text-muted d-block">EMA 20</small>
                                            <strong id="step-6-ema20">-</strong>
                                        </div>
                                    </div>
                                </div>
                                <div id="step-6-message" class="mt-2 small text-muted"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 7: Signal Generation -->
                    <div class="card border-0 bg-light mb-3 smc-step-card" id="smc-step-7">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-2">
                                <div class="step-icon me-3" id="step-7-icon">
                                    <div class="spinner-border spinner-border-sm d-none text-primary" role="status"></div>
                                    <i class="bi bi-circle text-muted step-waiting"></i>
                                    <i class="bi bi-check-circle text-success step-success d-none"></i>
                                    <i class="bi bi-x-circle text-danger step-error d-none"></i>
                                </div>
                                <h6 class="mb-0">Step 7: Signal Generation</h6>
                                <span class="badge bg-secondary ms-auto step-status" id="step-7-status">Waiting</span>
                            </div>
                            <div id="step-7-details" class="step-details" style="display: none;">
                                <div id="step-7-signal" style="display: none;">
                                    <div class="alert alert-success" role="alert">
                                        <h6 class="alert-heading">
                                            <i class="bi bi-check-circle me-2"></i>Signal Generated!
                                        </h6>
                                        <div class="row g-2 mt-2">
                                            <div class="col-md-6">
                                                <strong>Direction:</strong> <span id="signal-direction" class="badge">-</span><br>
                                                <strong>Entry Price:</strong> <span id="signal-entry">-</span><br>
                                                <strong>Stop Loss:</strong> <span id="signal-sl">-</span><br>
                                            </div>
                                            <div class="col-md-6">
                                                <strong>Confidence:</strong> <span id="signal-confidence">-</span><br>
                                                <strong>Strength:</strong> <span id="signal-strength" class="badge">-</span><br>
                                                <strong>Risk/Reward:</strong> <span id="signal-rr">-</span><br>
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <strong>Take Profits:</strong> <span id="signal-tps">-</span>
                                        </div>
                                        <div class="mt-2">
                                            <small><strong>Reasoning:</strong></small>
                                            <ul id="signal-reasoning" class="mb-0 mt-1">
                                                <!-- Reasoning list will be populated here -->
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div id="step-7-no-signal" style="display: none;">
                                    <div class="alert alert-info" role="alert">
                                        <h6 class="alert-heading">
                                            <i class="bi bi-info-circle me-2"></i>No Signal Generated
                                        </h6>
                                        <p id="step-7-no-signal-reason" class="mb-0">Analysis completed but no valid signal conditions were met.</p>
                                    </div>
                                </div>
                                <div id="step-7-message" class="mt-2 small text-muted"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analysis Summary -->
                <div class="card border-0 bg-light" id="smc-summary-card" style="display: none;">
                    <div class="card-body">
                        <h6 class="card-title mb-3">
                            <i class="bi bi-clipboard-data text-info me-2"></i>Analysis Summary
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="card border-0 bg-white">
                                    <div class="card-body text-center">
                                        <h5 id="summary-success-rate" class="text-success mb-2">-</h5>
                                        <p class="small text-muted mb-0">Success Rate</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-0 bg-white">
                                    <div class="card-body text-center">
                                        <h5 id="summary-analysis-time" class="text-primary mb-2">-</h5>
                                        <p class="small text-muted mb-0">Analysis Time</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <strong>Symbol:</strong> <span id="summary-symbol">-</span> | 
                                <strong>Timestamp:</strong> <span id="summary-timestamp">-</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Management -->
        <div class="card section-spacing">
            <div class="card-header mobile-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-people me-2"></i>
                    User Whitelist Management
                </h5>
                <div class="mobile-btn-group">
                    <select class="form-select form-select-sm" id="status-filter" style="min-width: 120px;">
                        <option value="">All Status</option>
                        <option value="pending">⏳ Pending</option>
                        <option value="approved">✅ Approved</option>
                        <option value="rejected">❌ Rejected</option>
                        <option value="banned">🚫 Banned</option>
                    </select>
                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshData()" title="Refresh Data">
                        <i class="bi bi-arrow-clockwise me-1"></i>
                        <span class="d-none d-sm-inline">Refresh</span>
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div id="loading" class="text-center p-4 loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>User</th>
                                <th>Status</th>
                                <th>Requested</th>
                                <th>Last Access</th>
                                <th>Access Count</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Modal -->
    <div class="modal fade" id="actionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="actionModalTitle">Confirm Action</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="action-notes" class="form-label">Notes (optional):</label>
                        <textarea class="form-control" id="action-notes" rows="3" placeholder="Enter any notes about this action..."></textarea>
                    </div>
                    <p id="action-confirmation" class="mb-0"></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn" id="confirm-action-btn">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let whitelistData = [];
        let currentAction = null;

        // Load initial data
        document.addEventListener('DOMContentLoaded', function() {
            loadWhitelistData();
            loadDatabaseStats();
            loadKlinesDebugData();
            
            // Filter events
            document.getElementById('status-filter').addEventListener('change', filterUsers);
        });

        async function loadWhitelistData() {
            try {
                showLoading(true);
                
                // Load stats
                const statsResponse = await fetch('/api/admin/whitelist/stats');
                if (statsResponse.ok) {
                    const statsData = await statsResponse.json();
                    updateStats(statsData.stats);
                }

                // Load users
                const usersResponse = await fetch('/api/admin/whitelist/users');
                if (usersResponse.ok) {
                    const usersData = await usersResponse.json();
                    whitelistData = usersData.users;
                    filterUsers();
                }
            } catch (error) {
                console.error('Error loading whitelist data:', error);
                showError('Failed to load data: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function updateStats(stats) {
            document.getElementById('pending-count').textContent = stats.pending || 0;
            document.getElementById('approved-count').textContent = stats.approved || 0;
            document.getElementById('rejected-count').textContent = stats.rejected || 0;
            document.getElementById('banned-count').textContent = stats.banned || 0;
        }

        function filterUsers() {
            const filter = document.getElementById('status-filter').value;
            let filteredData = whitelistData;
            
            if (filter) {
                filteredData = whitelistData.filter(user => user.status === filter);
            }
            
            renderUsers(filteredData);
        }

        function renderUsers(users) {
            const tbody = document.getElementById('users-table');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">No users found</td></tr>';
                return;
            }

            const html = users.map(user => {
                const statusColor = getStatusColor(user.status);
                const displayName = getUserDisplayName(user);
                
                return `
                    <tr>
                        <td>
                            <div>
                                <strong>${displayName}</strong>
                                ${user.telegram_username ? `<br><small class="text-muted">@${user.telegram_username}</small>` : ''}
                                <br><small class="text-muted">ID: ${user.telegram_user_id}</small>
                            </div>
                        </td>
                        <td>
                            <span class="badge ${statusColor} status-badge">${user.status.toUpperCase()}</span>
                            ${user.review_notes ? `<br><small class="text-muted" title="${user.review_notes}">📝 ${user.review_notes.substring(0, 30)}${user.review_notes.length > 30 ? '...' : ''}</small>` : ''}
                        </td>
                        <td>
                            <small>${user.requested_at || '-'}</small>
                            ${user.reviewed_at ? `<br><small class="text-muted">Reviewed: ${user.reviewed_at}</small>` : ''}
                        </td>
                        <td><small>${user.last_access || 'Never'}</small></td>
                        <td><span class="badge bg-info">${user.access_count}</span></td>
                        <td>
                            <div class="btn-group-vertical btn-group-sm">
                                ${user.status !== 'approved' ? `<button class="btn btn-success btn-sm" onclick="showActionModal('approve', '${user.telegram_user_id}', '${displayName}')">
                                    <i class="bi bi-check"></i> Approve
                                </button>` : ''}
                                ${user.status !== 'rejected' ? `<button class="btn btn-danger btn-sm" onclick="showActionModal('reject', '${user.telegram_user_id}', '${displayName}')">
                                    <i class="bi bi-x"></i> Reject
                                </button>` : ''}
                                ${user.status !== 'banned' ? `<button class="btn btn-warning btn-sm" onclick="showActionModal('ban', '${user.telegram_user_id}', '${displayName}')">
                                    <i class="bi bi-ban"></i> Ban
                                </button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            tbody.innerHTML = html;
        }

        function getUserDisplayName(user) {
            if (user.first_name || user.last_name) {
                return `${user.first_name || ''} ${user.last_name || ''}`.trim();
            }
            return user.telegram_username || `User ${user.telegram_user_id}`;
        }

        function getStatusColor(status) {
            switch (status) {
                case 'pending': return 'bg-warning text-dark';
                case 'approved': return 'bg-success';
                case 'rejected': return 'bg-danger';
                case 'banned': return 'bg-dark';
                default: return 'bg-secondary';
            }
        }

        function showActionModal(action, userId, userName) {
            currentAction = { action, userId, userName };
            
            const modal = new bootstrap.Modal(document.getElementById('actionModal'));
            const title = document.getElementById('actionModalTitle');
            const confirmation = document.getElementById('action-confirmation');
            const confirmBtn = document.getElementById('confirm-action-btn');
            
            title.textContent = `${action.charAt(0).toUpperCase() + action.slice(1)} User`;
            confirmation.textContent = `Are you sure you want to ${action} ${userName}?`;
            
            // Style confirm button based on action
            confirmBtn.className = 'btn ';
            switch (action) {
                case 'approve':
                    confirmBtn.className += 'btn-success';
                    break;
                case 'reject':
                    confirmBtn.className += 'btn-danger';
                    break;
                case 'ban':
                    confirmBtn.className += 'btn-warning';
                    break;
            }
            
            confirmBtn.onclick = executeAction;
            
            // Clear notes
            document.getElementById('action-notes').value = '';
            
            modal.show();
        }

        async function executeAction() {
            if (!currentAction) return;
            
            const notes = document.getElementById('action-notes').value.trim();
            
            try {
                const response = await fetch(`/api/admin/whitelist/${currentAction.action}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: currentAction.userId,
                        notes: notes
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showSuccess(`User ${currentAction.userName} ${currentAction.action}ed successfully`);
                    loadWhitelistData(); // Reload data
                    bootstrap.Modal.getInstance(document.getElementById('actionModal')).hide();
                } else {
                    showError(result.error || 'Action failed');
                }
            } catch (error) {
                console.error('Error executing action:', error);
                showError('Action failed: ' + error.message);
            }
        }

        function refreshData() {
            loadWhitelistData();
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showSuccess(message) {
            // Create a dismissible success alert at the top of the page
            const alertContainer = document.querySelector('.container-fluid');
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                <i class="bi bi-check-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.insertBefore(alertDiv, alertContainer.firstChild);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function showError(message) {
            // Create a dismissible error alert at the top of the page
            const alertContainer = document.querySelector('.container-fluid');
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                <i class="bi bi-exclamation-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.insertBefore(alertDiv, alertContainer.firstChild);
            
            // Auto-dismiss after 7 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 7000);
        }

        // DATABASE MANAGEMENT FUNCTIONS
        async function loadDatabaseStats() {
            try {
                const response = await fetch('/api/admin/database/stats');
                if (response.ok) {
                    const data = await response.json();
                    updateDatabaseStats(data.stats);
                    updateSystemStatus(data.stats);
                }
            } catch (error) {
                console.error('Error loading database stats:', error);
                showError('Failed to load database stats: ' + error.message);
            }
        }

        function updateDatabaseStats(stats) {
            const tablesDiv = document.getElementById('database-tables');
            
            if (!stats.tables) {
                tablesDiv.innerHTML = '<div class="text-danger p-3">Failed to load table stats</div>';
                return;
            }

            let html = '<table class="table table-sm"><thead><tr><th>Table</th><th>Records</th><th>Status</th></tr></thead><tbody>';
            
            Object.entries(stats.tables).forEach(([tableName, info]) => {
                const statusColor = info.status === 'healthy' ? 'text-success' : 'text-danger';
                html += `
                    <tr>
                        <td><strong>${tableName}</strong></td>
                        <td><span class="badge bg-primary">${info.count}</span></td>
                        <td><span class="${statusColor}">${info.status}</span></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            tablesDiv.innerHTML = html;
        }

        function updateSystemStatus(stats) {
            const statusDiv = document.getElementById('system-status');
            
            let html = '<div class="row g-2">';
            
            // Database status
            const dbColor = stats.database_status === 'healthy' ? 'success' : 'danger';
            html += `
                <div class="col-12">
                    <div class="alert alert-${dbColor} py-2 mb-1">
                        <i class="bi bi-database"></i> Database: ${stats.database_status}
                    </div>
                </div>
            `;
            
            // Cache status
            if (stats.cache) {
                const cacheColor = stats.cache.enabled ? 'info' : 'warning';
                html += `
                    <div class="col-12">
                        <div class="alert alert-${cacheColor} py-2 mb-1">
                            <i class="bi bi-cpu"></i> Cache: ${stats.cache.cache_size} items
                            ${stats.cache.enabled ? '(Worker enabled)' : '(Worker disabled)'}
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            statusDiv.innerHTML = html;
        }

        async function loadTableData() {
            const tableName = document.getElementById('table-selector').value;
            const tableDataDiv = document.getElementById('table-data');
            
            if (!tableName) {
                tableDataDiv.innerHTML = '<div class="text-center text-muted p-4">Select a table above to view its contents</div>';
                return;
            }
            
            try {
                tableDataDiv.innerHTML = '<div class="text-center p-4"><div class="spinner-border spinner-border-sm"></div> Loading table data...</div>';
                
                const response = await fetch(`/api/admin/database/table/${tableName}?limit=20`);
                if (response.ok) {
                    const data = await response.json();
                    renderTableData(data.data);
                } else {
                    const error = await response.json();
                    tableDataDiv.innerHTML = `<div class="text-danger p-4">Error: ${error.error}</div>`;
                }
            } catch (error) {
                console.error('Error loading table data:', error);
                tableDataDiv.innerHTML = `<div class="text-danger p-4">Error loading table data: ${error.message}</div>`;
            }
        }

        function renderTableData(data) {
            const tableDataDiv = document.getElementById('table-data');
            
            if (!data.records || data.records.length === 0) {
                tableDataDiv.innerHTML = '<div class="text-center text-muted p-4">No records found in this table</div>';
                return;
            }
            
            let html = `
                <div class="p-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">
                            <i class="bi bi-table"></i> ${data.table_name} 
                            <span class="badge bg-secondary">${data.total_count} total records</span>
                        </h6>
                        <small class="text-muted">Showing ${data.records.length} of ${data.total_count}</small>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead class="table-light">
                                <tr>
            `;
            
            // Add column headers
            data.columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // Add data rows
            data.records.forEach(record => {
                html += '<tr>';
                data.columns.forEach(col => {
                    let value = record[col] || '';
                    // Truncate long values
                    if (value.length > 50) {
                        value = value.substring(0, 50) + '...';
                    }
                    html += `<td><small>${value}</small></td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div></div>';
            tableDataDiv.innerHTML = html;
        }

        async function clearCache(cacheType = 'all') {
            if (!confirm(`Are you sure you want to clear ${cacheType} cache? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/database/cache/clear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        cache_type: cacheType
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showSuccess(`Cache cleared: ${result.cleared_caches.join(', ')}`);
                    loadDatabaseStats(); // Refresh stats
                } else {
                    showError(result.error || 'Failed to clear cache');
                }
            } catch (error) {
                console.error('Error clearing cache:', error);
                showError('Failed to clear cache: ' + error.message);
            }
        }

        async function clearSMCSignals() {
            if (!confirm('Are you sure you want to clear all SMC signals from the database?\n\nThis will remove all cached SMC analysis data but will not affect other data.\n\nThis action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/database/smc/clear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showSuccess(`SMC Signals cleared successfully!\n\nRemoved ${result.cleared_count} signals\nCleaned up expired entries: ${result.expired_count}`);
                    loadDatabaseStats(); // Refresh stats
                } else {
                    showError(result.error || 'Failed to clear SMC signals');
                }
            } catch (error) {
                console.error('Error clearing SMC signals:', error);
                showError('Failed to clear SMC signals: ' + error.message);
            }
        }

        async function clearKlinesCache() {
            if (!confirm('Are you sure you want to clear all klines cache data from the database?\n\nThis will remove all cached candlestick/price history data but will not affect other data.\n\nThis action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/database/klines/clear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showSuccess(`Klines cache cleared successfully!\n\nRemoved ${result.cleared_count} klines entries\nExpired entries: ${result.expired_count}\nRemaining entries: ${result.remaining_count}`);
                    loadDatabaseStats(); // Refresh stats
                } else {
                    showError(result.error || 'Failed to clear klines cache');
                }
            } catch (error) {
                console.error('Error clearing klines cache:', error);
                showError('Failed to clear klines cache: ' + error.message);
            }
        }

        async function restartCacheWorker() {
            if (!confirm('Are you sure you want to restart the cache cleanup worker?\n\nThis will restart the background worker responsible for cleaning up expired cache entries.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/database/cache/restart-worker', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showSuccess('Cache cleanup worker restarted successfully!\n\nThe worker should now be active and running.');
                    loadDatabaseStats(); // Refresh stats to show updated worker status
                } else {
                    showError(result.error || 'Failed to restart cache cleanup worker');
                }
            } catch (error) {
                console.error('Error restarting cache worker:', error);
                showError('Failed to restart cache cleanup worker: ' + error.message);
            }
        }

        async function checkDataSyncStatus() {
            try {
                const response = await fetch('/api/admin/datasync/status');
                const result = await response.json();
                
                if (response.ok && result.success) {
                    const status = result.status;
                    const isRunning = status.service_running;
                    const statusText = isRunning ? 'RUNNING' : 'STOPPED';
                    const icon = isRunning ? '🟢' : '🔴';
                    
                    showSuccess(`${icon} Data Sync Service Status: ${statusText}\n\nLast Cache Cleanup: ${status.last_cache_cleanup || 'Never'}\n\nThis service fetches market data from exchanges to prevent rate limiting.`);
                    
                    // Update dropdown button color based on status
                    const dropdown = document.getElementById('dataSyncDropdown');
                    if (isRunning) {
                        dropdown.className = dropdown.className.replace('btn-danger', '').replace('btn-warning', '') + ' btn-success';
                    } else {
                        dropdown.className = dropdown.className.replace('btn-success', '').replace('btn-warning', '') + ' btn-danger';
                    }
                } else {
                    showError(result.error || 'Failed to get data sync status');
                }
            } catch (error) {
                console.error('Error checking data sync status:', error);
                showError('Failed to check data sync status: ' + error.message);
            }
        }

        async function stopDataSync() {
            if (!confirm('⚠️ STOP Data Sync Service?\n\nThis will stop the background service that fetches market data from exchanges (Binance, etc.).\n\nStopping this service will help prevent rate limiting issues but will disable real-time market data updates.\n\nAre you sure you want to proceed?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/datasync/stop', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showSuccess('🔴 Data Sync Service STOPPED!\n\nThe service has been stopped to prevent rate limiting.\n\nMarket data updates are now disabled.');
                    
                    // Update dropdown button to red
                    const dropdown = document.getElementById('dataSyncDropdown');
                    dropdown.className = dropdown.className.replace('btn-success', '').replace('btn-warning', '') + ' btn-danger';
                    
                    loadDatabaseStats(); // Refresh stats
                } else {
                    showError(result.error || 'Failed to stop data sync service');
                }
            } catch (error) {
                console.error('Error stopping data sync service:', error);
                showError('Failed to stop data sync service: ' + error.message);
            }
        }

        async function startDataSync() {
            if (!confirm('▶️ START Data Sync Service?\n\nThis will start the background service that fetches market data from exchanges.\n\n⚠️ WARNING: Starting this service may trigger rate limiting if the exchanges are being called too frequently.\n\nAre you sure you want to proceed?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/datasync/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showSuccess('🟢 Data Sync Service STARTED!\n\nThe service is now running and will fetch market data from exchanges.\n\nReal-time market data updates are now enabled.');
                    
                    // Update dropdown button to green
                    const dropdown = document.getElementById('dataSyncDropdown');
                    dropdown.className = dropdown.className.replace('btn-danger', '').replace('btn-warning', '') + ' btn-success';
                    
                    loadDatabaseStats(); // Refresh stats
                } else {
                    showError(result.error || 'Failed to start data sync service');
                }
            } catch (error) {
                console.error('Error starting data sync service:', error);
                showError('Failed to start data sync service: ' + error.message);
            }
        }

        async function migrateDatabase() {
            if (!confirm('⚠️ WARNING: This will drop and recreate all database tables!\n\nThis will DELETE ALL DATA in the database.\n\nOnly proceed if this is a development environment.\n\nAre you absolutely sure?')) {
                return;
            }
            
            if (!confirm('⚠️ FINAL WARNING: This action is IRREVERSIBLE!\n\nAll data will be permanently lost.\n\nClick OK only if you understand the consequences.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/database/migrate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showSuccess(`Database migrated successfully!\n\nTables created: ${result.tables_created.join(', ')}`);
                    loadDatabaseStats(); // Refresh stats
                } else {
                    showError(`Migration failed: ${result.error}\n\nResults: ${result.results ? result.results.join('\n') : 'No details available'}`);
                }
            } catch (error) {
                console.error('Error migrating database:', error);
                showError('Failed to migrate database: ' + error.message);
            }
        }

        async function backupDatabase() {
            if (!confirm('Create a development backup of important data?\n\nThis will export user credentials, whitelist, and trade configurations as JSON.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/database/backup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    let message = `Backup created successfully!\n\n`;
                    Object.entries(result.backup_summary).forEach(([table, count]) => {
                        message += `${table}: ${count} records\n`;
                    });
                    message += `\nNote: ${result.note}`;
                    showSuccess(message);
                } else {
                    showError('Backup failed: ' + result.error);
                }
            } catch (error) {
                console.error('Error creating backup:', error);
                showError('Failed to create backup: ' + error.message);
            }
        }

        // KLINES DEBUGGING FUNCTIONS
        let klinesDebugData = null;

        async function loadKlinesDebugData() {
            try {
                const response = await fetch('/api/admin/klines-debug');
                if (response.ok) {
                    klinesDebugData = await response.json();
                    updateKlinesSummary(klinesDebugData.summary);
                    updateSymbolStats(klinesDebugData.symbol_statistics);
                    updateExpiringCandles(klinesDebugData.expiring_candles);
                } else {
                    const error = await response.json();
                    showError('Failed to load klines debug data: ' + error.error);
                }
            } catch (error) {
                console.error('Error loading klines debug data:', error);
                showError('Failed to load klines debug data: ' + error.message);
            }
        }

        function updateKlinesSummary(summary) {
            document.getElementById('total-candles').textContent = summary.total_candles.toLocaleString();
            document.getElementById('complete-candles').textContent = summary.total_complete.toLocaleString();
            document.getElementById('incomplete-candles').textContent = summary.total_incomplete.toLocaleString();
            
            // Calculate expiring candles from the summary (this will be updated by the expiring candles list)
            const expiringCount = klinesDebugData ? klinesDebugData.expiring_candles.length : 0;
            document.getElementById('expiring-candles').textContent = expiringCount;
        }

        function updateSymbolStats(symbolStats) {
            const symbolStatsDiv = document.getElementById('klines-symbol-stats');
            
            if (!symbolStats || symbolStats.length === 0) {
                symbolStatsDiv.innerHTML = '<div class="text-center text-muted p-3">No klines data found</div>';
                return;
            }

            let html = '<div class="table-responsive"><table class="table table-sm table-striped">';
            html += `
                <thead class="table-light">
                    <tr>
                        <th>Symbol</th>
                        <th>Timeframe</th>
                        <th>Total</th>
                        <th>Complete</th>
                        <th>Incomplete</th>
                        <th>Gaps</th>
                        <th>Status</th>
                        <th>Config</th>
                    </tr>
                </thead>
                <tbody>
            `;

            symbolStats.forEach(stat => {
                const statusClass = getCleanupStatusClass(stat.cleanup_status);
                const gapsText = stat.gap_count > 0 ? `${stat.gap_count} gaps` : 'No gaps';
                const gapsClass = stat.gap_count > 0 ? 'text-danger' : 'text-success';
                
                html += `
                    <tr>
                        <td><strong>${stat.symbol}</strong></td>
                        <td><span class="badge bg-secondary">${stat.timeframe}</span></td>
                        <td>${stat.total_candles.toLocaleString()}</td>
                        <td class="text-success">${stat.complete_candles.toLocaleString()}</td>
                        <td class="text-warning">${stat.incomplete_candles.toLocaleString()}</td>
                        <td class="${gapsClass}"><small>${gapsText}</small></td>
                        <td><span class="badge ${statusClass}">${stat.cleanup_status.replace('_', ' ')}</span></td>
                        <td><small>Target: ${stat.config.target_candles}</small></td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            symbolStatsDiv.innerHTML = html;
        }

        function updateExpiringCandles(expiringCandles) {
            const expiringDiv = document.getElementById('expiring-candles-list');
            
            if (!expiringCandles || expiringCandles.length === 0) {
                expiringDiv.innerHTML = '<div class="text-center text-muted p-3">No candles expiring soon</div>';
                return;
            }

            let html = '<div class="list-group list-group-flush">';
            
            expiringCandles.slice(0, 10).forEach(candle => { // Show only first 10
                const urgencyClass = candle.hours_until_expiry < 1 ? 'text-danger' : 
                                   candle.hours_until_expiry < 6 ? 'text-warning' : 'text-muted';
                const typeText = candle.is_complete ? 'Complete' : 'Incomplete';
                const typeClass = candle.is_complete ? 'bg-success' : 'bg-warning';
                
                html += `
                    <div class="list-group-item list-group-item-action py-2">
                        <div class="d-flex w-100 justify-content-between align-items-center">
                            <div>
                                <strong>${candle.symbol}</strong>
                                <span class="badge bg-secondary ms-1">${candle.timeframe}</span>
                                <span class="badge ${typeClass} ms-1">${typeText}</span>
                            </div>
                            <small class="${urgencyClass}">
                                ${Math.abs(candle.hours_until_expiry).toFixed(1)}h
                            </small>
                        </div>
                        <small class="text-muted">
                            ${new Date(candle.timestamp).toLocaleString()}
                        </small>
                    </div>
                `;
            });
            
            if (expiringCandles.length > 10) {
                html += `
                    <div class="list-group-item text-center text-muted">
                        <small>... and ${expiringCandles.length - 10} more</small>
                    </div>
                `;
            }
            
            html += '</div>';
            expiringDiv.innerHTML = html;
        }

        function getCleanupStatusClass(status) {
            switch(status) {
                case 'no_cleanup_needed': return 'bg-success';
                case 'cleanup_eligible': return 'bg-warning';
                case 'cleanup_recommended': return 'bg-danger';
                default: return 'bg-secondary';
            }
        }

        function showKlinesGaps() {
            const gapsSection = document.getElementById('klines-gaps-section');
            const gapsData = document.getElementById('klines-gaps-data');
            
            if (!klinesDebugData || !klinesDebugData.symbol_statistics) {
                showError('No klines data loaded. Please refresh first.');
                return;
            }

            // Filter symbols with gaps
            const symbolsWithGaps = klinesDebugData.symbol_statistics.filter(stat => stat.gap_count > 0);
            
            if (symbolsWithGaps.length === 0) {
                gapsData.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle me-2"></i>No data gaps detected in recent klines data!</div>';
            } else {
                let html = '<div class="alert alert-warning mb-3"><i class="bi bi-exclamation-triangle me-2"></i>Found data gaps in klines data:</div>';
                
                symbolsWithGaps.forEach(stat => {
                    html += `
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-graph-down text-warning me-2"></i>
                                    ${stat.symbol} - ${stat.timeframe} 
                                    <span class="badge bg-danger ms-2">${stat.gap_count} gaps</span>
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Gap Start</th>
                                                <th>Gap End</th>
                                                <th>Missing Periods</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                    `;
                    
                    stat.gaps.forEach(gap => {
                        html += `
                            <tr>
                                <td><small>${new Date(gap.start).toLocaleString()}</small></td>
                                <td><small>${new Date(gap.end).toLocaleString()}</small></td>
                                <td><span class="badge bg-danger">${gap.missing_periods}</span></td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                gapsData.innerHTML = html;
            }
            
            // Show the gaps section
            gapsSection.style.display = 'block';
            
            // Scroll to gaps section
            gapsSection.scrollIntoView({ behavior: 'smooth' });
        }

        // SMC Analysis Diagnostic Functions
        let smcAnalysisInProgress = false;
        let smcAnalysisStartTime = null;

        function showSMCConfig() {
            showInfo('SMC Configuration:\n\n• Uses multiple timeframes (1H, 4H, 1D)\n• Analyzes market structure and order blocks\n• Detects fair value gaps and liquidity pools\n• Calculates technical indicators (RSI, Moving Averages)\n• Generates signals based on confluence of factors\n\nThis diagnostic tool shows the step-by-step analysis process even when no signals are generated.');
        }

        function clearSMCResults() {
            if (smcAnalysisInProgress) {
                if (!confirm('Analysis is currently in progress. Are you sure you want to clear the results?')) {
                    return;
                }
            }

            // Reset all UI elements
            document.getElementById('smc-progress-card').style.display = 'none';
            document.getElementById('smc-steps-container').style.display = 'none';
            document.getElementById('smc-summary-card').style.display = 'none';
            
            // Reset progress
            document.getElementById('smc-progress-bar').style.width = '0%';
            document.getElementById('smc-progress-text').textContent = '0/7 steps';
            document.getElementById('smc-current-step').textContent = 'Ready to start analysis...';
            
            // Reset all step cards
            for (let i = 1; i <= 7; i++) {
                resetStepCard(i);
            }
            
            // Reset button
            document.getElementById('start-smc-analysis').disabled = false;
            document.getElementById('start-smc-analysis').innerHTML = '<i class="bi bi-play-circle me-2"></i>Start Analysis';
            
            smcAnalysisInProgress = false;
            smcAnalysisStartTime = null;
            
            showSuccess('SMC analysis results cleared successfully!');
        }

        function resetStepCard(stepNumber) {
            const stepCard = document.getElementById(`smc-step-${stepNumber}`);
            const stepIcon = document.getElementById(`step-${stepNumber}-icon`);
            const stepStatus = document.getElementById(`step-${stepNumber}-status`);
            const stepDetails = document.getElementById(`step-${stepNumber}-details`);
            
            // Reset icons
            stepIcon.querySelector('.spinner-border').classList.add('d-none');
            stepIcon.querySelector('.step-waiting').classList.remove('d-none');
            stepIcon.querySelector('.step-success').classList.add('d-none');
            stepIcon.querySelector('.step-error').classList.add('d-none');
            
            // Reset status
            stepStatus.textContent = 'Waiting';
            stepStatus.className = 'badge bg-secondary ms-auto step-status';
            
            // Hide details
            stepDetails.style.display = 'none';
            
            // Reset card style
            stepCard.classList.remove('border-success', 'border-danger');
        }

        async function startSMCAnalysis() {
            if (smcAnalysisInProgress) {
                showWarning('Analysis is already in progress. Please wait for it to complete.');
                return;
            }

            const symbol = document.getElementById('smc-symbol').value.trim().toUpperCase();
            if (!symbol) {
                showError('Please enter a valid trading symbol (e.g., BTCUSDT)');
                return;
            }

            // Start analysis
            smcAnalysisInProgress = true;
            smcAnalysisStartTime = new Date();
            
            // Update button
            const startButton = document.getElementById('start-smc-analysis');
            startButton.disabled = true;
            startButton.innerHTML = '<div class="spinner-border spinner-border-sm me-2" role="status"></div>Analyzing...';
            
            // Show progress card
            document.getElementById('smc-progress-card').style.display = 'block';
            document.getElementById('smc-steps-container').style.display = 'block';
            
            // Update current step
            document.getElementById('smc-current-step').textContent = `Starting analysis for ${symbol}...`;
            
            try {
                const response = await fetch('/api/admin/smc/diagnostic', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ symbol: symbol })
                });
                
                const result = await response.json();
                
                if (response.ok && result.steps) {
                    await processSMCAnalysisResult(result);
                } else {
                    throw new Error(result.error || 'Failed to run SMC analysis');
                }
                
            } catch (error) {
                console.error('SMC Analysis Error:', error);
                showError('Failed to run SMC analysis: ' + error.message);
                
                // Reset button
                startButton.disabled = false;
                startButton.innerHTML = '<i class="bi bi-play-circle me-2"></i>Start Analysis';
                smcAnalysisInProgress = false;
            }
        }

        async function processSMCAnalysisResult(result) {
            // Process each step with animation
            const steps = result.steps || [];
            const totalSteps = 7;
            
            for (let i = 0; i < totalSteps; i++) {
                const stepNumber = i + 1;
                const stepData = steps[i];
                
                if (stepData) {
                    await updateStepUI(stepNumber, stepData, i + 1, totalSteps);
                    // Add small delay for better UX
                    await new Promise(resolve => setTimeout(resolve, 300));
                } else {
                    // Mark as not executed
                    updateStepAsSkipped(stepNumber);
                }
            }
            
            // Show final summary
            showAnalysisSummary(result);
            
            // Reset button
            const startButton = document.getElementById('start-smc-analysis');
            startButton.disabled = false;
            startButton.innerHTML = '<i class="bi bi-play-circle me-2"></i>Start Analysis';
            smcAnalysisInProgress = false;
        }

        async function updateStepUI(stepNumber, stepData, currentStep, totalSteps) {
            const stepCard = document.getElementById(`smc-step-${stepNumber}`);
            const stepIcon = document.getElementById(`step-${stepNumber}-icon`);
            const stepStatus = document.getElementById(`step-${stepNumber}-status`);
            const stepDetails = document.getElementById(`step-${stepNumber}-details`);
            
            // Update progress
            const progressPercent = (currentStep / totalSteps) * 100;
            document.getElementById('smc-progress-bar').style.width = `${progressPercent}%`;
            document.getElementById('smc-progress-text').textContent = `${currentStep}/${totalSteps} steps`;
            document.getElementById('smc-current-step').textContent = `${stepData.name}...`;
            
            // Show spinner first
            stepIcon.querySelector('.step-waiting').classList.add('d-none');
            stepIcon.querySelector('.spinner-border').classList.remove('d-none');
            stepStatus.textContent = 'Running';
            stepStatus.className = 'badge bg-primary ms-auto step-status';
            
            // Wait a moment for visual effect
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Update final status
            stepIcon.querySelector('.spinner-border').classList.add('d-none');
            
            if (stepData.status === 'completed') {
                stepIcon.querySelector('.step-success').classList.remove('d-none');
                stepStatus.textContent = 'Completed';
                stepStatus.className = 'badge bg-success ms-auto step-status';
                stepCard.classList.add('border-success');
                
                // Show details
                populateStepDetails(stepNumber, stepData);
                stepDetails.style.display = 'block';
                
            } else if (stepData.status === 'error') {
                stepIcon.querySelector('.step-error').classList.remove('d-none');
                stepStatus.textContent = 'Error';
                stepStatus.className = 'badge bg-danger ms-auto step-status';
                stepCard.classList.add('border-danger');
                
                // Show error details
                populateStepDetails(stepNumber, stepData);
                stepDetails.style.display = 'block';
            } else {
                stepIcon.querySelector('.step-waiting').classList.remove('d-none');
                stepStatus.textContent = 'Skipped';
                stepStatus.className = 'badge bg-warning ms-auto step-status';
            }
        }

        function updateStepAsSkipped(stepNumber) {
            const stepStatus = document.getElementById(`step-${stepNumber}-status`);
            stepStatus.textContent = 'Skipped';
            stepStatus.className = 'badge bg-warning ms-auto step-status';
        }

        function populateStepDetails(stepNumber, stepData) {
            const details = stepData.details || {};
            const message = details.message || '';
            
            // Update message
            const messageElement = document.getElementById(`step-${stepNumber}-message`);
            if (messageElement) {
                messageElement.textContent = message;
                messageElement.className = stepData.status === 'error' ? 'mt-2 small text-danger' : 'mt-2 small text-muted';
            }
            
            // Populate step-specific details
            switch (stepNumber) {
                case 1: // Data Acquisition
                    populateStep1Details(details);
                    break;
                case 2: // Market Structure
                    populateStep2Details(details);
                    break;
                case 3: // Order Blocks
                    populateStep3Details(details);
                    break;
                case 4: // Fair Value Gaps
                    populateStep4Details(details);
                    break;
                case 5: // Liquidity Pools
                    populateStep5Details(details);
                    break;
                case 6: // Technical Indicators
                    populateStep6Details(details);
                    break;
                case 7: // Signal Generation
                    populateStep7Details(details, stepData);
                    break;
            }
        }

        function populateStep1Details(details) {
            const timeframes = details.timeframes_fetched || {};
            document.getElementById('step-1-h1-count').textContent = timeframes['1h']?.candles_count || 0;
            document.getElementById('step-1-h4-count').textContent = timeframes['4h']?.candles_count || 0;
            document.getElementById('step-1-d1-count').textContent = timeframes['1d']?.candles_count || 0;
        }

        function populateStep2Details(details) {
            document.getElementById('step-2-h1-structure').textContent = details.h1_structure || '-';
            document.getElementById('step-2-h4-structure').textContent = details.h4_structure || '-';
            document.getElementById('step-2-d1-structure').textContent = details.d1_structure || '-';
        }

        function populateStep3Details(details) {
            document.getElementById('step-3-total-blocks').textContent = details.total_order_blocks || 0;
            document.getElementById('step-3-bullish-blocks').textContent = details.bullish_blocks || 0;
            document.getElementById('step-3-bearish-blocks').textContent = details.bearish_blocks || 0;
            document.getElementById('step-3-validated-blocks').textContent = details.validated_blocks || 0;
        }

        function populateStep4Details(details) {
            document.getElementById('step-4-total-fvgs').textContent = details.total_fvgs || 0;
            document.getElementById('step-4-bullish-fvgs').textContent = details.bullish_fvgs || 0;
            document.getElementById('step-4-bearish-fvgs').textContent = details.bearish_fvgs || 0;
            document.getElementById('step-4-unfilled-fvgs').textContent = details.unfilled_fvgs || 0;
        }

        function populateStep5Details(details) {
            document.getElementById('step-5-total-pools').textContent = details.total_pools || 0;
            document.getElementById('step-5-buy-pools').textContent = details.buy_side_pools || 0;
            document.getElementById('step-5-sell-pools').textContent = details.sell_side_pools || 0;
            document.getElementById('step-5-swept-pools').textContent = details.swept_pools || 0;
        }

        function populateStep6Details(details) {
            document.getElementById('step-6-current-price').textContent = details.current_price ? `$${Number(details.current_price).toLocaleString()}` : '-';
            document.getElementById('step-6-rsi').textContent = details.rsi_current ? Number(details.rsi_current).toFixed(1) : '-';
            
            const ma20 = details.moving_averages?.ma_20;
            const ema20 = details.moving_averages?.ema_20;
            document.getElementById('step-6-ma20').textContent = ma20 ? `$${Number(ma20).toLocaleString()}` : '-';
            document.getElementById('step-6-ema20').textContent = ema20 ? `$${Number(ema20).toLocaleString()}` : '-';
        }

        function populateStep7Details(details, stepData) {
            if (details.signal_generated) {
                // Show signal details
                document.getElementById('step-7-signal').style.display = 'block';
                document.getElementById('step-7-no-signal').style.display = 'none';
                
                document.getElementById('signal-direction').textContent = details.direction || '-';
                document.getElementById('signal-direction').className = `badge ${details.direction === 'long' ? 'bg-success' : 'bg-danger'}`;
                
                document.getElementById('signal-entry').textContent = details.entry_price ? `$${Number(details.entry_price).toLocaleString()}` : '-';
                document.getElementById('signal-sl').textContent = details.stop_loss ? `$${Number(details.stop_loss).toLocaleString()}` : '-';
                document.getElementById('signal-confidence').textContent = details.confidence ? `${(details.confidence * 100).toFixed(1)}%` : '-';
                document.getElementById('signal-strength').textContent = details.signal_strength || '-';
                document.getElementById('signal-strength').className = 'badge bg-info';
                document.getElementById('signal-rr').textContent = details.risk_reward_ratio ? `1:${details.risk_reward_ratio.toFixed(1)}` : '-';
                
                // Take profits
                const tps = details.take_profits || [];
                document.getElementById('signal-tps').textContent = tps.map(tp => `$${Number(tp).toLocaleString()}`).join(', ') || '-';
                
                // Reasoning
                const reasoning = details.reasoning || [];
                const reasoningList = document.getElementById('signal-reasoning');
                reasoningList.innerHTML = '';
                reasoning.forEach(reason => {
                    const li = document.createElement('li');
                    li.textContent = reason;
                    reasoningList.appendChild(li);
                });
                
            } else {
                // Show no signal
                document.getElementById('step-7-signal').style.display = 'none';
                document.getElementById('step-7-no-signal').style.display = 'block';
                document.getElementById('step-7-no-signal-reason').textContent = details.reason || 'Analysis completed but no valid signal conditions were met.';
            }
        }

        function showAnalysisSummary(result) {
            const summary = result.summary || {};
            const analysisTime = smcAnalysisStartTime ? ((new Date() - smcAnalysisStartTime) / 1000).toFixed(1) + 's' : '-';
            
            // Calculate success rate
            const successRate = summary.total_steps > 0 ? ((summary.successful_steps / summary.total_steps) * 100).toFixed(0) + '%' : '-';
            
            // Update summary
            document.getElementById('summary-success-rate').textContent = successRate;
            document.getElementById('summary-analysis-time').textContent = analysisTime;
            document.getElementById('summary-symbol').textContent = result.symbol || '-';
            document.getElementById('summary-timestamp').textContent = result.timestamp ? new Date(result.timestamp).toLocaleString() : '-';
            
            // Show summary card
            document.getElementById('smc-summary-card').style.display = 'block';
            
            // Update final progress
            document.getElementById('smc-current-step').textContent = result.signal_generated ? 
                `Analysis complete - Signal generated!` : 
                `Analysis complete - No signal generated`;
            
            // Show completion message
            if (result.signal_generated) {
                showSuccess(`🎯 SMC Analysis Complete!\n\nSignal Generated: ${result.signal?.direction?.toUpperCase() || 'Unknown'}\nSuccess Rate: ${successRate}\nAnalysis Time: ${analysisTime}`);
            } else {
                showInfo(`📊 SMC Analysis Complete!\n\nNo signals generated (market conditions did not meet criteria)\nSuccess Rate: ${successRate}\nAnalysis Time: ${analysisTime}`);
            }
        }
    </script>
</body>
</html>